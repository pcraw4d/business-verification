# Staging Environment Configuration
# Risk Assessment Service - Staging Settings

environment: "staging"

# Service Configuration
service:
  name: "risk-assessment-service"
  version: "1.0.0"
  description: "Enhanced Risk Assessment Service with ML-powered predictions"
  port: "8080"
  host: "0.0.0.0"

# Server Configuration
server:
  port: "8080"
  read_timeout: "30s"
  write_timeout: "30s"
  idle_timeout: "120s"
  max_header_bytes: 1048576  # 1MB

# Database Configuration (Supabase)
database:
  url: "${STAGING_DATABASE_URL}"
  max_open_conns: 25
  max_idle_conns: 10
  conn_max_lifetime: "1h"
  conn_max_idle_time: "30m"
  ssl_mode: "require"

# Supabase Configuration
supabase:
  url: "${STAGING_SUPABASE_URL}"
  anon_key: "${STAGING_SUPABASE_ANON_KEY}"
  service_role_key: "${STAGING_SUPABASE_SERVICE_ROLE_KEY}"
  jwt_secret: "${STAGING_SUPABASE_JWT_SECRET}"

# Redis Configuration
redis:
  url: "${STAGING_REDIS_URL}"
  password: "${STAGING_REDIS_PASSWORD}"
  db: 0
  pool_size: 25
  min_idle_conns: 5
  max_idle_conns: 10
  dial_timeout: "5s"
  read_timeout: "3s"
  write_timeout: "3s"
  pool_timeout: "4s"
  idle_timeout: "5m"
  max_retries: 3
  min_retry_backoff: "8ms"
  max_retry_backoff: "512ms"
  enable_fallback: true
  fallback_to_memory: true
  key_prefix: "staging:ra:"

# Logging Configuration
logging:
  level: "info"
  format: "json"
  output: "stdout"
  enable_caller: false
  enable_stacktrace: false

# Monitoring Configuration
monitoring:
  enabled: true
  metrics_enabled: true
  health_check_interval: "30s"
  performance_monitoring: true

# Rate Limiting Configuration
rate_limiting:
  enabled: true
  requests_per_minute: 500  # Moderate limits for staging
  burst_allowance: 50
  window_size: "1m"
  use_redis: true
  redis_key_prefix: "staging:rate_limit:"

# Authentication Configuration
authentication:
  require_auth: true
  allow_service_auth: true
  allow_api_key_auth: true
  allow_jwt_auth: true
  jwt_secret: "${STAGING_JWT_SECRET}"
  api_key_header: "X-API-Key"
  service_token: "${STAGING_SERVICE_TOKEN}"
  token_cache_ttl: "1h"

# Security Configuration
security:
  allowed_origins:
    - "https://staging.kyb-platform.com"
    - "https://staging-app.kyb-platform.com"
    - "https://staging-admin.kyb-platform.com"
    - "https://*.railway.app"
  allowed_methods:
    - "GET"
    - "POST"
    - "PUT"
    - "DELETE"
    - "OPTIONS"
    - "PATCH"
  allowed_headers:
    - "Content-Type"
    - "Authorization"
    - "X-Requested-With"
    - "X-API-Key"
    - "X-User-ID"
    - "X-Tenant-ID"
    - "X-Service-Token"
    - "X-Service-ID"
  allow_credentials: true
  max_age: 86400
  request_size_limit: 10485760  # 10MB for staging
  request_timeout: "30s"
  enable_hsts: true
  enable_csp: true
  enable_xss_protection: true
  enable_frame_options: true
  enable_content_type_options: true
  enable_referrer_policy: true

# ML Configuration
ml:
  models_path: "./models"
  cache_enabled: true
  cache_ttl: "2h"
  batch_size: 500
  max_concurrent_requests: 20
  model_update_interval: "12h"
  enable_model_validation: true
  validation_threshold: 0.85

# External APIs Configuration
external_apis:
  newsapi:
    base_url: "https://newsapi.org/v2"
    api_key: "${STAGING_NEWSAPI_KEY}"
    timeout: "10s"
    retry_attempts: 3
    retry_delay: "1s"
    rate_limit: 1000  # requests per day
    
  opencorporates:
    base_url: "https://api.opencorporates.com/v0.4"
    api_key: "${STAGING_OPENCORPORATES_API_KEY}"
    timeout: "10s"
    retry_attempts: 3
    retry_delay: "1s"
    rate_limit: 500  # requests per month
    
  thomson_reuters:
    base_url: "https://api.thomsonreuters.com"
    api_key: "${STAGING_THOMSON_REUTERS_API_KEY}"
    timeout: "15s"
    retry_attempts: 3
    retry_delay: "2s"
    rate_limit: 10000  # requests per month
    
  ofac:
    base_url: "https://api.treasury.gov"
    api_key: "${STAGING_OFAC_API_KEY}"
    timeout: "10s"
    retry_attempts: 3
    retry_delay: "1s"
    rate_limit: 1000  # requests per day

# Webhook Configuration
webhooks:
  enabled: true
  max_retries: 3
  retry_delay: "5s"
  timeout: "10s"
  signature_validation: true
  rate_limit: 200  # webhooks per minute

# Batch Processing Configuration
batch_processing:
  enabled: true
  max_batch_size: 5000
  processing_timeout: "1h"
  worker_pool_size: 10
  queue_size: 50000
  retry_attempts: 3
  retry_delay: "10s"

# Performance Configuration
performance:
  enable_profiling: false
  profiling_port: "6060"
  enable_tracing: true
  trace_sample_rate: 0.1  # 10% sampling in staging
  enable_metrics: true
  metrics_port: "9090"

# Staging-specific Settings
staging:
  enable_debug_endpoints: false
  enable_swagger: true
  swagger_path: "/docs"
  enable_cors_debug: false
  mock_external_apis: false
  enable_test_data: false
  test_data_path: "./testdata"
  enable_hot_reload: false
  log_sql_queries: false
  log_redis_commands: false
  enable_performance_logging: true

# Testing Configuration
testing:
  enabled: true
  test_database_url: "${STAGING_TEST_DATABASE_URL}"
  test_redis_url: "${STAGING_TEST_REDIS_URL}"
  test_timeout: "30s"
  enable_mocks: false
  mock_external_services: false
  test_data_cleanup: true

# Feature Flags
feature_flags:
  enable_advanced_ml: true
  enable_batch_processing: true
  enable_webhooks: true
  enable_real_time_updates: true
  enable_analytics: true
  enable_audit_logging: true
  enable_performance_monitoring: true
  enable_circuit_breaker: true
  enable_retry_logic: true
  enable_caching: true
  enable_compression: true
  enable_rate_limiting: true
  enable_authentication: true
  enable_authorization: true
  enable_encryption: true
  enable_ssl: true

# Debug Configuration
debug:
  enable_pprof: false
  enable_trace: true
  enable_metrics: true
  log_level: "info"
  log_requests: true
  log_responses: false
  log_errors: true
  log_performance: true
  log_database_queries: false
  log_redis_operations: false
  log_external_api_calls: true
  log_ml_predictions: true
  log_webhook_deliveries: true
  log_batch_processing: true

# Staging-specific Monitoring
monitoring:
  prometheus:
    enabled: true
    scrape_interval: "30s"
    metrics_path: "/metrics"
    
  grafana:
    enabled: true
    dashboard_url: "https://grafana-staging.kyb-platform.com"
    
  alerting:
    enabled: true
    slack_webhook: "${STAGING_SLACK_WEBHOOK}"
    email_recipients:
      - "staging-alerts@kyb-platform.com"

# Backup Configuration
backup:
  enabled: true
  frequency: "daily"
  retention_days: 14
  verification_enabled: true
  test_restore_frequency: "monthly"

# Load Testing Configuration
load_testing:
  enabled: true
  max_concurrent_users: 100
  test_duration: "10m"
  ramp_up_time: "2m"
  target_response_time: "2s"
  max_error_rate: 0.01  # 1%
