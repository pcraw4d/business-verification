<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add Merchant - KYB Platform</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="components/navigation.js"></script>
    <script src="components/mobile-optimization.js"></script>
    <style>
        /* Enhanced Form Styles from Classification Improvement Plan */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            margin: 0;
            padding: 0;
            min-height: 100vh;
        }

        .header-section {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 40px;
            margin-bottom: 30px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        .header-title {
            font-size: 2.5rem;
            font-weight: 700;
            color: #2c3e50;
            margin: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }

        .header-title i {
            font-size: 2.5rem;
            color: #3498db;
        }

        .header-description {
            color: #7f8c8d;
            font-size: 1.2rem;
            margin-top: 15px;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
        }

        /* Enhanced Merchant Form */
        .merchant-form {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 40px;
            margin-bottom: 30px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
        }

        .form-title {
            font-size: 1.8rem;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 30px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
            margin-bottom: 25px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .form-group.full-width {
            grid-column: 1 / -1;
        }

        .form-group.address-group {
            grid-column: 1 / -1;
        }

        .address-grid {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr;
            gap: 15px;
            margin-top: 10px;
        }

        .form-label {
            font-weight: 600;
            color: #495057;
            font-size: 0.95rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .form-label.required::after {
            content: " *";
            color: #e74c3c;
            font-weight: bold;
        }

        .form-input, .form-select {
            padding: 16px 20px;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: #f8f9fa;
            width: 100%;
            box-sizing: border-box;
        }

        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: #3498db;
            background: white;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        .form-textarea {
            min-height: 120px;
            resize: vertical;
        }

        .form-actions {
            display: flex;
            gap: 15px;
            justify-content: flex-end;
            margin-top: 30px;
        }

        .btn {
            padding: 14px 28px;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
            min-height: 48px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(52, 152, 219, 0.4);
        }

        .btn-outline {
            background: transparent;
            color: #6c757d;
            border: 2px solid #6c757d;
        }

        .btn-outline:hover {
            background: #6c757d;
            color: white;
            transform: translateY(-2px);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }

        /* Validation Styles */
        .form-input.error, .form-select.error {
            border-color: #e74c3c;
            background: #ffebee;
        }

        .form-input.success, .form-select.success {
            border-color: #27ae60;
            background: #e8f5e8;
        }

        .error-message {
            color: #e74c3c;
            font-size: 0.85rem;
            margin-top: 5px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .success-message {
            color: #27ae60;
            font-size: 0.85rem;
            margin-top: 5px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        /* Loading States */
        .loading {
            display: none;
            align-items: center;
            justify-content: center;
            gap: 10px;
            color: #3498db;
            font-weight: 600;
        }

        .loading.show {
            display: flex;
        }

        .spinner {
            width: 20px;
            height: 20px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Enhanced Mobile Responsive Design */
        @media (max-width: 768px) {
            .header-section, .merchant-form {
                margin: 15px;
                padding: 25px;
                border-radius: 15px;
            }

            .header-title {
                font-size: 2rem;
                flex-direction: column;
                gap: 10px;
            }

            .form-grid {
                grid-template-columns: 1fr;
                gap: 20px;
            }

            .address-grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }

            .form-actions {
                flex-direction: column;
                gap: 12px;
            }

            .btn {
                width: 100%;
                justify-content: center;
                padding: 16px 24px;
                font-size: 1.1rem;
            }
        }

        @media (max-width: 480px) {
            .header-section, .merchant-form {
                margin: 10px;
                padding: 20px;
            }

            .header-title {
                font-size: 1.8rem;
            }

            .header-description {
                font-size: 1rem;
            }

            .form-title {
                font-size: 1.5rem;
            }
        }

        /* Enhanced Accessibility */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }

        .form-input:focus, .form-select:focus, .btn:focus {
            outline: 2px solid #3498db;
            outline-offset: 2px;
        }

        /* Enhanced Touch Targets for Mobile */
        @media (max-width: 768px) {
            .form-input, .form-select, .btn {
                min-height: 48px;
                touch-action: manipulation;
                -webkit-tap-highlight-color: rgba(0, 0, 0, 0.1);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header Section -->
        <div class="header-section">
            <h1 class="header-title">
                <i class="fas fa-plus-circle"></i>
                Add New Merchant
            </h1>
            <p class="header-description">
                Enter merchant information to perform comprehensive business verification, risk assessment, and analytics analysis.
            </p>
        </div>

        <!-- Merchant Form -->
        <div class="merchant-form">
            <div class="form-title">
                <i class="fas fa-building"></i>
                Merchant Information
            </div>
            
            <form id="merchantForm" novalidate>
                <!-- Basic Information -->
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label required" for="businessName">
                            <i class="fas fa-building"></i>
                            Business Name
                        </label>
                        <input 
                            type="text" 
                            id="businessName" 
                            name="businessName"
                            class="form-input" 
                            placeholder="Enter business name..."
                            required
                            autocomplete="organization"
                        >
                        <div class="error-message" id="businessNameError"></div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="websiteUrl">
                            <i class="fas fa-globe"></i>
                            Website URL
                        </label>
                        <input 
                            type="url" 
                            id="websiteUrl" 
                            name="websiteUrl"
                            class="form-input" 
                            placeholder="https://example.com"
                            autocomplete="url"
                        >
                        <div class="error-message" id="websiteUrlError"></div>
                    </div>
                </div>

                <!-- Business Description -->
                <div class="form-group full-width">
                    <label class="form-label" for="businessDescription">
                        <i class="fas fa-file-text"></i>
                        Business Description
                    </label>
                    <textarea 
                        id="businessDescription" 
                        name="businessDescription"
                        class="form-input form-textarea" 
                        placeholder="Describe the business activities, industry, and services..."
                        autocomplete="off"
                    ></textarea>
                    <div class="error-message" id="businessDescriptionError"></div>
                </div>

                <!-- Address Information -->
                <div class="form-group address-group">
                    <label class="form-label required" for="address">
                        <i class="fas fa-map-marker-alt"></i>
                        Business Address
                    </label>
                    <div class="address-grid">
                        <div class="form-group">
                            <label class="form-label" for="streetAddress">
                                Street Address
                            </label>
                            <input 
                                type="text" 
                                id="streetAddress" 
                                name="streetAddress"
                                class="form-input" 
                                placeholder="123 Main Street"
                                autocomplete="street-address"
                            >
                            <div class="error-message" id="streetAddressError"></div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label" for="city">
                                City
                            </label>
                            <input 
                                type="text" 
                                id="city" 
                                name="city"
                                class="form-input" 
                                placeholder="New York"
                                autocomplete="address-level2"
                            >
                            <div class="error-message" id="cityError"></div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label" for="state">
                                State/Province
                            </label>
                            <input 
                                type="text" 
                                id="state" 
                                name="state"
                                class="form-input" 
                                placeholder="NY"
                                autocomplete="address-level1"
                            >
                            <div class="error-message" id="stateError"></div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label" for="postalCode">
                                Postal Code
                            </label>
                            <input 
                                type="text" 
                                id="postalCode" 
                                name="postalCode"
                                class="form-input" 
                                placeholder="10001"
                                autocomplete="postal-code"
                            >
                            <div class="error-message" id="postalCodeError"></div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label required" for="country">
                                Country
                            </label>
                            <select 
                                id="country" 
                                name="country"
                                class="form-select" 
                                required
                                autocomplete="country"
                            >
                                <option value="">Select Country</option>
                                <option value="US">United States</option>
                                <option value="CA">Canada</option>
                                <option value="GB">United Kingdom</option>
                                <option value="AU">Australia</option>
                                <option value="DE">Germany</option>
                                <option value="FR">France</option>
                                <option value="IT">Italy</option>
                                <option value="ES">Spain</option>
                                <option value="NL">Netherlands</option>
                                <option value="BE">Belgium</option>
                                <option value="CH">Switzerland</option>
                                <option value="AT">Austria</option>
                                <option value="SE">Sweden</option>
                                <option value="NO">Norway</option>
                                <option value="DK">Denmark</option>
                                <option value="FI">Finland</option>
                                <option value="IE">Ireland</option>
                                <option value="PT">Portugal</option>
                                <option value="LU">Luxembourg</option>
                                <option value="JP">Japan</option>
                                <option value="KR">South Korea</option>
                                <option value="SG">Singapore</option>
                                <option value="HK">Hong Kong</option>
                                <option value="NZ">New Zealand</option>
                                <option value="BR">Brazil</option>
                                <option value="MX">Mexico</option>
                                <option value="AR">Argentina</option>
                                <option value="CL">Chile</option>
                                <option value="CO">Colombia</option>
                                <option value="PE">Peru</option>
                                <option value="ZA">South Africa</option>
                                <option value="EG">Egypt</option>
                                <option value="NG">Nigeria</option>
                                <option value="KE">Kenya</option>
                                <option value="MA">Morocco</option>
                                <option value="TN">Tunisia</option>
                                <option value="IN">India</option>
                                <option value="CN">China</option>
                                <option value="TH">Thailand</option>
                                <option value="MY">Malaysia</option>
                                <option value="ID">Indonesia</option>
                                <option value="PH">Philippines</option>
                                <option value="VN">Vietnam</option>
                                <option value="TW">Taiwan</option>
                                <option value="IL">Israel</option>
                                <option value="AE">United Arab Emirates</option>
                                <option value="SA">Saudi Arabia</option>
                                <option value="TR">Turkey</option>
                                <option value="RU">Russia</option>
                                <option value="PL">Poland</option>
                                <option value="CZ">Czech Republic</option>
                                <option value="HU">Hungary</option>
                                <option value="RO">Romania</option>
                                <option value="BG">Bulgaria</option>
                                <option value="HR">Croatia</option>
                                <option value="SI">Slovenia</option>
                                <option value="SK">Slovakia</option>
                                <option value="LT">Lithuania</option>
                                <option value="LV">Latvia</option>
                                <option value="EE">Estonia</option>
                                <option value="GR">Greece</option>
                                <option value="CY">Cyprus</option>
                                <option value="MT">Malta</option>
                            </select>
                            <div class="error-message" id="countryError"></div>
                        </div>
                    </div>
                </div>

                <!-- Contact Information -->
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label" for="phoneNumber">
                            <i class="fas fa-phone"></i>
                            Phone Number
                        </label>
                        <input 
                            type="tel" 
                            id="phoneNumber" 
                            name="phoneNumber"
                            class="form-input" 
                            placeholder="+1 (555) 123-4567"
                            autocomplete="tel"
                        >
                        <div class="error-message" id="phoneNumberError"></div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="email">
                            <i class="fas fa-envelope"></i>
                            Email Address
                        </label>
                        <input 
                            type="email" 
                            id="email" 
                            name="email"
                            class="form-input" 
                            placeholder="contact@business.com"
                            autocomplete="email"
                        >
                        <div class="error-message" id="emailError"></div>
                    </div>
                </div>

                <!-- Business Registration -->
                <div class="form-group full-width">
                    <label class="form-label" for="registrationNumber">
                        <i class="fas fa-certificate"></i>
                        Business Registration Number
                    </label>
                    <input 
                        type="text" 
                        id="registrationNumber" 
                        name="registrationNumber"
                        class="form-input" 
                        placeholder="Enter business registration number (EIN, VAT, etc.)"
                        autocomplete="off"
                    >
                    <div class="error-message" id="registrationNumberError"></div>
                </div>

                <!-- Analysis Configuration -->
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label" for="analysisType">
                            <i class="fas fa-chart-line"></i>
                            Analysis Type
                        </label>
                        <select 
                            id="analysisType" 
                            name="analysisType"
                            class="form-select" 
                            autocomplete="off"
                        >
                            <option value="comprehensive">Comprehensive Analysis</option>
                            <option value="basic">Basic Classification</option>
                            <option value="risk">Risk Assessment</option>
                            <option value="compliance">Compliance Check</option>
                        </select>
                        <div class="error-message" id="analysisTypeError"></div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="assessmentType">
                            <i class="fas fa-exclamation-triangle"></i>
                            Risk Assessment Type
                        </label>
                        <select 
                            id="assessmentType" 
                            name="assessmentType"
                            class="form-select" 
                            autocomplete="off"
                        >
                            <option value="comprehensive">Comprehensive Assessment</option>
                            <option value="financial">Financial Risk Only</option>
                            <option value="operational">Operational Risk Only</option>
                            <option value="regulatory">Regulatory Risk Only</option>
                            <option value="reputational">Reputational Risk Only</option>
                            <option value="cybersecurity">Cybersecurity Risk Only</option>
                        </select>
                        <div class="error-message" id="assessmentTypeError"></div>
                    </div>
                </div>
                
                <!-- Form Actions -->
                <div class="form-actions">
                    <button type="button" class="btn btn-outline" id="clearFormBtn">
                        <i class="fas fa-eraser"></i>
                        Clear Form
                    </button>
                    <button type="submit" class="btn btn-primary" id="submitBtn">
                        <i class="fas fa-search"></i>
                        <span class="btn-text">Verify Merchant</span>
                        <div class="loading" id="submitLoading">
                            <div class="spinner"></div>
                            Processing...
                        </div>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Enhanced Form Validation and Processing
        class MerchantFormHandler {
            constructor() {
                this.form = document.getElementById('merchantForm');
                this.submitBtn = document.getElementById('submitBtn');
                this.clearBtn = document.getElementById('clearFormBtn');
                this.submitLoading = document.getElementById('submitLoading');
                this.init();
            }

            init() {
                this.bindEvents();
                this.initializeMobileOptimization();
            }

            bindEvents() {
                // Form submission
                this.form.addEventListener('submit', (e) => this.handleSubmit(e));
                
                // Clear form
                this.clearBtn.addEventListener('click', () => this.clearForm());
                
                // Real-time validation
                this.form.addEventListener('input', (e) => this.validateField(e.target));
                this.form.addEventListener('blur', (e) => this.validateField(e.target));
                
                // Phone number formatting
                const phoneInput = document.getElementById('phoneNumber');
                phoneInput.addEventListener('input', (e) => this.formatPhoneNumber(e.target));
            }

            initializeMobileOptimization() {
                if (typeof MobileOptimization !== 'undefined') {
                    const mobileOpt = new MobileOptimization({
                        touchTargetSize: 48,
                        enableTouchOptimization: true,
                        enableProgressiveEnhancement: true
                    });
                    mobileOpt.optimizeForMobile();
                }
            }

            validateField(field) {
                const fieldName = field.name;
                const value = field.value.trim();
                const errorElement = document.getElementById(fieldName + 'Error');
                
                // Clear previous validation
                field.classList.remove('error', 'success');
                if (errorElement) errorElement.textContent = '';

                // Required field validation
                if (field.hasAttribute('required') && !value) {
                    this.showError(field, errorElement, 'This field is required');
                    return false;
                }

                // Skip validation for empty optional fields
                if (!value && !field.hasAttribute('required')) {
                    this.showSuccess(field, errorElement);
                    return true;
                }

                // Field-specific validation
                switch (fieldName) {
                    case 'businessName':
                        if (value.length < 2) {
                            this.showError(field, errorElement, 'Business name must be at least 2 characters');
                            return false;
                        }
                        break;
                    
                    case 'websiteUrl':
                        if (!this.isValidUrl(value)) {
                            this.showError(field, errorElement, 'Please enter a valid URL (e.g., https://example.com)');
                            return false;
                        }
                        break;
                    
                    case 'email':
                        if (!this.isValidEmail(value)) {
                            this.showError(field, errorElement, 'Please enter a valid email address');
                            return false;
                        }
                        break;
                    
                    case 'phoneNumber':
                        if (!this.isValidPhone(value)) {
                            this.showError(field, errorElement, 'Please enter a valid phone number');
                            return false;
                        }
                        break;
                    
                    case 'country':
                        if (field.hasAttribute('required') && !value) {
                            this.showError(field, errorElement, 'Please select a country');
                            return false;
                        }
                        break;
                }

                this.showSuccess(field, errorElement);
                return true;
            }

            isValidUrl(url) {
                try {
                    new URL(url);
                    return url.startsWith('http://') || url.startsWith('https://');
                } catch {
                    return false;
                }
            }

            isValidEmail(email) {
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                return emailRegex.test(email);
            }

            isValidPhone(phone) {
                // Remove all non-digit characters
                const digits = phone.replace(/\D/g, '');
                // Check if it has 10-15 digits (international format)
                return digits.length >= 10 && digits.length <= 15;
            }

            formatPhoneNumber(input) {
                let value = input.value.replace(/\D/g, '');
                
                if (value.length > 0) {
                    if (value.length <= 3) {
                        value = `(${value}`;
                    } else if (value.length <= 6) {
                        value = `(${value.slice(0, 3)}) ${value.slice(3)}`;
                    } else if (value.length <= 10) {
                        value = `(${value.slice(0, 3)}) ${value.slice(3, 6)}-${value.slice(6)}`;
                    } else {
                        value = `+${value.slice(0, -10)} (${value.slice(-10, -7)}) ${value.slice(-7, -4)}-${value.slice(-4)}`;
                    }
                }
                
                input.value = value;
            }

            showError(field, errorElement, message) {
                field.classList.add('error');
                field.classList.remove('success');
                if (errorElement) {
                    errorElement.innerHTML = `<i class="fas fa-exclamation-circle"></i> ${message}`;
                }
            }

            showSuccess(field, errorElement) {
                field.classList.add('success');
                field.classList.remove('error');
                if (errorElement) {
                    errorElement.innerHTML = `<i class="fas fa-check-circle"></i> Valid`;
                }
            }

            validateForm() {
                const fields = this.form.querySelectorAll('input, select, textarea');
                let isValid = true;

                fields.forEach(field => {
                    if (!this.validateField(field)) {
                        isValid = false;
                    }
                });

                return isValid;
            }

            async handleSubmit(e) {
                console.log('ðŸ” Form submission started!');
                e.preventDefault();
                
                if (!this.validateForm()) {
                    console.log('ðŸ” Form validation failed, stopping submission');
                    this.scrollToFirstError();
                    return;
                }

                console.log('ðŸ” Form validation passed, starting processing...');
                this.setLoading(true);
                
                try {
                    const formData = this.collectFormData();
                    console.log('ðŸ” Form data collected:', formData);
                    await this.processMerchantVerification(formData);
                } catch (error) {
                    console.error('ðŸ” Error processing merchant verification:', error);
                    this.showNotification('Error processing merchant verification. Please try again.', 'error');
                } finally {
                    this.setLoading(false);
                }
            }

            collectFormData() {
                const formData = new FormData(this.form);
                const data = {};
                
                for (let [key, value] of formData.entries()) {
                    data[key] = value.trim();
                }
                
                // Generate business ID for API calls
                data.businessId = this.generateBusinessId(data.businessName);
                
                // Add timestamp and session info
                data.timestamp = new Date().toISOString();
                data.sessionId = this.generateSessionId();
                
                // Structure data for API calls
                data.apiData = {
                    // Business Intelligence API data
                    businessIntelligence: {
                        business_name: data.businessName,
                        geographic_region: data.country || 'us',
                        website_url: data.websiteUrl || '',
                        description: data.businessDescription || 'Business analysis request',
                        analysis_type: data.analysisType || 'comprehensive'
                    },
                    // Risk Assessment API data
                    riskAssessment: {
                        business_id: data.businessId,
                        business_name: data.businessName,
                        categories: this.getSelectedCategories(data.assessmentType),
                        include_history: true,
                        include_predictions: true
                    },
                    // Risk Indicators API data
                    riskIndicators: {
                        business_id: data.businessId,
                        business_name: data.businessName,
                        merchant_data: {
                            name: data.businessName,
                            website: data.websiteUrl,
                            description: data.businessDescription,
                            address: this.formatAddress(data),
                            phone: data.phoneNumber,
                            email: data.email,
                            registration: data.registrationNumber,
                            country: data.country
                        }
                    }
                };
                
                return data;
            }

            generateBusinessId(businessName) {
                // Generate a unique business ID based on name and timestamp
                const timestamp = Date.now();
                const nameHash = businessName.toLowerCase()
                    .replace(/[^a-z0-9]/g, '')
                    .substring(0, 8);
                return `biz_${nameHash}_${timestamp}`;
            }

            getSelectedCategories(assessmentType) {
                const categoryMap = {
                    'comprehensive': ['financial', 'operational', 'regulatory', 'reputational', 'cybersecurity'],
                    'financial': ['financial'],
                    'operational': ['operational'],
                    'regulatory': ['regulatory'],
                    'reputational': ['reputational'],
                    'cybersecurity': ['cybersecurity']
                };
                return categoryMap[assessmentType] || ['financial', 'operational', 'regulatory'];
            }

            formatAddress(data) {
                const addressParts = [
                    data.streetAddress,
                    data.city,
                    data.state,
                    data.postalCode,
                    data.country
                ].filter(part => part && part.trim());
                
                return addressParts.join(', ');
            }

            generateSessionId() {
                return 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            }

            async processMerchantVerification(data) {
                try {
                    console.log('ðŸ” Starting merchant verification process with data:', data);
                    console.log('ðŸ” About to call APIs in parallel...');
                    
                    // Store base data in session storage
                    sessionStorage.setItem('merchantData', JSON.stringify(data));
                    
                    // Make API calls in parallel for all three analyses
                    console.log('ðŸ” Calling APIs in parallel...');
                    const [businessIntelligenceResult, riskAssessmentResult, riskIndicatorsResult] = await Promise.allSettled([
                        this.callBusinessIntelligenceAPI(data.apiData.businessIntelligence),
                        this.callRiskAssessmentAPI(data.apiData.riskAssessment),
                        this.callRiskIndicatorsAPI(data.apiData.riskIndicators)
                    ]);
                    
                    console.log('ðŸ” All API calls completed. Results:', {
                        businessIntelligence: businessIntelligenceResult,
                        riskAssessment: riskAssessmentResult,
                        riskIndicators: riskIndicatorsResult
                    });
                    
                    // Store API results in session storage
                    const apiResults = {
                        businessIntelligence: businessIntelligenceResult.status === 'fulfilled' ? businessIntelligenceResult.value : null,
                        riskAssessment: riskAssessmentResult.status === 'fulfilled' ? riskAssessmentResult.value : null,
                        riskIndicators: riskIndicatorsResult.status === 'fulfilled' ? riskIndicatorsResult.value : null,
                        errors: {
                            businessIntelligence: businessIntelligenceResult.status === 'rejected' ? businessIntelligenceResult.reason : null,
                            riskAssessment: riskAssessmentResult.status === 'rejected' ? riskAssessmentResult.reason : null,
                            riskIndicators: riskIndicatorsResult.status === 'rejected' ? riskIndicatorsResult.reason : null
                        }
                    };
                    
                    // Log API results for debugging
                    console.log('ðŸ” API Results Summary:');
                    console.log('ðŸ” Business Intelligence:', businessIntelligenceResult.status, businessIntelligenceResult.value || businessIntelligenceResult.reason);
                    console.log('ðŸ” Risk Assessment:', riskAssessmentResult.status, riskAssessmentResult.value || riskAssessmentResult.reason);
                    console.log('ðŸ” Risk Indicators:', riskIndicatorsResult.status, riskIndicatorsResult.value || riskIndicatorsResult.reason);
                    
                    // Additional debugging for Business Intelligence API
                    if (businessIntelligenceResult.status === 'rejected') {
                        console.error('ðŸ” Business Intelligence API Error Details:', businessIntelligenceResult.reason);
                        console.error('ðŸ” Error type:', typeof businessIntelligenceResult.reason);
                        console.error('ðŸ” Error message:', businessIntelligenceResult.reason?.message);
                        console.error('ðŸ” Error stack:', businessIntelligenceResult.reason?.stack);
                    } else if (businessIntelligenceResult.status === 'fulfilled') {
                        console.log('ðŸ” Business Intelligence API Success - Full Response:', businessIntelligenceResult.value);
                    }
                    
                    sessionStorage.setItem('merchantApiResults', JSON.stringify(apiResults));
                    
                    // Redirect to merchant details page
                    window.location.href = '/merchant-details';
                    
                } catch (error) {
                    console.error('Error in merchant verification process:', error);
                    throw error;
                }
            }

            async callBusinessIntelligenceAPI(apiData) {
                console.log('ðŸ” Making Business Intelligence API call with data:', apiData);
                console.log('ðŸ” API URL:', 'https://api-gateway-service-production-21fd.up.railway.app/api/v1/classify');
                
                try {
                    const response = await fetch('https://api-gateway-service-production-21fd.up.railway.app/api/v1/classify', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(apiData)
                    });

                    console.log('ðŸ” Business Intelligence API response status:', response.status);
                    console.log('ðŸ” Business Intelligence API response headers:', Object.fromEntries(response.headers.entries()));

                    if (!response.ok) {
                        const errorText = await response.text();
                        console.error('ðŸ” Business Intelligence API error response:', errorText);
                        throw new Error(`Business Intelligence API error: ${response.status} - ${errorText}`);
                    }

                    const result = await response.json();
                    console.log('ðŸ” Business Intelligence API result:', result);
                    console.log('ðŸ” Business Intelligence API result success:', result.success);
                    return result;
                } catch (error) {
                    console.error('ðŸ” Business Intelligence API call failed:', error);
                    console.error('ðŸ” Error name:', error.name);
                    console.error('ðŸ” Error message:', error.message);
                    console.error('ðŸ” Error stack:', error.stack);
                    throw error;
                }
            }

            async callRiskAssessmentAPI(apiData) {
                // Since there's no dedicated risk assessment API, we'll generate risk data
                // based on the business intelligence results and some business logic
                return new Promise((resolve) => {
                    setTimeout(() => {
                        // Generate risk assessment data based on business name and other factors
                        const businessName = apiData.business_name || '';
                        const riskScore = this.calculateRiskScore(businessName);
                        
                        resolve({
                            success: true,
                            assessment: {
                                overall_risk_score: riskScore,
                                risk_level: this.getRiskLevel(riskScore),
                                confidence: 0.85,
                                categories: {
                                    financial: Math.max(10, riskScore - 10),
                                    operational: Math.max(15, riskScore - 5),
                                    regulatory: Math.max(20, riskScore + 5),
                                    reputational: Math.max(5, riskScore - 15),
                                    cybersecurity: Math.max(25, riskScore + 10)
                                },
                                factors: this.generateRiskFactors(riskScore),
                                recommendations: this.generateRiskRecommendations(riskScore)
                            }
                        });
                    }, 800);
                });
            }

            async callRiskIndicatorsAPI(apiData) {
                // For now, we'll use mock data since the risk indicators page uses mock data
                // In the future, this could be replaced with a real API call
                return new Promise((resolve) => {
                    setTimeout(() => {
                        resolve({
                            success: true,
                            risk_indicators: {
                                financial: 15,
                                operational: 35,
                                regulatory: 65,
                                cybersecurity: 85,
                                overall: 50
                            },
                            trends: {
                                financial: 'improving',
                                operational: 'stable',
                                regulatory: 'rising',
                                cybersecurity: 'escalating'
                            }
                        });
                    }, 1000);
                });
            }

            calculateRiskScore(businessName) {
                // Simple risk calculation based on business name characteristics
                let riskScore = 25; // Base risk score
                
                const name = businessName.toLowerCase();
                
                // High-risk keywords
                if (name.includes('crypto') || name.includes('bitcoin') || name.includes('forex')) {
                    riskScore += 30;
                }
                if (name.includes('gambling') || name.includes('casino') || name.includes('betting')) {
                    riskScore += 25;
                }
                if (name.includes('pharmaceutical') || name.includes('medical') || name.includes('health')) {
                    riskScore += 15;
                }
                if (name.includes('financial') || name.includes('investment') || name.includes('trading')) {
                    riskScore += 20;
                }
                
                // Low-risk keywords
                if (name.includes('consulting') || name.includes('services') || name.includes('solutions')) {
                    riskScore -= 10;
                }
                if (name.includes('technology') || name.includes('software') || name.includes('tech')) {
                    riskScore -= 5;
                }
                
                // Ensure score is within bounds
                return Math.max(5, Math.min(95, riskScore));
            }
            
            getRiskLevel(score) {
                if (score <= 25) return 'Low';
                if (score <= 50) return 'Medium';
                if (score <= 75) return 'High';
                return 'Critical';
            }
            
            generateRiskFactors(riskScore) {
                const factors = [];
                
                if (riskScore > 70) {
                    factors.push('High regulatory compliance requirements');
                    factors.push('Complex operational environment');
                    factors.push('Potential cybersecurity vulnerabilities');
                } else if (riskScore > 40) {
                    factors.push('Moderate compliance requirements');
                    factors.push('Standard operational risks');
                } else {
                    factors.push('Low regulatory requirements');
                    factors.push('Simple operational model');
                }
                
                return factors;
            }
            
            generateRiskRecommendations(riskScore) {
                const recommendations = [];
                
                if (riskScore > 70) {
                    recommendations.push('Implement comprehensive compliance monitoring');
                    recommendations.push('Enhance cybersecurity measures');
                    recommendations.push('Regular risk assessments required');
                } else if (riskScore > 40) {
                    recommendations.push('Standard compliance monitoring');
                    recommendations.push('Basic security measures');
                } else {
                    recommendations.push('Minimal monitoring required');
                    recommendations.push('Standard business practices');
                }
                
                return recommendations;
            }

            setLoading(loading) {
                this.submitBtn.disabled = loading;
                this.submitLoading.classList.toggle('show', loading);
                
                if (loading) {
                    this.submitBtn.querySelector('.btn-text').style.display = 'none';
                } else {
                    this.submitBtn.querySelector('.btn-text').style.display = 'inline';
                }
            }

            clearForm() {
                this.form.reset();
                
                // Clear all validation states
                const fields = this.form.querySelectorAll('input, select, textarea');
                fields.forEach(field => {
                    field.classList.remove('error', 'success');
                });
                
                const errorElements = this.form.querySelectorAll('.error-message');
                errorElements.forEach(element => {
                    element.textContent = '';
                });
                
                // Focus on first field
                document.getElementById('businessName').focus();
            }

            scrollToFirstError() {
                const firstError = this.form.querySelector('.error');
                if (firstError) {
                    firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    firstError.focus();
                }
            }

            showNotification(message, type = 'info') {
                // Create notification element
                const notification = document.createElement('div');
                notification.className = `notification notification-${type}`;
                notification.innerHTML = `
                    <i class="fas fa-${type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
                    ${message}
                `;
                
                // Add styles
                notification.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: ${type === 'error' ? '#e74c3c' : '#3498db'};
                    color: white;
                    padding: 15px 20px;
                    border-radius: 8px;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                    z-index: 10000;
                    display: flex;
                    align-items: center;
                    gap: 10px;
                    max-width: 400px;
                    animation: slideIn 0.3s ease;
                `;
                
                document.body.appendChild(notification);
                
                // Remove after 5 seconds
                setTimeout(() => {
                    notification.style.animation = 'slideOut 0.3s ease';
                    setTimeout(() => notification.remove(), 300);
                }, 5000);
            }
        }

        // Test API call directly - available globally
        window.testAPICall = async function() {
            console.log('ðŸ§ª Testing API call directly...');
            try {
                const testData = {
                    business_name: "The Greene Grape",
                    geographic_region: "US",
                    website_url: "https://greenegrape.com/",
                    description: "Business analysis request",
                    analysis_type: "comprehensive"
                };
                
                console.log('ðŸ§ª Test data:', testData);
                console.log('ðŸ§ª API URL:', 'https://api-gateway-service-production-21fd.up.railway.app/api/v1/classify');
                
                const response = await fetch('https://api-gateway-service-production-21fd.up.railway.app/api/v1/classify', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(testData)
                });
                
                console.log('ðŸ§ª Response status:', response.status);
                console.log('ðŸ§ª Response headers:', Object.fromEntries(response.headers.entries()));
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('ðŸ§ª API Error:', errorText);
                    return;
                }
                
                const result = await response.json();
                console.log('ðŸ§ª API Success! Result:', result);
                console.log('ðŸ§ª Business Intelligence data available:', !!result);
                
            } catch (error) {
                console.error('ðŸ§ª API Test failed:', error);
            }
        };

        // Initialize when DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            new MerchantFormHandler();
            
            // Add test button
            const testButton = document.createElement('button');
            testButton.textContent = 'ðŸ§ª Test API Call';
            testButton.style.cssText = 'position: fixed; top: 10px; right: 10px; z-index: 9999; background: #007bff; color: white; border: none; padding: 10px; border-radius: 5px; cursor: pointer;';
            testButton.onclick = testAPICall;
            document.body.appendChild(testButton);
        });

        // Add notification animations
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideIn {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            @keyframes slideOut {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(100%); opacity: 0; }
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>
