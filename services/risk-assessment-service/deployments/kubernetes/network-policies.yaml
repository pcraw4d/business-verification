apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: risk-assessment-service-network-policy
  namespace: kyb-platform
  labels:
    app: risk-assessment-service
    component: risk-assessment
spec:
  podSelector:
    matchLabels:
      app: risk-assessment-service
  policyTypes:
  - Ingress
  - Egress
  ingress:
  # Allow ingress from load balancer
  - from:
    - namespaceSelector:
        matchLabels:
          name: ingress-nginx
    ports:
    - protocol: TCP
      port: 8080
    - protocol: TCP
      port: 9090
  # Allow ingress from monitoring namespace
  - from:
    - namespaceSelector:
        matchLabels:
          name: monitoring
    ports:
    - protocol: TCP
      port: 9090
  # Allow ingress from other services in the same namespace
  - from:
    - namespaceSelector:
        matchLabels:
          name: kyb-platform
    ports:
    - protocol: TCP
      port: 8080
  egress:
  # Allow egress to database
  - to:
    - namespaceSelector:
        matchLabels:
          name: database
    ports:
    - protocol: TCP
      port: 5432
  # Allow egress to Redis
  - to:
    - namespaceSelector:
        matchLabels:
          name: cache
    ports:
    - protocol: TCP
      port: 6379
  # Allow egress to external APIs (HTTPS)
  - to: []
    ports:
    - protocol: TCP
      port: 443
  # Allow egress to DNS
  - to: []
    ports:
    - protocol: UDP
      port: 53
  # Allow egress to monitoring services
  - to:
    - namespaceSelector:
        matchLabels:
          name: monitoring
    ports:
    - protocol: TCP
      port: 9090
---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: risk-assessment-service-internal-policy
  namespace: kyb-platform
  labels:
    app: risk-assessment-service
    component: risk-assessment
    type: internal
spec:
  podSelector:
    matchLabels:
      app: risk-assessment-service
  policyTypes:
  - Ingress
  ingress:
  # Allow ingress only from other services in the same namespace
  - from:
    - namespaceSelector:
        matchLabels:
          name: kyb-platform
    ports:
    - protocol: TCP
      port: 8080
