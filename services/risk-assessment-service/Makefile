# Makefile for Risk Assessment Service

.PHONY: help test test-coverage test-benchmark test-race lint security build run clean

# Default target
help:
	@echo "Available targets:"
	@echo "  test          - Run all tests"
	@echo "  test-coverage - Run tests with coverage report"
	@echo "  test-benchmark- Run benchmark tests"
	@echo "  test-race     - Run race condition tests"
	@echo "  lint          - Run linting"
	@echo "  security      - Run security scan"
	@echo "  build         - Build the service"
	@echo "  run           - Run the service"
	@echo "  clean         - Clean build artifacts"

# Run all tests
test:
	@echo "ğŸ§ª Running all tests..."
	go test -v ./...

# Run tests with coverage
test-coverage:
	@echo "ğŸ“Š Running tests with coverage..."
	@mkdir -p coverage
	go test -v -race -coverprofile=coverage/coverage.out ./...
	go tool cover -html=coverage/coverage.out -o coverage/coverage.html
	@echo "ğŸ“ˆ Coverage report generated at coverage/coverage.html"

# Run benchmark tests
test-benchmark:
	@echo "ğŸƒ Running benchmark tests..."
	go test -bench=. -benchmem ./...

# Run race condition tests
test-race:
	@echo "ğŸ Running race condition tests..."
	go test -race ./...

# Run linting
lint:
	@echo "ğŸ” Running linting..."
	@if command -v golangci-lint >/dev/null 2>&1; then \
		golangci-lint run; \
	else \
		echo "âš ï¸  golangci-lint not found, installing..."; \
		go install github.com/golangci/golangci-lint/cmd/golangci-lint@latest; \
		golangci-lint run; \
	fi

# Run security scan
security:
	@echo "ğŸ”’ Running security scan..."
	@if command -v gosec >/dev/null 2>&1; then \
		gosec ./...; \
	else \
		echo "âš ï¸  gosec not found, installing..."; \
		go install github.com/securecodewarrior/gosec/v2/cmd/gosec@latest; \
		gosec ./...; \
	fi

# Build the service
build:
	@echo "ğŸ”¨ Building the service..."
	go build -o bin/risk-assessment-service ./cmd/main.go

# Run the service
run:
	@echo "ğŸš€ Running the service..."
	go run ./cmd/main.go

# Clean build artifacts
clean:
	@echo "ğŸ§¹ Cleaning build artifacts..."
	rm -rf bin/
	rm -rf coverage/
	go clean

# Install dependencies
deps:
	@echo "ğŸ“¦ Installing dependencies..."
	go mod tidy
	go mod download

# Run the test script
test-script:
	@echo "ğŸ“œ Running test script..."
	./scripts/run_tests.sh

# Run load tests
load-test:
	@echo "ğŸš€ Running load tests..."
	./scripts/run_load_tests.sh

# Run load test with custom parameters
load-test-custom:
	@echo "ğŸš€ Running custom load test..."
	@read -p "Service URL (default: http://localhost:8080): " url; \
	url=$${url:-http://localhost:8080}; \
	read -p "Duration (default: 5m): " duration; \
	duration=$${duration:-5m}; \
	read -p "Concurrent Users (default: 20): " users; \
	users=$${users:-20}; \
	read -p "Target RPS (default: 16.67): " rps; \
	rps=$${rps:-16.67}; \
	go run ./cmd/load_test.go -url=$$url -duration=$$duration -users=$$users -rps=$$rps -type=load -verbose

# Run stress test
stress-test:
	@echo "ğŸ”¥ Running stress test..."
	go run ./cmd/load_test.go -type=stress -duration=10m -users=50 -verbose

# Run spike test
spike-test:
	@echo "âš¡ Running spike test..."
	go run ./cmd/load_test.go -type=spike -duration=5m -users=30 -verbose

# Railway deployment commands
deploy:
	@echo "ğŸš€ Deploying to Railway..."
	./scripts/deploy_railway.sh

deploy-verify:
	@echo "ğŸ” Verifying Railway deployment..."
	./scripts/deploy_railway.sh verify

deploy-status:
	@echo "ğŸ“Š Checking Railway deployment status..."
	./scripts/deploy_railway.sh status

deploy-logs:
	@echo "ğŸ“‹ Viewing Railway logs..."
	./scripts/deploy_railway.sh logs

# Railway CLI commands
railway-login:
	@echo "ğŸ” Logging into Railway..."
	railway login

railway-status:
	@echo "ğŸ“Š Railway project status..."
	railway status

railway-logs:
	@echo "ğŸ“‹ Railway logs..."
	railway logs --tail 50

railway-variables:
	@echo "ğŸ” Railway environment variables..."
	railway variables

railway-domain:
	@echo "ğŸŒ Railway service domain..."
	railway domain

# Beta testing commands
beta-create-tester:
	@echo "ğŸ‘¥ Creating beta tester..."
	./scripts/manage_beta_testing.sh create-tester

beta-send-invitation:
	@echo "ğŸ“§ Sending beta testing invitation..."
	./scripts/manage_beta_testing.sh send-invitation

beta-view-testers:
	@echo "ğŸ‘¥ Viewing beta testers..."
	./scripts/manage_beta_testing.sh view-testers

beta-view-feedback:
	@echo "ğŸ’¬ Viewing feedback..."
	./scripts/manage_beta_testing.sh view-feedback

beta-view-stats:
	@echo "ğŸ“Š Viewing beta testing statistics..."
	./scripts/manage_beta_testing.sh view-feedback-stats

beta-view-program-stats:
	@echo "ğŸ“Š Viewing beta program statistics..."
	./scripts/manage_beta_testing.sh view-program-stats

beta-performance-test:
	@echo "ğŸš€ Running beta performance test..."
	./scripts/manage_beta_testing.sh performance-test

beta-check-health:
	@echo "ğŸ¥ Checking beta testing service health..."
	./scripts/manage_beta_testing.sh check-health

beta-generate-report:
	@echo "ğŸ“‹ Generating beta testing report..."
	./scripts/manage_beta_testing.sh generate-report

beta-start-services:
	@echo "ğŸš€ Starting beta testing services..."
	./scripts/manage_beta_testing.sh start-services

beta-stop-services:
	@echo "ğŸ›‘ Stopping beta testing services..."
	./scripts/manage_beta_testing.sh stop-services

# Performance testing commands
performance-test:
	@echo "ğŸš€ Running performance test..."
	go run ./cmd/performance_test.go

performance-test-quick:
	@echo "âš¡ Running quick performance test..."
	go run ./cmd/performance_test.go -concurrent-users=5 -requests-per-user=50 -test-duration=2m

performance-test-stress:
	@echo "ğŸ”¥ Running stress performance test..."
	go run ./cmd/performance_test.go -concurrent-users=50 -requests-per-user=200 -test-duration=10m

performance-test-spike:
	@echo "âš¡ Running spike performance test..."
	go run ./cmd/performance_test.go -concurrent-users=100 -requests-per-user=100 -test-duration=5m

# ML validation commands
validate-ml:
	@echo "ğŸ¤– Running ML model validation..."
	go run ./cmd/validate_model.go

validate-ml-quick:
	@echo "âš¡ Running quick ML validation..."
	go run ./cmd/validate_model.go -k 3 -samples 100 -time-range 30d

validate-ml-comprehensive:
	@echo "ğŸ” Running comprehensive ML validation..."
	go run ./cmd/validate_model.go -k 10 -samples 5000 -time-range 730d -confidence 0.99

# Performance optimization commands
optimize-performance:
	@echo "âš¡ Running performance optimization..."
	@echo "This will analyze current performance and apply optimizations"
	@echo "Make sure the service is running on http://localhost:8080"
	@read -p "Press Enter to continue..." dummy
	curl -X GET http://localhost:8080/api/v1/optimization/report

performance-stats:
	@echo "ğŸ“Š Getting performance statistics..."
	curl -X GET http://localhost:8080/api/v1/optimization/stats | jq .

performance-health:
	@echo "ğŸ¥ Checking performance health..."
	curl -X GET http://localhost:8080/api/v1/optimization/health | jq .

performance-report:
	@echo "ğŸ“‹ Getting full performance report..."
	curl -X GET http://localhost:8080/api/v1/optimization/report/full

# Run all quality checks
quality: lint security test-coverage
	@echo "âœ… All quality checks completed!"

# CI/CD pipeline
ci: deps lint security test-coverage build
	@echo "âœ… CI/CD pipeline completed successfully!"

# Full performance validation
performance-validation: performance-test validate-ml optimize-performance
	@echo "âœ… Performance validation completed!"
