package middleware

import (
	"testing"
	"time"
)

func TestDefaultResourceConfig(t *testing.T) {
	config := DefaultResourceConfig()

	if config.MonitoringInterval != 10*time.Second {
		t.Errorf("Expected 10 second monitoring interval, got %v", config.MonitoringInterval)
	}

	if config.OptimizationInterval != 30*time.Second {
		t.Errorf("Expected 30 second optimization interval, got %v", config.OptimizationInterval)
	}

	if config.MaxCPUUsage != 80.0 {
		t.Errorf("Expected 80%% max CPU usage, got %.2f", config.MaxCPUUsage)
	}

	if config.MaxMemoryUsage != 80.0 {
		t.Errorf("Expected 80%% max memory usage, got %.2f", config.MaxMemoryUsage)
	}

	if config.AlertThresholds.CPUWarning != 70.0 {
		t.Errorf("Expected 70%% CPU warning threshold, got %.2f", config.AlertThresholds.CPUWarning)
	}

	if config.AlertThresholds.MemoryWarning != 70.0 {
		t.Errorf("Expected 70%% memory warning threshold, got %.2f", config.AlertThresholds.MemoryWarning)
	}
}

func TestNewResourceUtilizationManager(t *testing.T) {
	rum := NewResourceUtilizationManager(nil)
	defer rum.Shutdown()

	if rum.config == nil {
		t.Error("Expected config to be set")
	}

	if rum.metrics == nil {
		t.Error("Expected metrics to be initialized")
	}

	if rum.optimizer == nil {
		t.Error("Expected optimizer to be initialized")
	}

	if rum.alerts == nil {
		t.Error("Expected alerts to be initialized")
	}
}

func TestResourceUtilizationManager_CollectMetrics(t *testing.T) {
	rum := NewResourceUtilizationManager(nil)
	defer rum.Shutdown()

	err := rum.CollectMetrics()
	if err != nil {
		t.Errorf("CollectMetrics failed: %v", err)
	}

	metrics := rum.GetResourceMetrics()
	if metrics.Timestamp.IsZero() {
		t.Error("Expected timestamp to be set")
	}

	if metrics.CPUCores <= 0 {
		t.Error("Expected CPU cores to be positive")
	}

	if metrics.GoroutineCount <= 0 {
		t.Error("Expected goroutine count to be positive")
	}
}

func TestResourceUtilizationManager_OptimizeResources(t *testing.T) {
	rum := NewResourceUtilizationManager(nil)
	defer rum.Shutdown()

	// Set up test metrics
	rum.metrics.CPUUsage = 85.0
	rum.metrics.MemoryUsage = 85.0
	rum.metrics.GoroutineCount = 900

	err := rum.OptimizeResources()
	if err != nil {
		t.Errorf("OptimizeResources failed: %v", err)
	}

	history := rum.GetOptimizationHistory()
	if len(history) == 0 {
		t.Error("Expected optimization history to be recorded")
	}
}

func TestResourceAlert_Creation(t *testing.T) {
	config := DefaultResourceConfig()
	rum := NewResourceUtilizationManager(config)
	defer rum.Shutdown()

	// Simulate high resource usage
	rum.metrics.CPUUsage = 95.0
	rum.metrics.MemoryUsage = 95.0
	rum.metrics.GoroutineCount = 1500

	rum.checkResourceAlerts()

	alerts := rum.GetResourceAlerts()
	if len(alerts) == 0 {
		t.Error("Expected alerts to be created for high resource usage")
	}

	// Check for CPU alert
	cpuAlertFound := false
	memoryAlertFound := false
	goroutineAlertFound := false

	for _, alert := range alerts {
		switch alert.Type {
		case "CPU":
			cpuAlertFound = true
			if alert.Level != "Critical" {
				t.Errorf("Expected CPU alert level to be Critical, got %s", alert.Level)
			}
		case "Memory":
			memoryAlertFound = true
			if alert.Level != "Critical" {
				t.Errorf("Expected Memory alert level to be Critical, got %s", alert.Level)
			}
		case "Goroutine":
			goroutineAlertFound = true
			if alert.Level != "Critical" {
				t.Errorf("Expected Goroutine alert level to be Critical, got %s", alert.Level)
			}
		}
	}

	if !cpuAlertFound {
		t.Error("Expected CPU alert to be created")
	}

	if !memoryAlertFound {
		t.Error("Expected Memory alert to be created")
	}

	if !goroutineAlertFound {
		t.Error("Expected Goroutine alert to be created")
	}
}

func TestMemoryOptimizationStrategy(t *testing.T) {
	config := DefaultResourceConfig()
	strategy := &MemoryOptimizationStrategy{config: config}

	metrics := &ResourceMetrics{
		MemoryUsage: 75.0, // Above warning threshold
	}

	if !strategy.CanOptimize(metrics) {
		t.Error("Expected memory optimization to be needed")
	}

	result, err := strategy.Optimize(metrics)
	if err != nil {
		t.Errorf("Memory optimization failed: %v", err)
	}

	if !result.Applied {
		t.Error("Expected memory optimization to be applied")
	}

	if result.Strategy != "MemoryOptimization" {
		t.Errorf("Expected strategy name to be MemoryOptimization, got %s", result.Strategy)
	}
}

func TestCPUOptimizationStrategy(t *testing.T) {
	config := DefaultResourceConfig()
	strategy := &CPUOptimizationStrategy{config: config}

	metrics := &ResourceMetrics{
		CPUUsage: 75.0, // Above warning threshold
	}

	if !strategy.CanOptimize(metrics) {
		t.Error("Expected CPU optimization to be needed")
	}

	result, err := strategy.Optimize(metrics)
	if err != nil {
		t.Errorf("CPU optimization failed: %v", err)
	}

	if result.Strategy != "CPUOptimization" {
		t.Errorf("Expected strategy name to be CPUOptimization, got %s", result.Strategy)
	}
}

func TestGoroutineOptimizationStrategy(t *testing.T) {
	config := DefaultResourceConfig()
	strategy := &GoroutineOptimizationStrategy{config: config}

	metrics := &ResourceMetrics{
		GoroutineCount: 900, // Above warning threshold
	}

	if !strategy.CanOptimize(metrics) {
		t.Error("Expected goroutine optimization to be needed")
	}

	result, err := strategy.Optimize(metrics)
	if err != nil {
		t.Errorf("Goroutine optimization failed: %v", err)
	}

	if result.Strategy != "GoroutineOptimization" {
		t.Errorf("Expected strategy name to be GoroutineOptimization, got %s", result.Strategy)
	}
}

func TestGCOptimizationStrategy(t *testing.T) {
	config := DefaultResourceConfig()
	strategy := &GCOptimizationStrategy{config: config}

	metrics := &ResourceMetrics{
		MemoryUsage: 65.0,                             // Above 60% threshold
		LastGCTime:  time.Now().Add(-6 * time.Minute), // Old GC time
	}

	if !strategy.CanOptimize(metrics) {
		t.Error("Expected GC optimization to be needed")
	}

	result, err := strategy.Optimize(metrics)
	if err != nil {
		t.Errorf("GC optimization failed: %v", err)
	}

	if !result.Applied {
		t.Error("Expected GC optimization to be applied")
	}

	if result.Strategy != "GCOptimization" {
		t.Errorf("Expected strategy name to be GCOptimization, got %s", result.Strategy)
	}
}

func TestResourceAlertManager_AddAlert(t *testing.T) {
	config := DefaultResourceConfig()
	ram := NewResourceAlertManager(config)

	alert := ResourceAlert{
		ID:        "test-alert",
		Type:      "CPU",
		Level:     "Warning",
		Metric:    "CPU usage",
		Current:   75.0,
		Threshold: 70.0,
		Timestamp: time.Now(),
		Resolved:  false,
	}

	ram.AddAlert(alert)

	alerts := ram.GetActiveAlerts()
	if len(alerts) != 1 {
		t.Errorf("Expected 1 active alert, got %d", len(alerts))
	}

	if alerts[0].ID != "test-alert" {
		t.Errorf("Expected alert ID to be test-alert, got %s", alerts[0].ID)
	}
}

func TestResourceAlertManager_ResolveAlert(t *testing.T) {
	config := DefaultResourceConfig()
	ram := NewResourceAlertManager(config)

	alert := ResourceAlert{
		ID:        "test-alert",
		Type:      "CPU",
		Level:     "Warning",
		Metric:    "CPU usage",
		Current:   75.0,
		Threshold: 70.0,
		Timestamp: time.Now(),
		Resolved:  false,
	}

	ram.AddAlert(alert)

	activeAlerts := ram.GetActiveAlerts()
	if len(activeAlerts) != 1 {
		t.Errorf("Expected 1 active alert before resolution, got %d", len(activeAlerts))
	}

	ram.ResolveAlert("test-alert")

	activeAlerts = ram.GetActiveAlerts()
	if len(activeAlerts) != 0 {
		t.Errorf("Expected 0 active alerts after resolution, got %d", len(activeAlerts))
	}
}

func TestResourceOptimizer_Strategies(t *testing.T) {
	config := DefaultResourceConfig()
	optimizer := NewResourceOptimizer(config)

	if len(optimizer.strategies) == 0 {
		t.Error("Expected optimization strategies to be registered")
	}

	expectedStrategies := []string{
		"MemoryOptimization",
		"CPUOptimization",
		"GoroutineOptimization",
		"GCOptimization",
	}

	for _, expectedStrategy := range expectedStrategies {
		found := false
		for _, strategy := range optimizer.strategies {
			if strategy.Name() == expectedStrategy {
				found = true
				break
			}
		}
		if !found {
			t.Errorf("Expected strategy %s to be registered", expectedStrategy)
		}
	}
}

func TestMemoryPooler_Creation(t *testing.T) {
	pooler := NewMemoryPooler()

	if pooler.pools == nil {
		t.Error("Expected pools to be initialized")
	}

	if pooler.metrics == nil {
		t.Error("Expected metrics to be initialized")
	}

	if pooler.metrics.PoolAllocations == nil {
		t.Error("Expected pool allocations to be initialized")
	}
}

func TestGCOptimizer_Creation(t *testing.T) {
	config := DefaultResourceConfig()
	gcOptimizer := NewGCOptimizer(config)

	if gcOptimizer.config != config {
		t.Error("Expected config to be set")
	}

	if gcOptimizer.targetPercent != config.GCTargetPercentage {
		t.Errorf("Expected target percent to be %d, got %d", config.GCTargetPercentage, gcOptimizer.targetPercent)
	}

	if gcOptimizer.gcMetrics == nil {
		t.Error("Expected GC metrics to be initialized")
	}
}

func TestCPULoadManager_Creation(t *testing.T) {
	config := DefaultResourceConfig()
	cpuManager := NewCPULoadManager(config)

	if cpuManager.config != config {
		t.Error("Expected config to be set")
	}

	if cpuManager.maxProcs <= 0 {
		t.Error("Expected max procs to be positive")
	}

	if cpuManager.loadBalancer == nil {
		t.Error("Expected load balancer to be initialized")
	}
}
