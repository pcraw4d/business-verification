package middleware

import (
	"fmt"
	"testing"
	"time"
)

// TestNewCPUOptimizationEnhancements tests creating new CPU optimization enhancements
func TestNewCPUOptimizationEnhancements(t *testing.T) {
	config := DefaultCPUOptimizationConfig()
	enhancements := NewCPUOptimizationEnhancements(config)

	if enhancements == nil {
		t.Fatal("Expected non-nil enhancements")
	}

	if enhancements.config != config {
		t.Error("Expected config to be set")
	}

	if enhancements.affinityManager == nil {
		t.Error("Expected affinity manager to be initialized")
	}

	if enhancements.performanceTuner == nil {
		t.Error("Expected performance tuner to be initialized")
	}

	if enhancements.loadBalancer == nil {
		t.Error("Expected load balancer to be initialized")
	}

	// Test with nil config
	enhancements2 := NewCPUOptimizationEnhancements(nil)
	if enhancements2 == nil {
		t.Fatal("Expected non-nil enhancements with nil config")
	}

	if enhancements2.config == nil {
		t.Error("Expected default config to be created")
	}
}

// TestCPUAffinityManager tests CPU affinity management functionality
func TestCPUAffinityManager(t *testing.T) {
	config := DefaultCPUOptimizationConfig()
	manager := NewCPUAffinityManager(config)

	if manager == nil {
		t.Fatal("Expected non-nil affinity manager")
	}

	// Test setting affinity
	err := manager.SetAffinity("test_process", []int{0, 1})
	if err != nil {
		t.Errorf("Failed to set affinity: %v", err)
	}

	// Test getting affinity
	cores := manager.GetAffinity("test_process")
	if len(cores) != 2 {
		t.Errorf("Expected 2 cores, got %d", len(cores))
	}

	if cores[0] != 0 || cores[1] != 1 {
		t.Errorf("Expected cores [0, 1], got %v", cores)
	}

	// Test getting non-existent affinity
	nonExistentCores := manager.GetAffinity("non_existent")
	if nonExistentCores != nil {
		t.Errorf("Expected nil for non-existent affinity, got %v", nonExistentCores)
	}

	// Test affinity optimization
	profile := &CPUProfile{
		Timestamp:    time.Now(),
		OverallUsage: 75.0,
		PerCoreUsage: []float64{80.0, 70.0, 85.0, 65.0},
	}

	err = manager.OptimizeAffinity(profile)
	if err != nil {
		t.Errorf("Failed to optimize affinity: %v", err)
	}

	// Check stats
	if manager.stats.TotalAffinityChanges != 1 {
		t.Errorf("Expected 1 affinity change, got %d", manager.stats.TotalAffinityChanges)
	}
}

// TestCPUPerformanceTuner tests CPU performance tuning functionality
func TestCPUPerformanceTuner(t *testing.T) {
	config := DefaultCPUOptimizationConfig()
	tuner := NewCPUPerformanceTuner(config)

	if tuner == nil {
		t.Fatal("Expected non-nil performance tuner")
	}

	// Test performance tuning
	profile := &CPUProfile{
		Timestamp:    time.Now(),
		OverallUsage: 75.0,
		PerCoreUsage: []float64{80.0, 70.0, 85.0, 65.0},
	}

	err := tuner.TunePerformance(profile)
	if err != nil {
		t.Errorf("Failed to tune performance: %v", err)
	}

	// Check stats
	if tuner.stats.TotalTunings != 1 {
		t.Errorf("Expected 1 tuning, got %d", tuner.stats.TotalTunings)
	}

	if tuner.stats.SuccessfulTunings != 3 { // 3 tuners should succeed
		t.Errorf("Expected 3 successful tunings, got %d", tuner.stats.SuccessfulTunings)
	}

	if tuner.stats.AverageGain <= 0 {
		t.Errorf("Expected positive average gain, got %f", tuner.stats.AverageGain)
	}
}

// TestAdvancedLoadBalancer tests advanced load balancing functionality
func TestAdvancedLoadBalancer(t *testing.T) {
	config := DefaultCPUOptimizationConfig()
	lb := NewAdvancedLoadBalancer(config)

	if lb == nil {
		t.Fatal("Expected non-nil advanced load balancer")
	}

	// Test available strategies
	strategies := lb.GetAvailableStrategies()
	expectedStrategies := []string{"least_connections", "weighted_least_response_time", "adaptive_load_balancing"}

	if len(strategies) != len(expectedStrategies) {
		t.Errorf("Expected %d strategies, got %d", len(expectedStrategies), len(strategies))
	}

	// Test setting strategy
	err := lb.SetStrategy("least_connections")
	if err != nil {
		t.Errorf("Failed to set strategy: %v", err)
	}

	// Test setting invalid strategy
	err = lb.SetStrategy("invalid_strategy")
	if err == nil {
		t.Error("Expected error for invalid strategy")
	}

	// Test worker selection
	workers := []*CPUWorker{
		{
			ID:             0,
			CurrentLoad:    50.0,
			TasksProcessed: 100,
			Status:         "busy",
		},
		{
			ID:             1,
			CurrentLoad:    30.0,
			TasksProcessed: 50,
			Status:         "idle",
		},
	}

	selectedWorker := lb.SelectWorker(workers)
	if selectedWorker == nil {
		t.Error("Expected non-nil selected worker")
	}

	// Test with empty workers
	emptyWorkers := []*CPUWorker{}
	selectedWorker = lb.SelectWorker(emptyWorkers)
	if selectedWorker != nil {
		t.Error("Expected nil worker for empty list")
	}
}

// TestCPUOptimizationEnhancementsIntegration tests integration of all components
func TestCPUOptimizationEnhancementsIntegration(t *testing.T) {
	config := DefaultCPUOptimizationConfig()
	enhancements := NewCPUOptimizationEnhancements(config)

	if enhancements == nil {
		t.Fatal("Expected non-nil enhancements")
	}

	// Test affinity stats
	affinityStats := enhancements.GetAffinityStats()
	if affinityStats == nil {
		t.Error("Expected non-nil affinity stats")
	}

	// Test tuner stats
	tunerStats := enhancements.GetTunerStats()
	if tunerStats == nil {
		t.Error("Expected non-nil tuner stats")
	}

	// Test load balancer stats
	lbStats := enhancements.GetLoadBalancerStats()
	if lbStats == nil {
		t.Error("Expected non-nil load balancer stats")
	}

	// Test shutdown
	enhancements.Shutdown()
}

// TestLoadBalancingStrategies tests different load balancing strategies
func TestLoadBalancingStrategies(t *testing.T) {
	config := DefaultCPUOptimizationConfig()
	lb := NewAdvancedLoadBalancer(config)

	workers := []*CPUWorker{
		{
			ID:             0,
			CurrentLoad:    80.0,
			TasksProcessed: 200,
			Status:         "overloaded",
		},
		{
			ID:             1,
			CurrentLoad:    40.0,
			TasksProcessed: 100,
			Status:         "busy",
		},
		{
			ID:             2,
			CurrentLoad:    20.0,
			TasksProcessed: 50,
			Status:         "idle",
		},
	}

	// Test least connections strategy
	err := lb.SetStrategy("least_connections")
	if err != nil {
		t.Errorf("Failed to set least_connections strategy: %v", err)
	}

	selectedWorker := lb.SelectWorker(workers)
	if selectedWorker == nil {
		t.Error("Expected non-nil worker for least_connections")
	}

	// Test weighted least response time strategy
	err = lb.SetStrategy("weighted_least_response_time")
	if err != nil {
		t.Errorf("Failed to set weighted_least_response_time strategy: %v", err)
	}

	selectedWorker = lb.SelectWorker(workers)
	if selectedWorker == nil {
		t.Error("Expected non-nil worker for weighted_least_response_time")
	}

	// Test adaptive load balancing strategy
	err = lb.SetStrategy("adaptive_load_balancing")
	if err != nil {
		t.Errorf("Failed to set adaptive_load_balancing strategy: %v", err)
	}

	selectedWorker = lb.SelectWorker(workers)
	if selectedWorker == nil {
		t.Error("Expected non-nil worker for adaptive_load_balancing")
	}
}

// TestPerformanceTuningStrategies tests different performance tuning strategies
func TestPerformanceTuningStrategies(t *testing.T) {
	config := DefaultCPUOptimizationConfig()
	tuner := NewCPUPerformanceTuner(config)

	profile := &CPUProfile{
		Timestamp:    time.Now(),
		OverallUsage: 85.0,
		PerCoreUsage: []float64{90.0, 85.0, 80.0, 75.0},
	}

	err := tuner.TunePerformance(profile)
	if err != nil {
		t.Errorf("Failed to tune performance: %v", err)
	}

	// Verify that all tuners were applied
	if tuner.stats.SuccessfulTunings != 3 {
		t.Errorf("Expected 3 successful tunings, got %d", tuner.stats.SuccessfulTunings)
	}

	// Verify average gain is positive
	if tuner.stats.AverageGain <= 0 {
		t.Errorf("Expected positive average gain, got %f", tuner.stats.AverageGain)
	}

	// Test with low CPU usage
	lowProfile := &CPUProfile{
		Timestamp:    time.Now(),
		OverallUsage: 30.0,
		PerCoreUsage: []float64{25.0, 30.0, 35.0, 40.0},
	}

	err = tuner.TunePerformance(lowProfile)
	if err != nil {
		t.Errorf("Failed to tune performance with low usage: %v", err)
	}
}

// TestCPUAffinityOptimization tests CPU affinity optimization
func TestCPUAffinityOptimization(t *testing.T) {
	config := DefaultCPUOptimizationConfig()
	manager := NewCPUAffinityManager(config)

	// Set initial affinities
	manager.SetAffinity("process1", []int{0, 1})
	manager.SetAffinity("process2", []int{2, 3})

	// Test optimization with mixed core usage
	profile := &CPUProfile{
		Timestamp:    time.Now(),
		OverallUsage: 70.0,
		PerCoreUsage: []float64{90.0, 85.0, 30.0, 25.0}, // Cores 2,3 are underutilized
	}

	err := manager.OptimizeAffinity(profile)
	if err != nil {
		t.Errorf("Failed to optimize affinity: %v", err)
	}

	// Verify optimization occurred
	if manager.stats.LastOptimization.IsZero() {
		t.Error("Expected optimization timestamp to be set")
	}
}

// TestConcurrentAccess tests concurrent access to enhancement components
func TestConcurrentAccess(t *testing.T) {
	config := DefaultCPUOptimizationConfig()
	enhancements := NewCPUOptimizationEnhancements(config)

	// Test concurrent access to affinity manager
	done := make(chan bool, 10)
	for i := 0; i < 10; i++ {
		go func(id int) {
			processID := fmt.Sprintf("process_%d", id)
			enhancements.affinityManager.SetAffinity(processID, []int{id % 4})
			enhancements.affinityManager.GetAffinity(processID)
			done <- true
		}(i)
	}

	// Wait for all goroutines to complete
	for i := 0; i < 10; i++ {
		<-done
	}

	// Test concurrent access to performance tuner
	profile := &CPUProfile{
		Timestamp:    time.Now(),
		OverallUsage: 75.0,
		PerCoreUsage: []float64{80.0, 70.0, 85.0, 65.0},
	}

	for i := 0; i < 5; i++ {
		go func() {
			enhancements.performanceTuner.TunePerformance(profile)
			done <- true
		}()
	}

	for i := 0; i < 5; i++ {
		<-done
	}

	// Test concurrent access to load balancer
	workers := []*CPUWorker{
		{ID: 0, CurrentLoad: 50.0, TasksProcessed: 100},
		{ID: 1, CurrentLoad: 30.0, TasksProcessed: 50},
	}

	for i := 0; i < 5; i++ {
		go func() {
			enhancements.loadBalancer.SelectWorker(workers)
			done <- true
		}()
	}

	for i := 0; i < 5; i++ {
		<-done
	}
}

// TestGracefulShutdown tests graceful shutdown of enhancements
func TestGracefulShutdown(t *testing.T) {
	config := DefaultCPUOptimizationConfig()
	enhancements := NewCPUOptimizationEnhancements(config)

	// Start some background operations
	go func() {
		for i := 0; i < 10; i++ {
			profile := &CPUProfile{
				Timestamp:    time.Now(),
				OverallUsage: 75.0,
				PerCoreUsage: []float64{80.0, 70.0, 85.0, 65.0},
			}
			enhancements.performanceTuner.TunePerformance(profile)
			time.Sleep(10 * time.Millisecond)
		}
	}()

	// Allow some operations to start
	time.Sleep(50 * time.Millisecond)

	// Shutdown gracefully
	enhancements.Shutdown()

	// Verify shutdown completed
	// Note: In a real test, you might want to add more sophisticated shutdown verification
}

// BenchmarkCPUOptimizationEnhancements benchmarks the enhancement components
func BenchmarkCPUOptimizationEnhancements(b *testing.B) {
	config := DefaultCPUOptimizationConfig()
	enhancements := NewCPUOptimizationEnhancements(config)
	defer enhancements.Shutdown()

	profile := &CPUProfile{
		Timestamp:    time.Now(),
		OverallUsage: 75.0,
		PerCoreUsage: []float64{80.0, 70.0, 85.0, 65.0},
	}

	workers := []*CPUWorker{
		{ID: 0, CurrentLoad: 50.0, TasksProcessed: 100},
		{ID: 1, CurrentLoad: 30.0, TasksProcessed: 50},
		{ID: 2, CurrentLoad: 70.0, TasksProcessed: 150},
	}

	b.ResetTimer()

	b.Run("PerformanceTuning", func(b *testing.B) {
		for i := 0; i < b.N; i++ {
			enhancements.performanceTuner.TunePerformance(profile)
		}
	})

	b.Run("AffinityOptimization", func(b *testing.B) {
		for i := 0; i < b.N; i++ {
			enhancements.affinityManager.OptimizeAffinity(profile)
		}
	})

	b.Run("LoadBalancing", func(b *testing.B) {
		for i := 0; i < b.N; i++ {
			enhancements.loadBalancer.SelectWorker(workers)
		}
	})
}
