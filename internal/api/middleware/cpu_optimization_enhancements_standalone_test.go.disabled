package middleware

import (
	"testing"
	"time"
)

// TestCPUOptimizationEnhancementsStandalone tests the CPU optimization enhancements without observability dependencies
func TestCPUOptimizationEnhancementsStandalone(t *testing.T) {
	// Create a simple config for testing
	config := &CPUOptimizationConfig{
		OptimizationEnabled:   true,
		OptimizationInterval:  30 * time.Second,
		MaxCPUUsage:           80.0,
		LoadBalancingEnabled:  true,
		NumWorkers:            10,
		LoadBalancingStrategy: "adaptive",
	}

	// Test creating enhancements
	enhancements := NewCPUOptimizationEnhancements(config)
	if enhancements == nil {
		t.Fatal("Expected non-nil enhancements")
	}

	// Test affinity manager
	affinityManager := enhancements.affinityManager
	if affinityManager == nil {
		t.Error("Expected non-nil affinity manager")
	}

	// Test setting affinity
	err := affinityManager.SetAffinity("test_process", []int{0, 1})
	if err != nil {
		t.Errorf("Failed to set affinity: %v", err)
	}

	// Test getting affinity
	cores := affinityManager.GetAffinity("test_process")
	if len(cores) != 2 {
		t.Errorf("Expected 2 cores, got %d", len(cores))
	}

	// Test performance tuner
	performanceTuner := enhancements.performanceTuner
	if performanceTuner == nil {
		t.Error("Expected non-nil performance tuner")
	}

	// Test load balancer
	loadBalancer := enhancements.loadBalancer
	if loadBalancer == nil {
		t.Error("Expected non-nil load balancer")
	}

	// Test available strategies
	strategies := loadBalancer.GetAvailableStrategies()
	if len(strategies) == 0 {
		t.Error("Expected non-empty strategies list")
	}

	// Test worker selection
	workers := []*CPUWorker{
		{
			ID:             0,
			CurrentLoad:    50.0,
			TasksProcessed: 100,
			Status:         "busy",
		},
		{
			ID:             1,
			CurrentLoad:    30.0,
			TasksProcessed: 50,
			Status:         "idle",
		},
	}

	selectedWorker := loadBalancer.SelectWorker(workers)
	if selectedWorker == nil {
		t.Error("Expected non-nil selected worker")
	}

	// Test shutdown
	enhancements.Shutdown()
}

// TestCPUAffinityManagerStandalone tests the CPU affinity manager without observability dependencies
func TestCPUAffinityManagerStandalone(t *testing.T) {
	config := &CPUOptimizationConfig{
		OptimizationEnabled:  true,
		LoadBalancingEnabled: true,
	}

	manager := NewCPUAffinityManager(config)
	if manager == nil {
		t.Fatal("Expected non-nil affinity manager")
	}

	// Test setting multiple affinities
	testCases := []struct {
		processID string
		cores     []int
	}{
		{"process1", []int{0, 1}},
		{"process2", []int{2, 3}},
		{"process3", []int{0, 2, 4}},
	}

	for _, tc := range testCases {
		err := manager.SetAffinity(tc.processID, tc.cores)
		if err != nil {
			t.Errorf("Failed to set affinity for %s: %v", tc.processID, err)
		}

		retrievedCores := manager.GetAffinity(tc.processID)
		if len(retrievedCores) != len(tc.cores) {
			t.Errorf("Expected %d cores for %s, got %d", len(tc.cores), tc.processID, len(retrievedCores))
		}
	}

	// Test optimization with mock profile
	profile := &CPUProfile{
		Timestamp:    time.Now(),
		OverallUsage: 75.0,
		PerCoreUsage: []float64{80.0, 70.0, 85.0, 65.0},
	}

	err := manager.OptimizeAffinity(profile)
	if err != nil {
		t.Errorf("Failed to optimize affinity: %v", err)
	}

	// Check stats
	stats := manager.GetStats()
	if stats.TotalAffinityChanges == 0 {
		t.Error("Expected affinity changes to be recorded")
	}
}

// TestCPUPerformanceTunerStandalone tests the CPU performance tuner without observability dependencies
func TestCPUPerformanceTunerStandalone(t *testing.T) {
	config := &CPUOptimizationConfig{
		OptimizationEnabled:  true,
		LoadBalancingEnabled: true,
	}

	tuner := NewCPUPerformanceTuner(config)
	if tuner == nil {
		t.Fatal("Expected non-nil performance tuner")
	}

	// Test performance tuning with different profiles
	testProfiles := []*CPUProfile{
		{
			Timestamp:    time.Now(),
			OverallUsage: 85.0,
			PerCoreUsage: []float64{90.0, 85.0, 80.0, 75.0},
		},
		{
			Timestamp:    time.Now(),
			OverallUsage: 30.0,
			PerCoreUsage: []float64{25.0, 30.0, 35.0, 40.0},
		},
		{
			Timestamp:    time.Now(),
			OverallUsage: 95.0,
			PerCoreUsage: []float64{98.0, 95.0, 92.0, 90.0},
		},
	}

	for i, profile := range testProfiles {
		err := tuner.TunePerformance(profile)
		if err != nil {
			t.Errorf("Failed to tune performance for profile %d: %v", i, err)
		}
	}

	// Check stats
	stats := tuner.GetStats()
	if stats.TotalTunings == 0 {
		t.Error("Expected tunings to be recorded")
	}

	if stats.AverageGain < 0 {
		t.Error("Expected positive average gain")
	}
}

// TestAdvancedLoadBalancerStandalone tests the advanced load balancer without observability dependencies
func TestAdvancedLoadBalancerStandalone(t *testing.T) {
	config := &CPUOptimizationConfig{
		Enabled:              true,
		LoadBalancingEnabled: true,
		MaxWorkers:           10,
		WorkerTimeout:        5 * time.Second,
	}

	lb := NewAdvancedLoadBalancer(config)
	if lb == nil {
		t.Fatal("Expected non-nil advanced load balancer")
	}

	// Test available strategies
	strategies := lb.GetAvailableStrategies()
	expectedStrategies := []string{"least_connections", "weighted_least_response_time", "adaptive_load_balancing"}

	if len(strategies) != len(expectedStrategies) {
		t.Errorf("Expected %d strategies, got %d", len(expectedStrategies), len(strategies))
	}

	// Test each strategy
	for _, strategy := range expectedStrategies {
		err := lb.SetStrategy(strategy)
		if err != nil {
			t.Errorf("Failed to set strategy %s: %v", strategy, err)
		}

		// Test worker selection with this strategy
		workers := []*CPUWorker{
			{
				ID:             0,
				CurrentLoad:    80.0,
				TasksProcessed: 200,
				Status:         "overloaded",
			},
			{
				ID:             1,
				CurrentLoad:    40.0,
				TasksProcessed: 100,
				Status:         "busy",
			},
			{
				ID:             2,
				CurrentLoad:    20.0,
				TasksProcessed: 50,
				Status:         "idle",
			},
		}

		selectedWorker := lb.SelectWorker(workers)
		if selectedWorker == nil {
			t.Errorf("Expected non-nil worker for strategy %s", strategy)
		}
	}

	// Test with empty workers
	emptyWorkers := []*CPUWorker{}
	selectedWorker := lb.SelectWorker(emptyWorkers)
	if selectedWorker != nil {
		t.Error("Expected nil worker for empty list")
	}

	// Test invalid strategy
	err := lb.SetStrategy("invalid_strategy")
	if err == nil {
		t.Error("Expected error for invalid strategy")
	}

	// Check stats
	stats := lb.GetStats()
	if stats.TotalRequests == 0 {
		t.Error("Expected requests to be recorded")
	}
}

// BenchmarkCPUOptimizationEnhancementsStandalone benchmarks the enhancement components
func BenchmarkCPUOptimizationEnhancementsStandalone(b *testing.B) {
	config := &CPUOptimizationConfig{
		Enabled:                     true,
		LoadBalancingEnabled:        true,
		AffinityOptimizationEnabled: true,
		PerformanceTuningEnabled:    true,
		MaxWorkers:                  10,
	}

	enhancements := NewCPUOptimizationEnhancements(config)
	defer enhancements.Shutdown()

	profile := &CPUProfile{
		Timestamp:    time.Now(),
		OverallUsage: 75.0,
		PerCoreUsage: []float64{80.0, 70.0, 85.0, 65.0},
	}

	workers := []*CPUWorker{
		{ID: 0, CurrentLoad: 50.0, TasksProcessed: 100},
		{ID: 1, CurrentLoad: 30.0, TasksProcessed: 50},
		{ID: 2, CurrentLoad: 70.0, TasksProcessed: 150},
	}

	b.ResetTimer()

	b.Run("PerformanceTuning", func(b *testing.B) {
		for i := 0; i < b.N; i++ {
			enhancements.performanceTuner.TunePerformance(profile)
		}
	})

	b.Run("AffinityOptimization", func(b *testing.B) {
		for i := 0; i < b.N; i++ {
			enhancements.affinityManager.OptimizeAffinity(profile)
		}
	})

	b.Run("LoadBalancing", func(b *testing.B) {
		for i := 0; i < b.N; i++ {
			enhancements.loadBalancer.SelectWorker(workers)
		}
	})
}
