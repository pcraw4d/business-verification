package middleware

import (
	"context"
	"fmt"
	"log"
	"time"
)

// NewPerformanceMonitoringManager creates a new performance monitoring manager
func NewPerformanceMonitoringManager(config *PerformanceMonitoringConfig) *PerformanceMonitoringManager {
	ctx, cancel := context.WithCancel(context.Background())

	manager := &PerformanceMonitoringManager{
		config:         config,
		ctx:            ctx,
		cancel:         cancel,
		monitoringDone: make(chan struct{}),
	}

	// Initialize components
	if config.MonitoringEnabled {
		manager.monitor = NewPerformanceMonitor(config.MonitorConfig)
	}

	if config.BottleneckDetectionEnabled {
		manager.bottleneckDetector = NewBottleneckDetector(config.BottleneckConfig)
	}

	if config.ProfilingEnabled {
		manager.profiler = NewPerformanceProfiler(config.ProfilerConfig)
	}

	if config.AnalyticsEnabled {
		manager.analytics = NewPerformanceAnalytics(config.AnalyticsConfig)
	}

	if config.AlertingEnabled {
		manager.alertManager = NewPerformanceAlertManager(config.AlertConfig)
	}

	return manager
}

// Start starts the performance monitoring manager
func (p *PerformanceMonitoringManager) Start() error {
	log.Println("ðŸ“Š Starting performance monitoring manager...")

	// Start monitor
	if p.monitor != nil {
		if err := p.monitor.Start(); err != nil {
			return fmt.Errorf("failed to start monitor: %w", err)
		}
	}

	// Start bottleneck detector
	if p.bottleneckDetector != nil {
		if err := p.bottleneckDetector.Start(); err != nil {
			return fmt.Errorf("failed to start bottleneck detector: %w", err)
		}
	}

	// Start profiler
	if p.profiler != nil {
		if err := p.profiler.Start(); err != nil {
			return fmt.Errorf("failed to start profiler: %w", err)
		}
	}

	// Start analytics
	if p.analytics != nil {
		if err := p.analytics.Start(); err != nil {
			return fmt.Errorf("failed to start analytics: %w", err)
		}
	}

	// Start alert manager
	if p.alertManager != nil {
		if err := p.alertManager.Start(); err != nil {
			return fmt.Errorf("failed to start alert manager: %w", err)
		}
	}

	// Start monitoring loop
	go p.monitoringLoop()

	log.Println("âœ… Performance monitoring manager started successfully")
	return nil
}

// Stop stops the performance monitoring manager
func (p *PerformanceMonitoringManager) Stop() error {
	log.Println("ðŸ›‘ Stopping performance monitoring manager...")

	p.cancel()

	// Stop components
	if p.monitor != nil {
		p.monitor.Stop()
	}

	if p.bottleneckDetector != nil {
		p.bottleneckDetector.Stop()
	}

	if p.profiler != nil {
		p.profiler.Stop()
	}

	if p.analytics != nil {
		p.analytics.Stop()
	}

	if p.alertManager != nil {
		p.alertManager.Stop()
	}

	// Wait for monitoring loop to finish
	select {
	case <-p.monitoringDone:
	case <-time.After(10 * time.Second):
		log.Println("âš ï¸ Timeout waiting for monitoring loop to stop")
	}

	log.Println("âœ… Performance monitoring manager stopped")
	return nil
}

// monitoringLoop runs the main monitoring loop
func (p *PerformanceMonitoringManager) monitoringLoop() {
	defer close(p.monitoringDone)

	ticker := time.NewTicker(p.config.MonitoringInterval)
	defer ticker.Stop()

	for {
		select {
		case <-p.ctx.Done():
			return
		case <-ticker.C:
			p.performMonitoring()
		}
	}
}

// performMonitoring performs comprehensive monitoring
func (p *PerformanceMonitoringManager) performMonitoring() {
	p.mu.Lock()
	defer p.mu.Unlock()

	// Collect metrics
	if p.monitor != nil {
		metrics, err := p.monitor.CollectMetrics()
		if err != nil {
			log.Printf("âŒ Failed to collect metrics: %v", err)
			return
		}

		// Detect bottlenecks
		if p.bottleneckDetector != nil {
			bottlenecks, err := p.bottleneckDetector.DetectBottlenecks(metrics)
			if err != nil {
				log.Printf("âŒ Failed to detect bottlenecks: %v", err)
			} else if len(bottlenecks) > 0 {
				log.Printf("ðŸ” Detected %d bottlenecks", len(bottlenecks))
			}
		}

		// Analyze trends
		if p.analytics != nil {
			trends, err := p.analytics.AnalyzeTrends(metrics)
			if err != nil {
				log.Printf("âŒ Failed to analyze trends: %v", err)
			} else if len(trends) > 0 {
				log.Printf("ðŸ“ˆ Analyzed %d trends", len(trends))
			}
		}

		// Check for alerts
		if p.alertManager != nil {
			alerts, err := p.alertManager.CheckAlerts(metrics)
			if err != nil {
				log.Printf("âŒ Failed to check alerts: %v", err)
			} else if len(alerts) > 0 {
				log.Printf("ðŸš¨ Generated %d alerts", len(alerts))
			}
		}
	}
}
