# Local Development Docker Compose
# Mirrors Railway production microservices architecture
# Usage: docker-compose -f docker-compose.local.yml up

services:
  # Redis Cache Service
  redis-cache:
    image: redis:7-alpine
    container_name: kyb-redis-local
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
    command: redis-server --appendonly yes
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 3
    networks:
      - kyb-network

  # Playwright Scraper Service (Phase 1)
  playwright-scraper:
    build:
      context: ./services/playwright-scraper
      dockerfile: Dockerfile
    container_name: kyb-playwright-local
    ports:
      - "3000:3000"
    environment:
      - PORT=3000
    healthcheck:
      test:
        [
          "CMD",
          "wget",
          "--no-verbose",
          "--tries=1",
          "-O",
          "/dev/null",
          "http://localhost:3000/health",
        ]
      interval: 10s
      timeout: 5s
      retries: 3
    deploy:
      resources:
        limits:
          memory: 2G
          cpus: '1.0'
        reservations:
          memory: 512M
          cpus: '0.5'
    ulimits:
      nproc: 64
      nofile: 1024
    networks:
      - kyb-network
    restart: unless-stopped

  # Classification Service
  classification-service:
    build:
      context: .
      dockerfile: services/classification-service/Dockerfile
    container_name: kyb-classification-local
    ports:
      - "8081:8081"
    environment:
      - PORT=8081
      - HOST=0.0.0.0
      - ENV=local
      - ENVIRONMENT=local
      - LOG_LEVEL=debug
      - SUPABASE_URL=${SUPABASE_URL}
      - SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFwcWh1cXFta2p4c2x0enNoZmFtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ4NzQ4MzEsImV4cCI6MjA3MDQ1MDgzMX0.UelJkQAVf-XJz1UV0Rbyi-hZHADGOdsHo1PwcPf7JVI
      - SUPABASE_SERVICE_ROLE_KEY=${SUPABASE_SERVICE_ROLE_KEY}
      - DATABASE_URL=${DATABASE_URL}
      - REDIS_URL=redis://redis-cache:6379
      # Phase 1: Playwright Service URL (use Docker service name for internal communication)
      - PLAYWRIGHT_SERVICE_URL=http://playwright-scraper:3000
    depends_on:
      redis-cache:
        condition: service_healthy
      playwright-scraper:
        condition: service_healthy
    healthcheck:
      test:
        [
          "CMD",
          "wget",
          "--no-verbose",
          "--tries=1",
          "-O",
          "/dev/null",
          "http://localhost:8081/health",
        ]
      interval: 30s
      timeout: 15s
      retries: 5
      start_period: 30s
    networks:
      - kyb-network
    restart: unless-stopped

  # Risk Assessment Service
  risk-assessment-service:
    build:
      context: .
      dockerfile: services/risk-assessment-service/Dockerfile.go123
    container_name: kyb-risk-assessment-local
    ports:
      - "8082:8080"
    environment:
      - PORT=8080
      - HOST=0.0.0.0
      - ENVIRONMENT=local
      - LOG_LEVEL=debug
      - DATABASE_URL=${DATABASE_URL}
      - SUPABASE_URL=${SUPABASE_URL}
      - SUPABASE_ANON_KEY=${SUPABASE_ANON_KEY}
      - REDIS_URL=redis://redis-cache:6379
      - ENABLE_ENSEMBLE=true
      - DEFAULT_PREDICTION_HORIZON=3
      - CGO_ENABLED=1
      - CGO_LDFLAGS=-L/app/onnxruntime/lib
      - CGO_CFLAGS=-I/app/onnxruntime/include
      - LD_LIBRARY_PATH=/app/onnxruntime/lib
      - LSTM_MODEL_PATH=/app/models/risk_lstm_v1.onnx
      - XGBOOST_MODEL_PATH=/app/models/xgb_model.json
    depends_on:
      redis-cache:
        condition: service_healthy
    healthcheck:
      test:
        [
          "CMD",
          "wget",
          "--no-verbose",
          "--tries=1",
          "-O",
          "/dev/null",
          "http://localhost:8080/health",
        ]
      interval: 30s
      timeout: 15s
      retries: 5
      start_period: 45s
    networks:
      - kyb-network
    restart: unless-stopped

  # Merchant Service
  merchant-service:
    build:
      context: .
      dockerfile: services/merchant-service/Dockerfile
    container_name: kyb-merchant-local
    ports:
      - "8083:8080"
    environment:
      - PORT=8080
      - HOST=0.0.0.0
      - ENV=local
      - ENVIRONMENT=local
      - LOG_LEVEL=debug
      - SUPABASE_URL=${SUPABASE_URL}
      - SUPABASE_ANON_KEY=${SUPABASE_API_KEY}
      - SUPABASE_SERVICE_ROLE_KEY=${SUPABASE_SERVICE_ROLE_KEY}
      - DATABASE_URL=${DATABASE_URL}
      - REDIS_URL=redis://redis-cache:6379
    depends_on:
      redis-cache:
        condition: service_healthy
    healthcheck:
      test:
        [
          "CMD",
          "wget",
          "--no-verbose",
          "--tries=1",
          "-O",
          "/dev/null",
          "http://localhost:8080/health",
        ]
      interval: 30s
      timeout: 15s
      retries: 5
      start_period: 30s
    networks:
      - kyb-network
    restart: unless-stopped

  # API Gateway
  api-gateway:
    build:
      context: .
      dockerfile: services/api-gateway/Dockerfile
    container_name: kyb-api-gateway-local
    ports:
      - "8080:8080"
    environment:
      - PORT=8080
      - HOST=0.0.0.0
      - ENVIRONMENT=local
      - LOG_LEVEL=debug
      - SUPABASE_URL=${SUPABASE_URL}
      - SUPABASE_ANON_KEY=${SUPABASE_API_KEY}
      - SUPABASE_SERVICE_ROLE_KEY=${SUPABASE_SERVICE_ROLE_KEY}
      - SUPABASE_JWT_SECRET=${SUPABASE_JWT_SECRET}
      # Service URLs - use Docker service names for internal communication
      - CLASSIFICATION_SERVICE_URL=http://classification-service:8081
      - MERCHANT_SERVICE_URL=http://merchant-service:8080
      - RISK_ASSESSMENT_SERVICE_URL=http://risk-assessment-service:8080
      - FRONTEND_URL=http://frontend:8080
      # CORS Configuration
      - CORS_ALLOWED_ORIGINS=*
      - CORS_ALLOWED_METHODS=GET,POST,PUT,DELETE,OPTIONS
      - CORS_ALLOWED_HEADERS=*
      - CORS_ALLOW_CREDENTIALS=true
      # Rate Limiting
      - RATE_LIMIT_ENABLED=true
      - RATE_LIMIT_REQUESTS_PER=1000
      - RATE_LIMIT_WINDOW_SIZE=3600
      - RATE_LIMIT_BURST_SIZE=2000
    depends_on:
      classification-service:
        condition: service_healthy
      merchant-service:
        condition: service_healthy
      risk-assessment-service:
        condition: service_healthy
    healthcheck:
      test:
        [
          "CMD",
          "wget",
          "--no-verbose",
          "--tries=1",
          "-O",
          "/dev/null",
          "http://localhost:8080/health",
        ]
      interval: 30s
      timeout: 15s
      retries: 5
      start_period: 45s
    networks:
      - kyb-network
    restart: unless-stopped
  # Frontend Service
  frontend:
    build:
      context: .
      dockerfile: services/frontend/Dockerfile
    container_name: kyb-frontend-local
    ports:
      - "8086:8080"
    environment:
      - PORT=8080
      - HOST=0.0.0.0
      - ENVIRONMENT=local
      - LOG_LEVEL=debug
      - API_GATEWAY_URL=http://api-gateway:8080
    depends_on:
      api-gateway:
        condition: service_healthy
    healthcheck:
      test:
        [
          "CMD",
          "wget",
          "--no-verbose",
          "--tries=1",
          "-O",
          "/dev/null",
          "http://localhost:8080/health",
        ]
      interval: 30s
      timeout: 15s
      retries: 5
      start_period: 30s
    networks:
      - kyb-network
    restart: unless-stopped

networks:
  kyb-network:
    driver: bridge
    name: kyb-local-network

volumes:
  redis-data:
    name: kyb-redis-data
