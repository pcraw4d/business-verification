name: Security Scanning

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  schedule:
    # Run daily at 2 AM UTC
    - cron: "0 2 * * *"

permissions:
  contents: read
  security-events: write
  actions: read

env:
  GO_VERSION: "1.22"
  SCAN_OUTPUT_DIR: "./security-reports"

jobs:
  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' || github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Full history for secret scanning

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Install security tools
        run: |
          echo "üîß Installing security tools..."

          # Install Go security tools
          echo "Installing gosec..."
          go install github.com/securecodewarrior/gosec/v2/cmd/gosec@latest || {
            echo "gosec v2 installation failed, trying alternative path..."
            go install github.com/securecodewarrior/gosec/cmd/gosec@latest || echo "gosec installation failed completely"
          }

          echo "Installing govulncheck..."
          go install golang.org/x/vuln/cmd/govulncheck@latest || echo "govulncheck installation failed"

          echo "Installing Trivy..."
          # Install Trivy with proper error handling
          curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh -s -- -b /usr/local/bin v0.50.0

          # Add Trivy to PATH
          echo "/usr/local/bin" >> $GITHUB_PATH

          echo "Installing Semgrep..."
          # Install Semgrep (free and open-source)
          python3 -m pip install semgrep || echo "Semgrep installation failed"

          echo "Installing OWASP ZAP baseline..."
          # Install OWASP ZAP baseline (free)
          curl -sSL https://github.com/zaproxy/zaproxy/releases/download/v2.14.0/zap_2.14.0_linux.tar.gz | tar -xz -C /opt/ || echo "ZAP installation failed"

          # Install Python security tools (if needed)
          if command -v pip3 &> /dev/null; then
            pip3 install bandit safety || echo "Python security tools installation failed"
          fi

          # Verify installations
          echo "üîç Verifying security tool installations..."
          gosec --version || echo "gosec installation failed"
          govulncheck --version || echo "govulncheck installation failed"
          trivy --version || echo "trivy installation failed"
          semgrep --version || echo "semgrep installation failed"
          if command -v bandit &> /dev/null; then
            bandit --version || echo "bandit installation failed"
          fi
          if command -v safety &> /dev/null; then
            safety --version || echo "safety installation failed"
          fi

      - name: Create output directory
        run: mkdir -p ${{ env.SCAN_OUTPUT_DIR }}

      - name: Run comprehensive security scan
        run: |
          chmod +x scripts/security-scan.sh
          ./scripts/security-scan.sh \
            --scan-dir . \
            --output-dir ${{ env.SCAN_OUTPUT_DIR }} \
            --scan-type all \
            --fail-on-critical true
        continue-on-error: true

      - name: Run Semgrep static analysis
        run: |
          echo "üîç Running Semgrep static analysis..."
          semgrep --config=auto \
                  --json \
                  --output=${{ env.SCAN_OUTPUT_DIR }}/semgrep-results.json \
                  --severity=ERROR \
                  --severity=WARNING \
                  . || echo "Semgrep scan completed with findings"

          # Also generate a text report
          semgrep --config=auto \
                  --output=${{ env.SCAN_OUTPUT_DIR }}/semgrep-results.txt \
                  --severity=ERROR \
                  --severity=WARNING \
                  . || echo "Semgrep text report completed"
        continue-on-error: true

      - name: Run CodeQL analysis
        uses: github/codeql-action/analyze@v3
        with:
          languages: go
          output: ${{ env.SCAN_OUTPUT_DIR }}/codeql-results
        continue-on-error: true

      - name: Upload security reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: security-reports-${{ github.run_id }}
          path: ${{ env.SCAN_OUTPUT_DIR }}/
          retention-days: 30

      - name: Parse scan results
        id: parse-results
        run: |
          # Parse gosec results
          if [ -f "${{ env.SCAN_OUTPUT_DIR }}/code-security-scan.json" ]; then
            CRITICAL_COUNT=$(jq '[.Issues[] | select(.severity == "HIGH")] | length' "${{ env.SCAN_OUTPUT_DIR }}/code-security-scan.json" 2>/dev/null || echo "0")
            HIGH_COUNT=$(jq '[.Issues[] | select(.severity == "MEDIUM")] | length' "${{ env.SCAN_OUTPUT_DIR }}/code-security-scan.json" 2>/dev/null || echo "0")
            echo "critical_count=$CRITICAL_COUNT" >> $GITHUB_OUTPUT
            echo "high_count=$HIGH_COUNT" >> $GITHUB_OUTPUT
          else
            echo "critical_count=0" >> $GITHUB_OUTPUT
            echo "high_count=0" >> $GITHUB_OUTPUT
          fi

          # Check for any scan failures
          if [ -f "${{ env.SCAN_OUTPUT_DIR }}/security-scan.log" ]; then
            if grep -q "ERROR\|CRITICAL" "${{ env.SCAN_OUTPUT_DIR }}/security-scan.log"; then
              echo "has_critical_issues=true" >> $GITHUB_OUTPUT
            else
              echo "has_critical_issues=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "has_critical_issues=false" >> $GITHUB_OUTPUT
          fi

      - name: Security scan summary
        if: always()
        run: |
          echo "## Security Scan Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Scan completed:** $(date)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Issues Found:" >> $GITHUB_STEP_SUMMARY
          echo "- Critical: ${{ steps.parse-results.outputs.critical_count }}" >> $GITHUB_STEP_SUMMARY
          echo "- High: ${{ steps.parse-results.outputs.high_count }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.parse-results.outputs.has_critical_issues }}" = "true" ]; then
            echo "‚ö†Ô∏è **Critical security issues detected!**" >> $GITHUB_STEP_SUMMARY
            echo "Please review the security reports and address issues immediately." >> $GITHUB_STEP_SUMMARY
          else
            echo "‚úÖ **No critical security issues detected**" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "üìã **Reports available:** Security reports have been uploaded as artifacts." >> $GITHUB_STEP_SUMMARY

      - name: Fail on critical issues
        if: steps.parse-results.outputs.has_critical_issues == 'true'
        run: |
          echo "üö® Critical security issues detected. Build failed."
          echo "Please review and fix security issues before proceeding."
          exit 1

  dependency-scan:
    name: Dependency Vulnerability Scan
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Install Trivy
        run: |
          curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh -s -- -b /usr/local/bin v0.50.0
          echo "/usr/local/bin" >> $GITHUB_PATH

      - name: Run Trivy vulnerability scanner
        run: |
          # Verify Trivy is available
          trivy --version

          # Run filesystem scan
          trivy fs --format sarif --output trivy-results.sarif --severity CRITICAL,HIGH . || {
            echo "Trivy scan failed, creating empty SARIF file"
            echo '{"version": "2.1.0", "runs": []}' > trivy-results.sarif
          }

      - name: Upload Trivy scan results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: "trivy-results.sarif"

      - name: Run Go vulnerability check
        run: |
          go install golang.org/x/vuln/cmd/govulncheck@latest
          govulncheck ./... > govulncheck-results.txt 2>&1 || true

          # Check for critical vulnerabilities
          if grep -q "CRITICAL\|HIGH" govulncheck-results.txt; then
            echo "üö® Critical or high severity vulnerabilities found in Go dependencies"
            cat govulncheck-results.txt
            exit 1
          else
            echo "‚úÖ No critical or high severity vulnerabilities found in Go dependencies"
          fi

  secret-scan:
    name: Secret Scanning
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Full history for secret scanning

      - name: Run TruffleHog secret scanner
        uses: trufflesecurity/trufflehog@v3.63.4
        with:
          args: --only-verified --fail --no-update
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Run GitGuardian secret scanner
        if: secrets.GITGUARDIAN_API_KEY != ''
        uses: GitGuardian/ggshield-action@v1.15.0
        with:
          args: scan path . --recursive --exit-zero
        env:
          GITGUARDIAN_API_KEY: ${{ secrets.GITGUARDIAN_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        continue-on-error: true

  container-scan:
    name: Container Security Scan
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Install Trivy
        run: |
          curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh -s -- -b /usr/local/bin v0.50.0
          echo "/usr/local/bin" >> $GITHUB_PATH

      - name: Build Docker image
        run: |
          docker build -t kyb-tool:latest .

      - name: Run Trivy container scanner
        run: |
          # Verify Trivy is available
          trivy --version

          # Run container scan
          trivy image --format sarif --output trivy-container-results.sarif --severity CRITICAL,HIGH kyb-tool:latest || {
            echo "Trivy scan failed, creating empty SARIF file"
            echo '{"version": "2.1.0", "runs": []}' > trivy-container-results.sarif
          }

      - name: Upload container scan results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: "trivy-container-results.sarif"

  compliance-check:
    name: Compliance Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Run compliance checks
        run: |
          # Check for hardcoded secrets (excluding test files, examples, and template files)
          echo "Checking for hardcoded secrets..."

          # More intelligent secret detection - look for actual secret patterns
          if grep -r -i "password\s*=\s*['\"][^'\"]*['\"]\|secret\s*=\s*['\"][^'\"]*['\"]\|api_key\s*=\s*['\"][^'\"]*['\"]\|token\s*=\s*['\"][^'\"]*['\"]" . \
            --exclude-dir=.git \
            --exclude-dir=vendor \
            --exclude-dir=node_modules \
            --exclude-dir=test \
            --exclude="*_test.go" \
            --exclude="*example*" \
            --exclude="*mock*" \
            --exclude="*.md" \
            --exclude="*.yml" \
            --exclude="*.yaml" \
            --exclude="*.template" \
            --exclude=".env.example" \
            --exclude="*.csv" \
            --exclude="*.html" \
            --exclude="*.json" \
            --exclude="*.go" | grep -v "example\|test\|mock\|TODO\|FIXME\|placeholder\|your_.*_here\|template\|func\|type\|struct\|interface\|const\|var"; then
            echo "üö® Potential hardcoded secrets found!"
            echo "Please ensure all secrets are in environment variables or secure configuration."
            exit 1
          fi

          echo "‚úÖ No hardcoded secrets detected"

          # Check for proper TLS configuration (excluding test files)
          echo "Checking TLS configuration..."
          if grep -r "http://" . --include="*.go" --exclude-dir=vendor --exclude-dir=test --exclude="*_test.go" | grep -v "example\|test\|mock"; then
            echo "‚ö†Ô∏è  HTTP URLs found in Go code (excluding tests)"
          fi

          # Check for proper error handling
          echo "Checking error handling..."
          ERROR_HANDLING_COUNT=$(grep -r "if err != nil" . --include="*.go" --exclude-dir=vendor --exclude="*_test.go" | wc -l)
          if [ "$ERROR_HANDLING_COUNT" -eq 0 ]; then
            echo "‚ö†Ô∏è  No error handling patterns found in main code"
          else
            echo "‚úÖ Found $ERROR_HANDLING_COUNT error handling patterns"
          fi

          echo "‚úÖ Basic compliance checks passed"

  security-notification:
    name: Security Notification
    runs-on: ubuntu-latest
    needs: [security-scan, dependency-scan, secret-scan]
    if: always() && (needs.security-scan.result == 'failure' || needs.dependency-scan.result == 'failure' || needs.secret-scan.result == 'failure')

    steps:
      - name: Send security alert
        run: |
          echo "üö® Security scan failed!"
          echo "Please review the security reports and address issues immediately."
          echo "Failed jobs:"
          echo "- Security Scan: ${{ needs.security-scan.result }}"
          echo "- Dependency Scan: ${{ needs.dependency-scan.result }}"
          echo "- Secret Scan: ${{ needs.secret-scan.result }}"

          # In a real implementation, this would send notifications via:
          # - Slack webhook
          # - Email
          # - PagerDuty
          # - Security team dashboard
