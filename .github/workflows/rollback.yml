name: Rollback Procedures

on:
  workflow_dispatch:
    inputs:
      environment:
        description: "Environment to rollback"
        required: true
        default: "staging"
        type: choice
        options:
          - staging
          - production
      rollback_type:
        description: "Type of rollback to perform"
        required: true
        default: "previous"
        type: choice
        options:
          - previous
          - specific_version
          - emergency
      target_version:
        description: "Specific version to rollback to (required if rollback_type is specific_version)"
        required: false
        type: string
      reason:
        description: "Reason for rollback"
        required: true
        type: string
      force_rollback:
        description: "Force rollback even if health checks fail"
        required: false
        default: false
        type: boolean

env:
  AWS_REGION: "us-east-1"
  DOCKER_REGISTRY: "ghcr.io"
  IMAGE_NAME: "kyb-platform"

jobs:
  # Pre-rollback validation
  validate-rollback:
    name: Validate Rollback
    runs-on: ubuntu-latest
    outputs:
      can_rollback: ${{ steps.validate.outputs.can_rollback }}
      rollback_version: ${{ steps.validate.outputs.rollback_version }}
      current_version: ${{ steps.validate.outputs.current_version }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Validate rollback conditions
        id: validate
        run: |
          echo "Validating rollback conditions..."

          ENVIRONMENT="${{ github.event.inputs.environment }}"
          ROLLBACK_TYPE="${{ github.event.inputs.rollback_type }}"
          TARGET_VERSION="${{ github.event.inputs.target_version }}"
          REASON="${{ github.event.inputs.reason }}"

          # Validate environment
          if [ "$ENVIRONMENT" != "staging" ] && [ "$ENVIRONMENT" != "production" ]; then
            echo "‚ùå Invalid environment: $ENVIRONMENT"
            exit 1
          fi

          # Get current version
          CLUSTER_NAME="kyb-platform-$ENVIRONMENT"
          SERVICE_NAME="kyb-platform-api"

          CURRENT_VERSION=$(aws ecs describe-services \
            --cluster "$CLUSTER_NAME" \
            --services "$SERVICE_NAME" \
            --query 'services[0].taskDefinition' \
            --output text | cut -d: -f2)

          echo "current_version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
          echo "Current version: $CURRENT_VERSION"

          # Determine rollback version
          if [ "$ROLLBACK_TYPE" = "specific_version" ]; then
            if [ -z "$TARGET_VERSION" ]; then
              echo "‚ùå Target version required for specific_version rollback"
              exit 1
            fi
            ROLLBACK_VERSION="$TARGET_VERSION"
          elif [ "$ROLLBACK_TYPE" = "previous" ]; then
            # Get previous task definition
            ROLLBACK_VERSION=$(aws ecs describe-task-definition \
              --task-definition "$CURRENT_VERSION" \
              --query 'taskDefinition.revision' \
              --output text)
            ROLLBACK_VERSION=$((ROLLBACK_VERSION - 1))
            ROLLBACK_VERSION="kyb-platform-api:$ROLLBACK_VERSION"
          elif [ "$ROLLBACK_TYPE" = "emergency" ]; then
            # Use a known stable version
            ROLLBACK_VERSION="kyb-platform-api:stable"
          fi

          echo "rollback_version=$ROLLBACK_VERSION" >> $GITHUB_OUTPUT
          echo "Rollback version: $ROLLBACK_VERSION"

          # Validate rollback version exists
          if ! aws ecs describe-task-definition --task-definition "$ROLLBACK_VERSION" > /dev/null 2>&1; then
            echo "‚ùå Rollback version $ROLLBACK_VERSION does not exist"
            exit 1
          fi

          # Check if rollback is needed
          if [ "$CURRENT_VERSION" = "$ROLLBACK_VERSION" ]; then
            echo "‚ùå Current version is already $ROLLBACK_VERSION"
            exit 1
          fi

          echo "can_rollback=true" >> $GITHUB_OUTPUT
          echo "‚úÖ Rollback validation successful"
          echo "Environment: $ENVIRONMENT"
          echo "Current version: $CURRENT_VERSION"
          echo "Rollback version: $ROLLBACK_VERSION"
          echo "Reason: $REASON"

  # Rollback to staging
  rollback-staging:
    name: Rollback Staging
    runs-on: ubuntu-latest
    needs: validate-rollback
    if: |
      needs.validate-rollback.outputs.can_rollback == 'true' && 
      github.event.inputs.environment == 'staging'
    environment: staging
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Perform staging rollback
        run: |
          echo "Performing staging rollback..."

          CLUSTER_NAME="kyb-platform-staging"
          SERVICE_NAME="kyb-platform-api"
          ROLLBACK_VERSION="${{ needs.validate-rollback.outputs.rollback_version }}"

          # Update service with rollback version
          aws ecs update-service \
            --cluster "$CLUSTER_NAME" \
            --service "$SERVICE_NAME" \
            --task-definition "$ROLLBACK_VERSION" \
            --force-new-deployment

          # Wait for rollback to complete
          echo "Waiting for rollback to complete..."
          aws ecs wait services-stable \
            --cluster "$CLUSTER_NAME" \
            --services "$SERVICE_NAME"

          echo "Staging rollback completed"

      - name: Verify staging rollback
        run: |
          echo "Verifying staging rollback..."

          # Wait for service to be ready
          sleep 60

          # Check health
          curl -f http://staging.kybplatform.com/health || {
            echo "‚ùå Health check failed after rollback"
            if [ "${{ github.event.inputs.force_rollback }}" != "true" ]; then
              exit 1
            fi
          }

          # Check version
          VERSION_RESPONSE=$(curl -s http://staging.kybplatform.com/status | jq -r '.version' 2>/dev/null || echo "unknown")
          echo "Current version after rollback: $VERSION_RESPONSE"

          echo "‚úÖ Staging rollback verification successful"

      - name: Notify staging rollback
        uses: actions/github-script@v7
        with:
          script: |
            const status = '${{ job.status }}';
            const environment = 'staging';
            const reason = '${{ github.event.inputs.reason }}';
            const currentVersion = '${{ needs.validate-rollback.outputs.current_version }}';
            const rollbackVersion = '${{ needs.validate-rollback.outputs.rollback_version }}';

            let message = `## üîÑ Staging Rollback\n\n`;
            message += `**Status**: ${status === 'success' ? '‚úÖ Success' : '‚ùå Failed'}\n`;
            message += `**Environment**: ${environment}\n`;
            message += `**Reason**: ${reason}\n`;
            message += `**From Version**: ${currentVersion}\n`;
            message += `**To Version**: ${rollbackVersion}\n`;
            message += `**Triggered by**: ${{ github.actor }}\n`;
            message += `**Time**: ${new Date().toISOString()}\n\n`;
            message += `üîó [View Rollback](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})`;

            console.log(message);

  # Rollback to production
  rollback-production:
    name: Rollback Production
    runs-on: ubuntu-latest
    needs: validate-rollback
    if: |
      needs.validate-rollback.outputs.can_rollback == 'true' && 
      github.event.inputs.environment == 'production'
    environment: production
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Perform production rollback
        run: |
          echo "Performing production rollback..."

          CLUSTER_NAME="kyb-platform-production"
          SERVICE_NAME="kyb-platform-api"
          ROLLBACK_VERSION="${{ needs.validate-rollback.outputs.rollback_version }}"

          # Update service with rollback version
          aws ecs update-service \
            --cluster "$CLUSTER_NAME" \
            --service "$SERVICE_NAME" \
            --task-definition "$ROLLBACK_VERSION" \
            --force-new-deployment

          # Wait for rollback to complete
          echo "Waiting for rollback to complete..."
          aws ecs wait services-stable \
            --cluster "$CLUSTER_NAME" \
            --services "$SERVICE_NAME"

          echo "Production rollback completed"

      - name: Verify production rollback
        run: |
          echo "Verifying production rollback..."

          # Wait for service to be ready
          sleep 120

          # Check health
          curl -f https://api.kybplatform.com/health || {
            echo "‚ùå Health check failed after rollback"
            if [ "${{ github.event.inputs.force_rollback }}" != "true" ]; then
              exit 1
            fi
          }

          # Check status
          curl -f https://api.kybplatform.com/status || {
            echo "‚ùå Status check failed after rollback"
            if [ "${{ github.event.inputs.force_rollback }}" != "true" ]; then
              exit 1
            fi
          }

          # Check version
          VERSION_RESPONSE=$(curl -s https://api.kybplatform.com/status | jq -r '.version' 2>/dev/null || echo "unknown")
          echo "Current version after rollback: $VERSION_RESPONSE"

          echo "‚úÖ Production rollback verification successful"

      - name: Run post-rollback tests
        run: |
          echo "Running post-rollback tests..."

          # Run basic API tests
          curl -f https://api.kybplatform.com/v1/classify \
            -H "Content-Type: application/json" \
            -d '{"business_name": "Test Corp"}' || {
            echo "‚ùå API test failed after rollback"
            if [ "${{ github.event.inputs.force_rollback }}" != "true" ]; then
              exit 1
            fi
          }

          echo "‚úÖ Post-rollback tests passed"

      - name: Create rollback record
        run: |
          echo "Creating rollback record..."

          ROLLBACK_RECORD=$(cat << EOF
          {
            "rollback_id": "${{ github.run_id }}",
            "environment": "production",
            "reason": "${{ github.event.inputs.reason }}",
            "rollback_type": "${{ github.event.inputs.rollback_type }}",
            "from_version": "${{ needs.validate-rollback.outputs.current_version }}",
            "to_version": "${{ needs.validate-rollback.outputs.rollback_version }}",
            "triggered_by": "${{ github.actor }}",
            "timestamp": "$(date -u +'%Y-%m-%dT%H:%M:%SZ')",
            "status": "completed"
          }
          EOF
          )

          echo "$ROLLBACK_RECORD" > rollback-record.json

          # Store rollback record (could be to S3, database, etc.)
          echo "Rollback record created"

      - name: Notify production rollback
        uses: actions/github-script@v7
        with:
          script: |
            const status = '${{ job.status }}';
            const environment = 'production';
            const reason = '${{ github.event.inputs.reason }}';
            const currentVersion = '${{ needs.validate-rollback.outputs.current_version }}';
            const rollbackVersion = '${{ needs.validate-rollback.outputs.rollback_version }}';

            let message = `## üîÑ Production Rollback\n\n`;
            message += `**Status**: ${status === 'success' ? '‚úÖ Success' : '‚ùå Failed'}\n`;
            message += `**Environment**: ${environment}\n`;
            message += `**Reason**: ${reason}\n`;
            message += `**From Version**: ${currentVersion}\n`;
            message += `**To Version**: ${rollbackVersion}\n`;
            message += `**Triggered by**: ${{ github.actor }}\n`;
            message += `**Time**: ${new Date().toISOString()}\n\n`;
            message += `üîó [View Rollback](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})`;

            // Send notification to production team
            console.log(message);

  # Rollback summary
  rollback-summary:
    name: Rollback Summary
    runs-on: ubuntu-latest
    needs: [validate-rollback, rollback-staging, rollback-production]
    if: always()

    steps:
      - name: Generate rollback summary
        run: |
          echo "## üîÑ Rollback Summary" > rollback-summary.md
          echo "**Timestamp**: $(date)" >> rollback-summary.md
          echo "**Environment**: ${{ github.event.inputs.environment }}" >> rollback-summary.md
          echo "**Rollback Type**: ${{ github.event.inputs.rollback_type }}" >> rollback-summary.md
          echo "**Reason**: ${{ github.event.inputs.reason }}" >> rollback-summary.md
          echo "**Triggered by**: ${{ github.actor }}" >> rollback-summary.md
          echo "" >> rollback-summary.md

          echo "### Rollback Details" >> rollback-summary.md
          echo "- **From Version**: ${{ needs.validate-rollback.outputs.current_version }}" >> rollback-summary.md
          echo "- **To Version**: ${{ needs.validate-rollback.outputs.rollback_version }}" >> rollback-summary.md
          echo "" >> rollback-summary.md

          echo "### Rollback Status" >> rollback-summary.md
          if [ "${{ github.event.inputs.environment }}" = "staging" ]; then
            if [ "${{ needs.rollback-staging.result }}" = "success" ]; then
              echo "- **Staging**: ‚úÖ Success" >> rollback-summary.md
            else
              echo "- **Staging**: ‚ùå Failed" >> rollback-summary.md
            fi
          elif [ "${{ github.event.inputs.environment }}" = "production" ]; then
            if [ "${{ needs.rollback-production.result }}" = "success" ]; then
              echo "- **Production**: ‚úÖ Success" >> rollback-summary.md
            else
              echo "- **Production**: ‚ùå Failed" >> rollback-summary.md
            fi
          fi
          echo "" >> rollback-summary.md

          echo "### Next Steps" >> rollback-summary.md
          echo "1. Monitor application health" >> rollback-summary.md
          echo "2. Investigate root cause of issues" >> rollback-summary.md
          echo "3. Plan next deployment with fixes" >> rollback-summary.md
          echo "4. Update rollback procedures if needed" >> rollback-summary.md

      - name: Upload rollback summary
        uses: actions/upload-artifact@v4
        with:
          name: rollback-summary
          path: rollback-summary.md
          retention-days: 30

      - name: Comment rollback summary
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            let comment = '## üîÑ Rollback Summary\n\n';
            comment += `**Environment**: ${{ github.event.inputs.environment }}\n`;
            comment += `**Type**: ${{ github.event.inputs.rollback_type }}\n`;
            comment += `**Reason**: ${{ github.event.inputs.reason }}\n`;
            comment += `**From**: ${{ needs.validate-rollback.outputs.current_version }}\n`;
            comment += `**To**: ${{ needs.validate-rollback.outputs.rollback_version }}\n\n`;

            if (fs.existsSync('rollback-summary.md')) {
              const summary = fs.readFileSync('rollback-summary.md', 'utf8');
              comment += summary;
            }

            comment += `\nüîó [View Rollback](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})`;

            // Create issue for rollback tracking
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `Rollback: ${{ github.event.inputs.environment }} - ${{ github.event.inputs.reason }}`,
              body: comment,
              labels: ['rollback', '${{ github.event.inputs.environment }}']
            });
