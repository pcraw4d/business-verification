name: Visual Regression Tests

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'web/**'
      - 'package.json'
      - 'playwright.config.js'
      - '.github/workflows/visual-regression-tests.yml'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'web/**'
      - 'package.json'
      - 'playwright.config.js'
      - '.github/workflows/visual-regression-tests.yml'

jobs:
  visual-regression-tests:
    timeout-minutes: 60
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        test-type: [baseline, interactive, state-based, cross-browser, responsive]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Fetch full history for better diff analysis
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: 'web/package-lock.json'
    
    - name: Install dependencies
      working-directory: ./web
      run: npm ci
    
    - name: Install Playwright browsers
      working-directory: ./web
      run: npx playwright install --with-deps
    
    - name: Create test results directory
      run: mkdir -p web/test-results
    
    - name: Run visual regression tests
      working-directory: ./web
      run: |
        case "${{ matrix.test-type }}" in
          "baseline")
            npx playwright test tests/visual/baseline-screenshots.spec.js --reporter=html
            ;;
          "interactive")
            npx playwright test tests/visual/interactive-element-tests.spec.js --reporter=html
            ;;
          "state-based")
            npx playwright test tests/visual/state-based-tests.spec.js --reporter=html
            ;;
          "cross-browser")
            npx playwright test tests/visual/cross-browser.spec.js --reporter=html
            ;;
          "responsive")
            npx playwright test tests/visual/responsive-design.spec.js --reporter=html
            ;;
        esac
      env:
        BASE_URL: https://shimmering-comfort-production.up.railway.app
    
    - name: Upload test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: playwright-report-${{ matrix.test-type }}
        path: web/playwright-report/
        retention-days: 30
    
    - name: Upload screenshots
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-screenshots-${{ matrix.test-type }}
        path: web/test-results/
        retention-days: 30
    
    - name: Upload baseline screenshots
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: baseline-screenshots-${{ matrix.test-type }}
        path: web/tests/visual/*.spec.js-snapshots/
        retention-days: 30

  visual-diff-analysis:
    needs: visual-regression-tests
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Download baseline screenshots
      uses: actions/download-artifact@v4
      with:
        name: baseline-screenshots-baseline
        path: web/baseline-screenshots/
    
    - name: Download test screenshots
      uses: actions/download-artifact@v4
      with:
        name: test-screenshots-baseline
        path: web/test-screenshots/
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
    
    - name: Install dependencies
      working-directory: ./web
      run: npm ci
    
    - name: Generate visual diff report
      working-directory: ./web
      run: |
        node -e "
        const fs = require('fs');
        const path = require('path');
        
        // Simple diff analysis
        const baselineDir = './baseline-screenshots';
        const testDir = './test-screenshots';
        
        let diffReport = '# Visual Regression Test Results\n\n';
        diffReport += '## Test Summary\n\n';
        diffReport += '- **Test Type**: Visual Regression Tests\n';
        diffReport += '- **Branch**: ${{ github.head_ref }}\n';
        diffReport += '- **Commit**: ${{ github.sha }}\n\n';
        
        if (fs.existsSync(baselineDir) && fs.existsSync(testDir)) {
          diffReport += '## Screenshot Comparison\n\n';
          diffReport += 'Baseline and test screenshots have been captured and are available for review.\n\n';
          diffReport += '### Available Artifacts:\n';
          diffReport += '- Baseline Screenshots\n';
          diffReport += '- Test Screenshots\n';
          diffReport += '- Playwright Reports\n\n';
          diffReport += 'Please review the artifacts to identify any visual regressions.\n';
        } else {
          diffReport += '## No Screenshots Available\n\n';
          diffReport += 'Screenshots were not captured. Please check the test execution logs.\n';
        }
        
        fs.writeFileSync('./visual-diff-report.md', diffReport);
        "
    
    - name: Comment PR with visual diff report
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const report = fs.readFileSync('./web/visual-diff-report.md', 'utf8');
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: report
          });

  baseline-update:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: 'web/package-lock.json'
    
    - name: Install dependencies
      working-directory: ./web
      run: npm ci
    
    - name: Install Playwright browsers
      working-directory: ./web
      run: npx playwright install --with-deps
    
    - name: Update baseline screenshots
      working-directory: ./web
      run: |
        npx playwright test tests/visual/baseline-screenshots.spec.js --update-snapshots
        npx playwright test tests/visual/interactive-element-tests.spec.js --update-snapshots
        npx playwright test tests/visual/state-based-tests.spec.js --update-snapshots
        npx playwright test tests/visual/cross-browser.spec.js --update-snapshots
        npx playwright test tests/visual/responsive-design.spec.js --update-snapshots
      env:
        BASE_URL: https://shimmering-comfort-production.up.railway.app
    
    - name: Commit updated baselines
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add web/tests/visual/*.spec.js-snapshots/
        git diff --staged --quiet || git commit -m "chore: update visual regression test baselines [skip ci]"
        git push
