name: E2E Tests and Quality Assurance

on:
    push:
        branches: [main, develop]
    pull_request:
        branches: [main, develop]
    schedule:
        # Run tests daily at 2 AM UTC
        - cron: "0 2 * * *"
    workflow_dispatch:
        inputs:
            environment:
                description: "Environment to test against"
                required: true
                default: "staging"
                type: choice
                options:
                    - staging
                    - production
            test_suites:
                description: "Test suites to run"
                required: false
                default: "all"
                type: choice
                options:
                    - all
                    - unit
                    - integration
                    - e2e
                    - performance
                    - security

env:
    GO_VERSION: "1.22"
    NODE_VERSION: "18"

jobs:
    # Job 1: Unit Tests
    unit-tests:
        name: Unit Tests
        runs-on: ubuntu-latest
        if: github.event.inputs.test_suites == 'all' || github.event.inputs.test_suites == 'unit' || github.event_name == 'push' || github.event_name == 'pull_request'

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Set up Go
              uses: actions/setup-go@v4
              with:
                  go-version: ${{ env.GO_VERSION }}

            - name: Cache Go modules
              uses: actions/cache@v3
              with:
                  path: ~/go/pkg/mod
                  key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
                  restore-keys: |
                      ${{ runner.os }}-go-

            - name: Install dependencies
              run: go mod download

            - name: Run unit tests
              run: |
                  go test -v -cover -coverprofile=coverage.out ./...

            - name: Generate coverage report
              run: |
                  go tool cover -html=coverage.out -o coverage.html

            - name: Upload coverage to Codecov
              uses: codecov/codecov-action@v3
              with:
                  file: ./coverage.out
                  flags: unittests
                  name: codecov-umbrella

            - name: Upload test results
              uses: actions/upload-artifact@v3
              if: always()
              with:
                  name: unit-test-results
                  path: |
                      coverage.out
                      coverage.html

    # Job 2: Integration Tests
    integration-tests:
        name: Integration Tests
        runs-on: ubuntu-latest
        if: github.event.inputs.test_suites == 'all' || github.event.inputs.test_suites == 'integration' || github.event_name == 'push' || github.event_name == 'pull_request'

        services:
            postgres:
                image: postgres:15
                env:
                    POSTGRES_PASSWORD: postgres
                    POSTGRES_DB: kyb_test
                options: >-
                    --health-cmd pg_isready
                    --health-interval 10s
                    --health-timeout 5s
                    --health-retries 5
                ports:
                    - 5432:5432

            redis:
                image: redis:7
                options: >-
                    --health-cmd "redis-cli ping"
                    --health-interval 10s
                    --health-timeout 5s
                    --health-retries 5
                ports:
                    - 6379:6379

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Set up Go
              uses: actions/setup-go@v4
              with:
                  go-version: ${{ env.GO_VERSION }}

            - name: Cache Go modules
              uses: actions/cache@v3
              with:
                  path: ~/go/pkg/mod
                  key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
                  restore-keys: |
                      ${{ runner.os }}-go-

            - name: Install dependencies
              run: go mod download

            - name: Wait for services
              run: |
                  sleep 10

            - name: Run integration tests
              env:
                  DATABASE_URL: postgres://postgres:postgres@localhost:5432/kyb_test?sslmode=disable
                  REDIS_URL: redis://localhost:6379
              run: |
                  go test -v -tags=integration ./test/integration/...

            - name: Upload integration test results
              uses: actions/upload-artifact@v3
              if: always()
              with:
                  name: integration-test-results
                  path: |
                      test-reports/

    # Job 3: End-to-End Tests
    e2e-tests:
        name: End-to-End Tests
        runs-on: ubuntu-latest
        if: github.event.inputs.test_suites == 'all' || github.event.inputs.test_suites == 'e2e' || github.event_name == 'push' || github.event_name == 'pull_request'

        strategy:
            matrix:
                environment: [staging, production]

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Set up Go
              uses: actions/setup-go@v4
              with:
                  go-version: ${{ env.GO_VERSION }}

            - name: Cache Go modules
              uses: actions/cache@v3
              with:
                  path: ~/go/pkg/mod
                  key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
                  restore-keys: |
                      ${{ runner.os }}-go-

            - name: Install dependencies
              run: go mod download

            - name: Run E2E tests
              env:
                  TEST_BASE_URL: ${{ matrix.environment == 'staging' && 'https://staging-api.kyb-platform.com' || 'https://kyb-api-gateway-production.up.railway.app' }}
                  TEST_API_GATEWAY_URL: ${{ matrix.environment == 'staging' && 'https://staging-api.kyb-platform.com' || 'https://kyb-api-gateway-production.up.railway.app' }}
                  TEST_CLASSIFICATION_URL: ${{ matrix.environment == 'staging' && 'https://staging-classification.kyb-platform.com' || 'https://kyb-classification-service-production.up.railway.app' }}
                  TEST_MERCHANT_URL: ${{ matrix.environment == 'staging' && 'https://staging-merchant.kyb-platform.com' || 'https://kyb-merchant-service-production.up.railway.app' }}
                  TEST_MONITORING_URL: ${{ matrix.environment == 'staging' && 'https://staging-monitoring.kyb-platform.com' || 'https://kyb-monitoring-production.up.railway.app' }}
                  TEST_PIPELINE_URL: ${{ matrix.environment == 'staging' && 'https://staging-pipeline.kyb-platform.com' || 'https://kyb-pipeline-service-production.up.railway.app' }}
                  TEST_FRONTEND_URL: ${{ matrix.environment == 'staging' && 'https://staging-frontend.kyb-platform.com' || 'https://kyb-frontend-production.up.railway.app' }}
                  TEST_BI_URL: ${{ matrix.environment == 'staging' && 'https://staging-bi.kyb-platform.com' || 'https://kyb-business-intelligence-gateway-production.up.railway.app' }}
                  SEC_TEST_API_KEY: ${{ secrets.TEST_API_KEY }}
                  SEC_ADMIN_API_KEY: ${{ secrets.ADMIN_API_KEY }}
                  SEC_USER_API_KEY: ${{ secrets.USER_API_KEY }}
              run: |
                  go test -v -tags=e2e -timeout=30m ./test/e2e/...

            - name: Upload E2E test results
              uses: actions/upload-artifact@v3
              if: always()
              with:
                  name: e2e-test-results-${{ matrix.environment }}
                  path: |
                      test-reports/

    # Job 4: Performance Tests
    performance-tests:
        name: Performance Tests
        runs-on: ubuntu-latest
        if: github.event.inputs.test_suites == 'all' || github.event.inputs.test_suites == 'performance' || github.event_name == 'schedule'

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Set up Go
              uses: actions/setup-go@v4
              with:
                  go-version: ${{ env.GO_VERSION }}

            - name: Cache Go modules
              uses: actions/cache@v3
              with:
                  path: ~/go/pkg/mod
                  key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
                  restore-keys: |
                      ${{ runner.os }}-go-

            - name: Install dependencies
              run: go mod download

            - name: Run performance tests
              env:
                  PERF_TEST_BASE_URL: https://kyb-api-gateway-production.up.railway.app
                  SEC_TEST_API_KEY: ${{ secrets.TEST_API_KEY }}
              run: |
                  go test -v -tags=performance -bench=. -benchmem -timeout=1h ./test/performance/...

            - name: Upload performance test results
              uses: actions/upload-artifact@v3
              if: always()
              with:
                  name: performance-test-results
                  path: |
                      test-reports/

    # Job 5: Security Tests
    security-tests:
        name: Security Tests
        runs-on: ubuntu-latest
        if: github.event.inputs.test_suites == 'all' || github.event.inputs.test_suites == 'security' || github.event_name == 'push' || github.event_name == 'pull_request'

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Set up Go
              uses: actions/setup-go@v4
              with:
                  go-version: ${{ env.GO_VERSION }}

            - name: Cache Go modules
              uses: actions/cache@v3
              with:
                  path: ~/go/pkg/mod
                  key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
                  restore-keys: |
                      ${{ runner.os }}-go-

            - name: Install dependencies
              run: go mod download

            - name: Run security tests
              env:
                  SEC_TEST_BASE_URL: https://kyb-api-gateway-production.up.railway.app
                  SEC_TEST_API_KEY: ${{ secrets.TEST_API_KEY }}
                  SEC_ADMIN_API_KEY: ${{ secrets.ADMIN_API_KEY }}
                  SEC_USER_API_KEY: ${{ secrets.USER_API_KEY }}
              run: |
                  go test -v -tags=security -timeout=30m ./test/security/...

            - name: Upload security test results
              uses: actions/upload-artifact@v3
              if: always()
              with:
                  name: security-test-results
                  path: |
                      test-reports/

    # Job 6: Load Testing
    load-tests:
        name: Load Tests
        runs-on: ubuntu-latest
        if: github.event_name == 'schedule' || github.event.inputs.test_suites == 'performance'

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Set up Go
              uses: actions/setup-go@v4
              with:
                  go-version: ${{ env.GO_VERSION }}

            - name: Install k6
              run: |
                  sudo apt-key adv --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys C5AD17C747E3415A3642D57D77C6C491D6AC1D69
                  echo "deb https://dl.k6.io/deb stable main" | sudo tee /etc/apt/sources.list.d/k6.list
                  sudo apt-get update
                  sudo apt-get install k6

            - name: Run load tests
              env:
                  K6_BASE_URL: https://kyb-api-gateway-production.up.railway.app
                  K6_API_KEY: ${{ secrets.TEST_API_KEY }}
              run: |
                  k6 run --out json=load-test-results.json test/load/load-test.js

            - name: Upload load test results
              uses: actions/upload-artifact@v3
              if: always()
              with:
                  name: load-test-results
                  path: |
                      load-test-results.json

    # Job 7: Test Report Generation
    test-report:
        name: Generate Test Report
        runs-on: ubuntu-latest
        needs:
            [
                unit-tests,
                integration-tests,
                e2e-tests,
                performance-tests,
                security-tests,
            ]
        if: always()

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Download all artifacts
              uses: actions/download-artifact@v3

            - name: Set up Go
              uses: actions/setup-go@v4
              with:
                  go-version: ${{ env.GO_VERSION }}

            - name: Install dependencies
              run: go mod download

            - name: Generate comprehensive test report
              run: |
                  go run test/automation/test_runner.go -config test/automation/test_runner_config.json

            - name: Upload comprehensive test report
              uses: actions/upload-artifact@v3
              with:
                  name: comprehensive-test-report
                  path: |
                      test-reports/

            - name: Comment PR with test results
              if: github.event_name == 'pull_request'
              uses: actions/github-script@v6
              with:
                  script: |
                      const fs = require('fs');
                      const path = require('path');

                      // Read test results
                      const testResultsPath = path.join('test-reports', 'test-results.json');
                      if (fs.existsSync(testResultsPath)) {
                        const testResults = JSON.parse(fs.readFileSync(testResultsPath, 'utf8'));
                        
                        const comment = `## üß™ Test Results
                        
                        **Environment**: ${testResults.environment}
                        **Duration**: ${testResults.duration}
                        **Total Tests**: ${testResults.total_tests}
                        **Passed**: ${testResults.passed_tests} ‚úÖ
                        **Failed**: ${testResults.failed_tests} ‚ùå
                        **Skipped**: ${testResults.skipped_tests} ‚è≠Ô∏è
                        **Coverage**: ${testResults.coverage.toFixed(2)}%
                        
                        ### Test Suites
                        ${testResults.suites.map(suite => 
                          `- **${suite.name}**: ${suite.status} (${suite.passed_tests}/${suite.total_tests} tests passed)`
                        ).join('\n')}
                        
                        ${testResults.failed_tests > 0 ? '‚ö†Ô∏è Some tests failed. Please review the test results.' : '‚úÖ All tests passed!'}
                        `;
                        
                        github.rest.issues.createComment({
                          issue_number: context.issue.number,
                          owner: context.repo.owner,
                          repo: context.repo.repo,
                          body: comment
                        });
                      }

    # Job 8: Quality Gate
    quality-gate:
        name: Quality Gate
        runs-on: ubuntu-latest
        needs: [unit-tests, integration-tests, e2e-tests, security-tests]
        if: always()

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Download test results
              uses: actions/download-artifact@v3

            - name: Check quality gate
              run: |
                  # Check if all critical tests passed
                  if [ -f "unit-test-results/coverage.out" ]; then
                    coverage=$(go tool cover -func=unit-test-results/coverage.out | grep total | awk '{print $3}' | sed 's/%//')
                    echo "Coverage: $coverage%"
                    
                    if (( $(echo "$coverage < 80" | bc -l) )); then
                      echo "‚ùå Coverage below 80% threshold"
                      exit 1
                    fi
                  fi

                  echo "‚úÖ Quality gate passed"

            - name: Fail if quality gate fails
              if: failure()
              run: |
                  echo "‚ùå Quality gate failed. Please fix the issues before merging."
                  exit 1
