name: E2E Tests and Quality Assurance

on:
  push:
    branches: [main, develop]
    paths:
      - "cmd/frontend-service/static/merchant-details.html"
      - "internal/api/handlers/merchant_analytics_handler.go"
      - "internal/api/handlers/async_risk_assessment_handler.go"
      - "test/e2e/merchant_details_e2e_test.go"
      - "test/e2e/merchant_analytics_api_test.go"
      - "test/integration/risk_assessment_integration_test.go"
      - ".github/workflows/e2e-tests.yml"
  pull_request:
    branches: [main, develop]
    paths:
      - "cmd/frontend-service/static/merchant-details.html"
      - "internal/api/handlers/merchant_analytics_handler.go"
      - "internal/api/handlers/async_risk_assessment_handler.go"
      - "test/e2e/merchant_details_e2e_test.go"
      - "test/e2e/merchant_analytics_api_test.go"
      - "test/integration/risk_assessment_integration_test.go"
      - ".github/workflows/e2e-tests.yml"
  schedule:
    # Run tests daily at 2 AM UTC
    - cron: "0 2 * * *"
  workflow_dispatch:
    inputs:
      environment:
        description: "Environment to test against"
        required: true
        default: "staging"
        type: choice
        options:
          - staging
          - production
      test_suites:
        description: "Test suites to run"
        required: false
        default: "all"
        type: choice
        options:
          - all
          - unit
          - integration
          - e2e
          - performance
          - security

env:
  GO_VERSION: "1.22"
  NODE_VERSION: "18"

jobs:
  # Job 1: Unit Tests
  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    if: github.event.inputs.test_suites == 'all' || github.event.inputs.test_suites == 'unit' || github.event_name == 'push' || github.event_name == 'pull_request'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Cache Go modules
        uses: actions/cache@v3
        with:
          path: ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-

      - name: Install dependencies
        run: go mod download

      - name: Run unit tests
        run: |
          go test -v -cover -coverprofile=coverage.out ./...

      - name: Generate coverage report
        run: |
          go tool cover -html=coverage.out -o coverage.html

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          file: ./coverage.out
          flags: unittests
          name: codecov-umbrella

      - name: Upload test results
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: unit-test-results
          path: |
            coverage.out
            coverage.html

  # Job 2: Integration Tests
  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    if: github.event.inputs.test_suites == 'all' || github.event.inputs.test_suites == 'integration' || github.event_name == 'push' || github.event_name == 'pull_request'

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: kyb_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

      redis:
        image: redis:7
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Cache Go modules
        uses: actions/cache@v3
        with:
          path: ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-

      - name: Install dependencies
        run: go mod download

      - name: Wait for services
        run: |
          sleep 10

      - name: Run integration tests
        env:
          DATABASE_URL: postgres://postgres:postgres@localhost:5432/kyb_test?sslmode=disable
          REDIS_URL: redis://localhost:6379
        run: |
          go test -v -tags=integration ./test/integration/...

      - name: Upload integration test results
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: integration-test-results
          path: |
            test-reports/

  # Job 3: End-to-End Tests
  e2e-tests:
    name: End-to-End Tests
    runs-on: ubuntu-latest
    if: github.event.inputs.test_suites == 'all' || github.event.inputs.test_suites == 'e2e' || github.event_name == 'push' || github.event_name == 'pull_request'

    strategy:
      matrix:
        environment: [staging, production]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Cache Go modules
        uses: actions/cache@v3
        with:
          path: ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-

      - name: Install dependencies
        run: go mod download

      - name: Run E2E tests
        env:
          TEST_BASE_URL: ${{ matrix.environment == 'staging' && 'https://staging-api.kyb-platform.com' || 'https://kyb-api-gateway-production.up.railway.app' }}
          TEST_API_GATEWAY_URL: ${{ matrix.environment == 'staging' && 'https://staging-api.kyb-platform.com' || 'https://kyb-api-gateway-production.up.railway.app' }}
          TEST_CLASSIFICATION_URL: ${{ matrix.environment == 'staging' && 'https://staging-classification.kyb-platform.com' || 'https://kyb-classification-service-production.up.railway.app' }}
          TEST_MERCHANT_URL: ${{ matrix.environment == 'staging' && 'https://staging-merchant.kyb-platform.com' || 'https://kyb-merchant-service-production.up.railway.app' }}
          TEST_MONITORING_URL: ${{ matrix.environment == 'staging' && 'https://staging-monitoring.kyb-platform.com' || 'https://kyb-monitoring-production.up.railway.app' }}
          TEST_PIPELINE_URL: ${{ matrix.environment == 'staging' && 'https://staging-pipeline.kyb-platform.com' || 'https://kyb-pipeline-service-production.up.railway.app' }}
          TEST_FRONTEND_URL: ${{ matrix.environment == 'staging' && 'https://staging-frontend.kyb-platform.com' || 'https://kyb-frontend-production.up.railway.app' }}
          TEST_BI_URL: ${{ matrix.environment == 'staging' && 'https://staging-bi.kyb-platform.com' || 'https://kyb-business-intelligence-gateway-production.up.railway.app' }}
          SEC_TEST_API_KEY: ${{ secrets.TEST_API_KEY }}
          SEC_ADMIN_API_KEY: ${{ secrets.ADMIN_API_KEY }}
          SEC_USER_API_KEY: ${{ secrets.USER_API_KEY }}
          TEST_AUTH_TOKEN: ${{ secrets.TEST_API_KEY }}
        run: |
          go test -v -tags=e2e -timeout=30m ./test/e2e/...

      - name: Install gotestsum for JUnit XML generation
        run: |
          go install gotest.tools/gotestsum@latest || echo "gotestsum installation failed, continuing without it"

      - name: Run merchant-details E2E tests
        env:
          TEST_BASE_URL: ${{ matrix.environment == 'staging' && 'https://staging-api.kyb-platform.com' || 'https://kyb-api-gateway-production.up.railway.app' }}
          TEST_AUTH_TOKEN: ${{ secrets.TEST_API_KEY }}
        run: |
          mkdir -p test-results
          go test -v -tags=e2e -timeout=30m -json ./test/e2e/merchant_details_e2e_test.go ./test/e2e/merchant_analytics_api_test.go | tee test-results/merchant-details-e2e.json
          # Convert JSON test output to JUnit XML if gotestsum is available
          if command -v gotestsum &> /dev/null; then
              gotestsum --junitfile test-results/merchant-details-e2e.xml --raw-command cat test-results/merchant-details-e2e.json || true
          fi

      - name: Run merchant-details integration tests
        env:
          TEST_BASE_URL: ${{ matrix.environment == 'staging' && 'https://staging-api.kyb-platform.com' || 'https://kyb-api-gateway-production.up.railway.app' }}
          TEST_AUTH_TOKEN: ${{ secrets.TEST_API_KEY }}
        run: |
          mkdir -p test-results
          go test -v -tags=integration -timeout=30m -json ./test/integration/risk_assessment_integration_test.go | tee test-results/risk-assessment-integration.json
          # Convert JSON test output to JUnit XML if gotestsum is available
          if command -v gotestsum &> /dev/null; then
              gotestsum --junitfile test-results/risk-assessment-integration.xml --raw-command cat test-results/risk-assessment-integration.json || true
          fi

      - name: Upload E2E test results
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: e2e-test-results-${{ matrix.environment }}
          path: |
            test-reports/

      - name: Upload merchant-details test results
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: merchant-details-test-results-${{ matrix.environment }}
          path: |
            test-reports/
            test-results/
          retention-days: 7

      - name: Publish Test Results
        uses: EnricoMi/publish-unit-test-result-action@v2
        if: always()
        with:
          files: |
            test-results/**/*.xml
          check_name: Merchant Details Tests (${{ matrix.environment }})
          comment_mode: create new
          report_individual_runs: true
          deduplicate_classes_by_file_name: true

  # Job 4: Performance Tests
  performance-tests:
    name: Performance Tests
    runs-on: ubuntu-latest
    if: github.event.inputs.test_suites == 'all' || github.event.inputs.test_suites == 'performance' || github.event_name == 'schedule'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Cache Go modules
        uses: actions/cache@v3
        with:
          path: ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-

      - name: Install dependencies
        run: go mod download

      - name: Run performance tests
        env:
          PERF_TEST_BASE_URL: https://kyb-api-gateway-production.up.railway.app
          SEC_TEST_API_KEY: ${{ secrets.TEST_API_KEY }}
        run: |
          go test -v -tags=performance -bench=. -benchmem -timeout=1h ./test/performance/...

      - name: Upload performance test results
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: performance-test-results
          path: |
            test-reports/

  # Job 5: Security Tests
  security-tests:
    name: Security Tests
    runs-on: ubuntu-latest
    if: github.event.inputs.test_suites == 'all' || github.event.inputs.test_suites == 'security' || github.event_name == 'push' || github.event_name == 'pull_request'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Cache Go modules
        uses: actions/cache@v3
        with:
          path: ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-

      - name: Install dependencies
        run: go mod download

      - name: Run security tests
        env:
          SEC_TEST_BASE_URL: https://kyb-api-gateway-production.up.railway.app
          SEC_TEST_API_KEY: ${{ secrets.TEST_API_KEY }}
          SEC_ADMIN_API_KEY: ${{ secrets.ADMIN_API_KEY }}
          SEC_USER_API_KEY: ${{ secrets.USER_API_KEY }}
        run: |
          go test -v -tags=security -timeout=30m ./test/security/...

      - name: Upload security test results
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: security-test-results
          path: |
            test-reports/

  # Job 6: Load Testing
  load-tests:
    name: Load Tests
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || github.event.inputs.test_suites == 'performance'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Install k6
        run: |
          sudo apt-key adv --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys C5AD17C747E3415A3642D57D77C6C491D6AC1D69
          echo "deb https://dl.k6.io/deb stable main" | sudo tee /etc/apt/sources.list.d/k6.list
          sudo apt-get update
          sudo apt-get install k6

      - name: Run load tests
        env:
          K6_BASE_URL: https://kyb-api-gateway-production.up.railway.app
          K6_API_KEY: ${{ secrets.TEST_API_KEY }}
        run: |
          k6 run --out json=load-test-results.json test/load/load-test.js

      - name: Upload load test results
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: load-test-results
          path: |
            load-test-results.json

  # Job 7: Test Report Generation
  test-report:
    name: Generate Test Report
    runs-on: ubuntu-latest
    needs:
      [
        unit-tests,
        integration-tests,
        e2e-tests,
        performance-tests,
        security-tests,
      ]
    if: always()

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v3

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Install dependencies
        run: go mod download

      - name: Generate comprehensive test report
        run: |
          go run test/automation/test_runner.go -config test/automation/test_runner_config.json

      - name: Upload comprehensive test report
        uses: actions/upload-artifact@v3
        with:
          name: comprehensive-test-report
          path: |
            test-reports/

      - name: Comment PR with test results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            const path = require('path');

            // Read test results
            const testResultsPath = path.join('test-reports', 'test-results.json');
            let comment = '## üß™ Test Results\n\n';
            
            // Initialize testResults with default values to avoid undefined errors
            let testResults = null;

            if (fs.existsSync(testResultsPath)) {
              testResults = JSON.parse(fs.readFileSync(testResultsPath, 'utf8'));
              
              comment += `**Environment**: ${testResults.environment}\n`;
              comment += `**Duration**: ${testResults.duration}\n`;
              comment += `**Total Tests**: ${testResults.total_tests}\n`;
              comment += `**Passed**: ${testResults.passed_tests} ‚úÖ\n`;
              comment += `**Failed**: ${testResults.failed_tests} ‚ùå\n`;
              comment += `**Skipped**: ${testResults.skipped_tests} ‚è≠Ô∏è\n`;
              comment += `**Coverage**: ${testResults.coverage.toFixed(2)}%\n\n`;
              comment += `### Test Suites\n`;
              comment += testResults.suites.map(suite => 
                `- **${suite.name}**: ${suite.status} (${suite.passed_tests}/${suite.total_tests} tests passed)`
              ).join('\n') + '\n\n';
            }

            // Add merchant-details specific test results from all environments
            const environments = ['staging', 'production'];
            let hasMerchantDetailsResults = false;

            for (const env of environments) {
              const merchantDetailsResultsPath = path.join(`merchant-details-test-results-${env}`, 'test-results');
              if (fs.existsSync(merchantDetailsResultsPath)) {
                if (!hasMerchantDetailsResults) {
                  comment += `### üìä Merchant Details Tests\n\n`;
                  hasMerchantDetailsResults = true;
                }
                
                comment += `#### ${env.charAt(0).toUpperCase() + env.slice(1)} Environment\n\n`;
                
                // Check for JUnit XML files
                const files = fs.readdirSync(merchantDetailsResultsPath, { recursive: true });
                const xmlFiles = files.filter(f => f.endsWith('.xml'));
                
                if (xmlFiles.length > 0) {
                  comment += `- Found ${xmlFiles.length} test result file(s)\n`;
                  comment += `- Results published to GitHub Checks\n`;
                }
                
                // Check for JSON test output
                const jsonFiles = files.filter(f => f.endsWith('.json'));
                if (jsonFiles.length > 0) {
                  comment += `- Test output files: ${jsonFiles.join(', ')}\n`;
                }
                
                comment += '\n';
              }
            }

            // Determine test status message
            if (!testResults) {
              // No test results available
              comment += '‚ö†Ô∏è Test results not available. Please check the test execution logs.';
            } else if (testResults.failed_tests > 0) {
              // Tests failed
              comment += '‚ö†Ô∏è Some tests failed. Please review the test results.';
            } else {
              // All tests passed
              comment += '‚úÖ All tests passed!';
            }

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

  # Job 8: Quality Gate
  quality-gate:
    name: Quality Gate
    runs-on: ubuntu-latest
    needs: [unit-tests, integration-tests, e2e-tests, security-tests]
    if: always()

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download test results
        uses: actions/download-artifact@v3

      - name: Check quality gate
        run: |
          # Check if all critical tests passed
          if [ -f "unit-test-results/coverage.out" ]; then
            coverage=$(go tool cover -func=unit-test-results/coverage.out | grep total | awk '{print $3}' | sed 's/%//')
            echo "Coverage: $coverage%"
            
            if (( $(echo "$coverage < 80" | bc -l) )); then
              echo "‚ùå Coverage below 80% threshold"
              exit 1
            fi
          fi

          echo "‚úÖ Quality gate passed"

      - name: Fail if quality gate fails
        if: failure()
        run: |
          echo "‚ùå Quality gate failed. Please fix the issues before merging."
          exit 1
