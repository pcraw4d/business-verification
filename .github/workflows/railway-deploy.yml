name: Railway Auto-Deploy

on:
  push:
    branches: [main]
        paths:
          - 'services/**'
          - 'frontend/**'
          - 'internal/**'
          - 'cmd/business-intelligence-gateway/**'
          - 'python_ml_service/**'
          - '.github/workflows/railway-deploy.yml'
  workflow_dispatch:

env:
  RAILWAY_PROJECT_ID: ${{ secrets.RAILWAY_PROJECT_ID }}
  RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}

jobs:
  detect-changes:
    name: Detect Service Changes
    runs-on: ubuntu-latest
    outputs:
      api-gateway: ${{ steps.changes.outputs.api-gateway }}
      merchant-service: ${{ steps.changes.outputs.merchant-service }}
      risk-assessment-service: ${{ steps.changes.outputs.risk-assessment-service }}
      frontend-service: ${{ steps.changes.outputs.frontend-service }}
      bi-service: ${{ steps.changes.outputs.bi-service }}
      python-ml-service: ${{ steps.changes.outputs.python-ml-service }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Detect changed services
        id: changes
        run: |
          echo "Detecting changed services..."
          
          # Check for API Gateway changes
          if git diff --name-only HEAD~1 HEAD | grep -qE '^(services/api-gateway|internal/api)'; then
            echo "api-gateway=true" >> $GITHUB_OUTPUT
            echo "âœ… API Gateway has changes"
          else
            echo "api-gateway=false" >> $GITHUB_OUTPUT
          fi
          
          # Check for Merchant Service changes
          if git diff --name-only HEAD~1 HEAD | grep -qE '^services/merchant-service'; then
            echo "merchant-service=true" >> $GITHUB_OUTPUT
            echo "âœ… Merchant Service has changes"
          else
            echo "merchant-service=false" >> $GITHUB_OUTPUT
          fi
          
          # Check for Risk Assessment Service changes
          if git diff --name-only HEAD~1 HEAD | grep -qE '^services/risk-assessment-service'; then
            echo "risk-assessment-service=true" >> $GITHUB_OUTPUT
            echo "âœ… Risk Assessment Service has changes"
          else
            echo "risk-assessment-service=false" >> $GITHUB_OUTPUT
          fi
          
          # Check for Frontend Service changes
          if git diff --name-only HEAD~1 HEAD | grep -qE '^(frontend|services/frontend-service)'; then
            echo "frontend-service=true" >> $GITHUB_OUTPUT
            echo "âœ… Frontend Service has changes"
          else
            echo "frontend-service=false" >> $GITHUB_OUTPUT
          fi
          
          # Check for BI Service changes
          if git diff --name-only HEAD~1 HEAD | grep -qE '^cmd/business-intelligence-gateway'; then
            echo "bi-service=true" >> $GITHUB_OUTPUT
            echo "âœ… BI Service has changes"
          else
            echo "bi-service=false" >> $GITHUB_OUTPUT
          fi
          
          # Check for Python ML Service changes
          if git diff --name-only HEAD~1 HEAD | grep -qE '^python_ml_service'; then
            echo "python-ml-service=true" >> $GITHUB_OUTPUT
            echo "âœ… Python ML Service has changes"
          else
            echo "python-ml-service=false" >> $GITHUB_OUTPUT
          fi

  deploy-api-gateway:
    name: Deploy API Gateway
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.api-gateway == 'true'
    environment: production
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Railway CLI
        run: npm install -g @railway/cli

      - name: Setup Railway authentication
        run: |
          mkdir -p ~/.railway
          echo "${{ secrets.RAILWAY_TOKEN }}" > ~/.railway/token
          chmod 600 ~/.railway/token

      - name: Deploy API Gateway Service
        run: |
          cd services/api-gateway
          railway link --service api-gateway-service --non-interactive || true
          railway up --detach
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}

      - name: Verify deployment
        run: |
          sleep 30
          curl -f https://api-gateway-service-production-21fd.up.railway.app/health || exit 1

  deploy-merchant-service:
    name: Deploy Merchant Service
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.merchant-service == 'true'
    environment: production
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Railway CLI
        run: npm install -g @railway/cli

      - name: Setup Railway authentication
        run: |
          mkdir -p ~/.railway
          echo "${{ secrets.RAILWAY_TOKEN }}" > ~/.railway/token
          chmod 600 ~/.railway/token

      - name: Deploy Merchant Service
        run: |
          cd services/merchant-service
          railway link --service merchant-service --non-interactive || true
          railway up --detach
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}

      - name: Verify deployment
        run: |
          sleep 30
          curl -f https://merchant-service-production.up.railway.app/health || exit 1

  deploy-risk-assessment-service:
    name: Deploy Risk Assessment Service
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.risk-assessment-service == 'true'
    environment: production
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Railway CLI
        run: npm install -g @railway/cli

      - name: Setup Railway authentication
        run: |
          mkdir -p ~/.railway
          echo "${{ secrets.RAILWAY_TOKEN }}" > ~/.railway/token
          chmod 600 ~/.railway/token

      - name: Deploy Risk Assessment Service
        run: |
          cd services/risk-assessment-service
          railway link --service risk-assessment-service --non-interactive || true
          railway up --detach
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}

      - name: Verify deployment
        run: |
          sleep 30
          curl -f https://risk-assessment-service-production.up.railway.app/health || exit 1

  deploy-frontend-service:
    name: Deploy Frontend Service
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.frontend-service == 'true'
    environment: production
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Railway CLI
        run: npm install -g @railway/cli

      - name: Setup Railway authentication
        run: |
          mkdir -p ~/.railway
          echo "${{ secrets.RAILWAY_TOKEN }}" > ~/.railway/token
          chmod 600 ~/.railway/token

      - name: Deploy Frontend Service
        run: |
          cd services/frontend-service
          railway link --service frontend-service --non-interactive || true
          railway up --detach
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}

      - name: Verify deployment
        run: |
          sleep 30
          curl -f https://frontend-service-production-b225.up.railway.app/health || exit 1

  deploy-bi-service:
    name: Deploy BI Service
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.bi-service == 'true' || github.event_name == 'workflow_dispatch'
    environment: production
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Railway CLI
        run: npm install -g @railway/cli

      - name: Setup Railway authentication
        run: |
          mkdir -p ~/.railway
          echo "${{ secrets.RAILWAY_TOKEN }}" > ~/.railway/token
          chmod 600 ~/.railway/token

      - name: Deploy BI Service
        run: |
          cd cmd/business-intelligence-gateway
          railway link --service bi-service --non-interactive || true
          railway up --detach
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}

      - name: Verify deployment
        run: |
          sleep 30
          curl -f https://bi-service-production.up.railway.app/health || exit 1

  deploy-python-ml-service:
    name: Deploy Python ML Service
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.python-ml-service == 'true'
    environment: production
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Railway CLI
        run: npm install -g @railway/cli

      - name: Setup Railway authentication
        run: |
          mkdir -p ~/.railway
          echo "${{ secrets.RAILWAY_TOKEN }}" > ~/.railway/token
          chmod 600 ~/.railway/token

      - name: Deploy Python ML Service
        run: |
          cd python_ml_service
          railway link --service python-ml-service --non-interactive || true
          railway up --detach
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}

      - name: Verify deployment
        run: |
          sleep 45
          # Get service URL from Railway
          SERVICE_URL=$(railway status --json 2>/dev/null | jq -r '.service.url // empty' || echo "")
          if [ -n "$SERVICE_URL" ]; then
            echo "ðŸ” Verifying deployment at: $SERVICE_URL"
            curl -f "$SERVICE_URL/health" || exit 1
            echo "âœ… Python ML Service is healthy"
          elif [ -n "${{ secrets.PYTHON_ML_SERVICE_URL }}" ]; then
            echo "ðŸ” Verifying deployment at: ${{ secrets.PYTHON_ML_SERVICE_URL }}"
            curl -f "${{ secrets.PYTHON_ML_SERVICE_URL }}/health" || exit 1
            echo "âœ… Python ML Service is healthy"
          else
            echo "âš ï¸ Service URL not available, skipping health check"
            echo "   Check Railway dashboard for service URL and set PYTHON_ML_SERVICE_URL secret if needed"
          fi

  deployment-summary:
    name: Deployment Summary
    runs-on: ubuntu-latest
    needs: [detect-changes, deploy-api-gateway, deploy-merchant-service, deploy-risk-assessment-service, deploy-frontend-service, deploy-bi-service, deploy-python-ml-service]
    if: always()
    steps:
      - name: Generate summary
        run: |
          echo "## ðŸš€ Railway Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Triggered by**: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Services Deployed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Service | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|--------|" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.detect-changes.outputs.api-gateway }}" = "true" ]; then
            if [ "${{ needs.deploy-api-gateway.result }}" = "success" ]; then
              echo "| API Gateway | âœ… Success |" >> $GITHUB_STEP_SUMMARY
            else
              echo "| API Gateway | âŒ Failed |" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "| API Gateway | â­ï¸ Skipped (no changes) |" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ needs.detect-changes.outputs.merchant-service }}" = "true" ]; then
            if [ "${{ needs.deploy-merchant-service.result }}" = "success" ]; then
              echo "| Merchant Service | âœ… Success |" >> $GITHUB_STEP_SUMMARY
            else
              echo "| Merchant Service | âŒ Failed |" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "| Merchant Service | â­ï¸ Skipped (no changes) |" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ needs.detect-changes.outputs.risk-assessment-service }}" = "true" ]; then
            if [ "${{ needs.deploy-risk-assessment-service.result }}" = "success" ]; then
              echo "| Risk Assessment Service | âœ… Success |" >> $GITHUB_STEP_SUMMARY
            else
              echo "| Risk Assessment Service | âŒ Failed |" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "| Risk Assessment Service | â­ï¸ Skipped (no changes) |" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ needs.detect-changes.outputs.frontend-service }}" = "true" ]; then
            if [ "${{ needs.deploy-frontend-service.result }}" = "success" ]; then
              echo "| Frontend Service | âœ… Success |" >> $GITHUB_STEP_SUMMARY
            else
              echo "| Frontend Service | âŒ Failed |" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "| Frontend Service | â­ï¸ Skipped (no changes) |" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ needs.detect-changes.outputs.bi-service }}" = "true" ]; then
            if [ "${{ needs.deploy-bi-service.result }}" = "success" ]; then
              echo "| BI Service | âœ… Success |" >> $GITHUB_STEP_SUMMARY
            else
              echo "| BI Service | âŒ Failed |" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "| BI Service | â­ï¸ Skipped (no changes) |" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ needs.detect-changes.outputs.python-ml-service }}" = "true" ]; then
            if [ "${{ needs.deploy-python-ml-service.result }}" = "success" ]; then
              echo "| Python ML Service | âœ… Success |" >> $GITHUB_STEP_SUMMARY
            else
              echo "| Python ML Service | âŒ Failed |" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "| Python ML Service | â­ï¸ Skipped (no changes) |" >> $GITHUB_STEP_SUMMARY
          fi

