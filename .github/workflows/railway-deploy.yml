name: Railway Auto-Deploy

on:
  push:
    branches: [main]
    paths:
      - 'services/**'
      - 'frontend/**'
      - 'internal/**'
      - '.github/workflows/railway-deploy.yml'
  workflow_dispatch:

env:
  RAILWAY_PROJECT_ID: ${{ secrets.RAILWAY_PROJECT_ID }}
  RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}

jobs:
  detect-changes:
    name: Detect Service Changes
    runs-on: ubuntu-latest
    outputs:
      api-gateway: ${{ steps.changes.outputs.api-gateway }}
      merchant-service: ${{ steps.changes.outputs.merchant-service }}
      risk-assessment-service: ${{ steps.changes.outputs.risk-assessment-service }}
      frontend-service: ${{ steps.changes.outputs.frontend-service }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Detect changed services
        id: changes
        run: |
          echo "Detecting changed services..."
          
          # Check for API Gateway changes
          if git diff --name-only HEAD~1 HEAD | grep -qE '^(services/api-gateway|internal/api)'; then
            echo "api-gateway=true" >> $GITHUB_OUTPUT
            echo "âœ… API Gateway has changes"
          else
            echo "api-gateway=false" >> $GITHUB_OUTPUT
          fi
          
          # Check for Merchant Service changes
          if git diff --name-only HEAD~1 HEAD | grep -qE '^services/merchant-service'; then
            echo "merchant-service=true" >> $GITHUB_OUTPUT
            echo "âœ… Merchant Service has changes"
          else
            echo "merchant-service=false" >> $GITHUB_OUTPUT
          fi
          
          # Check for Risk Assessment Service changes
          if git diff --name-only HEAD~1 HEAD | grep -qE '^services/risk-assessment-service'; then
            echo "risk-assessment-service=true" >> $GITHUB_OUTPUT
            echo "âœ… Risk Assessment Service has changes"
          else
            echo "risk-assessment-service=false" >> $GITHUB_OUTPUT
          fi
          
          # Check for Frontend Service changes
          if git diff --name-only HEAD~1 HEAD | grep -qE '^(frontend|services/frontend-service)'; then
            echo "frontend-service=true" >> $GITHUB_OUTPUT
            echo "âœ… Frontend Service has changes"
          else
            echo "frontend-service=false" >> $GITHUB_OUTPUT
          fi

  deploy-api-gateway:
    name: Deploy API Gateway
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.api-gateway == 'true'
    environment: production
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Railway CLI
        run: npm install -g @railway/cli

      - name: Setup Railway authentication
        run: |
          mkdir -p ~/.railway
          echo "${{ secrets.RAILWAY_TOKEN }}" > ~/.railway/token

      - name: Deploy API Gateway Service
        run: |
          cd services/api-gateway
          railway link --service api-gateway-service
          railway up --detach
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}

      - name: Verify deployment
        run: |
          sleep 30
          curl -f https://api-gateway-service-production-21fd.up.railway.app/health || exit 1

  deploy-merchant-service:
    name: Deploy Merchant Service
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.merchant-service == 'true'
    environment: production
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Railway CLI
        run: npm install -g @railway/cli

      - name: Setup Railway authentication
        run: |
          mkdir -p ~/.railway
          echo "${{ secrets.RAILWAY_TOKEN }}" > ~/.railway/token

      - name: Deploy Merchant Service
        run: |
          cd services/merchant-service
          railway link --service merchant-service
          railway up --detach
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}

      - name: Verify deployment
        run: |
          sleep 30
          curl -f https://merchant-service-production.up.railway.app/health || exit 1

  deploy-risk-assessment-service:
    name: Deploy Risk Assessment Service
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.risk-assessment-service == 'true'
    environment: production
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Railway CLI
        run: npm install -g @railway/cli

      - name: Setup Railway authentication
        run: |
          mkdir -p ~/.railway
          echo "${{ secrets.RAILWAY_TOKEN }}" > ~/.railway/token

      - name: Deploy Risk Assessment Service
        run: |
          cd services/risk-assessment-service
          railway link --service risk-assessment-service
          railway up --detach
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}

      - name: Verify deployment
        run: |
          sleep 30
          curl -f https://risk-assessment-service-production.up.railway.app/health || exit 1

  deploy-frontend-service:
    name: Deploy Frontend Service
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.frontend-service == 'true'
    environment: production
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Railway CLI
        run: npm install -g @railway/cli

      - name: Setup Railway authentication
        run: |
          mkdir -p ~/.railway
          echo "${{ secrets.RAILWAY_TOKEN }}" > ~/.railway/token

      - name: Deploy Frontend Service
        run: |
          cd services/frontend-service
          railway link --service frontend-service
          railway up --detach
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}

      - name: Verify deployment
        run: |
          sleep 30
          curl -f https://frontend-service-production-b225.up.railway.app/health || exit 1

  deployment-summary:
    name: Deployment Summary
    runs-on: ubuntu-latest
    needs: [detect-changes, deploy-api-gateway, deploy-merchant-service, deploy-risk-assessment-service, deploy-frontend-service]
    if: always()
    steps:
      - name: Generate summary
        run: |
          echo "## ðŸš€ Railway Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Triggered by**: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Services Deployed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Service | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|--------|" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.detect-changes.outputs.api-gateway }}" = "true" ]; then
            if [ "${{ needs.deploy-api-gateway.result }}" = "success" ]; then
              echo "| API Gateway | âœ… Success |" >> $GITHUB_STEP_SUMMARY
            else
              echo "| API Gateway | âŒ Failed |" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "| API Gateway | â­ï¸ Skipped (no changes) |" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ needs.detect-changes.outputs.merchant-service }}" = "true" ]; then
            if [ "${{ needs.deploy-merchant-service.result }}" = "success" ]; then
              echo "| Merchant Service | âœ… Success |" >> $GITHUB_STEP_SUMMARY
            else
              echo "| Merchant Service | âŒ Failed |" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "| Merchant Service | â­ï¸ Skipped (no changes) |" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ needs.detect-changes.outputs.risk-assessment-service }}" = "true" ]; then
            if [ "${{ needs.deploy-risk-assessment-service.result }}" = "success" ]; then
              echo "| Risk Assessment Service | âœ… Success |" >> $GITHUB_STEP_SUMMARY
            else
              echo "| Risk Assessment Service | âŒ Failed |" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "| Risk Assessment Service | â­ï¸ Skipped (no changes) |" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ needs.detect-changes.outputs.frontend-service }}" = "true" ]; then
            if [ "${{ needs.deploy-frontend-service.result }}" = "success" ]; then
              echo "| Frontend Service | âœ… Success |" >> $GITHUB_STEP_SUMMARY
            else
              echo "| Frontend Service | âŒ Failed |" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "| Frontend Service | â­ï¸ Skipped (no changes) |" >> $GITHUB_STEP_SUMMARY
          fi

