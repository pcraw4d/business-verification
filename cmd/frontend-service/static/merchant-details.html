<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://cdn.jsdelivr.net https://cdnjs.cloudflare.com https://d3js.org; style-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net https://cdnjs.cloudflare.com; font-src 'self' https://cdn.jsdelivr.net https://cdnjs.cloudflare.com data:; img-src 'self' data: https:; connect-src 'self' https:;">
    <title>Merchant Details - KYB Platform</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="css/risk-indicators.css">
    <script src="js/api-config.js"></script>
    <script src="js/debug-form-flow.js"></script>
    <script src="components/navigation.js"></script>
    <script src="components/merchant-context.js"></script>
    <script src="components/session-manager.js"></script>
    <script src="components/coming-soon-banner.js"></script>
    <script src="components/mock-data-tooltip.js"></script>
    <!-- Risk Assessment Components -->
    <script src="js/components/risk-websocket-client.js"></script>
    <script src="js/components/risk-tooltip-system.js"></script>
    <script src="js/components/risk-score-panel.js"></script>
    <script src="js/components/risk-drag-drop.js"></script>
    <script src="js/components/data-enrichment.js"></script>
    <script src="js/components/external-data-sources.js"></script>
    <script src="js/components/export-button.js"></script>
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .card-hover {
            transition: all 0.3s ease-in-out;
        }
        .card-hover:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }
        .confidence-bar {
            background: linear-gradient(90deg, #ef4444 0%, #f97316 25%, #eab308 50%, #22c55e 75%, #3b82f6 100%);
        }
        .risk-gauge {
            background: conic-gradient(from 0deg, #ef4444 0deg, #f97316 72deg, #eab308 144deg, #22c55e 216deg, #3b82f6 288deg, #ef4444 360deg);
        }
        .expandable-section {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-in-out;
        }
        .expandable-section.expanded {
            max-height: 1000px;
        }
        .skeleton-loading {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
        }
        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
        .progressive-disclosure {
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.4s ease-in-out;
        }
        .progressive-disclosure.visible {
            opacity: 1;
            transform: translateY(0);
        }
        /* Enhanced Risk Level Styles */
        .risk-indicator {
            position: relative;
            transition: all 0.3s ease-in-out;
        }
        .risk-indicator:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }
        .risk-badge {
            position: relative;
            overflow: hidden;
            border: 2px solid;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        .risk-badge::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: left 0.5s;
        }
        .risk-badge:hover::before {
            left: 100%;
        }
        .risk-low {
            background: linear-gradient(135deg, #10b981, #059669);
            border-color: #047857;
            color: white;
        }
        .risk-medium {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            border-color: #b45309;
            color: white;
        }
        .risk-high {
            background: linear-gradient(135deg, #f97316, #ea580c);
            border-color: #c2410c;
            color: white;
        }
        .risk-critical {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            border-color: #b91c1c;
            color: white;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }
        .risk-trend {
            position: relative;
            display: inline-flex;
            align-items: center;
            padding: 2px 6px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
        }
        .trend-up {
            background: #fef2f2;
            color: #dc2626;
        }
        .trend-down {
            background: #f0fdf4;
            color: #16a34a;
        }
        .trend-stable {
            background: #f8fafc;
            color: #6b7280;
        }
        /* Tab Styles */
        .tab-content {
            display: none !important;
            visibility: hidden !important;
        }
        .tab-content.active {
            display: block !important;
            visibility: visible !important;
        }
        .tab-button {
            background: none;
            border: none;
            padding: 12px 24px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
        }
        .tab-button.active {
            border-bottom-color: #3498db;
            color: #3498db;
            font-weight: 600;
        }
        .tab-button:hover {
            background: rgba(52, 152, 219, 0.1);
        }
        
        /* Responsive Tab Navigation */
        .tab-navigation-container {
            position: relative;
        }
        
        .tab-navigation-wrapper {
            display: flex;
            align-items: center;
            overflow-x: auto;
            overflow-y: hidden;
            scrollbar-width: thin;
            scrollbar-color: #cbd5e0 transparent;
        }
        
        .tab-navigation-wrapper::-webkit-scrollbar {
            height: 6px;
        }
        
        .tab-navigation-wrapper::-webkit-scrollbar-track {
            background: transparent;
        }
        
        .tab-navigation-wrapper::-webkit-scrollbar-thumb {
            background-color: #cbd5e0;
            border-radius: 3px;
        }
        
        .tab-navigation-wrapper::-webkit-scrollbar-thumb:hover {
            background-color: #a0aec0;
        }
        
        /* Desktop: Show all tabs */
        @media (min-width: 1025px) {
            .tab-navigation-wrapper {
                overflow-x: visible;
            }
            
            .tab-more-dropdown {
                display: none !important;
            }
        }
        
        /* Tablet: Show More dropdown for overflow */
        @media (min-width: 768px) and (max-width: 1024px) {
            .tab-navigation-wrapper {
                overflow-x: visible;
            }
            
            .tab-more-dropdown {
                position: relative;
            }
            
            .tab-more-button {
                position: relative;
            }
            
            .tab-more-menu {
                position: absolute;
                top: 100%;
                right: 0;
                background: white;
                border: 1px solid #e5e7eb;
                border-radius: 8px;
                box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
                min-width: 200px;
                z-index: 1000;
                margin-top: 4px;
            }
            
            .tab-more-menu button {
                display: block;
                width: 100%;
                text-align: left;
                padding: 12px 16px;
                border: none;
                background: none;
                color: #374151;
                cursor: pointer;
                transition: background-color 0.2s;
            }
            
            .tab-more-menu button:hover {
                background-color: #f3f4f6;
            }
            
            .tab-more-menu button.active {
                background-color: rgba(52, 152, 219, 0.1);
                color: #3498db;
            }
        }
        
        /* Mobile: Horizontal scroll */
        @media (max-width: 767px) {
            .tab-navigation-wrapper {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                scroll-snap-type: x mandatory;
            }
            
            .tab-button {
                scroll-snap-align: start;
                flex-shrink: 0;
                min-width: fit-content;
                min-height: 44px; /* Minimum touch target size */
                padding: 12px 16px; /* Larger touch targets */
            }
            
            .tab-more-dropdown {
                display: none !important;
            }
            
            /* Show scroll indicators on mobile */
            .tab-navigation-wrapper::after {
                content: '';
                position: absolute;
                right: 0;
                top: 0;
                bottom: 0;
                width: 30px;
                background: linear-gradient(to right, transparent, rgba(255, 255, 255, 0.9));
                pointer-events: none;
            }
            
            /* Mobile card optimizations */
            .card-hover {
                margin-bottom: 1rem;
            }
            
            /* Ensure all buttons meet touch target requirements */
            button, .btn {
                min-height: 44px;
                min-width: 44px;
                touch-action: manipulation;
            }
            
            /* Optimize grid layouts for mobile */
            .grid {
                gap: 1rem;
            }
        }
        
        /* Touch optimization */
        @media (hover: none) and (pointer: coarse) {
            /* Mobile/touch device optimizations */
            .card-hover:hover {
                transform: none; /* Disable hover effects on touch devices */
            }
            
            button, .btn, .tab-button {
                -webkit-tap-highlight-color: rgba(52, 152, 219, 0.2);
            }
        }
        
        /* Fixed Footer Styles */
        .fixed-footer {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(10px);
            border-top: 1px solid #e5e7eb;
            box-shadow: 0 -4px 6px -1px rgba(0, 0, 0, 0.1), 0 -2px 4px -1px rgba(0, 0, 0, 0.06);
            z-index: 999;
            padding: 0;
        }
        
        .fixed-footer-content {
            max-width: 1280px;
            margin: 0 auto;
            padding: 16px 24px;
        }
        
        .fixed-footer-actions {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }
        
        .fixed-footer-btn {
            display: inline-flex;
            align-items: center;
            padding: 10px 20px;
            font-size: 14px;
            font-weight: 500;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            transition: all 0.2s ease;
            min-height: 44px;
            min-width: 120px;
        }
        
        .fixed-footer-btn:focus {
            outline: 2px solid #3498db;
            outline-offset: 2px;
        }
        
        .fixed-footer-btn-secondary {
            background: #f3f4f6;
            color: #374151;
            border: 1px solid #d1d5db;
        }
        
        .fixed-footer-btn-secondary:hover:not(:disabled) {
            background: #e5e7eb;
            color: #1f2937;
        }
        
        .fixed-footer-btn-primary {
            background: #dc2626;
            color: white;
        }
        
        .fixed-footer-btn-primary:hover:not(:disabled) {
            background: #b91c1c;
        }
        
        .fixed-footer-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        /* Adjust main content padding to account for fixed footer */
        .main-content {
            padding-bottom: 80px;
        }
        
        /* Ensure footer stays above content but below modals */
        .fixed-footer {
            z-index: 999;
        }
        
        /* Button Styles */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 8px 16px;
            font-size: 14px;
            font-weight: 500;
            border-radius: 6px;
            border: 1px solid transparent;
            cursor: pointer;
            transition: all 0.2s ease;
            text-decoration: none;
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .btn-sm {
            padding: 6px 12px;
            font-size: 12px;
        }
        
        .btn-outline {
            background: transparent;
            border-color: #d1d5db;
            color: #374151;
        }
        
        .btn-outline:hover:not(:disabled) {
            background: #f3f4f6;
            border-color: #9ca3af;
        }
        
        .btn-primary {
            background: #3498db;
            color: white;
            border-color: #3498db;
        }
        
        .btn-primary:hover:not(:disabled) {
            background: #2980b9;
            border-color: #2980b9;
        }
        
        /* Mobile responsive footer */
        @media (max-width: 768px) {
            .fixed-footer-content {
                padding: 12px 16px;
            }
            
            .fixed-footer-actions {
                flex-direction: column;
                width: 100%;
                gap: 8px;
            }
            
            .fixed-footer-btn {
                width: 100%;
                justify-content: center;
                min-height: 48px; /* Larger touch targets on mobile */
                font-size: 16px; /* Prevent zoom on iOS */
            }
        }
        
        /* Mobile optimizations for cards */
        @media (max-width: 640px) {
            .grid.grid-cols-1.md\:grid-cols-2 {
                grid-template-columns: 1fr;
            }
            
            /* Ensure cards are full width on mobile */
            .bg-white.rounded-lg.shadow-lg {
                margin-bottom: 1rem;
            }
            
            /* Optimize spacing */
            .space-y-3 > * + * {
                margin-top: 0.75rem;
            }
        }
        
        /* Accessibility: Skip Navigation Link */
        .skip-navigation-link {
            position: absolute;
            top: -40px;
            left: 0;
            background: #000;
            color: #fff;
            padding: 8px 16px;
            text-decoration: none;
            z-index: 10000;
            border-radius: 4px;
        }
        
        .skip-navigation-link:focus {
            top: 0;
        }
        
        /* Accessibility: Focus Indicators */
        *:focus {
            outline: 2px solid #3498db;
            outline-offset: 2px;
        }
        
        button:focus,
        a:focus,
        input:focus,
        select:focus,
        textarea:focus {
            outline: 2px solid #3498db;
            outline-offset: 2px;
        }
        
        /* Accessibility: Screen Reader Only */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border-width: 0;
        }
        
        /* Risk Assessment Styles from merchant-detail.html */
        .risk-overview {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .risk-score-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
        }

        .risk-score-value {
            font-size: 3rem;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .risk-score-label {
            font-size: 1.1rem;
            opacity: 0.9;
            margin-bottom: 15px;
        }

        .risk-score-trend {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-size: 0.9rem;
        }

        .risk-categories {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .risk-category {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .category-name {
            font-weight: 600;
            color: #2c3e50;
        }

        .category-score {
            padding: 6px 12px;
            border-radius: 20px;
            font-weight: 700;
            font-size: 0.9rem;
        }

        .category-score.low {
            background: #d4edda;
            color: #155724;
        }

        .category-score.medium {
            background: #fff3cd;
            color: #856404;
        }

        .category-score.high {
            background: #f8d7da;
            color: #721c24;
        }

        .risk-charts {
            margin-top: 30px;
        }

        .chart-container {
            background: rgba(255, 255, 255, 0.9);
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .chart-container h4 {
            margin-bottom: 15px;
            color: #2c3e50;
            font-weight: 600;
        }

        .status-badge {
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-badge.verified {
            background: #d4edda;
            color: #155724;
        }
        
        /* Activity List Styles */
        .activity-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .activity-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
            border-left: 4px solid #3498db;
        }

        .activity-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #e3f2fd;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #1976d2;
            flex-shrink: 0;
        }

        .activity-content {
            flex: 1;
        }

        .activity-title {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 4px;
        }

        .activity-description {
            font-size: 0.9rem;
            color: #7f8c8d;
            margin-bottom: 4px;
        }

        .activity-date {
            font-size: 0.8rem;
            color: #95a5a6;
        }

        .activity-amount {
            font-weight: 600;
            color: #27ae60;
        }
        
        /* Info Grid Styles */
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }

        .info-item {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .info-label {
            font-size: 0.9rem;
            color: #7f8c8d;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .info-value {
            font-size: 1rem;
            color: #2c3e50;
            font-weight: 500;
        }
        
        /* Mobile Responsive Styles */
        @media (max-width: 768px) {
            .risk-overview {
                grid-template-columns: 1fr;
                gap: 20px;
            }

            .risk-score-card {
                padding: 20px;
            }

            .risk-score-value {
                font-size: 2.5rem;
            }
            
            .tab-button {
                padding: 8px 12px;
                font-size: 0.8rem;
            }
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Navigation -->
    <nav class="bg-white shadow-lg sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <h1 class="text-xl font-bold text-gray-900" id="merchantNameText">Loading...</h1>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <span class="bg-green-100 text-green-800 text-xs font-medium px-2.5 py-0.5 rounded">ENHANCED</span>
                    <span class="bg-blue-100 text-blue-800 text-xs font-medium px-2.5 py-0.5 rounded">LIVE</span>
                    <button id="helpBtn" class="text-gray-600 hover:text-gray-900">
                        <i class="fas fa-question-circle"></i>
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Skip Navigation Link for Accessibility -->
    <a href="#main-content" class="skip-navigation-link" aria-label="Skip to main content">Skip to main content</a>
    
    <!-- Main Content -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8" id="main-content" role="main">
        <!-- Tab Navigation -->
        <div class="bg-white rounded-lg shadow-lg mb-8">
            <div class="border-b border-gray-200">
                <nav class="tab-navigation-container" aria-label="Tabs" role="tablist">
                    <div class="tab-navigation-wrapper">
                        <button class="tab-button active whitespace-nowrap py-2 px-1 border-b-2 border-blue-500 font-medium text-sm text-blue-600" data-tab="overview" role="tab" aria-selected="true" aria-controls="overview" id="tab-overview">
                            <i class="fas fa-info-circle mr-2"></i>
                            Overview
                        </button>
                        <button class="tab-button whitespace-nowrap py-2 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300" data-tab="business-analytics" role="tab" aria-selected="false" aria-controls="business-analytics" id="tab-business-analytics">
                            <i class="fas fa-chart-line mr-2"></i>
                            Business Analytics
                        </button>
                        <button class="tab-button whitespace-nowrap py-2 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300" data-tab="risk-assessment" role="tab" aria-selected="false" aria-controls="risk-assessment" id="tab-risk-assessment">
                            <i class="fas fa-exclamation-triangle mr-2"></i>
                            Risk Assessment
                        </button>
                        <button class="tab-button whitespace-nowrap py-2 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300" data-tab="risk-indicators" role="tab" aria-selected="false" aria-controls="risk-indicators" id="tab-risk-indicators">
                            <i class="fas fa-gauge-high mr-2"></i>
                            Risk Indicators
                        </button>
                        <!-- More dropdown for tablet view -->
                        <div class="tab-more-dropdown" id="tabMoreDropdown" style="display: none;">
                            <button class="tab-button tab-more-button whitespace-nowrap py-2 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300" id="tabMoreButton" aria-haspopup="true" aria-expanded="false">
                                More
                                <i class="fas fa-chevron-down ml-2"></i>
                            </button>
                            <div class="tab-more-menu" id="tabMoreMenu" role="menu" aria-labelledby="tabMoreButton" style="display: none;">
                                <!-- Overflow tabs will be moved here dynamically -->
                            </div>
                        </div>
                    </div>
                </nav>
            </div>
        </div>

        <!-- Tab Content -->
        <!-- Overview Tab (formerly Merchant Details) -->
        <div class="tab-content active" id="overview" role="tabpanel" aria-labelledby="tab-overview">
            <!-- Card Grid Layout -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                <!-- Overview Card -->
                <div class="bg-white rounded-lg shadow-lg p-6 card-hover" id="overviewCard" role="region" aria-labelledby="overviewCardTitle">
                    <div class="flex items-center mb-4">
                        <div class="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center mr-3" aria-hidden="true">
                            <i class="fas fa-info-circle text-blue-600"></i>
                        </div>
                        <h3 class="text-lg font-semibold text-gray-900" id="overviewCardTitle">Overview</h3>
                    </div>
                    <div class="space-y-3" id="overviewCardContent">
                        <div class="loading-state" id="overviewCardLoading">
                            <div class="animate-pulse space-y-2">
                                <div class="h-4 bg-gray-200 rounded w-3/4"></div>
                                <div class="h-4 bg-gray-200 rounded w-1/2"></div>
                                <div class="h-4 bg-gray-200 rounded w-2/3"></div>
                            </div>
                        </div>
                        <div class="error-state hidden" id="overviewCardError">
                            <p class="text-sm text-red-600">Failed to load overview data</p>
                        </div>
                        <div class="content-state hidden" id="overviewCardData">
                            <div>
                                <label class="block text-xs font-medium text-gray-500 uppercase tracking-wide">Business ID</label>
                                <p class="mt-1 text-sm text-gray-900 font-medium" id="overviewBusinessId">-</p>
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-500 uppercase tracking-wide mt-3">Industry</label>
                                <p class="mt-1 text-sm text-gray-900" id="overviewIndustry">-</p>
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-500 uppercase tracking-wide mt-3">Status</label>
                                <p class="mt-1 text-sm text-gray-900">
                                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800" id="overviewStatus">Active</span>
                                </p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Contact Card -->
                <div class="bg-white rounded-lg shadow-lg p-6 card-hover" id="contactCard" role="region" aria-labelledby="contactCardTitle">
                    <div class="flex items-center mb-4">
                        <div class="w-10 h-10 bg-green-100 rounded-full flex items-center justify-center mr-3" aria-hidden="true">
                            <i class="fas fa-address-book text-green-600"></i>
                        </div>
                        <h3 class="text-lg font-semibold text-gray-900" id="contactCardTitle">Contact</h3>
                    </div>
                    <div class="space-y-3" id="contactCardContent">
                        <div class="loading-state" id="contactCardLoading">
                            <div class="animate-pulse space-y-2">
                                <div class="h-4 bg-gray-200 rounded w-3/4"></div>
                                <div class="h-4 bg-gray-200 rounded w-1/2"></div>
                                <div class="h-4 bg-gray-200 rounded w-2/3"></div>
                            </div>
                        </div>
                        <div class="error-state hidden" id="contactCardError">
                            <p class="text-sm text-red-600">Failed to load contact data</p>
                        </div>
                        <div class="content-state hidden" id="contactCardData">
                            <div>
                                <label class="block text-xs font-medium text-gray-500 uppercase tracking-wide">Address</label>
                                <p class="mt-1 text-sm text-gray-900" id="contactAddress">-</p>
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-500 uppercase tracking-wide mt-3">Phone</label>
                                <p class="mt-1 text-sm text-gray-900" id="contactPhone">-</p>
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-500 uppercase tracking-wide mt-3">Email</label>
                                <p class="mt-1 text-sm text-gray-900" id="contactEmail">-</p>
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-500 uppercase tracking-wide mt-3">Website</label>
                                <p class="mt-1 text-sm text-gray-900" id="contactWebsite">-</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Financial Card -->
                <div class="bg-white rounded-lg shadow-lg p-6 card-hover" id="financialCard" role="region" aria-labelledby="financialCardTitle">
                    <div class="flex items-center mb-4">
                        <div class="w-10 h-10 bg-yellow-100 rounded-full flex items-center justify-center mr-3" aria-hidden="true">
                            <i class="fas fa-chart-line text-yellow-600"></i>
                        </div>
                        <h3 class="text-lg font-semibold text-gray-900" id="financialCardTitle">Financial</h3>
                    </div>
                    <div class="space-y-3" id="financialCardContent">
                        <div class="loading-state" id="financialCardLoading">
                            <div class="animate-pulse space-y-2">
                                <div class="h-4 bg-gray-200 rounded w-3/4"></div>
                                <div class="h-4 bg-gray-200 rounded w-1/2"></div>
                                <div class="h-4 bg-gray-200 rounded w-2/3"></div>
                            </div>
                        </div>
                        <div class="error-state hidden" id="financialCardError">
                            <p class="text-sm text-red-600">Failed to load financial data</p>
                        </div>
                        <div class="content-state hidden" id="financialCardData">
                            <div>
                                <label class="block text-xs font-medium text-gray-500 uppercase tracking-wide">Annual Revenue</label>
                                <p class="mt-1 text-sm text-gray-900" id="financialRevenue">-</p>
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-500 uppercase tracking-wide mt-3">Employee Count</label>
                                <p class="mt-1 text-sm text-gray-900" id="financialEmployees">-</p>
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-500 uppercase tracking-wide mt-3">Founded Year</label>
                                <p class="mt-1 text-sm text-gray-900" id="financialFounded">-</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Compliance Card -->
                <div class="bg-white rounded-lg shadow-lg p-6 card-hover" id="complianceCard" role="region" aria-labelledby="complianceCardTitle">
                    <div class="flex items-center mb-4">
                        <div class="w-10 h-10 bg-purple-100 rounded-full flex items-center justify-center mr-3" aria-hidden="true">
                            <i class="fas fa-clipboard-check text-purple-600"></i>
                        </div>
                        <h3 class="text-lg font-semibold text-gray-900" id="complianceCardTitle">Compliance</h3>
                    </div>
                    <div class="space-y-3" id="complianceCardContent">
                        <div class="loading-state" id="complianceCardLoading">
                            <div class="animate-pulse space-y-2">
                                <div class="h-4 bg-gray-200 rounded w-3/4"></div>
                                <div class="h-4 bg-gray-200 rounded w-1/2"></div>
                                <div class="h-4 bg-gray-200 rounded w-2/3"></div>
                            </div>
                        </div>
                        <div class="error-state hidden" id="complianceCardError">
                            <p class="text-sm text-red-600">Failed to load compliance data</p>
                        </div>
                        <div class="content-state hidden" id="complianceCardData">
                            <div>
                                <label class="block text-xs font-medium text-gray-500 uppercase tracking-wide">KYB Status</label>
                                <p class="mt-1 text-sm text-gray-900">
                                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800" id="complianceStatus">Verified</span>
                                </p>
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-500 uppercase tracking-wide mt-3">Last Verification</label>
                                <p class="mt-1 text-sm text-gray-900" id="complianceLastVerification">-</p>
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-500 uppercase tracking-wide mt-3">Compliance Score</label>
                                <p class="mt-1 text-sm text-gray-900" id="complianceScore">-</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Business Analytics Tab -->
        <div class="tab-content" id="business-analytics">
            <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-2xl font-bold text-gray-900">Business Analytics</h2>
                    <div id="businessAnalyticsExportButtonContainer" style="display: inline-block;"></div>
                </div>
            </div>
            
            <!-- Data Enrichment Card -->
            <div class="bg-white rounded-lg shadow-lg p-6 mb-6" id="dataEnrichmentCard" role="region" aria-labelledby="dataEnrichmentTitle">
                <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center">
                        <div class="w-10 h-10 bg-indigo-100 rounded-full flex items-center justify-center mr-3" aria-hidden="true">
                            <i class="fas fa-database text-indigo-600"></i>
                        </div>
                        <h3 class="text-lg font-semibold text-gray-900" id="dataEnrichmentTitle">Data Enrichment</h3>
                    </div>
                </div>
                <div id="dataEnrichmentContainer">
                    <div class="loading-state" id="dataEnrichmentLoading">
                        <div class="animate-pulse space-y-2">
                            <div class="h-4 bg-gray-200 rounded w-3/4"></div>
                            <div class="h-4 bg-gray-200 rounded w-1/2"></div>
                        </div>
                    </div>
                    <div class="error-state hidden" id="dataEnrichmentError">
                        <p class="text-sm text-red-600">Failed to load enrichment sources</p>
                    </div>
                    <div class="content-state hidden" id="dataEnrichmentContent">
                        <p class="text-sm text-gray-600 mb-4">Enrich merchant data from external sources to get additional insights.</p>
                        <div id="enrichmentSourcesList" class="mb-4">
                            <!-- Enrichment sources will be populated here -->
                        </div>
                        <button class="btn btn-primary btn-sm" id="triggerEnrichmentBtn" disabled aria-label="Trigger data enrichment from available sources">
                            <i class="fas fa-sync mr-2" aria-hidden="true"></i>
                            Enrich Data
                        </button>
                        <div id="enrichmentResults" class="mt-4 hidden">
                            <!-- Enrichment results will be displayed here -->
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- External Data Sources Card -->
            <div class="bg-white rounded-lg shadow-lg p-6 mb-6" id="externalDataSourcesCard" role="region" aria-labelledby="externalDataSourcesTitle">
                <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center">
                        <div class="w-10 h-10 bg-teal-100 rounded-full flex items-center justify-center mr-3" aria-hidden="true">
                            <i class="fas fa-external-link-alt text-teal-600"></i>
                        </div>
                        <h3 class="text-lg font-semibold text-gray-900" id="externalDataSourcesTitle">External Data Sources</h3>
                    </div>
                </div>
                <div id="externalDataSourcesContainer">
                    <div class="loading-state" id="externalDataSourcesLoading">
                        <div class="animate-pulse space-y-2">
                            <div class="h-4 bg-gray-200 rounded w-3/4"></div>
                            <div class="h-4 bg-gray-200 rounded w-1/2"></div>
                        </div>
                    </div>
                    <div class="error-state hidden" id="externalDataSourcesError">
                        <p class="text-sm text-red-600">Failed to load external data sources</p>
                    </div>
                    <div class="content-state hidden" id="externalDataSourcesContent">
                        <!-- External data sources will be populated here by component -->
                    </div>
                </div>
            </div>
            
            <div id="dashboardResults" class="space-y-8">
                <!-- Core Classification Results -->
                <div id="coreResults" class="progressive-disclosure">
                    <div class="bg-white rounded-lg shadow-lg p-6">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-xl font-bold text-gray-900">Core Classification Results</h3>
                            <button class="text-blue-600 hover:text-blue-800 text-sm font-medium" onclick="toggleSection('coreDetails')">
                                <i class="fas fa-chevron-down mr-1"></i>
                                Show Details
                            </button>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <!-- Primary Industry -->
                            <div class="text-center">
                                <div class="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-3">
                                    <i class="fas fa-industry text-blue-600 text-xl"></i>
                                </div>
                                <h4 class="font-medium text-gray-900" id="primaryIndustry">Technology</h4>
                                <p class="text-sm text-gray-500" id="industryCode">541511</p>
                            </div>
                            
                            <!-- Confidence Score -->
                            <div class="text-center">
                                <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-3">
                                    <i class="fas fa-chart-line text-green-600 text-xl"></i>
                                </div>
                                <h4 class="font-medium text-gray-900">Confidence</h4>
                                <p class="text-sm text-gray-500" id="confidenceScore">85%</p>
                            </div>
                            
                            <!-- Risk Level -->
                            <div class="text-center">
                                <div class="w-16 h-16 bg-yellow-100 rounded-full flex items-center justify-center mx-auto mb-3">
                                    <i class="fas fa-shield-alt text-yellow-600 text-xl"></i>
                                </div>
                                <h4 class="font-medium text-gray-900">Risk Level</h4>
                                <p class="text-sm text-gray-500" id="riskLevel">Low</p>
                            </div>
                        </div>
                        
                        <!-- Expandable Details -->
                        <div id="coreDetails" class="expandable-section mt-6">
                            <div class="border-t pt-6">
                                <!-- Enhanced Classification Results -->
                                <div id="enhancedClassificationResults" class="mb-6">
                                    <!-- Top 3 Results for Each Code Type -->
                                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
                                        <!-- MCC Codes -->
                                        <div id="mccCodesCard" class="bg-gray-50 rounded-lg p-4">
                                            <div class="flex items-center mb-3">
                                                <div class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center mr-3">
                                                    <span class="text-blue-600 font-bold text-sm">M</span>
                                                </div>
                                                <h6 class="font-medium text-gray-900">MCC Codes</h6>
                                            </div>
                                            <div id="mccCodesList" class="space-y-3">
                                                <!-- Populated by JavaScript -->
                                            </div>
                                        </div>
                                        
                                        <!-- SIC Codes -->
                                        <div id="sicCodesCard" class="bg-gray-50 rounded-lg p-4">
                                            <div class="flex items-center mb-3">
                                                <div class="w-8 h-8 bg-red-100 rounded-full flex items-center justify-center mr-3">
                                                    <span class="text-red-600 font-bold text-sm">S</span>
                                                </div>
                                                <h6 class="font-medium text-gray-900">SIC Codes</h6>
                                            </div>
                                            <div id="sicCodesList" class="space-y-3">
                                                <!-- Populated by JavaScript -->
                                            </div>
                                        </div>
                                        
                                        <!-- NAICS Codes -->
                                        <div id="naicsCodesCard" class="bg-gray-50 rounded-lg p-4">
                                            <div class="flex items-center mb-3">
                                                <div class="w-8 h-8 bg-green-100 rounded-full flex items-center justify-center mr-3">
                                                    <span class="text-green-600 font-bold text-sm">N</span>
                                                </div>
                                                <h6 class="font-medium text-gray-900">NAICS Codes</h6>
                                            </div>
                                            <div id="naicsCodesList" class="space-y-3">
                                                <!-- Populated by JavaScript -->
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Method Breakdown -->
                                    <div id="methodBreakdownSection" class="mb-6">
                                        <h5 class="font-medium text-gray-900 mb-3">Classification Methods Used</h5>
                                        <div id="methodBreakdown" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                            <!-- Populated by JavaScript -->
                                        </div>
                                    </div>
                                    
                                    <!-- Website Keywords -->
                                    <div id="websiteKeywordsSection" class="mb-6">
                                        <div class="flex items-center justify-between mb-3">
                                            <h5 class="font-medium text-gray-900">Website Keywords Used</h5>
                                            <button id="toggleKeywordsBtn" class="text-blue-600 hover:text-blue-800 text-sm font-medium flex items-center">
                                                <span id="toggleKeywordsText">Show Keywords</span>
                                                <svg id="toggleKeywordsIcon" class="w-4 h-4 ml-1 transform transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                                </svg>
                                            </button>
                                        </div>
                                        <div id="websiteKeywords" class="flex flex-wrap gap-2" style="display: none;">
                                            <!-- Populated by JavaScript -->
                                        </div>
                                    </div>
                                    
                                    <!-- Classification Reasoning -->
                                    <div id="classificationReasoningSection" class="mb-6">
                                        <h5 class="font-medium text-gray-900 mb-3">Classification Reasoning</h5>
                                        <div id="classificationReasoning" class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                                            <!-- Populated by JavaScript -->
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Security Indicators Section -->
                <div id="securityIndicators" class="progressive-disclosure">
                    <div class="bg-white rounded-lg shadow-lg p-6">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-xl font-bold text-gray-900">Security & Trust Indicators</h3>
                            <button class="text-blue-600 hover:text-blue-800 text-sm font-medium" onclick="toggleSection('securityDetails')">
                                <i class="fas fa-chevron-down mr-1"></i>
                                Show Details
                            </button>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                            <!-- Data Source Trust -->
                            <div class="text-center">
                                <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-3">
                                    <i class="fas fa-shield-check text-green-600 text-xl"></i>
                                </div>
                                <h4 class="font-medium text-gray-900">Data Source</h4>
                                <p class="text-sm text-gray-500" id="dataSourceTrust">Trusted</p>
                            </div>
                            
                            <!-- Website Verification -->
                            <div class="text-center">
                                <div class="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-3">
                                    <i class="fas fa-globe text-blue-600 text-xl"></i>
                                </div>
                                <h4 class="font-medium text-gray-900">Website</h4>
                                <p class="text-sm text-gray-500" id="websiteVerification">Verified</p>
                            </div>
                            
                            <!-- Security Validation -->
                            <div class="text-center">
                                <div class="w-16 h-16 bg-purple-100 rounded-full flex items-center justify-center mx-auto mb-3">
                                    <i class="fas fa-lock text-purple-600 text-xl"></i>
                                </div>
                                <h4 class="font-medium text-gray-900">Security</h4>
                                <p class="text-sm text-gray-500" id="securityValidation">Validated</p>
                            </div>
                            
                            <!-- Trust Score -->
                            <div class="text-center">
                                <div class="w-16 h-16 bg-yellow-100 rounded-full flex items-center justify-center mx-auto mb-3">
                                    <i class="fas fa-star text-yellow-600 text-xl"></i>
                                </div>
                                <h4 class="font-medium text-gray-900">Trust Score</h4>
                                <p class="text-sm text-gray-500" id="trustScore">95%</p>
                            </div>
                        </div>
                        
                        <!-- Expandable Security Details -->
                        <div id="securityDetails" class="expandable-section mt-6">
                            <div class="border-t pt-6">
                                <div id="securityDetailsContent">
                                    <!-- Populated by JavaScript -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Quality Metrics Section -->
                <div id="qualityMetrics" class="progressive-disclosure">
                    <div class="bg-white rounded-lg shadow-lg p-6">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-xl font-bold text-gray-900">Data Quality Metrics</h3>
                            <button class="text-blue-600 hover:text-blue-800 text-sm font-medium" onclick="toggleSection('qualityDetails')">
                                <i class="fas fa-chevron-down mr-1"></i>
                                Show Details
                            </button>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-5 gap-6">
                            <!-- Overall Quality -->
                            <div class="text-center">
                                <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-3">
                                    <i class="fas fa-award text-green-600 text-xl"></i>
                                </div>
                                <h4 class="font-medium text-gray-900">Overall Quality</h4>
                                <p class="text-sm text-gray-500" id="overallQuality">A</p>
                            </div>
                            
                            <!-- Evidence Strength -->
                            <div class="text-center">
                                <div class="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-3">
                                    <i class="fas fa-chart-bar text-blue-600 text-xl"></i>
                                </div>
                                <h4 class="font-medium text-gray-900">Evidence</h4>
                                <p class="text-sm text-gray-500" id="evidenceStrength">Strong</p>
                            </div>
                            
                            <!-- Data Completeness -->
                            <div class="text-center">
                                <div class="w-16 h-16 bg-purple-100 rounded-full flex items-center justify-center mx-auto mb-3">
                                    <i class="fas fa-database text-purple-600 text-xl"></i>
                                </div>
                                <h4 class="font-medium text-gray-900">Completeness</h4>
                                <p class="text-sm text-gray-500" id="dataCompleteness">85%</p>
                            </div>
                            
                            <!-- Agreement Score -->
                            <div class="text-center">
                                <div class="w-16 h-16 bg-yellow-100 rounded-full flex items-center justify-center mx-auto mb-3">
                                    <i class="fas fa-handshake text-yellow-600 text-xl"></i>
                                </div>
                                <h4 class="font-medium text-gray-900">Agreement</h4>
                                <p class="text-sm text-gray-500" id="agreementScore">75%</p>
                            </div>
                            
                            <!-- Consistency -->
                            <div class="text-center">
                                <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-3">
                                    <i class="fas fa-balance-scale text-red-600 text-xl"></i>
                                </div>
                                <h4 class="font-medium text-gray-900">Consistency</h4>
                                <p class="text-sm text-gray-500" id="consistencyScore">Low</p>
                            </div>
                        </div>
                        
                        <!-- Expandable Quality Details -->
                        <div id="qualityDetails" class="expandable-section mt-6">
                            <div class="border-t pt-6">
                                <div id="qualityDetailsContent">
                                    <!-- Populated by JavaScript -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Risk Assessment Section -->
                <div id="riskAssessment" class="progressive-disclosure">
                    <div class="bg-white rounded-lg shadow-lg p-6">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-xl font-bold text-gray-900">Risk Assessment</h3>
                            <button class="text-blue-600 hover:text-blue-800 text-sm font-medium" onclick="toggleSection('riskDetails')">
                                <i class="fas fa-chevron-down mr-1"></i>
                                Show Details
                            </button>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                            <!-- Overall Risk Score -->
                            <div class="text-center">
                                <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-3">
                                    <i class="fas fa-exclamation-triangle text-red-600 text-xl"></i>
                                </div>
                                <h4 class="font-medium text-gray-900">Risk Score</h4>
                                <p class="text-sm text-gray-500" id="overallRiskScore">25</p>
                            </div>
                            
                            <!-- Compliance Risk -->
                            <div class="text-center">
                                <div class="w-16 h-16 bg-yellow-100 rounded-full flex items-center justify-center mx-auto mb-3">
                                    <i class="fas fa-gavel text-yellow-600 text-xl"></i>
                                </div>
                                <h4 class="font-medium text-gray-900">Compliance Risk</h4>
                                <p class="text-sm text-gray-500" id="complianceRisk">Low</p>
                            </div>
                            
                            <!-- Financial Risk -->
                            <div class="text-center">
                                <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-3">
                                    <i class="fas fa-dollar-sign text-green-600 text-xl"></i>
                                </div>
                                <h4 class="font-medium text-gray-900">Financial Risk</h4>
                                <p class="text-sm text-gray-500" id="financialRisk">Low</p>
                            </div>
                            
                            <!-- Operational Risk -->
                            <div class="text-center">
                                <div class="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-3">
                                    <i class="fas fa-cogs text-blue-600 text-xl"></i>
                                </div>
                                <h4 class="font-medium text-gray-900">Operational Risk</h4>
                                <p class="text-sm text-gray-500" id="operationalRisk">Medium</p>
                            </div>
                        </div>
                        
                        <!-- Expandable Risk Details -->
                        <div id="riskDetails" class="expandable-section mt-6">
                            <div class="border-t pt-6">
                                <div id="riskDetailsContent">
                                    <!-- Populated by JavaScript -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Business Intelligence Section -->
                <div id="businessIntelligence" class="progressive-disclosure">
                    <div class="bg-white rounded-lg shadow-lg p-6">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-xl font-bold text-gray-900">Business Intelligence</h3>
                            <button class="text-blue-600 hover:text-blue-800 text-sm font-medium" onclick="toggleSection('intelligenceDetails')">
                                <i class="fas fa-chevron-down mr-1"></i>
                                Show Details
                            </button>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                            <!-- Employee Count -->
                            <div class="text-center">
                                <div class="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-3">
                                    <i class="fas fa-users text-blue-600 text-xl"></i>
                                </div>
                                <h4 class="font-medium text-gray-900">Employees</h4>
                                <p class="text-sm text-gray-500" id="employeeCount">50-100</p>
                            </div>
                            
                            <!-- Revenue Range -->
                            <div class="text-center">
                                <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-3">
                                    <i class="fas fa-chart-line text-green-600 text-xl"></i>
                                </div>
                                <h4 class="font-medium text-gray-900">Revenue</h4>
                                <p class="text-sm text-gray-500" id="revenueRange">$1M-$10M</p>
                            </div>
                            
                            <!-- Founded Year -->
                            <div class="text-center">
                                <div class="w-16 h-16 bg-purple-100 rounded-full flex items-center justify-center mx-auto mb-3">
                                    <i class="fas fa-calendar text-purple-600 text-xl"></i>
                                </div>
                                <h4 class="font-medium text-gray-900">Founded</h4>
                                <p class="text-sm text-gray-500" id="foundedYear">2015</p>
                            </div>
                            
                            <!-- Location -->
                            <div class="text-center">
                                <div class="w-16 h-16 bg-yellow-100 rounded-full flex items-center justify-center mx-auto mb-3">
                                    <i class="fas fa-map-marker-alt text-yellow-600 text-xl"></i>
                                </div>
                                <h4 class="font-medium text-gray-900">Location</h4>
                                <p class="text-sm text-gray-500" id="businessLocation">San Francisco</p>
                            </div>
                        </div>
                        
                        <!-- Expandable Intelligence Details -->
                        <div id="intelligenceDetails" class="expandable-section mt-6">
                            <div class="border-t pt-6">
                                <div id="intelligenceDetailsContent">
                                    <!-- Populated by JavaScript -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Verification Status Section -->
                <div id="verificationStatus" class="progressive-disclosure">
                    <div class="bg-white rounded-lg shadow-lg p-6">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-xl font-bold text-gray-900">Verification Status</h3>
                            <button class="text-blue-600 hover:text-blue-800 text-sm font-medium" onclick="toggleSection('verificationDetails')">
                                <i class="fas fa-chevron-down mr-1"></i>
                                Show Details
                            </button>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                            <!-- Verification Status -->
                            <div class="text-center">
                                <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-3">
                                    <i class="fas fa-check-circle text-green-600 text-xl"></i>
                                </div>
                                <h4 class="font-medium text-gray-900">Status</h4>
                                <p class="text-sm text-gray-500" id="verificationStatus">Complete</p>
                            </div>
                            
                            <!-- Processing Time -->
                            <div class="text-center">
                                <div class="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-3">
                                    <i class="fas fa-clock text-blue-600 text-xl"></i>
                                </div>
                                <h4 class="font-medium text-gray-900">Processing Time</h4>
                                <p class="text-sm text-gray-500" id="processingTime">0.5s</p>
                            </div>
                            
                            <!-- Data Sources -->
                            <div class="text-center">
                                <div class="w-16 h-16 bg-purple-100 rounded-full flex items-center justify-center mx-auto mb-3">
                                    <i class="fas fa-database text-purple-600 text-xl"></i>
                                </div>
                                <h4 class="font-medium text-gray-900">Data Sources</h4>
                                <p class="text-sm text-gray-500" id="dataSources">5 sources</p>
                            </div>
                            
                            <!-- Last Updated -->
                            <div class="text-center">
                                <div class="w-16 h-16 bg-yellow-100 rounded-full flex items-center justify-center mx-auto mb-3">
                                    <i class="fas fa-sync text-yellow-600 text-xl"></i>
                                </div>
                                <h4 class="font-medium text-gray-900">Last Updated</h4>
                                <p class="text-sm text-gray-500" id="lastUpdated">Just now</p>
                            </div>
                        </div>
                        
                        <!-- Expandable Verification Details -->
                        <div id="verificationDetails" class="expandable-section mt-6">
                            <div class="border-t pt-6">
                                <div id="verificationDetailsContent">
                                    <!-- Populated by JavaScript -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Risk Assessment Tab -->
        <div class="tab-content" id="risk-assessment">
            <div class="bg-white rounded-lg shadow-lg p-6">
                <div class="flex items-center justify-between mb-6">
                    <div class="flex items-center">
                        <div class="w-12 h-12 bg-purple-100 rounded-full flex items-center justify-center mr-4">
                            <i class="fas fa-shield-alt text-purple-600 text-xl"></i>
                        </div>
                        <h2 class="text-2xl font-bold text-gray-900">Risk Assessment</h2>
                    </div>
                    <div class="flex items-center gap-3">
                        <button class="btn btn-outline btn-sm" id="configureRiskFactorsBtn" aria-label="Configure risk factors" aria-expanded="false" aria-controls="riskConfigContainer">
                            <i class="fas fa-cog mr-2" aria-hidden="true"></i>
                            Configure Risk Factors
                        </button>
                        <div id="riskExportButtonContainer" style="display: inline-block;"></div>
                    </div>
                </div>
                <div id="riskAssessmentContainer">
                    <!-- Risk Score Panel -->
                    <div id="riskScorePanel"></div>
                    
                    <!-- Website Risk Display -->
                    <div id="websiteRiskDisplay" style="margin-top: 1.5rem;"></div>
                    
                    <!-- Risk Configuration (Drag and Drop) -->
                    <div id="riskConfigContainer" class="risk-config-container" style="display: none;" role="region" aria-labelledby="riskConfigTitle" aria-hidden="true">
                        <div class="bg-gray-50 rounded-lg p-6 mt-6 border border-gray-200">
                            <div class="flex items-center justify-between mb-4">
                                <h4 class="text-lg font-semibold text-gray-900" id="riskConfigTitle">Risk Configuration</h4>
                            <button class="text-gray-500 hover:text-gray-700" id="closeRiskConfigBtn" aria-label="Close risk configuration">
                                <i class="fas fa-times" aria-hidden="true"></i>
                            </button>
                            </div>
                            <p class="text-sm text-gray-600 mb-4">Drag and drop to reorder risk factors by priority</p>
                            <div id="riskFactorsList" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                                <!-- Risk factors will be populated here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Risk Indicators Tab -->
        <div class="tab-content" id="risk-indicators">
            <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-2xl font-bold text-gray-900">Risk Indicators</h2>
                    <div id="riskIndicatorsExportButtonContainer" style="display: inline-block;"></div>
                </div>
            </div>
            <div id="riskIndicatorsContainer"></div>
        </div>

    </div>

    <!-- Fixed Footer with Session Buttons -->
    <footer class="fixed-footer" id="sessionFooter" role="contentinfo">
        <div class="fixed-footer-content">
            <div class="fixed-footer-actions">
                <button class="fixed-footer-btn fixed-footer-btn-secondary" id="footerHistoryBtn" aria-label="View session history" type="button">
                    <i class="fas fa-history mr-2" aria-hidden="true"></i>
                    History
                </button>
                <button class="fixed-footer-btn fixed-footer-btn-primary" id="footerEndSessionBtn" aria-label="End current session" type="button">
                    <i class="fas fa-sign-out-alt mr-2" aria-hidden="true"></i>
                    End Session
                </button>
            </div>
        </div>
    </footer>

    <script>
        // Merchant Details JavaScript
        class MerchantDetails {
            constructor() {
                this.merchantData = null;
                this.apiResults = null;
                this.dataSourceTracking = new Map(); // Track data source for each card
                this.tooltip = null; // Mock data tooltip instance
                this.init();
            }

            init() {
                console.log(' MerchantDetails.init() called');
                console.log(' Page URL:', window.location.href);
                console.log(' Document ready state:', document.readyState);
                this.initializeTooltip();
                this.loadMerchantData();
                this.bindEvents();
                this.initializeComponents();
                console.log(' MerchantDetails initialization complete');
            }
            
            initializeTooltip() {
                // Initialize mock data tooltip if available
                if (typeof MockDataTooltip !== 'undefined') {
                    this.tooltip = window.mockDataTooltip || new MockDataTooltip();
                }
            }
            
            /**
             * Track data source for a card
             * @param {string} cardId - Card identifier
             * @param {string} source - Data source: 'real', 'mock', or 'empty'
             */
            trackDataSource(cardId, source) {
                this.dataSourceTracking.set(cardId, source);
            }
            
            /**
             * Get data source for a card
             * @param {string} cardId - Card identifier
             * @returns {string} Data source
             */
            getDataSource(cardId) {
                return this.dataSourceTracking.get(cardId) || 'unknown';
            }
            
            /**
             * Add mock data tooltip to a card if data is mock
             * @param {string} cardId - Card identifier
             * @param {HTMLElement} cardElement - Card element
             * @param {Object} tooltipContent - Tooltip content object
             */
            addMockDataTooltip(cardId, cardElement, tooltipContent) {
                if (!this.tooltip || !cardElement) return;
                
                const dataSource = this.getDataSource(cardId);
                if (dataSource === 'mock') {
                    // Find card title element to attach indicator
                    const titleElement = cardElement.querySelector('h3');
                    if (titleElement) {
                        this.tooltip.attach(titleElement, tooltipContent);
                    }
                }
            }
            
            /**
             * Get tooltip content template for a card type
             * @param {string} cardType - Card type
             * @returns {Object} Tooltip content object
             */
            getTooltipContent(cardType) {
                const templates = {
                    overview: {
                        header: 'Mock Data',
                        content: 'This overview information is using sample data. Real data will be available once the merchant profile is fully verified and integrated with external data sources.',
                        footer: 'Data source: Mock database'
                    },
                    contact: {
                        header: 'Mock Contact Data',
                        content: 'Contact information shown here is sample data. Real contact details will be populated from the merchant registration form and verified through external data sources.',
                        footer: 'Data source: Form submission (pending verification)'
                    },
                    financial: {
                        header: 'Mock Financial Data',
                        content: 'Financial information is currently unavailable. This data will be populated from external financial data providers once the merchant completes the verification process.',
                        footer: 'Data source: External financial APIs (not yet integrated)'
                    },
                    compliance: {
                        header: 'Mock Compliance Data',
                        content: 'Compliance status shown here is sample data. Real compliance information will be available after KYB verification is completed and regulatory checks are performed.',
                        footer: 'Data source: Compliance verification service (pending)'
                    },
                    coreResults: {
                        header: 'Mock Classification Data',
                        content: 'Industry classification codes (MCC, SIC, NAICS) shown here are sample data. Real classification will be determined through AI/ML analysis of business information and website content.',
                        footer: 'Data source: Classification API (pending integration)'
                    },
                    securityIndicators: {
                        header: 'Mock Security Data',
                        content: 'Security and trust indicators are using sample data. Real security validation will be performed through website scanning and SSL certificate verification.',
                        footer: 'Data source: Security scanning service (pending)'
                    },
                    qualityMetrics: {
                        header: 'Mock Quality Metrics',
                        content: 'Data quality metrics shown here are sample values. Real metrics will be calculated based on data completeness, accuracy, and consistency from multiple sources.',
                        footer: 'Data source: Quality assessment engine (pending)'
                    },
                    riskAssessment: {
                        header: 'Mock Risk Assessment',
                        content: 'Risk assessment data is using sample values. Real risk scores will be calculated based on comprehensive risk analysis including compliance, financial, and operational factors.',
                        footer: 'Data source: Risk assessment service (pending)'
                    },
                    businessIntelligence: {
                        header: 'Mock Business Intelligence',
                        content: 'Business intelligence insights are using sample data. Real insights will be generated from market analysis, competitive research, and industry trend data.',
                        footer: 'Data source: Business intelligence API (pending)'
                    },
                    verificationStatus: {
                        header: 'Mock Verification Status',
                        content: 'Verification status shown here is sample data. Real verification will be performed through identity checks, address validation, and compliance screening.',
                        footer: 'Data source: Verification service (pending)'
                    },
                    dataEnrichment: {
                        header: 'Data Enrichment',
                        content: 'Data enrichment allows you to enhance merchant information from external sources. Click "Enrich Data" to trigger enrichment from available sources.',
                        footer: 'Feature: Data enrichment service'
                    },
                    externalDataSources: {
                        header: 'External Data Sources',
                        content: 'These are integrated external data sources that provide additional merchant information. Data is synced periodically from these sources.',
                        footer: 'Feature: External data integration'
                    }
                };
                
                return templates[cardType] || {
                    header: 'Mock Data',
                    content: 'This data is using sample information for demonstration purposes.',
                    footer: 'Data source: Mock database'
                };
            }

            loadMerchantData() {
                try {
                    console.log(' loadMerchantData() called');
                    
                    // Try to get merchant ID from URL first (for direct links)
                    const urlParams = new URLSearchParams(window.location.search);
                    const merchantIdFromUrl = urlParams.get('merchantId') || urlParams.get('id');
                    
                    // Load merchant data from session storage
                    const merchantDataStr = sessionStorage.getItem('merchantData');
                    const apiResultsStr = sessionStorage.getItem('merchantApiResults');
                    
                    console.log(' SessionStorage check:');
                    console.log(' merchantData exists:', !!merchantDataStr);
                    console.log(' merchantApiResults exists:', !!apiResultsStr);
                    console.log(' merchantId from URL:', merchantIdFromUrl);
                    
                    // Parse and validate merchant data
                    if (merchantDataStr) {
                        try {
                            console.log(' Parsing merchantData from sessionStorage...');
                            this.merchantData = JSON.parse(merchantDataStr);
                            
                            // Validate merchant data structure
                            if (!this.validateMerchantData(this.merchantData)) {
                                console.warn(' Invalid merchant data structure, using fallback');
                                this.merchantData = this.normalizeMerchantData(this.merchantData);
                            }
                            
                            console.log(' merchantData parsed successfully:', Object.keys(this.merchantData));
                            
                            // If we have merchant ID from URL but it doesn't match, try to fetch from API
                            if (merchantIdFromUrl && this.merchantData.id !== merchantIdFromUrl && 
                                this.merchantData.merchantId !== merchantIdFromUrl && 
                                this.merchantData.businessId !== merchantIdFromUrl) {
                                console.log(' Merchant ID mismatch, attempting to fetch from API...');
                                this.fetchMerchantDataFromAPI(merchantIdFromUrl);
                            } else {
                                this.populateMerchantDetails();
                                // Load overview cards after data is loaded
                                setTimeout(() => this.loadOverviewCards(), 500);
                                // Update merchant context if available
                                if (window.merchantContext && window.merchantContext.setMerchantContext) {
                                    window.merchantContext.setMerchantContext(this.merchantData);
                                }
                            }
                        } catch (parseError) {
                            console.error(' Error parsing merchantData from sessionStorage:', parseError);
                            // If we have merchant ID from URL, try to fetch from API
                            if (merchantIdFromUrl) {
                                console.log(' Attempting to fetch merchant data from API...');
                                this.fetchMerchantDataFromAPI(merchantIdFromUrl);
                            } else {
                                console.warn(' No merchant data and no merchant ID available');
                            }
                        }
                    } else if (merchantIdFromUrl) {
                        // No session data but we have merchant ID from URL - fetch from API
                        console.log(' No session data, fetching from API using merchant ID from URL...');
                        this.fetchMerchantDataFromAPI(merchantIdFromUrl);
                    } else {
                        console.warn(' No merchantData found in sessionStorage and no merchant ID in URL');
                    }
                    
                    // Parse and validate API results
                    if (apiResultsStr) {
                        try {
                            console.log(' Parsing apiResults from sessionStorage...');
                            this.apiResults = JSON.parse(apiResultsStr);
                            
                            // Validate API results structure
                            if (!this.validateApiResults(this.apiResults)) {
                                console.warn(' Invalid API results structure');
                                this.apiResults = this.normalizeApiResults(this.apiResults);
                            }
                            
                            console.log(' apiResults parsed successfully:', Object.keys(this.apiResults));
                            this.populateApiResults();
                        } catch (parseError) {
                            console.error(' Error parsing apiResults from sessionStorage:', parseError);
                            this.apiResults = null;
                        }
                    } else {
                        console.warn(' No apiResults found in sessionStorage');
                    }
                    
                    // Update page title - wait for DOM to be ready
                    if (this.merchantData && this.merchantData.businessName) {
                        const updateTitle = (retries = 15) => {
                            // Strategy 1: Try getElementById
                            let titleElement = document.getElementById('merchantNameText');
                            
                            // Strategy 2: Try querySelector with multiple selectors
                            if (!titleElement) {
                                titleElement = document.querySelector('h1#merchantNameText') ||
                                              document.querySelector('h1[id="merchantNameText"]') ||
                                              document.querySelector('#merchantNameText');
                            }
                            
                            // Strategy 3: Search within header/container
                            if (!titleElement) {
                                const header = document.querySelector('header') || 
                                              document.querySelector('.flex.items-center') ||
                                              document.querySelector('[class*="flex"][class*="items-center"]');
                                if (header) {
                                    titleElement = header.querySelector('#merchantNameText') ||
                                                  header.querySelector('h1');
                                }
                            }
                            
                            // Strategy 4: Search all h1 elements
                            if (!titleElement) {
                                const allH1s = document.querySelectorAll('h1');
                                for (const h1 of allH1s) {
                                    if (h1.id === 'merchantNameText' || 
                                        h1.textContent === 'Loading...' ||
                                        h1.textContent.trim() === '') {
                                        titleElement = h1;
                                        break;
                                    }
                                }
                            }
                            
                            if (titleElement) {
                                titleElement.textContent = this.merchantData.businessName;
                                document.title = `${this.merchantData.businessName} - Merchant Details - KYB Platform`;
                                console.log(' Page title updated:', this.merchantData.businessName, {
                                    elementId: titleElement.id,
                                    elementTag: titleElement.tagName,
                                    elementText: titleElement.textContent.substring(0, 50)
                                });
                            } else if (retries > 0) {
                                // Retry if element not found yet
                                setTimeout(() => updateTitle(retries - 1), 200);
                            } else {
                                console.warn(' merchantNameText element not found after all retries');
                                // Always update document.title as fallback
                                document.title = `${this.merchantData.businessName} - Merchant Details - KYB Platform`;
                                console.log(' Document title updated as fallback');
                                
                                // Log available h1 elements for debugging
                                const allH1s = Array.from(document.querySelectorAll('h1'));
                                console.log(' Available h1 elements:', allH1s.map(h => ({
                                    id: h.id,
                                    text: h.textContent.substring(0, 50),
                                    classes: h.className.substring(0, 50),
                                    parent: h.parentElement ? h.parentElement.tagName : 'none'
                                })));
                            }
                        };
                        updateTitle();
                    } else {
                        console.warn(' No businessName in merchantData');
                    }
                    
                    console.log(' loadMerchantData() completed successfully');
                } catch (error) {
                    console.error(' Error loading merchant data:', error);
                    console.error(' Error stack:', error.stack);
                    this.showError('Failed to load merchant data');
                }
            }

            populateMerchantDetails() {
                console.log(' populateMerchantDetails() called');
                if (!this.merchantData) {
                    console.warn(' No merchantData available to populate');
                    if (window.formFlowDebugger) {
                        window.formFlowDebugger.log('error', 'No merchantData available to populate');
                    }
                    return;
                }
                console.log(' Populating merchant details with data:', Object.keys(this.merchantData));
                console.log(' Document ready state:', document.readyState);
                console.log(' Document body exists:', !!document.body);
                console.log(' Document body children count:', document.body ? document.body.children.length : 0);
                
                // Debug logging
                if (window.formFlowDebugger) {
                    window.formFlowDebugger.log('dom', 'populateMerchantDetails called', {
                        readyState: document.readyState,
                        bodyExists: !!document.body,
                        bodyChildren: document.body ? document.body.children.length : 0,
                        dataKeys: Object.keys(this.merchantData)
                    });
                }

                // Wait a bit for DOM to be fully ready, especially if tabs are involved
                const populateFields = () => {
                    // First, ensure the overview tab is visible - try multiple methods
                    let overviewTab = document.getElementById('overview');
                    
                    // If not found, try querySelector as fallback
                    if (!overviewTab) {
                        overviewTab = document.querySelector('.tab-content#overview');
                    }
                    
                    // If still not found, try finding any tab-content with overview
                    if (!overviewTab) {
                        const allTabContents = document.querySelectorAll('.tab-content');
                        for (const tab of allTabContents) {
                            if (tab.id === 'overview') {
                                overviewTab = tab;
                                break;
                            }
                        }
                    }
                    
                    if (!overviewTab) {
                        // Don't log error here - let retry logic handle it
                        return false; // Return false to indicate failure
                    }
                    
                    // Ensure the tab is active (visible)
                    if (!overviewTab.classList.contains('active')) {
                        console.log(' Overview tab not active, activating it...');
                        overviewTab.classList.add('active');
                        // Also activate the corresponding button
                        const tabButton = document.querySelector('[data-tab="overview"]');
                        if (tabButton) {
                            tabButton.classList.add('active');
                        }
                    }
                    
                    // Helper function to safely set text content - search within tab container first
                    const setTextContent = (elementId, value, fallback = '-') => {
                        // First try to find within the tab container
                        let element = overviewTab.querySelector(`#${elementId}`);
                        // If not found, try document-wide
                        if (!element) {
                            element = document.getElementById(elementId);
                        }
                        // If still not found, try querySelector
                        if (!element) {
                            element = document.querySelector(`#${elementId}`);
                        }
                        
                        if (element) {
                            element.textContent = value || fallback;
                            return true;
                        } else {
                            console.warn(` Element with id "${elementId}" not found in DOM`);
                            return false;
                        }
                    };

                // Populate merchant details tab with null checks
                const fields = [
                    { id: 'businessName', value: this.merchantData.businessName },
                    { id: 'websiteUrl', value: this.merchantData.websiteUrl },
                    { id: 'businessDescription', value: this.merchantData.businessDescription },
                    { id: 'registrationNumber', value: this.merchantData.registrationNumber },
                    { id: 'streetAddress', value: this.merchantData.streetAddress },
                    { id: 'city', value: this.merchantData.city },
                    { id: 'state', value: this.merchantData.state },
                    { id: 'postalCode', value: this.merchantData.postalCode },
                    { id: 'country', value: this.merchantData.country },
                    { id: 'phoneNumber', value: this.merchantData.phoneNumber },
                    { id: 'email', value: this.merchantData.email }
                ];

                    let populatedCount = 0;
                    fields.forEach(field => {
                        if (setTextContent(field.id, field.value)) {
                            populatedCount++;
                        }
                    });

                    console.log(` Populated ${populatedCount} out of ${fields.length} fields`);
                    
                    if (populatedCount === 0) {
                        console.warn(' No fields were populated - check if the merchant details tab HTML structure exists');
                        // Log available elements for debugging - fix invalid selector syntax
                        const businessEls = Array.from(document.querySelectorAll('[id*="business"]')).map(el => el.id);
                        const addressEls = Array.from(document.querySelectorAll('[id*="address"]')).map(el => el.id);
                        const cityEls = Array.from(document.querySelectorAll('[id*="city"]')).map(el => el.id);
                        const countryEls = Array.from(document.querySelectorAll('[id*="country"]')).map(el => el.id);
                        console.log(' Available elements with similar IDs:', {
                            business: businessEls,
                            address: addressEls,
                            city: cityEls,
                            country: countryEls
                        });
                        // Also check what's actually in the tab container
                        if (overviewTab) {
                            const tabElements = Array.from(overviewTab.querySelectorAll('[id]')).map(el => ({
                                id: el.id,
                                tagName: el.tagName,
                                textContent: el.textContent.substring(0, 50)
                            }));
                            console.log(' Elements inside overview tab:', tabElements);
                        }
                    }
                    
                    return populatedCount > 0; // Return true if any fields were populated
                };

                // Wait for DOM to be fully ready with MutationObserver support
                const waitForDOM = (callback, maxWait = 5000) => {
                    const startTime = Date.now();
                    let observer = null;
                    let timeoutId = null;
                    
                    const checkDOM = () => {
                        // Check if body exists and has content
                        if (!document.body || document.body.children.length === 0) {
                            if (Date.now() - startTime < maxWait) {
                                timeoutId = setTimeout(checkDOM, 100);
                                return;
                            }
                        }
                        
                        // Check if the tab container exists - try multiple selectors
                        let tabContainer = document.getElementById('overview');
                        if (!tabContainer) {
                            // Try alternative selectors
                            tabContainer = document.querySelector('.tab-content#overview');
                        }
                        if (!tabContainer) {
                            tabContainer = document.querySelector('[id="overview"]');
                        }
                        // Also try searching within main content container
                        if (!tabContainer) {
                            const mainContent = document.querySelector('.max-w-7xl.mx-auto');
                            if (mainContent) {
                                tabContainer = mainContent.querySelector('#overview') ||
                                             mainContent.querySelector('.tab-content');
                            }
                        }
                        
                        if (tabContainer) {
                            console.log(' Tab container found, proceeding with population');
                            if (window.formFlowDebugger) {
                                window.formFlowDebugger.log('dom', 'Tab container found', {
                                    id: tabContainer.id,
                                    className: tabContainer.className,
                                    hasActive: tabContainer.classList.contains('active')
                                });
                            }
                            // Clean up observer and timeout
                            if (observer) observer.disconnect();
                            if (timeoutId) clearTimeout(timeoutId);
                            callback();
                            return true;
                        }
                        return false;
                    };
                    
                    // Use MutationObserver to detect when tab container is added
                    const setupObserver = () => {
                        if (!document.body) return;
                        
                        observer = new MutationObserver((mutations) => {
                            mutations.forEach((mutation) => {
                                mutation.addedNodes.forEach((node) => {
                                    if (node.nodeType === 1) { // Element node
                                        // Check if it's the tab container or contains it
                                        if (node.id === 'overview' ||
                                            node.classList.contains('tab-content') ||
                                            (node.querySelector && node.querySelector('#overview'))) {
                                            console.log(' Tab container detected via MutationObserver');
                                            if (checkDOM()) {
                                                return; // Container found, callback called
                                            }
                                        }
                                    }
                                });
                            });
                        });
                        
                        observer.observe(document.body, {
                            childList: true,
                            subtree: true
                        });
                        console.log(' MutationObserver started for tab container discovery');
                    };
                    
                    // Start checking immediately
                    if (checkDOM()) {
                        return; // Container already exists
                    }
                    
                    // Set up MutationObserver
                    if (document.body) {
                        setupObserver();
                    } else {
                        if (document.readyState === 'loading') {
                            document.addEventListener('DOMContentLoaded', setupObserver);
                        } else {
                            setTimeout(setupObserver, 100);
                        }
                    }
                    
                    // Also use polling as fallback
                    if (document.readyState === 'complete' || document.readyState === 'interactive') {
                        timeoutId = setTimeout(checkDOM, 100);
                    } else {
                        window.addEventListener('load', () => {
                            timeoutId = setTimeout(checkDOM, 100);
                        });
                        timeoutId = setTimeout(checkDOM, 100);
                    }
                    
                    // Timeout after maxWait
                    setTimeout(() => {
                        if (observer) observer.disconnect();
                        if (timeoutId) clearTimeout(timeoutId);
                        
                        if (!checkDOM()) {
                            console.error(' Tab container not found after waiting for DOM');
                            const allTabContents = document.querySelectorAll('.tab-content, [id*="merchant"], [class*="tab"]');
                            console.error(' Available tab-content elements:', Array.from(allTabContents).map(t => ({
                                id: t.id,
                                className: t.className,
                                tagName: t.tagName,
                                innerHTML: t.innerHTML.substring(0, 100)
                            })));
                            console.error(' All elements with id containing "merchant":', Array.from(document.querySelectorAll('[id*="merchant"]')).map(e => ({
                                id: e.id,
                                tagName: e.tagName,
                                className: e.className
                            })));
                            if (window.formFlowDebugger) {
                                window.formFlowDebugger.log('error', 'Tab container not found after waiting', {
                                    waitTime: Date.now() - startTime,
                                    readyState: document.readyState
                                });
                            }
                            callback(); // Still try to populate, maybe it will work
                        }
                    }, maxWait);
                };
                
                // Retry logic with multiple attempts
                let retryCount = 0;
                const maxRetries = 15; // Increased retries even more
                const retryInterval = 300; // 300ms between retries
                
                const attemptPopulate = () => {
                    const success = populateFields();
                    
                    if (!success && retryCount < maxRetries) {
                        retryCount++;
                        console.log(` Populate attempt ${retryCount}/${maxRetries} failed, retrying in ${retryInterval}ms...`);
                        setTimeout(attemptPopulate, retryInterval);
                    } else if (!success) {
                        console.error(' Failed to populate merchant details after all retries!');
                        // Log what tab containers DO exist - try multiple selectors
                        console.log(' Checking for tab elements with various selectors...');
                        const selectors = [
                            '.tab-content',
                            '[id*="overview"]',
                            '[class*="tab"]',
                            '#overview',
                            'div.tab-content',
                            'div[id="overview"]'
                        ];
                        
                        selectors.forEach(selector => {
                            try {
                                const elements = document.querySelectorAll(selector);
                                if (elements.length > 0) {
                                    console.log(` Found ${elements.length} elements with selector "${selector}":`, 
                                        Array.from(elements).map(el => ({
                                            id: el.id,
                                            className: el.className,
                                            tagName: el.tagName,
                                            innerHTML: el.innerHTML.substring(0, 100)
                                        }))
                                    );
                                }
                            } catch (e) {
                                console.warn(` Error with selector "${selector}":`, e);
                            }
                        });
                        
                        // Also log document structure
                        console.log(' Document body structure:', {
                            bodyExists: !!document.body,
                            bodyChildren: document.body ? document.body.children.length : 0,
                            readyState: document.readyState,
                            allIds: Array.from(document.querySelectorAll('[id]')).map(el => el.id).slice(0, 20)
                        });
                    } else {
                        console.log(` Successfully populated merchant details after ${retryCount} retries`);
                    }
                };
                
                // Wait for DOM to be ready, then start populating
                waitForDOM(() => {
                    attemptPopulate();
                });
            }

            populateApiResults() {
                if (!this.apiResults) return;

                // Populate Business Intelligence results
                if (this.apiResults.businessIntelligence) {
                    this.populateBusinessIntelligenceResults(this.apiResults.businessIntelligence);
                }

                // Populate Risk Assessment results
                if (this.apiResults.riskAssessment) {
                    this.populateRiskAssessmentResults(this.apiResults.riskAssessment);
                }

                // Populate Risk Indicators results
                if (this.apiResults.riskIndicators) {
                    this.populateRiskIndicatorsResults(this.apiResults.riskIndicators);
                }
            }

            populateBusinessIntelligenceResults(data) {
                console.log(' Populating Business Intelligence results:', data);
                console.log(' Data type:', typeof data);
                console.log(' Is data null?', data === null);
                console.log(' Is data undefined?', data === undefined);
                console.log(' Data keys:', data ? Object.keys(data) : 'N/A');
                console.log(' Actual BI data structure:', JSON.stringify(data, null, 2));
                
                // HTML escaping function to prevent XSS
                const escapeHtml = (text) => {
                    if (text == null) return '';
                    const div = document.createElement('div');
                    div.textContent = String(text);
                    return div.innerHTML;
                };
                
                // Check if data is empty or invalid
                if (!data || (typeof data === 'object' && Object.keys(data).length === 0)) {
                    console.warn(' Business Intelligence data is empty or invalid');
                    return;
                }
                
                // Extract data from various possible structures
                let result = data;
                if (data.business_intelligence) {
                    result = data.business_intelligence;
                } else if (data.response) {
                    result = data.response;
                }
                
                // Extract classification codes
                let mccCodes = [];
                let sicCodes = [];
                let naicsCodes = [];
                let primaryIndustry = 'Unknown';
                let confidenceScore = 0;
                let methodsUsed = [];
                let websiteKeywords = [];
                let classificationReasoning = '';
                
                // Try different data structures
                if (result.response && result.response.classification_codes) {
                    const codes = result.response.classification_codes;
                    mccCodes = codes.mcc || [];
                    sicCodes = codes.sic || [];
                    naicsCodes = codes.naics || [];
                    primaryIndustry = result.response.primary_classification?.industry_name || result.response.detected_industry || 'Unknown';
                    confidenceScore = result.response.primary_classification?.confidence_score || result.response.overall_confidence || 0;
                    methodsUsed = result.response.methods_used || result.response.classification_methods || [];
                    websiteKeywords = result.response.website_keywords || result.response.keywords || [];
                    classificationReasoning = result.response.reasoning || result.response.classification_reasoning || result.response.explanation || '';
                } else if (result.classification_codes) {
                    mccCodes = result.classification_codes.mcc || [];
                    sicCodes = result.classification_codes.sic || [];
                    naicsCodes = result.classification_codes.naics || [];
                    primaryIndustry = result.primary_classification?.industry_name || result.detected_industry || 'Unknown';
                    confidenceScore = result.primary_classification?.confidence_score || result.overall_confidence || 0;
                    methodsUsed = result.methods_used || result.classification_methods || [];
                    websiteKeywords = result.website_keywords || result.keywords || [];
                    classificationReasoning = result.reasoning || result.classification_reasoning || result.explanation || '';
                } else if (result.classification && result.classification.classification_codes) {
                    const codes = result.classification.classification_codes;
                    mccCodes = codes.mcc || [];
                    sicCodes = codes.sic || [];
                    naicsCodes = codes.naics || [];
                    primaryIndustry = result.classification.primary_industry || result.classification.industry_name || 'Unknown';
                    confidenceScore = result.classification.confidence_score || result.classification.confidence || 0;
                    methodsUsed = result.classification.methods_used || result.classification.methods || [];
                    websiteKeywords = result.classification.website_keywords || result.classification.keywords || [];
                    classificationReasoning = result.classification.reasoning || result.classification.explanation || '';
                } else if (result.data) {
                    // Try nested data structure
                    const dataObj = result.data;
                    if (dataObj.classification_codes) {
                        mccCodes = dataObj.classification_codes.mcc || [];
                        sicCodes = dataObj.classification_codes.sic || [];
                        naicsCodes = dataObj.classification_codes.naics || [];
                    }
                    primaryIndustry = dataObj.primary_industry || dataObj.industry_name || 'Unknown';
                    confidenceScore = dataObj.confidence_score || dataObj.confidence || 0;
                    methodsUsed = dataObj.methods_used || dataObj.classification_methods || [];
                    websiteKeywords = dataObj.website_keywords || dataObj.keywords || [];
                    classificationReasoning = dataObj.reasoning || dataObj.explanation || '';
                }
                
                // Log extracted data
                console.log(' Extracted data:', {
                    mccCodes: mccCodes.length,
                    sicCodes: sicCodes.length,
                    naicsCodes: naicsCodes.length,
                    primaryIndustry,
                    confidenceScore,
                    methodsUsed: methodsUsed.length,
                    websiteKeywords: websiteKeywords.length,
                    hasReasoning: !!classificationReasoning
                });
                
                // Populate primary industry and confidence
                const primaryIndustryEl = document.getElementById('primaryIndustry');
                const industryCodeEl = document.getElementById('industryCode');
                const confidenceScoreEl = document.getElementById('confidenceScore');
                
                if (primaryIndustryEl) {
                    primaryIndustryEl.textContent = primaryIndustry;
                }
                
                if (industryCodeEl) {
                    if (naicsCodes.length > 0) {
                        const code = typeof naicsCodes[0] === 'string' ? naicsCodes[0] : (naicsCodes[0].code || naicsCodes[0].naics_code || '-');
                        industryCodeEl.textContent = code;
                    } else {
                        industryCodeEl.textContent = '-';
                    }
                }
                
                if (confidenceScoreEl) {
                    confidenceScoreEl.textContent = `${Math.round(confidenceScore * 100)}%`;
                }
                
                // Populate MCC codes
                const mccList = document.getElementById('mccCodesList');
                if (mccList) {
                    if (mccCodes.length > 0) {
                        const mccHTML = mccCodes.slice(0, 3).map((code, index) => {
                            const codeObj = typeof code === 'string' ? { code, description: code } : code;
                            const codeValue = codeObj.code || codeObj.mcc_code || codeObj.mcc || (typeof code === 'string' ? code : 'Unknown');
                            const description = codeObj.description || codeObj.name || codeValue;
                            const confidence = codeObj.confidence || 0.8;
                            // Escape user-controlled data to prevent XSS
                            const escapedDescription = escapeHtml(description);
                            const escapedCodeValue = escapeHtml(codeValue);
                            return `
                                <div class="bg-white rounded-lg p-3 border border-gray-200">
                                    <div class="flex justify-between items-start mb-2">
                                        <span class="bg-blue-100 text-blue-600 text-xs font-bold px-2 py-1 rounded-full">#${index + 1}</span>
                                        <span class="text-xs text-gray-500">${Math.round(confidence * 100)}%</span>
                                    </div>
                                    <h6 class="font-medium text-gray-900 mb-1 text-sm">${escapedDescription}</h6>
                                    <p class="text-xs text-gray-600 font-mono">${escapedCodeValue}</p>
                                </div>
                            `;
                        }).join('');
                        mccList.innerHTML = mccHTML;
                    } else {
                        mccList.innerHTML = '<p class="text-sm text-gray-500">No MCC codes found</p>';
                    }
                }
                
                // Populate SIC codes
                const sicList = document.getElementById('sicCodesList');
                if (sicList) {
                    if (sicCodes.length > 0) {
                        const sicHTML = sicCodes.slice(0, 3).map((code, index) => {
                            const codeObj = typeof code === 'string' ? { code, description: code } : code;
                            const codeValue = codeObj.code || codeObj.sic_code || codeObj.sic || (typeof code === 'string' ? code : 'Unknown');
                            const description = codeObj.description || codeObj.name || codeValue;
                            const confidence = codeObj.confidence || 0.8;
                            // Escape user-controlled data to prevent XSS
                            const escapedDescription = escapeHtml(description);
                            const escapedCodeValue = escapeHtml(codeValue);
                            return `
                                <div class="bg-white rounded-lg p-3 border border-gray-200">
                                    <div class="flex justify-between items-start mb-2">
                                        <span class="bg-red-100 text-red-600 text-xs font-bold px-2 py-1 rounded-full">#${index + 1}</span>
                                        <span class="text-xs text-gray-500">${Math.round(confidence * 100)}%</span>
                                    </div>
                                    <h6 class="font-medium text-gray-900 mb-1 text-sm">${escapedDescription}</h6>
                                    <p class="text-xs text-gray-600 font-mono">${escapedCodeValue}</p>
                                </div>
                            `;
                        }).join('');
                        sicList.innerHTML = sicHTML;
                    } else {
                        sicList.innerHTML = '<p class="text-sm text-gray-500">No SIC codes found</p>';
                    }
                }
                
                // Populate NAICS codes
                const naicsList = document.getElementById('naicsCodesList');
                if (naicsList) {
                    if (naicsCodes.length > 0) {
                        const naicsHTML = naicsCodes.slice(0, 3).map((code, index) => {
                            const codeObj = typeof code === 'string' ? { code, description: code } : code;
                            const codeValue = codeObj.code || codeObj.naics_code || codeObj.naics || (typeof code === 'string' ? code : 'Unknown');
                            const description = codeObj.description || codeObj.name || codeValue;
                            const confidence = codeObj.confidence || 0.8;
                            // Escape user-controlled data to prevent XSS
                            const escapedDescription = escapeHtml(description);
                            const escapedCodeValue = escapeHtml(codeValue);
                            return `
                                <div class="bg-white rounded-lg p-3 border border-gray-200">
                                    <div class="flex justify-between items-start mb-2">
                                        <span class="bg-green-100 text-green-600 text-xs font-bold px-2 py-1 rounded-full">#${index + 1}</span>
                                        <span class="text-xs text-gray-500">${Math.round(confidence * 100)}%</span>
                                    </div>
                                    <h6 class="font-medium text-gray-900 mb-1 text-sm">${escapedDescription}</h6>
                                    <p class="text-xs text-gray-600 font-mono">${escapedCodeValue}</p>
                                </div>
                            `;
                        }).join('');
                        naicsList.innerHTML = naicsHTML;
                    } else {
                        naicsList.innerHTML = '<p class="text-sm text-gray-500">No NAICS codes found</p>';
                    }
                }
                
                // Populate method breakdown
                const methodBreakdownEl = document.getElementById('methodBreakdown');
                if (methodBreakdownEl) {
                    if (methodsUsed.length > 0) {
                        methodBreakdownEl.innerHTML = methodsUsed.map(method => {
                            const methodName = typeof method === 'string' ? method : (method.name || method.method || 'Unknown');
                            const methodConfidence = typeof method === 'object' && method.confidence ? Math.round(method.confidence * 100) : 'N/A';
                            // Escape user-controlled data to prevent XSS
                            const escapedMethodName = escapeHtml(methodName);
                            return `
                                <div class="bg-white rounded-lg p-3 border border-gray-200">
                                    <div class="flex justify-between items-center">
                                        <span class="font-medium text-gray-900 text-sm">${escapedMethodName}</span>
                                        <span class="text-xs text-gray-500">${methodConfidence}%</span>
                                    </div>
                                </div>
                            `;
                        }).join('');
                    } else {
                        methodBreakdownEl.innerHTML = '<p class="text-sm text-gray-500">No classification methods information available</p>';
                    }
                }
                
                // Populate website keywords
                const websiteKeywordsEl = document.getElementById('websiteKeywords');
                if (websiteKeywordsEl && websiteKeywords.length > 0) {
                    websiteKeywordsEl.innerHTML = websiteKeywords.map(keyword => {
                        const keywordText = typeof keyword === 'string' ? keyword : (keyword.text || keyword.keyword || keyword);
                        // Escape user-controlled data to prevent XSS
                        const escapedKeywordText = escapeHtml(keywordText);
                        return `<span class="bg-blue-100 text-blue-800 text-xs font-medium px-2 py-1 rounded-full">${escapedKeywordText}</span>`;
                    }).join('');
                    
                    // Set up toggle button
                    const toggleKeywordsBtn = document.getElementById('toggleKeywordsBtn');
                    if (toggleKeywordsBtn) {
                        toggleKeywordsBtn.addEventListener('click', () => {
                            const isVisible = websiteKeywordsEl.style.display !== 'none';
                            websiteKeywordsEl.style.display = isVisible ? 'none' : 'flex';
                            const toggleText = document.getElementById('toggleKeywordsText');
                            const toggleIcon = document.getElementById('toggleKeywordsIcon');
                            if (toggleText) toggleText.textContent = isVisible ? 'Show Keywords' : 'Hide Keywords';
                            if (toggleIcon) toggleIcon.style.transform = isVisible ? 'rotate(0deg)' : 'rotate(180deg)';
                        });
                    }
                } else if (websiteKeywordsEl) {
                    websiteKeywordsEl.innerHTML = '<p class="text-sm text-gray-500">No website keywords available</p>';
                }
                
                // Populate classification reasoning
                const classificationReasoningEl = document.getElementById('classificationReasoning');
                if (classificationReasoningEl) {
                    if (classificationReasoning) {
                        // Escape user-controlled data to prevent XSS
                        const escapedReasoning = escapeHtml(classificationReasoning);
                        classificationReasoningEl.innerHTML = `<p class="text-sm text-gray-700">${escapedReasoning}</p>`;
                    } else {
                        classificationReasoningEl.innerHTML = '<p class="text-sm text-gray-500">No classification reasoning available</p>';
                    }
                }
                
                // Track data source for core results
                const hasRealClassificationData = mccCodes.length > 0 || sicCodes.length > 0 || naicsCodes.length > 0;
                this.trackDataSource('coreResults', hasRealClassificationData ? 'real' : 'mock');
                
                // Show progressive disclosure sections ONLY if Business Analytics tab is active
                const businessAnalyticsTab = document.getElementById('business-analytics');
                const isBusinessAnalyticsActive = businessAnalyticsTab && 
                    businessAnalyticsTab.classList.contains('active') && 
                    window.getComputedStyle(businessAnalyticsTab).display !== 'none';
                
                if (isBusinessAnalyticsActive) {
                    setTimeout(() => {
                        const element = document.getElementById('coreResults');
                        if (element) {
                            element.classList.add('visible');
                            element.style.opacity = ''; // Remove any inline opacity that might have been set
                            // Add tooltip if mock data
                            if (!hasRealClassificationData) {
                                this.addMockDataTooltip('coreResults', element, this.getTooltipContent('coreResults'));
                            }
                        }
                    }, 100);
                    
                    setTimeout(() => {
                        const element = document.getElementById('securityIndicators');
                        if (element) {
                            element.classList.add('visible');
                            element.style.opacity = '';
                            // Track and add tooltip for security indicators
                            const hasRealSecurityData = this.apiResults?.securityIndicators || this.apiResults?.security;
                            this.trackDataSource('securityIndicators', hasRealSecurityData ? 'real' : 'mock');
                            if (!hasRealSecurityData) {
                                this.addMockDataTooltip('securityIndicators', element, this.getTooltipContent('securityIndicators'));
                            }
                        }
                    }, 200);
                    
                    setTimeout(() => {
                        const element = document.getElementById('qualityMetrics');
                        if (element) {
                            element.classList.add('visible');
                            element.style.opacity = '';
                            // Track and add tooltip for quality metrics
                            const hasRealQualityData = this.apiResults?.qualityMetrics || this.apiResults?.quality;
                            this.trackDataSource('qualityMetrics', hasRealQualityData ? 'real' : 'mock');
                            if (!hasRealQualityData) {
                                this.addMockDataTooltip('qualityMetrics', element, this.getTooltipContent('qualityMetrics'));
                            }
                        }
                    }, 300);
                    
                    setTimeout(() => {
                        const element = document.getElementById('riskAssessment');
                        if (element) {
                            element.classList.add('visible');
                            element.style.opacity = '';
                            // Track and add tooltip for risk assessment
                            const hasRealRiskData = this.apiResults?.riskAssessment || this.apiResults?.risk;
                            this.trackDataSource('riskAssessment', hasRealRiskData ? 'real' : 'mock');
                            if (!hasRealRiskData) {
                                this.addMockDataTooltip('riskAssessment', element, this.getTooltipContent('riskAssessment'));
                            }
                        }
                    }, 400);
                    
                    setTimeout(() => {
                        const element = document.getElementById('businessIntelligence');
                        if (element) {
                            element.classList.add('visible');
                            element.style.opacity = '';
                            // Track and add tooltip for business intelligence
                            const hasRealIntelligenceData = this.apiResults?.businessIntelligence || this.apiResults?.intelligence;
                            this.trackDataSource('businessIntelligence', hasRealIntelligenceData ? 'real' : 'mock');
                            if (!hasRealIntelligenceData) {
                                this.addMockDataTooltip('businessIntelligence', element, this.getTooltipContent('businessIntelligence'));
                            }
                        }
                    }, 500);
                    
                    setTimeout(() => {
                        const element = document.getElementById('verificationStatus');
                        if (element) {
                            element.classList.add('visible');
                            element.style.opacity = '';
                            // Track and add tooltip for verification status
                            const hasRealVerificationData = this.apiResults?.verification || this.merchantData?.verification;
                            this.trackDataSource('verificationStatus', hasRealVerificationData ? 'real' : 'mock');
                            if (!hasRealVerificationData) {
                                this.addMockDataTooltip('verificationStatus', element, this.getTooltipContent('verificationStatus'));
                            }
                        }
                    }, 600);
                } else {
                    // Business Analytics tab is not active, ensure all progressive-disclosure elements are hidden
                    const progressiveElements = [
                        document.getElementById('coreResults'),
                        document.getElementById('securityIndicators'),
                        document.getElementById('qualityMetrics'),
                        document.getElementById('riskAssessment'),
                        document.getElementById('businessIntelligence'),
                        document.getElementById('verificationStatus')
                    ];
                    progressiveElements.forEach(element => {
                        if (element) {
                            element.classList.remove('visible');
                            element.style.opacity = '0';
                        }
                    });
                }
            }

            populateRiskAssessmentResults(data) {
                console.log('Populating Risk Assessment results:', data);
            }

            populateRiskIndicatorsResults(data) {
                console.log('Populating Risk Indicators results:', data);
            }

            bindEvents() {
                // Tab switching
                document.querySelectorAll('.tab-button').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const tabId = e.target.closest('.tab-button').dataset.tab;
                        if (tabId) {
                            this.switchTab(tabId);
                        }
                    });
                    
                    // Keyboard navigation for tabs
                    button.addEventListener('keydown', (e) => {
                        const tabs = Array.from(document.querySelectorAll('.tab-button:not(.tab-more-button)'));
                        const currentIndex = tabs.indexOf(button);
                        
                        if (e.key === 'ArrowRight' || e.key === 'ArrowLeft') {
                            e.preventDefault();
                            let nextIndex;
                            if (e.key === 'ArrowRight') {
                                nextIndex = (currentIndex + 1) % tabs.length;
                            } else {
                                nextIndex = (currentIndex - 1 + tabs.length) % tabs.length;
                            }
                            tabs[nextIndex].focus();
                            tabs[nextIndex].click();
                        } else if (e.key === 'Home') {
                            e.preventDefault();
                            tabs[0].focus();
                            tabs[0].click();
                        } else if (e.key === 'End') {
                            e.preventDefault();
                            tabs[tabs.length - 1].focus();
                            tabs[tabs.length - 1].click();
                        }
                    });
                });
                
                // Responsive tab handling
                this.setupResponsiveTabs();
                
                // More dropdown toggle
                const moreButton = document.getElementById('tabMoreButton');
                const moreMenu = document.getElementById('tabMoreMenu');
                if (moreButton && moreMenu) {
                    moreButton.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const isExpanded = moreButton.getAttribute('aria-expanded') === 'true';
                        moreButton.setAttribute('aria-expanded', !isExpanded);
                        moreMenu.style.display = isExpanded ? 'none' : 'block';
                    });
                    
                    // Close dropdown when clicking outside
                    document.addEventListener('click', (e) => {
                        if (!moreButton.contains(e.target) && !moreMenu.contains(e.target)) {
                            moreButton.setAttribute('aria-expanded', 'false');
                            moreMenu.style.display = 'none';
                        }
                    });
                }
                
                // Risk Configuration toggle
                this.setupRiskConfiguration();
            }
            
            setupRiskConfiguration() {
                const configBtn = document.getElementById('configureRiskFactorsBtn');
                const configContainer = document.getElementById('riskConfigContainer');
                const closeBtn = document.getElementById('closeRiskConfigBtn');
                
                if (configBtn && configContainer) {
                    configBtn.addEventListener('click', () => {
                        const isVisible = configContainer.style.display !== 'none';
                        if (isVisible) {
                            configContainer.style.display = 'none';
                            configContainer.setAttribute('aria-hidden', 'true');
                            configBtn.setAttribute('aria-expanded', 'false');
                        } else {
                            configContainer.style.display = 'block';
                            configContainer.setAttribute('aria-hidden', 'false');
                            configBtn.setAttribute('aria-expanded', 'true');
                            // Initialize drag-drop if component is available
                            this.initializeRiskDragDrop();
                        }
                    });
                    
                    // Keyboard support
                    configBtn.addEventListener('keydown', (e) => {
                        if (e.key === 'Enter' || e.key === ' ') {
                            e.preventDefault();
                            configBtn.click();
                        }
                    });
                }
                
                if (closeBtn && configContainer) {
                    closeBtn.addEventListener('click', () => {
                        configContainer.style.display = 'none';
                        const configBtn = document.getElementById('configureRiskFactorsBtn');
                        if (configBtn) {
                            configBtn.setAttribute('aria-expanded', 'false');
                        }
                    });
                }
            }
            
            initializeRiskDragDrop() {
                // Initialize RiskDragDrop component if available
                if (typeof RiskDragDrop !== 'undefined') {
                    const container = document.getElementById('riskConfigContainer');
                    if (container && !window.riskDragDrop) {
                        window.riskDragDrop = new RiskDragDrop('riskConfigContainer');
                        window.riskDragDrop.init();
                    } else if (window.riskDragDrop) {
                        window.riskDragDrop.refresh();
                    }
                }
            }
            
            initializeRiskComponents() {
                const merchantId = this.getMerchantId();
                if (!merchantId) {
                    console.warn('No merchant ID available for risk components');
                    return;
                }
                
                // Initialize Risk Score Panel
                if (typeof RiskScorePanel !== 'undefined') {
                    const scorePanelContainer = document.getElementById('riskScorePanel');
                    if (scorePanelContainer) {
                        try {
                            if (!window.riskScorePanel) {
                                window.riskScorePanel = new RiskScorePanel('riskScorePanel', {
                                    collapsed: false,
                                    showBreakdown: true,
                                    showFactors: true
                                });
                            }
                            window.riskScorePanel.init();
                            
                            // Load risk score data
                            this.loadRiskScoreData(merchantId);
                        } catch (error) {
                            console.error('Error initializing Risk Score Panel:', error);
                            this.showRiskComponentError('riskScorePanel', error);
                        }
                    }
                }
                
                // Initialize Website Risk Display
                if (typeof WebsiteRiskDisplay !== 'undefined') {
                    const websiteRiskContainer = document.getElementById('websiteRiskDisplay');
                    if (websiteRiskContainer) {
                        try {
                            if (!window.websiteRiskDisplay) {
                                window.websiteRiskDisplay = new WebsiteRiskDisplay('websiteRiskDisplay', {
                                    merchantId: merchantId
                                });
                            }
                            window.websiteRiskDisplay.init();
                            
                            // Load website risk data
                            this.loadWebsiteRiskData(merchantId);
                        } catch (error) {
                            console.error('Error initializing Website Risk Display:', error);
                            this.showRiskComponentError('websiteRiskDisplay', error);
                        }
                    }
                }
            }
            
            async loadRiskScoreData(merchantId) {
                if (!window.riskScorePanel) return;
                
                try {
                    // Fetch risk score data from API
                    const response = await fetch(`/api/v1/merchants/${merchantId}/risk-score`, {
                        headers: {
                            'Authorization': `Bearer ${this.getAuthToken()}`
                        }
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        if (window.riskScorePanel.updateScore) {
                            window.riskScorePanel.updateScore(data);
                        }
                    } else {
                        throw new Error(`Failed to load risk score: ${response.status}`);
                    }
                } catch (error) {
                    console.error('Error loading risk score data:', error);
                    // Show placeholder or error state
                    const container = document.getElementById('riskScorePanel');
                    if (container && !container.innerHTML.trim()) {
                        container.innerHTML = `
                            <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                                <p class="text-sm text-yellow-700">Risk score data will be available once assessment is complete.</p>
                            </div>
                        `;
                    }
                }
            }
            
            async loadWebsiteRiskData(merchantId) {
                if (!window.websiteRiskDisplay) return;
                
                try {
                    // Fetch website risk data from API
                    const response = await fetch(`/api/v1/merchants/${merchantId}/website-risk`, {
                        headers: {
                            'Authorization': `Bearer ${this.getAuthToken()}`
                        }
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        if (window.websiteRiskDisplay.updateData) {
                            window.websiteRiskDisplay.updateData(data);
                        }
                    } else {
                        throw new Error(`Failed to load website risk: ${response.status}`);
                    }
                } catch (error) {
                    console.error('Error loading website risk data:', error);
                    // Show placeholder or error state
                    const container = document.getElementById('websiteRiskDisplay');
                    if (container && !container.innerHTML.trim()) {
                        container.innerHTML = `
                            <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                                <p class="text-sm text-yellow-700">Website risk data will be available once assessment is complete.</p>
                            </div>
                        `;
                    }
                }
            }
            
            showRiskComponentError(containerId, error) {
                const container = document.getElementById(containerId);
                if (container) {
                    container.innerHTML = `
                        <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                            <div class="flex items-center mb-2">
                                <i class="fas fa-exclamation-circle text-red-600 mr-2"></i>
                                <h4 class="font-semibold text-red-900">Error Loading Component</h4>
                            </div>
                            <p class="text-sm text-red-700">${error.message || 'Failed to load component. Please try again.'}</p>
                        </div>
                    `;
                }
            }
            
            setupResponsiveTabs() {
                // Cache DOM elements for performance
                const wrapper = document.querySelector('.tab-navigation-wrapper');
                const moreDropdown = document.getElementById('tabMoreDropdown');
                const moreMenu = document.getElementById('tabMoreMenu');
                
                if (!wrapper || !moreDropdown) return;
                
                // Handle responsive tab layout
                const handleResize = () => {
                    const width = window.innerWidth;
                    
                    // Tablet view: Move overflow tabs to More dropdown
                    if (width >= 768 && width <= 1024) {
                        moreDropdown.style.display = 'block';
                        this.moveOverflowTabsToDropdown(wrapper, moreMenu);
                    } else {
                        moreDropdown.style.display = 'none';
                        // Move tabs back from dropdown
                        this.moveTabsBackFromDropdown(wrapper, moreMenu);
                    }
                };
                
                // Initial setup
                handleResize();
                
                // Handle window resize with debouncing for performance
                let resizeTimeout;
                const debouncedResize = () => {
                    clearTimeout(resizeTimeout);
                    resizeTimeout = setTimeout(handleResize, 250);
                };
                window.addEventListener('resize', debouncedResize, { passive: true });
            }
            
            moveOverflowTabsToDropdown(wrapper, moreMenu) {
                if (!wrapper || !moreMenu) return;
                
                // Clear existing dropdown items first
                const existingItems = moreMenu.querySelectorAll('.tab-dropdown-item');
                existingItems.forEach(item => item.remove());
                
                const tabs = Array.from(wrapper.querySelectorAll('.tab-button:not(.tab-more-button)'));
                const wrapperRect = wrapper.getBoundingClientRect();
                const moreButton = document.getElementById('tabMoreButton');
                const moreButtonWidth = moreButton ? moreButton.offsetWidth : 0;
                const availableWidth = wrapperRect.width - moreButtonWidth - 40; // 40px padding
                
                let totalWidth = 0;
                const visibleTabs = [];
                const overflowTabs = [];
                
                // Use requestAnimationFrame for better performance
                requestAnimationFrame(() => {
                    tabs.forEach((tab, index) => {
                        const tabWidth = tab.offsetWidth || 120; // Estimate if not rendered
                        if (totalWidth + tabWidth <= availableWidth) {
                            totalWidth += tabWidth;
                            visibleTabs.push(tab);
                            tab.style.display = '';
                        } else {
                            overflowTabs.push(tab);
                        }
                    });
                    
                    // Process overflow tabs
                    this.processOverflowTabs(overflowTabs, moreMenu, moreButton);
                });
            }
            
            processOverflowTabs(overflowTabs, moreMenu, moreButton) {
                overflowTabs.forEach(tab => {
                    const tabId = tab.getAttribute('data-tab');
                    const tabText = tab.textContent.trim();
                    const tabIcon = tab.querySelector('i');
                    const iconClass = tabIcon ? tabIcon.className : '';
                    
                    // Create dropdown menu item
                    const menuItem = document.createElement('button');
                    menuItem.className = 'tab-dropdown-item';
                    menuItem.setAttribute('data-tab', tabId);
                    menuItem.setAttribute('role', 'menuitem');
                    menuItem.innerHTML = tabIcon ? `<i class="${iconClass} mr-2"></i>${tabText}` : tabText;
                    
                    // Add click handler
                    menuItem.addEventListener('click', (e) => {
                        e.stopPropagation();
                        this.switchTab(tabId);
                        if (moreButton) {
                            moreButton.setAttribute('aria-expanded', 'false');
                        }
                        moreMenu.style.display = 'none';
                    });
                    
                    moreMenu.appendChild(menuItem);
                    
                    // Hide original tab
                    tab.style.display = 'none';
                });
            }
            
            moveTabsBackFromDropdown(wrapper, moreMenu) {
                if (!moreMenu) return;
                
                const dropdownItems = Array.from(moreMenu.querySelectorAll('.tab-dropdown-item'));
                dropdownItems.forEach(item => {
                    const tabId = item.getAttribute('data-tab');
                    const originalTab = wrapper.querySelector(`[data-tab="${tabId}"]:not(.tab-more-button)`);
                    if (originalTab) {
                        originalTab.style.display = '';
                    }
                    item.remove();
                });
            }

            switchTab(tabId) {
                console.log(' Switching to tab:', tabId);
                
                // Explicitly hide ALL tabs first using both class removal and inline styles
                document.querySelectorAll('.tab-content').forEach(tab => {
                    const currentTabId = tab.id;
                    const beforeDisplay = window.getComputedStyle(tab).display;
                    tab.classList.remove('active');
                    tab.style.display = 'none'; // Force hide to prevent any CSS conflicts
                    tab.style.visibility = 'hidden'; // Also hide visibility to ensure content is not visible
                    tab.setAttribute('aria-hidden', 'true');
                    
                    // Remove 'visible' class from all progressive-disclosure elements inside hidden tabs
                    // This prevents opacity: 1 from making content visible even when parent is display: none
                    const progressiveElements = tab.querySelectorAll('.progressive-disclosure');
                    console.log(` Tab ${currentTabId}: Found ${progressiveElements.length} progressive-disclosure elements`);
                    progressiveElements.forEach((el, idx) => {
                        const hadVisible = el.classList.contains('visible');
                        el.classList.remove('visible');
                        // Also force opacity to 0 to ensure content is hidden
                        el.style.opacity = '0';
                        console.log(` Tab ${currentTabId}: Progressive-disclosure ${idx} - hadVisible: ${hadVisible}, removed visible class, set opacity: 0`);
                    });
                    
                    const afterDisplay = window.getComputedStyle(tab).display;
                    console.log(` Hiding tab ${currentTabId}: before=${beforeDisplay}, after=${afterDisplay}, inline=${tab.style.display}`);
                });
                
                // Remove active class from all buttons and update ARIA attributes
                document.querySelectorAll('.tab-button').forEach(button => {
                    button.classList.remove('active');
                    button.setAttribute('aria-selected', 'false');
                });
                
                // Also update dropdown items
                document.querySelectorAll('.tab-dropdown-item').forEach(item => {
                    item.classList.remove('active');
                });

                // Find and show only the selected tab
                const tabElement = document.getElementById(tabId);
                const buttonElement = document.querySelector(`[data-tab="${tabId}"]:not(.tab-dropdown-item)`);
                const dropdownItem = document.querySelector(`.tab-dropdown-item[data-tab="${tabId}"]`);
                
                if (tabElement) {
                    const beforeDisplay = window.getComputedStyle(tabElement).display;
                    tabElement.classList.add('active');
                    tabElement.style.display = 'block'; // Force show to ensure visibility
                    tabElement.style.visibility = 'visible'; // Also show visibility to ensure content is visible
                    tabElement.setAttribute('aria-hidden', 'false');
                    
                    // If this is the business-analytics tab, ensure progressive-disclosure elements are visible
                    if (tabId === 'business-analytics') {
                        // Remove inline opacity styles and add visible class to show progressive-disclosure elements
                        const progressiveElements = tabElement.querySelectorAll('.progressive-disclosure');
                        progressiveElements.forEach((el, idx) => {
                            el.style.opacity = ''; // Remove inline opacity to allow CSS to control it
                            el.classList.add('visible'); // Add visible class to make content visible
                            console.log(` Business Analytics: Added 'visible' class to progressive-disclosure ${idx}`);
                        });
                    }
                    
                    const afterDisplay = window.getComputedStyle(tabElement).display;
                    console.log(' Activated tab:', tabId, 'Element ID:', tabElement.id);
                    console.log(` Showing tab ${tabId}: before=${beforeDisplay}, after=${afterDisplay}, inline=${tabElement.style.display}`);
                    
                    // Verify all other tabs are hidden
                    document.querySelectorAll('.tab-content').forEach(tab => {
                        if (tab.id !== tabId) {
                            const computedDisplay = window.getComputedStyle(tab).display;
                            const inlineDisplay = tab.style.display;
                            const hasActive = tab.classList.contains('active');
                            const isVisible = tab.offsetParent !== null;
                            const rect = tab.getBoundingClientRect();
                            
                            console.log(` Tab ${tab.id} state:`, {
                                computedDisplay,
                                inlineDisplay,
                                hasActive,
                                isVisible,
                                width: rect.width,
                                height: rect.height,
                                top: rect.top,
                                left: rect.left
                            });
                            
                            if (computedDisplay !== 'none' || isVisible) {
                                console.warn(` Tab ${tab.id} is still visible! computed=${computedDisplay}, inline=${inlineDisplay}, isVisible=${isVisible}`);
                                
                                // Check for CSS rules that might override
                                const styles = window.getComputedStyle(tab);
                                console.warn(` Tab ${tab.id} computed styles:`, {
                                    display: styles.display,
                                    visibility: styles.visibility,
                                    opacity: styles.opacity,
                                    position: styles.position,
                                    zIndex: styles.zIndex
                                });
                            }
                        }
                    });
                } else {
                    console.error(' Tab element not found for ID:', tabId);
                    // Log all available tab IDs for debugging
                    const allTabs = document.querySelectorAll('.tab-content');
                    console.log(' Available tab IDs:', Array.from(allTabs).map(t => t.id));
                }
                
                if (buttonElement) {
                    buttonElement.classList.add('active');
                    buttonElement.setAttribute('aria-selected', 'true');
                    console.log(' Activated button for tab:', tabId);
                } else if (dropdownItem) {
                    dropdownItem.classList.add('active');
                    console.log(' Activated dropdown item for tab:', tabId);
                } else {
                    console.error(' Button element not found for tab:', tabId);
                }
                
                // Handle special tab initializations - each tab loads unique content
                const merchantId = this.getMerchantId();
                
                if (tabId === 'overview') {
                    // Overview tab: Load merchant overview cards
                    console.log(' Loading Overview tab content');
                    this.loadOverviewCards();
                } else if (tabId === 'business-analytics') {
                    // Business Analytics tab: Load analytics data
                    console.log(' Loading Business Analytics tab content');
                    this.loadBusinessAnalyticsData(merchantId);
                } else if (tabId === 'risk-assessment') {
                    // Risk Assessment tab: Load risk assessment data
                    console.log(' Loading Risk Assessment tab content');
                    this.initializeRiskComponents();
                    
                    // Initialize MerchantRiskTab if not already initialized
                    if (!window.merchantRiskTab && typeof MerchantRiskTab !== 'undefined') {
                        window.merchantRiskTab = new MerchantRiskTab();
                    }
                    
                    if (window.merchantRiskTab) {
                        const container = document.getElementById('riskAssessmentContainer');
                        if (container) {
                            window.merchantRiskTab.loadRiskAssessmentContent(container).catch(error => {
                                console.error('Error loading Risk Assessment content:', error);
                                this.showRiskComponentError('riskAssessmentContainer', error);
                            });
                        }
                    }
                } else if (tabId === 'risk-indicators') {
                    // Risk Indicators tab: Load risk indicators data
                    console.log(' Loading Risk Indicators tab content');
                    if (window.riskIndicatorsTab && merchantId) {
                        window.riskIndicatorsTab.init(merchantId);
                    } else if (merchantId) {
                        // Load risk indicators data directly if component not available
                        this.loadRiskIndicatorsData(merchantId);
                    }
                }
            }
            
            /**
             * Validate merchant data structure
             */
            validateMerchantData(data) {
                if (!data || typeof data !== 'object') return false;
                // At minimum, we should have some identifying information
                return !!(data.id || data.merchantId || data.businessId || data.businessName);
            }
            
            /**
             * Normalize merchant data to ensure consistent structure
             */
            normalizeMerchantData(data) {
                if (!data || typeof data !== 'object') {
                    return {};
                }
                
                // Ensure we have at least one ID field
                const normalized = { ...data };
                if (!normalized.id && !normalized.merchantId && !normalized.businessId) {
                    // Try to extract ID from any field
                    normalized.id = normalized.id || normalized.merchantId || normalized.businessId || 
                                   normalized._id || normalized.ID || null;
                }
                
                return normalized;
            }
            
            /**
             * Validate API results structure
             */
            validateApiResults(data) {
                if (!data || typeof data !== 'object') return false;
                // API results should be an object (even if empty)
                return true;
            }
            
            /**
             * Normalize API results to ensure consistent structure
             */
            normalizeApiResults(data) {
                if (!data || typeof data !== 'object') {
                    return {};
                }
                return data;
            }
            
            /**
             * Fetch merchant data from API
             */
            async fetchMerchantDataFromAPI(merchantId) {
                if (!merchantId) {
                    console.warn(' No merchant ID provided for API fetch');
                    return;
                }
                
                try {
                    console.log(' Fetching merchant data from API for ID:', merchantId);
                    
                    const authToken = this.getAuthToken();
                    const response = await fetch(`/api/v1/merchants/${merchantId}`, {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${authToken}`,
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        console.log(' Merchant data fetched from API:', Object.keys(data));
                        
                        // Store in session storage for future use
                        sessionStorage.setItem('merchantData', JSON.stringify(data));
                        
                        // Update instance data
                        this.merchantData = data;
                        
                        // Populate UI
                        this.populateMerchantDetails();
                        setTimeout(() => this.loadOverviewCards(), 500);
                        
                        // Update merchant context if available
                        if (window.merchantContext && window.merchantContext.setMerchantContext) {
                            window.merchantContext.setMerchantContext(this.merchantData);
                        }
                        
                        // Track as real data
                        this.trackDataSource('overview', 'real');
                        this.trackDataSource('contact', 'real');
                        this.trackDataSource('financial', 'real');
                        this.trackDataSource('compliance', 'real');
                    } else {
                        console.warn(' Failed to fetch merchant data from API:', response.status, response.statusText);
                        // Fall back to mock data
                        this.handleMissingData();
                    }
                } catch (error) {
                    console.error(' Error fetching merchant data from API:', error);
                    // Fall back to mock data
                    this.handleMissingData();
                }
            }
            
            /**
             * Handle case when merchant data is missing
             */
            handleMissingData() {
                console.warn(' No merchant data available, using mock data fallback');
                // Load overview cards with mock data
                setTimeout(() => this.loadOverviewCards(), 500);
            }
            
            /**
             * Get authentication token
             */
            getAuthToken() {
                // Try to get from various sources
                return localStorage.getItem('authToken') || 
                       sessionStorage.getItem('authToken') ||
                       document.cookie.split('; ').find(row => row.startsWith('authToken='))?.split('=')[1] ||
                       null;
            }
            
            getMerchantId() {
                // Try to get from URL parameters first
                const urlParams = new URLSearchParams(window.location.search);
                const merchantIdFromUrl = urlParams.get('merchantId') || urlParams.get('id');
                if (merchantIdFromUrl) {
                    return merchantIdFromUrl;
                }
                
                // Try to get from session storage
                const merchantDataStr = sessionStorage.getItem('merchantData');
                if (merchantDataStr) {
                    try {
                        const merchantData = JSON.parse(merchantDataStr);
                        return merchantData.id || merchantData.merchantId || merchantData.businessId;
                    } catch (e) {
                        console.warn('Failed to parse merchant data from session storage:', e);
                    }
                }
                
                // Try to get from global merchant details instance
                if (this.merchantData) {
                    return this.merchantData.id || this.merchantData.merchantId || this.merchantData.businessId;
                }
                
                return null;
            }
            
            loadOverviewCards() {
                // Load all cards when overview tab is activated
                this.loadOverviewCard();
                this.loadContactCard();
                this.loadFinancialCard();
                this.loadComplianceCard();
            }
            
            loadOverviewCard() {
                const loadingEl = document.getElementById('overviewCardLoading');
                const errorEl = document.getElementById('overviewCardError');
                const dataEl = document.getElementById('overviewCardData');
                
                if (!loadingEl || !errorEl || !dataEl) return;
                
                // Show loading state
                loadingEl.classList.remove('hidden');
                errorEl.classList.add('hidden');
                dataEl.classList.add('hidden');
                
                // Simulate loading delay, then populate
                setTimeout(() => {
                    try {
                        if (this.merchantData) {
                            const businessId = this.merchantData.id || this.merchantData.businessId || this.merchantData.merchantId || '-';
                            const industry = this.merchantData.industry || this.merchantData.businessType || 'Not specified';
                            const status = this.merchantData.status || 'Active';
                            
                            document.getElementById('overviewBusinessId').textContent = businessId;
                            document.getElementById('overviewIndustry').textContent = industry;
                            document.getElementById('overviewStatus').textContent = status;
                            
                            // Track data source (real data from form)
                            this.trackDataSource('overview', 'real');
                            
                            loadingEl.classList.add('hidden');
                            dataEl.classList.remove('hidden');
                        } else {
                            // Use mock data if no merchant data available
                            document.getElementById('overviewBusinessId').textContent = 'DEMO-001';
                            document.getElementById('overviewIndustry').textContent = 'Technology';
                            document.getElementById('overviewStatus').textContent = 'Active';
                            
                            // Track as mock data
                            this.trackDataSource('overview', 'mock');
                            
                            loadingEl.classList.add('hidden');
                            dataEl.classList.remove('hidden');
                            
                            // Add tooltip for mock data
                            const cardElement = document.getElementById('overviewCard');
                            if (cardElement) {
                                this.addMockDataTooltip('overview', cardElement, this.getTooltipContent('overview'));
                            }
                        }
                    } catch (error) {
                        console.error('Error loading overview card:', error);
                        loadingEl.classList.add('hidden');
                        errorEl.classList.remove('hidden');
                    }
                }, 300);
            }
            
            loadContactCard() {
                const loadingEl = document.getElementById('contactCardLoading');
                const errorEl = document.getElementById('contactCardError');
                const dataEl = document.getElementById('contactCardData');
                
                if (!loadingEl || !errorEl || !dataEl) return;
                
                // Show loading state
                loadingEl.classList.remove('hidden');
                errorEl.classList.add('hidden');
                dataEl.classList.add('hidden');
                
                // Simulate loading delay, then populate
                setTimeout(() => {
                    try {
                        if (this.merchantData) {
                            const address = [
                                this.merchantData.streetAddress,
                                this.merchantData.city,
                                this.merchantData.state,
                                this.merchantData.postalCode
                            ].filter(Boolean).join(', ') || '-';
                            
                            document.getElementById('contactAddress').textContent = address;
                            document.getElementById('contactPhone').textContent = this.merchantData.phoneNumber || 'Not provided';
                            document.getElementById('contactEmail').textContent = this.merchantData.email || 'Not provided';
                            
                            const websiteEl = document.getElementById('contactWebsite');
                            if (this.merchantData.websiteUrl) {
                                websiteEl.innerHTML = `<a href="${this.merchantData.websiteUrl}" target="_blank" rel="noopener noreferrer" class="text-blue-600 hover:underline">${this.merchantData.websiteUrl}</a>`;
                            } else {
                                websiteEl.textContent = 'Not provided';
                            }
                            
                            // Track data source (real data from form)
                            this.trackDataSource('contact', 'real');
                            
                            loadingEl.classList.add('hidden');
                            dataEl.classList.remove('hidden');
                        } else {
                            // Use mock data if no merchant data available
                            document.getElementById('contactAddress').textContent = '123 Sample Street, City, State 12345';
                            document.getElementById('contactPhone').textContent = '+1 (555) 123-4567';
                            document.getElementById('contactEmail').textContent = 'contact@example.com';
                            document.getElementById('contactWebsite').textContent = 'https://www.example.com';
                            
                            // Track as mock data
                            this.trackDataSource('contact', 'mock');
                            
                            loadingEl.classList.add('hidden');
                            dataEl.classList.remove('hidden');
                            
                            // Add tooltip for mock data
                            const cardElement = document.getElementById('contactCard');
                            if (cardElement) {
                                this.addMockDataTooltip('contact', cardElement, this.getTooltipContent('contact'));
                            }
                        }
                    } catch (error) {
                        console.error('Error loading contact card:', error);
                        loadingEl.classList.add('hidden');
                        errorEl.classList.remove('hidden');
                    }
                }, 400);
            }
            
            loadFinancialCard() {
                const loadingEl = document.getElementById('financialCardLoading');
                const errorEl = document.getElementById('financialCardError');
                const dataEl = document.getElementById('financialCardData');
                
                if (!loadingEl || !errorEl || !dataEl) return;
                
                // Show loading state
                loadingEl.classList.remove('hidden');
                errorEl.classList.add('hidden');
                dataEl.classList.add('hidden');
                
                // Simulate loading delay, then populate
                setTimeout(() => {
                    try {
                        // Check if we have real financial data
                        const hasRealData = this.merchantData?.annualRevenue || this.merchantData?.employeeCount || this.merchantData?.foundedYear;
                        
                        if (hasRealData) {
                            document.getElementById('financialRevenue').textContent = this.merchantData.annualRevenue || 'Not disclosed';
                            document.getElementById('financialEmployees').textContent = this.merchantData.employeeCount || 'Not disclosed';
                            document.getElementById('financialFounded').textContent = this.merchantData.foundedYear || 'Not disclosed';
                            
                            // Track as real data
                            this.trackDataSource('financial', 'real');
                        } else {
                            // Use mock data
                            document.getElementById('financialRevenue').textContent = '$5,000,000 - $10,000,000';
                            document.getElementById('financialEmployees').textContent = '50-100';
                            document.getElementById('financialFounded').textContent = '2015';
                            
                            // Track as mock data
                            this.trackDataSource('financial', 'mock');
                        }
                        
                        loadingEl.classList.add('hidden');
                        dataEl.classList.remove('hidden');
                        
                        // Add tooltip for mock data
                        if (this.getDataSource('financial') === 'mock') {
                            const cardElement = document.getElementById('financialCard');
                            if (cardElement) {
                                this.addMockDataTooltip('financial', cardElement, this.getTooltipContent('financial'));
                            }
                        }
                    } catch (error) {
                        console.error('Error loading financial card:', error);
                        loadingEl.classList.add('hidden');
                        errorEl.classList.remove('hidden');
                    }
                }, 500);
            }
            
            async loadBusinessAnalyticsData(merchantId) {
                // Load business analytics data for Business Analytics tab
                console.log(' Loading Business Analytics data for merchant:', merchantId);
                
                // Check if data is already loaded from session storage
                const apiResultsStr = sessionStorage.getItem('merchantApiResults');
                if (apiResultsStr) {
                    try {
                        const apiResults = JSON.parse(apiResultsStr);
                        // Data is already populated from session storage
                        console.log(' Business Analytics data loaded from session storage');
                        return;
                    } catch (e) {
                        console.warn('Failed to parse API results from session storage:', e);
                    }
                }
                
                // If no session data, try to load from API
                if (merchantId) {
                    try {
                        // Load analytics data from API endpoint
                        const response = await fetch(`/api/v1/merchants/${merchantId}/analytics`, {
                            headers: {
                                'Authorization': `Bearer ${this.getAuthToken()}`
                            }
                        });
                        
                        if (response.ok) {
                            const data = await response.json();
                            console.log(' Business Analytics data loaded from API');
                            // Store in session for future use
                            sessionStorage.setItem('merchantAnalytics', JSON.stringify(data));
                        } else {
                            console.warn(' Analytics API endpoint not available, using session data');
                        }
                    } catch (error) {
                        console.warn(' Failed to load analytics from API, using session data:', error);
                    }
                }
            }
            
            async loadRiskIndicatorsData(merchantId) {
                // Load risk indicators data for Risk Indicators tab
                console.log(' Loading Risk Indicators data for merchant:', merchantId);
                
                if (!merchantId) {
                    console.warn(' No merchant ID available for risk indicators');
                    return;
                }
                
                try {
                    // Load risk indicators from API endpoint
                    const response = await fetch(`/api/v1/merchants/${merchantId}/risk-indicators`, {
                        headers: {
                            'Authorization': `Bearer ${this.getAuthToken()}`
                        }
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        console.log(' Risk Indicators data loaded from API');
                        // Update risk indicators display
                        this.updateRiskIndicatorsDisplay(data);
                    } else {
                        console.warn(' Risk Indicators API endpoint not available');
                        this.showRiskIndicatorsPlaceholder();
                    }
                } catch (error) {
                    console.warn(' Failed to load risk indicators from API:', error);
                    this.showRiskIndicatorsPlaceholder();
                }
            }
            
            updateRiskIndicatorsDisplay(data) {
                // Update risk indicators tab with loaded data
                const container = document.getElementById('risk-indicators');
                if (!container) return;
                
                // Implementation would update the risk indicators display
                // This is a placeholder for future implementation
                console.log(' Updating Risk Indicators display with data:', data);
            }
            
            showRiskIndicatorsPlaceholder() {
                // Show placeholder message when risk indicators data is not available
                const container = document.getElementById('risk-indicators');
                if (!container) return;
                
                const placeholder = container.querySelector('.risk-indicators-placeholder');
                if (placeholder) {
                    placeholder.innerHTML = `
                        <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                            <p class="text-sm text-yellow-700">Risk indicators data will be available once assessment is complete.</p>
                        </div>
                    `;
                }
            }
            
            loadComplianceCard() {
                const loadingEl = document.getElementById('complianceCardLoading');
                const errorEl = document.getElementById('complianceCardError');
                const dataEl = document.getElementById('complianceCardData');
                
                if (!loadingEl || !errorEl || !dataEl) return;
                
                // Show loading state
                loadingEl.classList.remove('hidden');
                errorEl.classList.add('hidden');
                dataEl.classList.add('hidden');
                
                // Simulate loading delay, then populate
                setTimeout(() => {
                    try {
                        // Check if we have real compliance data
                        const hasRealData = this.merchantData?.kybStatus || this.merchantData?.lastVerification || this.merchantData?.complianceScore;
                        
                        if (hasRealData) {
                            const status = this.merchantData.kybStatus || 'Verified';
                            document.getElementById('complianceStatus').textContent = status;
                            document.getElementById('complianceLastVerification').textContent = this.merchantData.lastVerification || '-';
                            document.getElementById('complianceScore').textContent = this.merchantData.complianceScore || '-';
                            
                            // Track as real data
                            this.trackDataSource('compliance', 'real');
                        } else {
                            // Use mock data
                            document.getElementById('complianceStatus').textContent = 'Verified';
                            document.getElementById('complianceLastVerification').textContent = new Date().toLocaleDateString();
                            document.getElementById('complianceScore').textContent = '95%';
                            
                            // Track as mock data
                            this.trackDataSource('compliance', 'mock');
                        }
                        
                        loadingEl.classList.add('hidden');
                        dataEl.classList.remove('hidden');
                        
                        // Add tooltip for mock data
                        if (this.getDataSource('compliance') === 'mock') {
                            const cardElement = document.getElementById('complianceCard');
                            if (cardElement) {
                                this.addMockDataTooltip('compliance', cardElement, this.getTooltipContent('compliance'));
                            }
                        }
                    } catch (error) {
                        console.error('Error loading compliance card:', error);
                        loadingEl.classList.add('hidden');
                        errorEl.classList.remove('hidden');
                    }
                }, 600);
            }
            
            /**
             * Populate Security Details expandable section
             */
            populateSecurityDetails(container) {
                if (!container) return;
                
                const data = this.apiResults?.securityIndicators || this.apiResults?.security || {};
                const hasRealData = Object.keys(data).length > 0;
                
                if (hasRealData) {
                    this.trackDataSource('securityDetails', 'real');
                } else {
                    this.trackDataSource('securityDetails', 'mock');
                }
                
                const securityData = hasRealData ? data : {
                    sslStatus: 'Valid',
                    certificateValid: true,
                    securityHeaders: ['HSTS', 'CSP', 'X-Frame-Options'],
                    trustScore: 0.95,
                    lastScan: new Date().toISOString()
                };
                
                container.innerHTML = `
                    <div class="space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="bg-gray-50 rounded-lg p-4">
                                <h5 class="font-medium text-gray-900 mb-2">SSL Certificate</h5>
                                <p class="text-sm text-gray-600">Status: <span class="font-semibold text-green-600">${securityData.sslStatus || 'Valid'}</span></p>
                                <p class="text-sm text-gray-600 mt-1">Certificate Valid: <span class="font-semibold">${securityData.certificateValid ? 'Yes' : 'No'}</span></p>
                            </div>
                            <div class="bg-gray-50 rounded-lg p-4">
                                <h5 class="font-medium text-gray-900 mb-2">Security Headers</h5>
                                <div class="flex flex-wrap gap-2 mt-2">
                                    ${(securityData.securityHeaders || []).map(header => 
                                        `<span class="bg-blue-100 text-blue-800 text-xs font-medium px-2 py-1 rounded">${this.escapeHtml(header)}</span>`
                                    ).join('')}
                                </div>
                            </div>
                        </div>
                        <div class="bg-gray-50 rounded-lg p-4">
                            <h5 class="font-medium text-gray-900 mb-2">Trust Score</h5>
                            <div class="flex items-center gap-4">
                                <div class="flex-1">
                                    <div class="w-full bg-gray-200 rounded-full h-2">
                                        <div class="bg-green-600 h-2 rounded-full" style="width: ${(securityData.trustScore || 0.95) * 100}%"></div>
                                    </div>
                                </div>
                                <span class="text-sm font-semibold text-gray-900">${Math.round((securityData.trustScore || 0.95) * 100)}%</span>
                            </div>
                        </div>
                        ${hasRealData ? '' : this.getMockDataIndicator('security')}
                    </div>
                `;
            }
            
            /**
             * Populate Quality Details expandable section
             */
            populateQualityDetails(container) {
                if (!container) return;
                
                const data = this.apiResults?.qualityMetrics || this.apiResults?.quality || {};
                const hasRealData = Object.keys(data).length > 0;
                
                if (hasRealData) {
                    this.trackDataSource('qualityDetails', 'real');
                } else {
                    this.trackDataSource('qualityDetails', 'mock');
                }
                
                const qualityData = hasRealData ? data : {
                    completeness: 0.85,
                    accuracy: 0.92,
                    consistency: 0.78,
                    timeliness: 0.90,
                    sources: 5
                };
                
                container.innerHTML = `
                    <div class="space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="bg-gray-50 rounded-lg p-4">
                                <h5 class="font-medium text-gray-900 mb-3">Data Completeness</h5>
                                <div class="flex items-center gap-4">
                                    <div class="flex-1">
                                        <div class="w-full bg-gray-200 rounded-full h-2">
                                            <div class="bg-blue-600 h-2 rounded-full" style="width: ${(qualityData.completeness || 0.85) * 100}%"></div>
                                        </div>
                                    </div>
                                    <span class="text-sm font-semibold text-gray-900">${Math.round((qualityData.completeness || 0.85) * 100)}%</span>
                                </div>
                            </div>
                            <div class="bg-gray-50 rounded-lg p-4">
                                <h5 class="font-medium text-gray-900 mb-3">Data Accuracy</h5>
                                <div class="flex items-center gap-4">
                                    <div class="flex-1">
                                        <div class="w-full bg-gray-200 rounded-full h-2">
                                            <div class="bg-green-600 h-2 rounded-full" style="width: ${(qualityData.accuracy || 0.92) * 100}%"></div>
                                        </div>
                                    </div>
                                    <span class="text-sm font-semibold text-gray-900">${Math.round((qualityData.accuracy || 0.92) * 100)}%</span>
                                </div>
                            </div>
                            <div class="bg-gray-50 rounded-lg p-4">
                                <h5 class="font-medium text-gray-900 mb-3">Data Consistency</h5>
                                <div class="flex items-center gap-4">
                                    <div class="flex-1">
                                        <div class="w-full bg-gray-200 rounded-full h-2">
                                            <div class="bg-yellow-600 h-2 rounded-full" style="width: ${(qualityData.consistency || 0.78) * 100}%"></div>
                                        </div>
                                    </div>
                                    <span class="text-sm font-semibold text-gray-900">${Math.round((qualityData.consistency || 0.78) * 100)}%</span>
                                </div>
                            </div>
                            <div class="bg-gray-50 rounded-lg p-4">
                                <h5 class="font-medium text-gray-900 mb-3">Data Timeliness</h5>
                                <div class="flex items-center gap-4">
                                    <div class="flex-1">
                                        <div class="w-full bg-gray-200 rounded-full h-2">
                                            <div class="bg-purple-600 h-2 rounded-full" style="width: ${(qualityData.timeliness || 0.90) * 100}%"></div>
                                        </div>
                                    </div>
                                    <span class="text-sm font-semibold text-gray-900">${Math.round((qualityData.timeliness || 0.90) * 100)}%</span>
                                </div>
                            </div>
                        </div>
                        <div class="bg-gray-50 rounded-lg p-4">
                            <h5 class="font-medium text-gray-900 mb-2">Data Sources</h5>
                            <p class="text-sm text-gray-600">Number of sources: <span class="font-semibold">${qualityData.sources || 5}</span></p>
                        </div>
                        ${hasRealData ? '' : this.getMockDataIndicator('quality')}
                    </div>
                `;
            }
            
            /**
             * Populate Risk Details expandable section
             */
            populateRiskDetails(container) {
                if (!container) return;
                
                const data = this.apiResults?.riskAssessment || this.apiResults?.risk || {};
                const hasRealData = Object.keys(data).length > 0;
                
                if (hasRealData) {
                    this.trackDataSource('riskDetails', 'real');
                } else {
                    this.trackDataSource('riskDetails', 'mock');
                }
                
                const riskData = hasRealData ? data : {
                    complianceRisk: { level: 'Low', score: 0.2, factors: ['No regulatory violations', 'Clean compliance history'] },
                    financialRisk: { level: 'Low', score: 0.15, factors: ['Stable revenue', 'Good credit rating'] },
                    operationalRisk: { level: 'Medium', score: 0.45, factors: ['Limited operational history', 'Growing business'] }
                };
                
                container.innerHTML = `
                    <div class="space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div class="bg-gray-50 rounded-lg p-4">
                                <h5 class="font-medium text-gray-900 mb-2">Compliance Risk</h5>
                                <p class="text-sm text-gray-600 mb-2">Level: <span class="font-semibold text-green-600">${riskData.complianceRisk?.level || 'Low'}</span></p>
                                <p class="text-sm text-gray-600 mb-3">Score: <span class="font-semibold">${((riskData.complianceRisk?.score || 0.2) * 100).toFixed(0)}%</span></p>
                                <ul class="text-xs text-gray-600 space-y-1">
                                    ${(riskData.complianceRisk?.factors || []).map(factor => 
                                        `<li> ${this.escapeHtml(factor)}</li>`
                                    ).join('')}
                                </ul>
                            </div>
                            <div class="bg-gray-50 rounded-lg p-4">
                                <h5 class="font-medium text-gray-900 mb-2">Financial Risk</h5>
                                <p class="text-sm text-gray-600 mb-2">Level: <span class="font-semibold text-green-600">${riskData.financialRisk?.level || 'Low'}</span></p>
                                <p class="text-sm text-gray-600 mb-3">Score: <span class="font-semibold">${((riskData.financialRisk?.score || 0.15) * 100).toFixed(0)}%</span></p>
                                <ul class="text-xs text-gray-600 space-y-1">
                                    ${(riskData.financialRisk?.factors || []).map(factor => 
                                        `<li> ${this.escapeHtml(factor)}</li>`
                                    ).join('')}
                                </ul>
                            </div>
                            <div class="bg-gray-50 rounded-lg p-4">
                                <h5 class="font-medium text-gray-900 mb-2">Operational Risk</h5>
                                <p class="text-sm text-gray-600 mb-2">Level: <span class="font-semibold text-yellow-600">${riskData.operationalRisk?.level || 'Medium'}</span></p>
                                <p class="text-sm text-gray-600 mb-3">Score: <span class="font-semibold">${((riskData.operationalRisk?.score || 0.45) * 100).toFixed(0)}%</span></p>
                                <ul class="text-xs text-gray-600 space-y-1">
                                    ${(riskData.operationalRisk?.factors || []).map(factor => 
                                        `<li> ${this.escapeHtml(factor)}</li>`
                                    ).join('')}
                                </ul>
                            </div>
                        </div>
                        ${hasRealData ? '' : this.getMockDataIndicator('risk')}
                    </div>
                `;
            }
            
            /**
             * Populate Intelligence Details expandable section
             */
            populateIntelligenceDetails(container) {
                if (!container) return;
                
                const data = this.apiResults?.businessIntelligence || this.apiResults?.intelligence || {};
                const hasRealData = Object.keys(data).length > 0;
                
                if (hasRealData) {
                    this.trackDataSource('intelligenceDetails', 'real');
                } else {
                    this.trackDataSource('intelligenceDetails', 'mock');
                }
                
                const intelligenceData = hasRealData ? data : {
                    marketPosition: 'Established',
                    growthTrend: 'Positive',
                    competitiveAdvantage: ['Strong brand', 'Market leadership'],
                    industryInsights: ['Growing market', 'High demand']
                };
                
                container.innerHTML = `
                    <div class="space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="bg-gray-50 rounded-lg p-4">
                                <h5 class="font-medium text-gray-900 mb-2">Market Position</h5>
                                <p class="text-sm text-gray-600">${intelligenceData.marketPosition || 'Established'}</p>
                            </div>
                            <div class="bg-gray-50 rounded-lg p-4">
                                <h5 class="font-medium text-gray-900 mb-2">Growth Trend</h5>
                                <p class="text-sm text-gray-600">${intelligenceData.growthTrend || 'Positive'}</p>
                            </div>
                        </div>
                        <div class="bg-gray-50 rounded-lg p-4">
                            <h5 class="font-medium text-gray-900 mb-2">Competitive Advantages</h5>
                            <div class="flex flex-wrap gap-2 mt-2">
                                ${(intelligenceData.competitiveAdvantage || []).map(advantage => 
                                    `<span class="bg-green-100 text-green-800 text-xs font-medium px-2 py-1 rounded">${this.escapeHtml(advantage)}</span>`
                                ).join('')}
                            </div>
                        </div>
                        <div class="bg-gray-50 rounded-lg p-4">
                            <h5 class="font-medium text-gray-900 mb-2">Industry Insights</h5>
                            <ul class="text-sm text-gray-600 space-y-1 mt-2">
                                ${(intelligenceData.industryInsights || []).map(insight => 
                                    `<li> ${this.escapeHtml(insight)}</li>`
                                ).join('')}
                            </ul>
                        </div>
                        ${hasRealData ? '' : this.getMockDataIndicator('intelligence')}
                    </div>
                `;
            }
            
            /**
             * Populate Verification Details expandable section
             */
            populateVerificationDetails(container) {
                if (!container) return;
                
                const data = this.apiResults?.verification || this.merchantData?.verification || {};
                const hasRealData = Object.keys(data).length > 0;
                
                if (hasRealData) {
                    this.trackDataSource('verificationDetails', 'real');
                } else {
                    this.trackDataSource('verificationDetails', 'mock');
                }
                
                const verificationData = hasRealData ? data : {
                    steps: [
                        { name: 'Identity Verification', status: 'Complete', timestamp: new Date().toISOString() },
                        { name: 'Address Verification', status: 'Complete', timestamp: new Date().toISOString() },
                        { name: 'Business Registration Check', status: 'Complete', timestamp: new Date().toISOString() },
                        { name: 'Compliance Screening', status: 'Complete', timestamp: new Date().toISOString() }
                    ],
                    overallStatus: 'Verified',
                    verificationDate: new Date().toISOString()
                };
                
                container.innerHTML = `
                    <div class="space-y-4">
                        <div class="bg-gray-50 rounded-lg p-4">
                            <h5 class="font-medium text-gray-900 mb-3">Verification Steps</h5>
                            <div class="space-y-3">
                                ${(verificationData.steps || []).map((step, index) => `
                                    <div class="flex items-center justify-between p-3 bg-white rounded-lg border border-gray-200">
                                        <div class="flex items-center gap-3">
                                            <div class="w-8 h-8 bg-green-100 rounded-full flex items-center justify-center">
                                                <i class="fas fa-check text-green-600 text-xs"></i>
                                            </div>
                                            <div>
                                                <p class="text-sm font-medium text-gray-900">${this.escapeHtml(step.name)}</p>
                                                <p class="text-xs text-gray-500">${step.timestamp ? new Date(step.timestamp).toLocaleDateString() : 'N/A'}</p>
                                            </div>
                                        </div>
                                        <span class="text-xs font-semibold text-green-600">${step.status || 'Complete'}</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        <div class="bg-gray-50 rounded-lg p-4">
                            <h5 class="font-medium text-gray-900 mb-2">Overall Status</h5>
                            <p class="text-sm text-gray-600">Status: <span class="font-semibold text-green-600">${verificationData.overallStatus || 'Verified'}</span></p>
                            <p class="text-sm text-gray-600 mt-1">Verification Date: <span class="font-semibold">${verificationData.verificationDate ? new Date(verificationData.verificationDate).toLocaleDateString() : 'N/A'}</span></p>
                        </div>
                        ${hasRealData ? '' : this.getMockDataIndicator('verification')}
                    </div>
                `;
            }
            
            /**
             * Get mock data indicator HTML
             */
            getMockDataIndicator(sectionType) {
                if (!this.tooltip) return '';
                
                return `
                    <div class="mt-4 p-3 bg-yellow-50 border border-yellow-200 rounded-lg">
                        <p class="text-xs text-yellow-700">
                            <i class="fas fa-info-circle mr-1"></i>
                            This section contains sample data for demonstration purposes.
                        </p>
                    </div>
                `;
            }
            
            /**
             * Escape HTML to prevent XSS
             */
            escapeHtml(text) {
                if (text == null) return '';
                const div = document.createElement('div');
                div.textContent = String(text);
                return div.innerHTML;
            }

            initializeComponents() {
                // Initialize navigation if available
                if (typeof KYBNavigation !== 'undefined') {
                    new KYBNavigation();
                }
                
                // Initialize merchant context if available
                if (typeof MerchantContext !== 'undefined') {
                    window.merchantContext = new MerchantContext({
                        showInHeader: true,
                        showInSidebar: false,
                        enableQuickSwitch: true
                    });
                    // Set merchant context when data is loaded
                    if (this.merchantData) {
                        window.merchantContext.setMerchantContext(this.merchantData);
                    }
                }
                
                // Initialize session manager if available
                if (typeof SessionManager !== 'undefined') {
                    new SessionManager();
                }
                
                // Initialize mock data warning if available
                // Mock data tooltip system is initialized in initializeTooltip()
                // No global warning banner needed - tooltips are shown on individual cards
                
                // Initialize coming soon banner if available
                if (typeof ComingSoonBanner !== 'undefined') {
                    new ComingSoonBanner();
                }
                
                // Initialize export buttons
                this.initializeExportButtons();
                
                // Initialize data enrichment
                this.initializeDataEnrichment();
                
                // Initialize external data sources
                this.initializeExternalDataSources();
                
                // Initialize fixed footer buttons
                this.initializeFooterButtons();
            }
            
            initializeExternalDataSources() {
                if (typeof ExternalDataSources === 'undefined') {
                    return;
                }
                
                const container = document.getElementById('externalDataSourcesContainer');
                if (!container) return;
                
                const loadingEl = document.getElementById('externalDataSourcesLoading');
                const errorEl = document.getElementById('externalDataSourcesError');
                const contentEl = document.getElementById('externalDataSourcesContent');
                
                // Show loading state
                if (loadingEl) loadingEl.classList.remove('hidden');
                if (errorEl) errorEl.classList.add('hidden');
                if (contentEl) contentEl.classList.add('hidden');
                
                try {
                    // Initialize ExternalDataSources component
                    window.externalDataSources = new ExternalDataSources('externalDataSourcesContainer');
                    window.externalDataSources.init().then(() => {
                        // Add tooltip to External Data Sources card
                        const externalDataSourcesCard = document.getElementById('externalDataSourcesCard');
                        if (externalDataSourcesCard && this.tooltip) {
                            this.addMockDataTooltip('externalDataSources', externalDataSourcesCard, this.getTooltipContent('externalDataSources'));
                        }
                        // Hide loading, show content
                        if (loadingEl) loadingEl.classList.add('hidden');
                        if (contentEl) contentEl.classList.remove('hidden');
                    }).catch(error => {
                        console.error('Error initializing external data sources:', error);
                        if (loadingEl) loadingEl.classList.add('hidden');
                        if (errorEl) errorEl.classList.remove('hidden');
                    });
                } catch (error) {
                    console.error('Error creating ExternalDataSources component:', error);
                    if (loadingEl) loadingEl.classList.add('hidden');
                    if (errorEl) errorEl.classList.remove('hidden');
                }
            }
            
            initializeFooterButtons() {
                const historyBtn = document.getElementById('footerHistoryBtn');
                const endSessionBtn = document.getElementById('footerEndSessionBtn');
                
                if (historyBtn) {
                    historyBtn.addEventListener('click', () => {
                        this.navigateToHistory();
                    });
                    // Enable button
                    historyBtn.disabled = false;
                }
                
                if (endSessionBtn) {
                    endSessionBtn.addEventListener('click', () => {
                        this.endSession();
                    });
                    // Enable button
                    endSessionBtn.disabled = false;
                }
            }
            
            navigateToHistory() {
                // Navigate to history page (session history view)
                // Check if there's a history page route, otherwise show session history modal
                if (typeof SessionManager !== 'undefined') {
                    // Try to use SessionManager's history functionality
                    const sessionManager = document.querySelector('#sessionManagerContainer');
                    if (sessionManager) {
                        const historyBtn = document.getElementById('sessionHistoryBtn');
                        if (historyBtn) {
                            historyBtn.click();
                        }
                    } else {
                        // Navigate to a history page if it exists
                        window.location.href = '/session-history.html';
                    }
                } else {
                    // Fallback: navigate to dashboard or show alert
                    const confirmed = confirm('Session history feature is not available. Would you like to go to the dashboard?');
                    if (confirmed) {
                        window.location.href = '/dashboard-hub.html';
                    }
                }
            }
            
            endSession() {
                // Clear current session data and redirect to dashboard
                const confirmed = confirm('Are you sure you want to end the current session? All unsaved data will be lost.');
                if (confirmed) {
                    // Clear session storage
                    sessionStorage.removeItem('merchantData');
                    sessionStorage.removeItem('merchantApiResults');
                    sessionStorage.removeItem('merchant_session');
                    
                    // Clear any other session-related data
                    if (typeof SessionManager !== 'undefined') {
                        const sessionManager = document.querySelector('#sessionManagerContainer');
                        if (sessionManager) {
                            const endSessionBtn = document.getElementById('endSessionBtn');
                            if (endSessionBtn) {
                                endSessionBtn.click();
                                return; // SessionManager will handle the redirect
                            }
                        }
                    }
                    
                    // Redirect to dashboard
                    window.location.href = '/dashboard-hub.html';
                }
            }
            
            initializeExportButtons() {
                if (typeof ExportButton === 'undefined') {
                    return;
                }
                
                // Risk Assessment export button
                const riskExportContainer = document.getElementById('riskExportButtonContainer');
                if (riskExportContainer) {
                    const riskExportButton = new ExportButton({
                        container: riskExportContainer,
                        exportType: 'risk',
                        formats: ['csv', 'pdf', 'json', 'excel'],
                        onExportStart: (format) => {
                            console.log(`Starting risk ${format} export...`);
                        },
                        onExportComplete: (format, result) => {
                            console.log(`Risk export completed: ${format}`, result);
                        },
                        onExportError: (format, error) => {
                            console.error(`Risk export failed: ${format}`, error);
                            alert(`Risk export failed: ${error.message}`);
                        }
                    });
                    riskExportButton.init();
                }
                
                // Business Analytics export button
                const businessAnalyticsExportContainer = document.getElementById('businessAnalyticsExportButtonContainer');
                if (businessAnalyticsExportContainer) {
                    const businessAnalyticsExportButton = new ExportButton({
                        container: businessAnalyticsExportContainer,
                        exportType: 'analytics',
                        formats: ['csv', 'pdf', 'json', 'excel'],
                        onExportStart: (format) => {
                            console.log(`Starting business analytics ${format} export...`);
                        },
                        onExportComplete: (format, result) => {
                            console.log(`Business analytics export completed: ${format}`, result);
                        },
                        onExportError: (format, error) => {
                            console.error(`Business analytics export failed: ${format}`, error);
                            alert(`Business analytics export failed: ${error.message}`);
                        }
                    });
                    businessAnalyticsExportButton.init();
                }
                
                // Risk Indicators export button
                const riskIndicatorsExportContainer = document.getElementById('riskIndicatorsExportButtonContainer');
                if (riskIndicatorsExportContainer) {
                    const riskIndicatorsExportButton = new ExportButton({
                        container: riskIndicatorsExportContainer,
                        exportType: 'risk-indicators',
                        formats: ['csv', 'pdf', 'json', 'excel'],
                        onExportStart: (format) => {
                            console.log(`Starting risk indicators ${format} export...`);
                        },
                        onExportComplete: (format, result) => {
                            console.log(`Risk indicators export completed: ${format}`, result);
                        },
                        onExportError: (format, error) => {
                            console.error(`Risk indicators export failed: ${format}`, error);
                            alert(`Risk indicators export failed: ${error.message}`);
                        }
                    });
                    riskIndicatorsExportButton.init();
                }
            }
            
            initializeDataEnrichment() {
                if (typeof DataEnrichment === 'undefined') {
                    return;
                }
                
                const merchantId = this.getMerchantId();
                if (merchantId) {
                    window.dataEnrichment = new DataEnrichment(merchantId);
                    window.dataEnrichment.init().then(() => {
                        this.populateDataEnrichmentUI();
                    }).catch(error => {
                        console.error('Error initializing data enrichment:', error);
                        this.showDataEnrichmentError();
                    });
                }
            }
            
            populateDataEnrichmentUI() {
                const loadingEl = document.getElementById('dataEnrichmentLoading');
                const errorEl = document.getElementById('dataEnrichmentError');
                const contentEl = document.getElementById('dataEnrichmentContent');
                
                // Add tooltip to Data Enrichment card
                const dataEnrichmentCard = document.getElementById('dataEnrichmentCard');
                if (dataEnrichmentCard && this.tooltip) {
                    this.addMockDataTooltip('dataEnrichment', dataEnrichmentCard, this.getTooltipContent('dataEnrichment'));
                }
                const sourcesList = document.getElementById('enrichmentSourcesList');
                const triggerBtn = document.getElementById('triggerEnrichmentBtn');
                
                if (!loadingEl || !errorEl || !contentEl || !sourcesList || !triggerBtn) return;
                
                try {
                    // Hide loading, show content
                    loadingEl.classList.add('hidden');
                    errorEl.classList.add('hidden');
                    contentEl.classList.remove('hidden');
                    
                    // Get supported sources from DataEnrichment component
                    const sources = window.dataEnrichment?.supportedSources || [
                        { name: 'Thomson Reuters', id: 'thomson-reuters', available: true },
                        { name: 'Industry Data', id: 'industry', available: true },
                        { name: 'Query Service', id: 'query', available: true }
                    ];
                    
                    // Populate sources list
                    if (sources.length > 0) {
                        sourcesList.innerHTML = sources.map(source => `
                            <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg mb-2">
                                <div class="flex items-center">
                                    <i class="fas fa-check-circle text-green-600 mr-2"></i>
                                    <span class="text-sm font-medium text-gray-900">${source.name}</span>
                                </div>
                                <span class="text-xs text-gray-500">${source.available ? 'Available' : 'Unavailable'}</span>
                            </div>
                        `).join('');
                        
                        // Enable trigger button if at least one source is available
                        const hasAvailableSource = sources.some(s => s.available);
                        triggerBtn.disabled = !hasAvailableSource;
                    } else {
                        sourcesList.innerHTML = '<p class="text-sm text-gray-500">No enrichment sources available</p>';
                        triggerBtn.disabled = true;
                    }
                    
                    // Add click handler for trigger button
                    triggerBtn.addEventListener('click', () => {
                        this.triggerDataEnrichment();
                    });
                } catch (error) {
                    console.error('Error populating data enrichment UI:', error);
                    this.showDataEnrichmentError();
                }
            }
            
            showDataEnrichmentError() {
                const loadingEl = document.getElementById('dataEnrichmentLoading');
                const errorEl = document.getElementById('dataEnrichmentError');
                const contentEl = document.getElementById('dataEnrichmentContent');
                
                if (loadingEl) loadingEl.classList.add('hidden');
                if (contentEl) contentEl.classList.add('hidden');
                if (errorEl) errorEl.classList.remove('hidden');
            }
            
            async triggerDataEnrichment() {
                const triggerBtn = document.getElementById('triggerEnrichmentBtn');
                const resultsEl = document.getElementById('enrichmentResults');
                
                if (!triggerBtn || !window.dataEnrichment) return;
                
                // Disable button and show loading
                triggerBtn.disabled = true;
                triggerBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Enriching...';
                
                try {
                    // Get first available source
                    const sources = window.dataEnrichment.supportedSources || [];
                    const availableSource = sources.find(s => s.available);
                    const sourceId = availableSource ? availableSource.id : 'thomson-reuters';
                    
                    // Trigger enrichment
                    const result = await window.dataEnrichment.enrichData(sourceId);
                    
                    // Show results
                    if (resultsEl) {
                        resultsEl.classList.remove('hidden');
                        resultsEl.innerHTML = `
                            <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                                <div class="flex items-center mb-2">
                                    <i class="fas fa-check-circle text-green-600 mr-2"></i>
                                    <h4 class="font-semibold text-green-900">Enrichment Complete</h4>
                                </div>
                                <p class="text-sm text-green-700">Data has been successfully enriched from ${availableSource?.name || sourceId}.</p>
                            </div>
                        `;
                    }
                    
                    // Re-enable button
                    triggerBtn.disabled = false;
                    triggerBtn.innerHTML = '<i class="fas fa-sync mr-2"></i>Enrich Data';
                } catch (error) {
                    console.error('Error triggering enrichment:', error);
                    
                    // Show error
                    if (resultsEl) {
                        resultsEl.classList.remove('hidden');
                        resultsEl.innerHTML = `
                            <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                                <div class="flex items-center mb-2">
                                    <i class="fas fa-exclamation-circle text-red-600 mr-2"></i>
                                    <h4 class="font-semibold text-red-900">Enrichment Failed</h4>
                                </div>
                                <p class="text-sm text-red-700">${error.message || 'Failed to enrich data. Please try again.'}</p>
                            </div>
                        `;
                    }
                    
                    // Re-enable button
                    triggerBtn.disabled = false;
                    triggerBtn.innerHTML = '<i class="fas fa-sync mr-2"></i>Enrich Data';
                }
            }

            showError(message) {
                console.error(message);
                // You can implement a proper error display here
            }
        }

        // Global functions for expandable sections
        // Enhanced toggleSection function with loading states and smooth animations
        function toggleSection(sectionId) {
            const section = document.getElementById(sectionId);
            if (!section) {
                console.warn(`Section ${sectionId} not found`);
                return;
            }
            
            const isExpanded = section.classList.contains('expanded');
            const button = document.querySelector(`[onclick="toggleSection('${sectionId}')"]`);
            
            if (!isExpanded) {
                // Expanding: Show loading state and populate content
                showSectionLoading(sectionId);
                
                // Populate section content based on section ID
                populateExpandableSection(sectionId).then(() => {
                    // Content loaded, hide loading and show content
                    hideSectionLoading(sectionId);
                    section.classList.add('expanded');
                    updateToggleButton(button, true);
                }).catch(error => {
                    console.error(`Error populating section ${sectionId}:`, error);
                    showSectionError(sectionId);
                    hideSectionLoading(sectionId);
                });
            } else {
                // Collapsing: Just toggle the class
                section.classList.remove('expanded');
                updateToggleButton(button, false);
            }
        }
        
        // Show loading state for expandable section
        function showSectionLoading(sectionId) {
            const section = document.getElementById(sectionId);
            if (!section) return;
            
            const contentContainer = section.querySelector('[id$="Content"]');
            if (contentContainer) {
                contentContainer.innerHTML = `
                    <div class="flex items-center justify-center py-8">
                        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
                        <span class="ml-3 text-sm text-gray-600">Loading...</span>
                    </div>
                `;
            }
        }
        
        // Hide loading state
        function hideSectionLoading(sectionId) {
            const section = document.getElementById(sectionId);
            if (!section) return;
            
            // Loading state will be replaced by content
        }
        
        // Show error state
        function showSectionError(sectionId) {
            const section = document.getElementById(sectionId);
            if (!section) return;
            
            const contentContainer = section.querySelector('[id$="Content"]');
            if (contentContainer) {
                contentContainer.innerHTML = `
                    <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                        <p class="text-sm text-red-700">Failed to load section content. Please try again.</p>
                    </div>
                `;
            }
        }
        
        // Update toggle button text and icon
        function updateToggleButton(button, isExpanded) {
            if (!button) return;
            
            const icon = button.querySelector('i');
            if (icon) {
                if (isExpanded) {
                    icon.classList.remove('fa-chevron-down');
                    icon.classList.add('fa-chevron-up');
                } else {
                    icon.classList.remove('fa-chevron-up');
                    icon.classList.add('fa-chevron-down');
                }
            }
            
            const text = button.textContent.trim();
            if (text.includes('Show')) {
                button.innerHTML = button.innerHTML.replace('Show Details', 'Hide Details');
            } else if (text.includes('Hide')) {
                button.innerHTML = button.innerHTML.replace('Hide Details', 'Show Details');
            }
        }
        
        // Populate expandable section content
        async function populateExpandableSection(sectionId) {
            // Check if content is already populated
            const section = document.getElementById(sectionId);
            if (!section) return;
            
            const contentContainer = section.querySelector('[id$="Content"]');
            if (!contentContainer) return;
            
            // Check if content is already loaded (has content beyond loading state)
            if (contentContainer.innerHTML.trim() && 
                !contentContainer.innerHTML.includes('Loading...') && 
                !contentContainer.innerHTML.includes('Populated by JavaScript')) {
                return; // Content already loaded
            }
            
            // Get merchant details instance
            const merchantDetails = window.merchantDetails;
            if (!merchantDetails) {
                throw new Error('MerchantDetails instance not found');
            }
            
            // Populate based on section ID
            switch (sectionId) {
                case 'coreDetails':
                    // Already populated by populateApiResults
                    return;
                case 'securityDetails':
                    merchantDetails.populateSecurityDetails(contentContainer);
                    break;
                case 'qualityDetails':
                    merchantDetails.populateQualityDetails(contentContainer);
                    break;
                case 'riskDetails':
                    merchantDetails.populateRiskDetails(contentContainer);
                    break;
                case 'intelligenceDetails':
                    merchantDetails.populateIntelligenceDetails(contentContainer);
                    break;
                case 'verificationDetails':
                    merchantDetails.populateVerificationDetails(contentContainer);
                    break;
                default:
                    console.warn(`Unknown section ID: ${sectionId}`);
            }
        }

        // DOM Structure Diagnostic - Check for Business Analytics content outside tab system
        const diagnoseBusinessAnalyticsContent = () => {
            console.log(' ========== BUSINESS ANALYTICS CONTENT DIAGNOSTIC ==========');
            
            // Check if Business Analytics content exists in #business-analytics tab
            const businessAnalyticsTab = document.getElementById('business-analytics');
            const coreResults = document.getElementById('coreResults');
            const isCoreResultsInTab = businessAnalyticsTab && coreResults ? businessAnalyticsTab.contains(coreResults) : false;
            
            console.log(' #business-analytics tab:');
            console.log('  - exists:', !!businessAnalyticsTab);
            console.log('  - display:', businessAnalyticsTab ? window.getComputedStyle(businessAnalyticsTab).display : 'N/A');
            console.log('  - inlineDisplay:', businessAnalyticsTab ? businessAnalyticsTab.style.display : 'N/A');
            console.log('  - hasActive class:', businessAnalyticsTab ? businessAnalyticsTab.classList.contains('active') : false);
            console.log('  - visible (offsetParent):', businessAnalyticsTab ? businessAnalyticsTab.offsetParent !== null : false);
            console.log('  - children count:', businessAnalyticsTab ? businessAnalyticsTab.children.length : 0);
            console.log('  - containsCoreResults:', isCoreResultsInTab);
            
            if (!isCoreResultsInTab && coreResults) {
                console.warn(' CRITICAL: #coreResults is NOT inside #business-analytics tab!');
                console.warn(' This means the content is outside the tab system!');
                
                // Find where #coreResults actually is
                let parent = coreResults.parentElement;
                let parentChain = [];
                while (parent && parent !== document.body) {
                    parentChain.push({
                        tag: parent.tagName,
                        id: parent.id || 'N/A',
                        classes: parent.className || 'N/A'
                    });
                    parent = parent.parentElement;
                }
                console.warn(' #coreResults parent chain:', parentChain);
            }
            
            // Check for Core Classification Results (coreResults already declared above)
            console.log(' #coreResults element:', {
                exists: !!coreResults,
                parent: coreResults ? coreResults.parentElement.id : 'N/A',
                parentDisplay: coreResults ? window.getComputedStyle(coreResults.parentElement).display : 'N/A',
                visible: coreResults ? coreResults.offsetParent !== null : false,
                display: coreResults ? window.getComputedStyle(coreResults).display : 'N/A'
            });
            
            // Check for dashboardResults
            const dashboardResults = document.getElementById('dashboardResults');
            console.log(' #dashboardResults element:', {
                exists: !!dashboardResults,
                parent: dashboardResults ? dashboardResults.parentElement.id : 'N/A',
                parentDisplay: dashboardResults ? window.getComputedStyle(dashboardResults.parentElement).display : 'N/A',
                visible: dashboardResults ? dashboardResults.offsetParent !== null : false,
                display: dashboardResults ? window.getComputedStyle(dashboardResults).display : 'N/A'
            });
            
            // Check for "Core Classification Results" heading anywhere in DOM
            const coreClassificationHeadings = Array.from(document.querySelectorAll('h3')).filter(h3 => 
                h3.textContent.includes('Core Classification')
            );
            console.log(' "Core Classification Results" headings found:', coreClassificationHeadings.length);
            coreClassificationHeadings.forEach((h3, idx) => {
                let parent = h3.parentElement;
                let tabContent = null;
                while (parent && parent !== document.body) {
                    if (parent.classList.contains('tab-content')) {
                        tabContent = parent;
                        break;
                    }
                    parent = parent.parentElement;
                }
                console.log(` Heading ${idx}:`, {
                    text: h3.textContent.substring(0, 50),
                    inTabContent: !!tabContent,
                    tabContentId: tabContent ? tabContent.id : 'N/A',
                    tabContentDisplay: tabContent ? window.getComputedStyle(tabContent).display : 'N/A',
                    visible: h3.offsetParent !== null,
                    display: window.getComputedStyle(h3).display
                });
            });
            
            // Check for "Website Keywords Used" heading anywhere in DOM
            const websiteKeywordsHeadings = Array.from(document.querySelectorAll('h5')).filter(h5 => 
                h5.textContent.includes('Website Keywords')
            );
            console.log(' "Website Keywords Used" headings found:', websiteKeywordsHeadings.length);
            websiteKeywordsHeadings.forEach((h5, idx) => {
                let parent = h5.parentElement;
                let tabContent = null;
                while (parent && parent !== document.body) {
                    if (parent.classList.contains('tab-content')) {
                        tabContent = parent;
                        break;
                    }
                    parent = parent.parentElement;
                }
                console.log(` Heading ${idx}:`, {
                    text: h5.textContent.substring(0, 50),
                    inTabContent: !!tabContent,
                    tabContentId: tabContent ? tabContent.id : 'N/A',
                    tabContentDisplay: tabContent ? window.getComputedStyle(tabContent).display : 'N/A',
                    visible: h5.offsetParent !== null,
                    display: window.getComputedStyle(h5).display
                });
            });
            
            // Check all tab-content elements and their display states
            const allTabContents = document.querySelectorAll('.tab-content');
            console.log(' All tab-content elements:');
            allTabContents.forEach((tab, idx) => {
                const computedStyle = window.getComputedStyle(tab);
                const hasCoreResults = tab.querySelector('#coreResults') !== null;
                const hasDashboardResults = tab.querySelector('#dashboardResults') !== null;
                console.log(` Tab ${idx} (${tab.id}):`, {
                    display: computedStyle.display,
                    inlineDisplay: tab.style.display || 'none',
                    visibility: computedStyle.visibility,
                    opacity: computedStyle.opacity,
                    hasActive: tab.classList.contains('active'),
                    visible: tab.offsetParent !== null,
                    hasCoreResults: hasCoreResults,
                    hasDashboardResults: hasDashboardResults,
                    childrenCount: tab.children.length
                });
            });
            
            // Check for CSS rules that might override display
            if (businessAnalyticsTab) {
                const styles = window.getComputedStyle(businessAnalyticsTab);
                console.log(' #business-analytics computed styles:', {
                    display: styles.display,
                    visibility: styles.visibility,
                    opacity: styles.opacity,
                    position: styles.position,
                    zIndex: styles.zIndex,
                    height: styles.height,
                    width: styles.width
                });
            }
            
            // Check for duplicate #coreResults elements
            const allCoreResults = document.querySelectorAll('#coreResults');
            console.log(' Total #coreResults elements found:', allCoreResults.length);
            if (allCoreResults.length > 1) {
                console.warn(' DUPLICATE #coreResults elements detected!');
                allCoreResults.forEach((el, idx) => {
                    let parent = el.parentElement;
                    const parentChain = [];
                    while (parent && parent !== document.body) {
                        parentChain.push({
                            tag: parent.tagName,
                            id: parent.id || 'N/A',
                            class: parent.className || 'N/A'
                        });
                        parent = parent.parentElement;
                    }
                    console.log(` #coreResults ${idx + 1} parent chain:`, parentChain);
                });
            }
            
            // Show full parent chain for #coreResults
            if (coreResults) {
                let parent = coreResults.parentElement;
                const parentChain = [];
                while (parent && parent !== document.body) {
                    parentChain.push({
                        tag: parent.tagName,
                        id: parent.id || 'N/A',
                        class: parent.className || 'N/A',
                        isTabContent: parent.classList.contains('tab-content'),
                        isMaxW7xl: parent.classList.contains('max-w-7xl')
                    });
                    parent = parent.parentElement;
                }
                console.log(' #coreResults full parent chain:', parentChain);
            }
            
            // Check ALL .max-w-7xl containers
            const allMaxWContainers = document.querySelectorAll('.max-w-7xl');
            console.log(' Total .max-w-7xl containers found:', allMaxWContainers.length);
            allMaxWContainers.forEach((container, idx) => {
                const isInContainer = container.contains(coreResults);
                const containerInfo = {
                    index: idx,
                    id: container.id || 'N/A',
                    classes: container.className,
                    containsCoreResults: isInContainer,
                    location: container.getBoundingClientRect()
                };
                console.log(` .max-w-7xl container ${idx + 1}:`, containerInfo);
            });
            
            // Check if content is outside .max-w-7xl container (check main content container specifically)
            // Find the main content container (the one that comes AFTER the nav, not the nav itself)
            const allMaxWContainersWithAuto = document.querySelectorAll('.max-w-7xl.mx-auto');
            let mainMaxWContainer = null;
            if (allMaxWContainersWithAuto.length > 0) {
                // The main content container should be the one that contains the tab navigation
                for (const container of allMaxWContainersWithAuto) {
                    const hasTabNav = container.querySelector('nav[aria-label="Tabs"]') !== null;
                    if (hasTabNav) {
                        mainMaxWContainer = container;
                        break;
                    }
                }
                // If we didn't find it by tab nav, use the last one (should be the main content)
                if (!mainMaxWContainer && allMaxWContainersWithAuto.length > 1) {
                    mainMaxWContainer = allMaxWContainersWithAuto[allMaxWContainersWithAuto.length - 1];
                } else if (!mainMaxWContainer) {
                    mainMaxWContainer = allMaxWContainersWithAuto[0];
                }
            }
            
            if (mainMaxWContainer && coreResults) {
                const isInContainer = mainMaxWContainer.contains(coreResults);
                console.log(' Main content container found:', {
                    hasTabNav: mainMaxWContainer.querySelector('nav[aria-label="Tabs"]') !== null,
                    containerIndex: Array.from(allMaxWContainersWithAuto).indexOf(mainMaxWContainer),
                    isInContainer: isInContainer
                });
                console.log(' #coreResults is inside main content .max-w-7xl.mx-auto:', isInContainer);
                if (!isInContainer) {
                    console.warn(' #coreResults is OUTSIDE the main content .max-w-7xl container!');
                    console.warn(' This means the content is not part of the tab system!');
                    
                    // Find which container actually contains it
                    for (let i = 0; i < allMaxWContainers.length; i++) {
                        if (allMaxWContainers[i].contains(coreResults)) {
                            console.warn(` #coreResults is actually inside .max-w-7xl container ${i + 1} (likely the nav container)`);
                            break;
                        }
                    }
                }
            }
            
            console.log(' ================================================');
        };

        // Enhanced CSS Diagnostic - Check computed styles and CSS rules
        const diagnoseCSSStyles = () => {
            console.log(' ========== CSS STYLES DIAGNOSTIC ==========');
            
            const businessAnalyticsTab = document.getElementById('business-analytics');
            const coreResults = document.getElementById('coreResults');
            const dashboardResults = document.getElementById('dashboardResults');
            const overviewTab = document.getElementById('overview');
            
            if (!businessAnalyticsTab || !coreResults) {
                console.error(' Required elements not found');
                return;
            }
            
            // Check Business Analytics tab computed styles
            console.log(' #business-analytics tab computed styles:');
            const baStyles = window.getComputedStyle(businessAnalyticsTab);
            console.log({
                display: baStyles.display,
                visibility: baStyles.visibility,
                position: baStyles.position,
                zIndex: baStyles.zIndex,
                opacity: baStyles.opacity,
                transform: baStyles.transform,
                width: baStyles.width,
                height: baStyles.height,
                top: baStyles.top,
                left: baStyles.left,
                right: baStyles.right,
                bottom: baStyles.bottom,
                overflow: baStyles.overflow,
                clip: baStyles.clip,
                clipPath: baStyles.clipPath
            });
            
            // Check inline styles
            console.log(' #business-analytics tab inline styles:');
            console.log({
                display: businessAnalyticsTab.style.display,
                visibility: businessAnalyticsTab.style.visibility,
                position: businessAnalyticsTab.style.position,
                zIndex: businessAnalyticsTab.style.zIndex,
                opacity: businessAnalyticsTab.style.opacity
            });
            
            // Check #coreResults computed styles
            console.log(' #coreResults computed styles:');
            const coreStyles = window.getComputedStyle(coreResults);
            console.log({
                display: coreStyles.display,
                visibility: coreStyles.visibility,
                position: coreStyles.position,
                zIndex: coreStyles.zIndex,
                opacity: coreStyles.opacity,
                transform: coreStyles.transform,
                width: coreStyles.width,
                height: coreStyles.height,
                top: coreStyles.top,
                left: coreStyles.left,
                right: coreStyles.right,
                bottom: coreStyles.bottom,
                overflow: coreStyles.overflow,
                clip: coreStyles.clip,
                clipPath: coreStyles.clipPath,
                offsetParent: coreResults.offsetParent ? coreResults.offsetParent.id : 'null'
            });
            
            // Check #coreResults inline styles
            console.log(' #coreResults inline styles:');
            console.log({
                display: coreResults.style.display,
                visibility: coreResults.style.visibility,
                position: coreResults.style.position,
                zIndex: coreResults.style.zIndex,
                opacity: coreResults.style.opacity
            });
            
            // Check parent chain styles
            console.log(' Parent chain styles:');
            let element = coreResults;
            let depth = 0;
            while (element && element !== document.body && depth < 10) {
                const styles = window.getComputedStyle(element);
                console.log(`  Level ${depth} (${element.tagName}${element.id ? '#' + element.id : ''}${element.className ? '.' + element.className.split(' ').join('.') : ''}):`, {
                    display: styles.display,
                    visibility: styles.visibility,
                    position: styles.position,
                    zIndex: styles.zIndex,
                    opacity: styles.opacity
                });
                element = element.parentElement;
                depth++;
            }
            
            // Check for CSS rules that might override display: none
            console.log(' Checking for CSS rules that might override display:');
            const allStylesheets = Array.from(document.styleSheets);
            let foundRules = [];
            
            allStylesheets.forEach((sheet, sheetIdx) => {
                try {
                    const rules = Array.from(sheet.cssRules || sheet.rules || []);
                    rules.forEach((rule, ruleIdx) => {
                        if (rule.selectorText) {
                            // Check if rule targets business-analytics or coreResults
                            if (rule.selectorText.includes('business-analytics') || 
                                rule.selectorText.includes('coreResults') ||
                                rule.selectorText.includes('dashboardResults') ||
                                rule.selectorText.includes('.tab-content') ||
                                rule.selectorText.includes('#business-analytics')) {
                                
                                const ruleStyles = rule.style;
                                if (ruleStyles.display || ruleStyles.visibility || ruleStyles.position) {
                                    foundRules.push({
                                        selector: rule.selectorText,
                                        display: ruleStyles.display,
                                        visibility: ruleStyles.visibility,
                                        position: ruleStyles.position,
                                        zIndex: ruleStyles.zIndex,
                                        opacity: ruleStyles.opacity,
                                        sheetIndex: sheetIdx,
                                        ruleIndex: ruleIdx
                                    });
                                }
                            }
                        }
                    });
                } catch (e) {
                    // Cross-origin stylesheets may throw errors
                    console.log(` Could not access stylesheet ${sheetIdx}:`, e.message);
                }
            });
            
            if (foundRules.length > 0) {
                console.log(' Found CSS rules that might affect Business Analytics content:');
                foundRules.forEach(rule => {
                    console.log('  Rule:', rule);
                });
            } else {
                console.log(' No CSS rules found that directly target Business Analytics content');
            }
            
            // Check if content is actually visible in viewport
            console.log(' Viewport visibility check:');
            const coreRect = coreResults.getBoundingClientRect();
            const baRect = businessAnalyticsTab.getBoundingClientRect();
            console.log({
                coreResults: {
                    inViewport: coreRect.width > 0 && coreRect.height > 0 && 
                               coreRect.top < window.innerHeight && 
                               coreRect.bottom > 0 &&
                               coreRect.left < window.innerWidth &&
                               coreRect.right > 0,
                    rect: {
                        top: coreRect.top,
                        left: coreRect.left,
                        width: coreRect.width,
                        height: coreRect.height
                    }
                },
                businessAnalyticsTab: {
                    inViewport: baRect.width > 0 && baRect.height > 0 && 
                               baRect.top < window.innerHeight && 
                               baRect.bottom > 0 &&
                               baRect.left < window.innerWidth &&
                               baRect.right > 0,
                    rect: {
                        top: baRect.top,
                        left: baRect.left,
                        width: baRect.width,
                        height: baRect.height
                    }
                }
            });
            
            // Check Overview tab for comparison
            if (overviewTab) {
                console.log(' #overview tab computed styles (for comparison):');
                const overviewStyles = window.getComputedStyle(overviewTab);
                console.log({
                    display: overviewStyles.display,
                    visibility: overviewStyles.visibility,
                    position: overviewStyles.position,
                    zIndex: overviewStyles.zIndex,
                    opacity: overviewStyles.opacity
                });
                
                const overviewRect = overviewTab.getBoundingClientRect();
                console.log(' #overview tab viewport visibility:', {
                    inViewport: overviewRect.width > 0 && overviewRect.height > 0 && 
                               overviewRect.top < window.innerHeight && 
                               overviewRect.bottom > 0 &&
                               overviewRect.left < window.innerWidth &&
                               overviewRect.right > 0,
                    rect: {
                        top: overviewRect.top,
                        left: overviewRect.left,
                        width: overviewRect.width,
                        height: overviewRect.height
                    }
                });
            }
            
            console.log(' ================================================');
        };

        // Make diagnostic functions globally available
        window.diagnoseBusinessAnalyticsContent = diagnoseBusinessAnalyticsContent;
        window.diagnoseCSSStyles = diagnoseCSSStyles;
        
        // Initialize when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            console.log(' Initializing MerchantDetails class...');
            console.log(' Window location:', window.location.href);
            console.log(' Document ready state:', document.readyState);
            
            // Ensure only overview tab is visible on page load
            document.querySelectorAll('.tab-content').forEach(tab => {
                if (tab.id === 'overview') {
                    tab.classList.add('active');
                    tab.style.display = 'block';
                    tab.style.visibility = 'visible';
                } else {
                    tab.classList.remove('active');
                    tab.style.display = 'none';
                    tab.style.visibility = 'hidden';
                    
                    // Remove 'visible' class from all progressive-disclosure elements inside hidden tabs
                    // This prevents opacity: 1 from making content visible even when parent is display: none
                    const progressiveElements = tab.querySelectorAll('.progressive-disclosure');
                    progressiveElements.forEach(el => {
                        el.classList.remove('visible');
                        el.style.opacity = '0';
                    });
                }
            });
            
            // Ensure overview button is active
            document.querySelectorAll('.tab-button').forEach(button => {
                if (button.getAttribute('data-tab') === 'overview') {
                    button.classList.add('active');
                } else {
                    button.classList.remove('active');
                }
            });
            
            // Run diagnostic after a short delay to ensure DOM is fully initialized
            setTimeout(() => {
                diagnoseBusinessAnalyticsContent();
            }, 500);
            
            try {
                window.merchantDetails = new MerchantDetails();
                console.log(' MerchantDetails instance created successfully');
            } catch (error) {
                console.error(' Error creating MerchantDetails instance:', error);
                console.error(' Error stack:', error.stack);
            }
        });
    </script>

    <!-- Risk Indicators Components -->
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- api-config.js already loaded in head, no need to load again -->
    <script src="js/components/real-data-integration.js"></script>
    <script src="js/components/risk-visualization.js"></script>
    <script src="js/components/risk-explainability.js"></script>
    <script src="js/components/risk-level-indicator.js"></script>
    <script src="js/utils/risk-indicators-helpers.js"></script>
    <script src="js/components/risk-indicators-ui-template.js"></script>
    <script src="js/components/risk-indicators-data-service.js"></script>
    <script src="js/components/website-risk-display.js"></script>
    <script src="js/components/merchant-risk-indicators-tab.js"></script>
    
    <!-- Risk Assessment Components -->
    <!-- Note: risk-visualization.js and risk-explainability.js are already loaded above for Risk Indicators -->
    <script src="js/components/risk-scenarios.js" onerror="console.error(' Failed to load risk-scenarios.js')"></script>
    <script src="js/components/risk-history.js" onerror="console.error(' Failed to load risk-history.js')"></script>
    <script src="js/components/risk-export.js" onerror="console.error(' Failed to load risk-export.js')"></script>
    <script>
        // Force cache busting with timestamp
        const timestamp = new Date().getTime();
        const script = document.createElement('script');
        script.src = `js/merchant-risk-tab.js?v=3.0&t=${timestamp}`;
        script.onerror = function() {
            console.error(' Failed to load merchant-risk-tab.js', this.src);
        };
        document.head.appendChild(script);
    </script>
    <script>
        // Verify all scripts loaded successfully - this should run immediately after scripts load
        try {
            console.log(' Script loading verification:');
            console.log('  - RiskVisualization:', typeof RiskVisualization);
            console.log('  - RiskExplainability:', typeof RiskExplainability);
            console.log('  - RiskScenarioAnalysis:', typeof RiskScenarioAnalysis);
            console.log('  - RiskHistoryTracking:', typeof RiskHistoryTracking);
            console.log('  - RiskExport:', typeof RiskExport);
            console.log('  - MerchantRiskTab:', typeof MerchantRiskTab);
            console.log('  - window.MerchantRiskTab:', typeof window.MerchantRiskTab);
        } catch (error) {
            console.error(' Error in script verification:', error);
        }
    </script>

    <!-- Initialize Risk Indicators Tab -->
    <script>
        // Helper function to get merchant ID
        function getMerchantId() {
            // Try to get from URL parameters first
            const urlParams = new URLSearchParams(window.location.search);
            const merchantIdFromUrl = urlParams.get('merchantId') || urlParams.get('id');
            if (merchantIdFromUrl) {
                return merchantIdFromUrl;
            }
            
            // Try to get from session storage
            const merchantDataStr = sessionStorage.getItem('merchantData');
            if (merchantDataStr) {
                try {
                    const merchantData = JSON.parse(merchantDataStr);
                    return merchantData.id || merchantData.merchantId || merchantData.businessId;
                } catch (e) {
                    console.warn('Failed to parse merchant data from session storage:', e);
                }
            }
            
            // Try to get from global merchant details instance
            if (window.merchantDetails && window.merchantDetails.merchantData) {
                return window.merchantDetails.merchantData.id || 
                       window.merchantDetails.merchantData.merchantId || 
                       window.merchantDetails.merchantData.businessId;
            }
            
            // Fallback: generate a test merchant ID for demo purposes
            console.warn('No merchant ID found, using demo merchant ID');
            return 'demo-merchant-123';
        }

        // Comprehensive DOM structure logging to diagnose rendering issues
        const logDOMStructure = () => {
            console.log(' ========== DOM STRUCTURE DIAGNOSTICS ==========');
            console.log(' Document ready state:', document.readyState);
            console.log(' Body exists:', !!document.body);
            console.log(' Body children count:', document.body ? document.body.children.length : 0);
            
            // Check for main content container
            const mainContent = document.querySelector('.max-w-7xl.mx-auto');
            console.log(' Main content container (.max-w-7xl):', !!mainContent);
            
            // Check for tab navigation
            const tabNav = document.querySelector('nav[aria-label="Tabs"]');
            console.log(' Tab navigation (nav[aria-label="Tabs"]):', !!tabNav);
            if (tabNav) {
                console.log(' Tab nav children:', tabNav.children.length);
                console.log(' Tab nav buttons:', tabNav.querySelectorAll('button').length);
            }
            
            // Check for tab buttons
            const tabButtons = document.querySelectorAll('.tab-button, button[data-tab]');
            console.log(' Tab buttons found:', tabButtons.length);
            if (tabButtons.length > 0) {
                Array.from(tabButtons).forEach((btn, idx) => {
                    console.log(` Tab button ${idx}:`, {
                        text: (btn.textContent || '').trim().substring(0, 30),
                        dataTab: btn.getAttribute('data-tab'),
                        classes: btn.className.substring(0, 50),
                        visible: btn.offsetParent !== null,
                        display: window.getComputedStyle(btn).display
                    });
                });
            }
            
            // Check for tab content
            const tabContent = document.querySelectorAll('.tab-content');
            console.log(' Tab content containers:', tabContent.length);
            if (tabContent.length > 0) {
                Array.from(tabContent).forEach((tab, idx) => {
                    console.log(` Tab content ${idx}:`, {
                        id: tab.id,
                        classes: tab.className.substring(0, 50),
                        visible: tab.offsetParent !== null,
                        display: window.getComputedStyle(tab).display,
                        hasActive: tab.classList.contains('active')
                    });
                });
            }
            
            // Check for merchantNameText
            const merchantName = document.getElementById('merchantNameText');
            console.log(' merchantNameText element:', !!merchantName);
            if (merchantName) {
                console.log(' merchantNameText:', {
                    visible: merchantName.offsetParent !== null,
                    display: window.getComputedStyle(merchantName).display,
                    text: merchantName.textContent.substring(0, 50)
                });
            }
            
            // Check for h1 elements
            const h1Elements = document.querySelectorAll('h1');
            console.log(' Total h1 elements:', h1Elements.length);
            
            // Check for all buttons
            const allButtons = document.querySelectorAll('button');
            console.log(' Total buttons in document:', allButtons.length);
            
            // Check CSS visibility
            if (mainContent) {
                const styles = window.getComputedStyle(mainContent);
                console.log(' Main content CSS:', {
                    display: styles.display,
                    visibility: styles.visibility,
                    opacity: styles.opacity,
                    height: styles.height,
                    width: styles.width
                });
            }
            
            console.log(' ================================================');
        };
        
        // Initialize flags to track button setup status
        window.riskIndicatorsButtonSetup = false;
        window.riskAssessmentButtonSetup = false;
        window.tabObserver = null;
        
        // MutationObserver to detect when content is added
        const observeDOMChanges = () => {
            // Check if both buttons are already set up - if so, disconnect observer
            if (window.riskIndicatorsButtonSetup && window.riskAssessmentButtonSetup) {
                if (window.tabObserver) {
                    window.tabObserver.disconnect();
                    window.tabObserver = null;
                    console.log(' Both buttons set up - MutationObserver disconnected');
                }
                return;
            }
            
            // Debounce timer to prevent rapid re-triggers
            let debounceTimer = null;
            
            const observer = new MutationObserver((mutations) => {
                // Clear existing debounce timer
                if (debounceTimer) {
                    clearTimeout(debounceTimer);
                }
                
                // Debounce: only process after 500ms of no mutations
                debounceTimer = setTimeout(() => {
                    // Check if both buttons are already set up
                    if (window.riskIndicatorsButtonSetup && window.riskAssessmentButtonSetup) {
                        if (window.tabObserver) {
                            window.tabObserver.disconnect();
                            window.tabObserver = null;
                            console.log(' Both buttons set up - MutationObserver disconnected');
                        }
                        return;
                    }
                    
                    let contentAdded = false;
                    mutations.forEach((mutation) => {
                        if (mutation.addedNodes.length > 0) {
                            mutation.addedNodes.forEach((node) => {
                                if (node.nodeType === 1) { // Element node
                                    // Check if it's a tab button or tab content
                                    if (node.matches && (
                                        node.matches('.tab-button') ||
                                        node.matches('button[data-tab]') ||
                                        node.matches('.tab-content') ||
                                        node.matches('#overview') ||
                                        node.matches('nav[aria-label="Tabs"]')
                                    )) {
                                        contentAdded = true;
                                        console.log(' Tab-related content detected in DOM:', {
                                            tagName: node.tagName,
                                            id: node.id,
                                            classes: node.className,
                                            dataTab: node.getAttribute('data-tab')
                                        });
                                    }
                                    // Check if node contains tab buttons
                                    if (node.querySelectorAll) {
                                        const tabButtons = node.querySelectorAll('.tab-button, button[data-tab]');
                                        if (tabButtons.length > 0) {
                                            contentAdded = true;
                                            console.log(` Found ${tabButtons.length} tab buttons in added node`);
                                        }
                                    }
                                }
                            });
                        }
                    });
                    
                    if (contentAdded) {
                        console.log(' Tab content detected - checking if setup needed...');
                        // Only re-run if buttons are not already set up
                        setTimeout(() => {
                            if (!window.riskIndicatorsButtonSetup && window.setupRiskIndicatorsButton) {
                                window.setupRiskIndicatorsButton();
                            }
                            if (!window.riskAssessmentButtonSetup && window.setupRiskAssessmentButton) {
                                window.setupRiskAssessmentButton();
                            }
                        }, 100);
                    }
                }, 500); // 500ms debounce
            });
            
            // Store observer reference globally so it can be disconnected
            window.tabObserver = observer;
            
            // Start observing
            if (document.body) {
                observer.observe(document.body, {
                    childList: true,
                    subtree: true
                });
                console.log(' MutationObserver started to detect tab content');
            } else {
                // Wait for body
                if (document.readyState === 'loading') {
                    document.addEventListener('DOMContentLoaded', () => {
                        if (document.body) {
                            observer.observe(document.body, {
                                childList: true,
                                subtree: true
                            });
                            console.log(' MutationObserver started (after DOMContentLoaded)');
                        }
                    });
                } else {
                    setTimeout(() => {
                        if (document.body) {
                            observer.observe(document.body, {
                                childList: true,
                                subtree: true
                            });
                            console.log(' MutationObserver started (after timeout)');
                        }
                    }, 100);
                }
            }
        };
        
        // Log DOM structure on page load
        if (document.readyState === 'complete' || document.readyState === 'interactive') {
            logDOMStructure();
            observeDOMChanges();
        } else {
            window.addEventListener('load', () => {
                logDOMStructure();
                observeDOMChanges();
            });
            // Also log immediately
            setTimeout(logDOMStructure, 100);
        }
        
        // Initialize NEW Risk Indicators Tab (run after existing DOMContentLoaded)
        setTimeout(function() {
            console.log(' DOM loaded, initializing NEW Risk Indicators Tab...');
            console.log(' Checking if D3.js is loaded:', typeof d3);
            console.log(' Checking if MerchantRiskIndicatorsTab class exists:', typeof MerchantRiskIndicatorsTab);
            console.log(' Checking if RiskIndicatorsUITemplate exists:', typeof RiskIndicatorsUITemplate);
            console.log(' Checking if RiskIndicatorsDataService exists:', typeof RiskIndicatorsDataService);
            
            // Initialize Risk Indicators Tab
            try {
                if (typeof MerchantRiskIndicatorsTab === 'undefined') {
                    console.error(' MerchantRiskIndicatorsTab class not found!');
                    return;
                }
                window.riskIndicatorsTab = new MerchantRiskIndicatorsTab('riskIndicatorsContainer');
                console.log(' NEW Risk Indicators Tab initialized successfully');
                
                // Try to initialize visualization component if D3.js is available
                if (typeof d3 !== 'undefined') {
                    window.riskIndicatorsTab.initializeVisualization();
                } else {
                    console.warn(' D3.js not available, visualization will be initialized later');
                }
            } catch (error) {
                console.error(' Failed to initialize NEW Risk Indicators Tab:', error);
            }
            
            // Listen for tab activation - retry if button not found
            // Make globally accessible for MutationObserver
            window.setupRiskIndicatorsButton = function() {
                const findButton = (retries = 10) => {
                    console.log(' Looking for Risk Indicators tab button... (attempts remaining:', retries, ')');
                    console.log(' Document ready state:', document.readyState);
                    console.log(' Body exists:', !!document.body);
                    
                    // Strategy 1: Search within tab navigation container first
                    const tabNav = document.querySelector('nav[aria-label="Tabs"]') || 
                                   document.querySelector('.border-b.border-gray-200 nav') ||
                                   document.querySelector('nav.-mb-px');
                    
                    let riskIndicatorsTabButton = null;
                    
                    if (tabNav) {
                        console.log(' Tab navigation container found');
                        // Search within container
                        riskIndicatorsTabButton = tabNav.querySelector('[data-tab="risk-indicators"]');
                        if (!riskIndicatorsTabButton) {
                            // Search by text within container
                            const buttons = tabNav.querySelectorAll('button');
                            for (const btn of buttons) {
                                const text = (btn.textContent || btn.innerText || '').trim();
                                if (text.includes('Risk Indicators') || text.includes('Indicators')) {
                                    riskIndicatorsTabButton = btn;
                                    console.log(' Found button by text in tab nav container');
                                    break;
                                }
                            }
                        }
                    }
                    
                    // Strategy 2: Search all buttons by text content (most reliable)
                    if (!riskIndicatorsTabButton) {
                        console.log(' Searching all buttons by text content...');
                        const allButtons = document.querySelectorAll('button');
                        console.log(' Total buttons found:', allButtons.length);
                        
                        for (const btn of allButtons) {
                            const text = (btn.textContent || btn.innerText || '').trim();
                            const dataTab = btn.getAttribute('data-tab');
                            
                            // Log first few buttons for debugging
                            if (allButtons.length <= 10) {
                                console.log(` Button: "${text.substring(0, 30)}" | data-tab="${dataTab}" | classes="${btn.className.substring(0, 50)}"`);
                            }
                            
                            // Match by data-tab attribute or text content
                            if (dataTab === 'risk-indicators' || 
                                text.toLowerCase().includes('risk indicators') ||
                                text.toLowerCase().includes('indicators')) {
                                riskIndicatorsTabButton = btn;
                                console.log(' Found button by text content:', text.substring(0, 50));
                                break;
                            }
                        }
                    }
                    
                    // Strategy 3: Try querySelector on document (fallback)
                    if (!riskIndicatorsTabButton) {
                        riskIndicatorsTabButton = document.querySelector('[data-tab="risk-indicators"]');
                    }
                    
                    if (riskIndicatorsTabButton) {
                        console.log(' Risk Indicators tab button found:', {
                            text: (riskIndicatorsTabButton.textContent || '').trim().substring(0, 50),
                            dataTab: riskIndicatorsTabButton.getAttribute('data-tab'),
                            classes: riskIndicatorsTabButton.className,
                            id: riskIndicatorsTabButton.id
                        });
                        setupButtonHandler(riskIndicatorsTabButton);
                        // Mark as set up to prevent re-initialization
                        window.riskIndicatorsButtonSetup = true;
                        // Check if we can disconnect observer
                        if (window.riskIndicatorsButtonSetup && window.riskAssessmentButtonSetup && window.tabObserver) {
                            window.tabObserver.disconnect();
                            window.tabObserver = null;
                            console.log(' Both buttons set up - MutationObserver disconnected');
                        }
                        return;
                    } else if (retries > 0) {
                        // Retry after a short delay
                        setTimeout(() => findButton(retries - 1), 200);
                    } else {
                        console.error(' Risk Indicators tab button not found after all retries');
                        const allButtons = Array.from(document.querySelectorAll('button'));
                        console.error(' All available buttons:', allButtons.map(b => ({
                            text: (b.textContent || '').trim().substring(0, 50),
                            dataTab: b.getAttribute('data-tab'),
                            classes: b.className.substring(0, 100),
                            id: b.id,
                            parent: b.parentElement ? b.parentElement.tagName : 'none'
                        })));
                    }
                };
                
                const setupButtonHandler = (button) => {
                    if (!button) return;
                    
                    // Check if button already has our handler (prevent infinite loop)
                    if (button.hasAttribute('data-risk-indicators-handler')) {
                        console.log(' Risk Indicators button handler already set up, skipping');
                        return;
                    }
                    
                    console.log(' Setting up Risk Indicators tab button handler');
                    
                    // Mark button as having handler
                    button.setAttribute('data-risk-indicators-handler', 'true');
                    
                    // Remove any existing event listeners by cloning the button
                    const newButton = button.cloneNode(true);
                    newButton.setAttribute('data-risk-indicators-handler', 'true');
                    button.parentNode.replaceChild(newButton, button);
                    
                    // Add our new event listener to the clean button
                    newButton.addEventListener('click', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        console.log(' NEW Risk Indicators Tab button clicked!');
                        
                        // Handle tab switching (add/remove active classes and set inline styles)
                        document.querySelectorAll('.tab-content').forEach(tab => {
                            tab.classList.remove('active');
                            tab.style.display = 'none'; // Force hide to prevent any CSS conflicts
                            tab.style.visibility = 'hidden'; // Also hide visibility to ensure content is not visible
                            
                            // Remove 'visible' class from all progressive-disclosure elements inside hidden tabs
                            const progressiveElements = tab.querySelectorAll('.progressive-disclosure');
                            progressiveElements.forEach(el => {
                                el.classList.remove('visible');
                                el.style.opacity = '0';
                            });
                        });
                        document.querySelectorAll('.tab-button').forEach(button => {
                            button.classList.remove('active');
                        });
                        
                        // Add active class to Risk Indicators tab and button
                        const tabElement = document.getElementById('risk-indicators');
                        if (tabElement) {
                            tabElement.classList.add('active');
                            tabElement.style.display = 'block'; // Force show to ensure visibility
                            tabElement.style.visibility = 'visible'; // Also show visibility to ensure content is visible
                        }
                        newButton.classList.add('active');
                        
                        const merchantId = getMerchantId();
                        console.log(' Risk Indicators Tab clicked, merchant ID:', merchantId);
                        if (merchantId && window.riskIndicatorsTab) {
                            console.log(' Calling NEW Risk Indicators Tab init...');
                            window.riskIndicatorsTab.init(merchantId);
                        } else {
                            console.error(' No merchant ID found or risk indicators tab not initialized');
                            // Show a simple test message if initialization fails
                            const container = document.getElementById('riskIndicatorsContainer');
                            if (container) {
                                container.innerHTML = `
                                    <div class="bg-yellow-100 border border-yellow-400 text-yellow-700 px-4 py-3 rounded">
                                        <h3 class="font-bold">NEW Risk Indicators Tab</h3>
                                        <p>Tab is working! Merchant ID: ${merchantId || 'Not found'}</p>
                                        <p>This is a test message. The full Risk Indicators implementation should load here.</p>
                                        <p>If you see this, the NEW implementation is working but needs data.</p>
                                    </div>
                                `;
                            }
                        }
                    });
                };
                
                findButton();
            };
            
            // Wait for DOM to be fully ready before setting up button
            if (document.readyState === 'complete' || document.readyState === 'interactive') {
                window.setupRiskIndicatorsButton();
            } else {
                window.addEventListener('load', window.setupRiskIndicatorsButton);
            }
        }, 2000); // Wait 2 seconds for DOM to be fully ready
        
        // Initialize Risk Assessment Tab (separate timeout to ensure all scripts are loaded)
        setTimeout(function() {
            try {
                console.log(' Initializing Risk Assessment Tab...');
                console.log(' Checking if MerchantRiskTab class exists:', typeof MerchantRiskTab);
                console.log(' Checking if RiskScenarioAnalysis exists:', typeof RiskScenarioAnalysis);
                console.log(' Checking if RiskHistoryTracking exists:', typeof RiskHistoryTracking);
                console.log(' Checking if RiskExport exists:', typeof RiskExport);
                
                if (typeof MerchantRiskTab === 'undefined') {
                    console.error(' MerchantRiskTab class not found! Make sure js/merchant-risk-tab.js is loaded.');
                    return;
                }
                
                try {
                    window.merchantRiskTab = new MerchantRiskTab();
                    console.log(' Risk Assessment Tab initialized successfully');
                } catch (error) {
                    console.error(' Failed to initialize Risk Assessment Tab:', error);
                    console.error('Error stack:', error.stack);
                    return;
                }
                
                // Set up Risk Assessment tab click handler - retry if button not found
                // Make globally accessible for MutationObserver
                window.setupRiskAssessmentButton = function() {
                    const findButton = (retries = 10) => {
                        console.log(' Looking for Risk Assessment tab button... (attempts remaining:', retries, ')');
                        console.log(' Document ready state:', document.readyState);
                        console.log(' Body exists:', !!document.body);
                        
                        // Strategy 1: Search within tab navigation container first
                        const tabNav = document.querySelector('nav[aria-label="Tabs"]') || 
                                       document.querySelector('.border-b.border-gray-200 nav') ||
                                       document.querySelector('nav.-mb-px');
                        
                        let riskAssessmentTabButton = null;
                        
                        if (tabNav) {
                            console.log(' Tab navigation container found');
                            // Search within container
                            riskAssessmentTabButton = tabNav.querySelector('[data-tab="risk-assessment"]');
                            if (!riskAssessmentTabButton) {
                                // Search by text within container
                                const buttons = tabNav.querySelectorAll('button');
                                for (const btn of buttons) {
                                    const text = (btn.textContent || btn.innerText || '').trim();
                                    if (text.includes('Risk Assessment') || text.includes('Assessment')) {
                                        riskAssessmentTabButton = btn;
                                        console.log(' Found button by text in tab nav container');
                                        break;
                                    }
                                }
                            }
                        }
                        
                        // Strategy 2: Search all buttons by text content (most reliable)
                        if (!riskAssessmentTabButton) {
                            console.log(' Searching all buttons by text content...');
                            const allButtons = document.querySelectorAll('button');
                            console.log(' Total buttons found:', allButtons.length);
                            
                            for (const btn of allButtons) {
                                const text = (btn.textContent || btn.innerText || '').trim();
                                const dataTab = btn.getAttribute('data-tab');
                                
                                // Log first few buttons for debugging
                                if (allButtons.length <= 10) {
                                    console.log(` Button: "${text.substring(0, 30)}" | data-tab="${dataTab}" | classes="${btn.className.substring(0, 50)}"`);
                                }
                                
                                // Match by data-tab attribute or text content
                                if (dataTab === 'risk-assessment' || 
                                    text.toLowerCase().includes('risk assessment') ||
                                    text.toLowerCase().includes('assessment')) {
                                    riskAssessmentTabButton = btn;
                                    console.log(' Found button by text content:', text.substring(0, 50));
                                    break;
                                }
                            }
                        }
                        
                        // Strategy 3: Try querySelector on document (fallback)
                        if (!riskAssessmentTabButton) {
                            riskAssessmentTabButton = document.querySelector('[data-tab="risk-assessment"]');
                        }
                        
                        if (riskAssessmentTabButton) {
                            console.log(' Risk Assessment tab button found:', {
                                text: (riskAssessmentTabButton.textContent || '').trim().substring(0, 50),
                                dataTab: riskAssessmentTabButton.getAttribute('data-tab'),
                                classes: riskAssessmentTabButton.className,
                                id: riskAssessmentTabButton.id
                            });
                            setupButtonHandler(riskAssessmentTabButton);
                            // Mark as set up to prevent re-initialization
                            window.riskAssessmentButtonSetup = true;
                            // Check if we can disconnect observer
                            if (window.riskIndicatorsButtonSetup && window.riskAssessmentButtonSetup && window.tabObserver) {
                                window.tabObserver.disconnect();
                                window.tabObserver = null;
                                console.log(' Both buttons set up - MutationObserver disconnected');
                            }
                            return;
                        } else if (retries > 0) {
                            // Retry after a short delay
                            setTimeout(() => findButton(retries - 1), 200);
                        } else {
                            console.error(' Risk Assessment tab button not found after all retries');
                            console.error(' Available buttons:', Array.from(document.querySelectorAll('button')).map(b => ({
                                text: (b.textContent || '').trim(),
                                dataTab: b.getAttribute('data-tab'),
                                classes: b.className
                            })));
                        }
                    };
                    
                    const setupButtonHandler = (button) => {
                        if (!button) return;
                        
                        // Check if button already has our handler (prevent infinite loop)
                        if (button.hasAttribute('data-risk-assessment-handler')) {
                            console.log(' Risk Assessment button handler already set up, skipping');
                            return;
                        }
                        
                        console.log(' Setting up Risk Assessment tab button handler');
                        
                        // Mark button as having handler
                        button.setAttribute('data-risk-assessment-handler', 'true');
                        
                        // Remove any existing event listeners by cloning the button
                        const newRiskAssessmentButton = button.cloneNode(true);
                        newRiskAssessmentButton.setAttribute('data-risk-assessment-handler', 'true');
                        button.parentNode.replaceChild(newRiskAssessmentButton, button);
                        
                        // Add click event listener
                        newRiskAssessmentButton.addEventListener('click', function(e) {
                            e.preventDefault();
                            e.stopPropagation();
                            console.log(' Risk Assessment Tab button clicked!');
                            
                            // Handle tab switching (add/remove active classes and set inline styles)
                            document.querySelectorAll('.tab-content').forEach(tab => {
                                tab.classList.remove('active');
                                tab.style.display = 'none'; // Force hide to prevent any CSS conflicts
                                tab.style.visibility = 'hidden'; // Also hide visibility to ensure content is not visible
                                
                                // Remove 'visible' class from all progressive-disclosure elements inside hidden tabs
                                const progressiveElements = tab.querySelectorAll('.progressive-disclosure');
                                progressiveElements.forEach(el => {
                                    el.classList.remove('visible');
                                    el.style.opacity = '0';
                                });
                            });
                            document.querySelectorAll('.tab-button').forEach(button => {
                                button.classList.remove('active');
                            });
                            
                            // Add active class to Risk Assessment tab and button
                            const tabElement = document.getElementById('risk-assessment');
                            if (tabElement) {
                                tabElement.classList.add('active');
                                tabElement.style.display = 'block'; // Force show to ensure visibility
                                tabElement.style.visibility = 'visible'; // Also show visibility to ensure content is visible
                            }
                            newRiskAssessmentButton.classList.add('active');
                            
                            // Load risk assessment content
                            const merchantId = getMerchantId();
                            console.log(' Risk Assessment Tab clicked, merchant ID:', merchantId);
                            
                            const container = document.getElementById('riskAssessmentContainer');
                            console.log(' Risk Assessment container:', container);
                            console.log(' window.merchantRiskTab:', window.merchantRiskTab);
                            
                            if (container && window.merchantRiskTab) {
                                console.log(' Loading Risk Assessment content...');
                                window.merchantRiskTab.loadRiskAssessmentContent(container).catch(error => {
                                    console.error(' Error loading Risk Assessment content:', error);
                                    console.error('Error stack:', error.stack);
                                    if (container) {
                                        container.innerHTML = `
                                            <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded">
                                                <h3 class="font-bold">Error Loading Risk Assessment</h3>
                                                <p>Unable to load risk assessment data. Please try again later.</p>
                                                <p class="text-sm mt-2">Error: ${error.message}</p>
                                            </div>
                                        `;
                                    }
                                });
                            } else {
                                console.error(' Risk Assessment container or MerchantRiskTab not found');
                                console.error('Container:', container);
                                console.error('MerchantRiskTab:', window.merchantRiskTab);
                                if (container) {
                                    container.innerHTML = `
                                        <div class="bg-yellow-100 border border-yellow-400 text-yellow-700 px-4 py-3 rounded">
                                            <h3 class="font-bold">Risk Assessment Tab</h3>
                                            <p>Merchant ID: ${merchantId || 'Not found'}</p>
                                            <p>Container: ${container ? 'Found' : 'Not found'}</p>
                                            <p>MerchantRiskTab: ${window.merchantRiskTab ? 'Found' : 'Not found'}</p>
                                            <p>Initializing Risk Assessment content...</p>
                                        </div>
                                    `;
                                }
                            }
                        });
                    };
                    
                    findButton();
                };
                
                // Wait for DOM to be fully ready before setting up button
                if (document.readyState === 'complete' || document.readyState === 'interactive') {
                    window.setupRiskAssessmentButton();
                } else {
                    window.addEventListener('load', window.setupRiskAssessmentButton);
                }
            } catch (error) {
                console.error(' Error in Risk Assessment initialization:', error);
                console.error('Error stack:', error.stack);
            }
        }, 3000); // Wait 3 seconds for all scripts to load
    </script>
</body>
</html>
