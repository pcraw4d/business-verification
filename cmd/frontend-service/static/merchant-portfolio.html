<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KYB Platform - Merchant Portfolio Management</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header Section */
        .portfolio-header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }

        .header-title {
            font-size: 28px;
            font-weight: 700;
            color: #1e293b;
            margin: 0;
        }

        .header-subtitle {
            font-size: 16px;
            color: #64748b;
            margin: 8px 0 0 0;
        }

        .header-stats {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }

        .stat-item {
            text-align: center;
        }

        .stat-value {
            font-size: 24px;
            font-weight: 700;
            color: #3b82f6;
            display: block;
        }

        .stat-label {
            font-size: 12px;
            color: #64748b;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Main Content */
        .portfolio-content {
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 30px;
            align-items: start;
        }

        /* Sidebar */
        .portfolio-sidebar {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .sidebar-section {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }

        .section-title {
            font-size: 18px;
            font-weight: 600;
            color: #1e293b;
            margin: 0 0 16px 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Main Area */
        .portfolio-main {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        /* Quick Actions */
        .quick-actions {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }

        .actions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
        }

        .action-card {
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            color: inherit;
        }

        .action-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 30px rgba(0, 0, 0, 0.15);
            border-color: #3b82f6;
        }

        .action-icon {
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 12px;
            color: white;
            font-size: 20px;
        }

        .action-title {
            font-size: 16px;
            font-weight: 600;
            color: #1e293b;
            margin: 0 0 8px 0;
        }

        .action-description {
            font-size: 14px;
            color: #64748b;
            margin: 0;
        }

        /* Component Containers */
        .component-container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }

        /* Responsive Design */
        @media (max-width: 1024px) {
            .portfolio-content {
                grid-template-columns: 1fr;
                gap: 20px;
            }

            .portfolio-sidebar {
                order: 2;
            }

            .portfolio-main {
                order: 1;
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 16px;
            }

            .portfolio-header {
                padding: 20px;
            }

            .header-content {
                flex-direction: column;
                align-items: flex-start;
            }

            .header-stats {
                width: 100%;
                justify-content: space-around;
            }

            .actions-grid {
                grid-template-columns: 1fr;
            }

            .component-container {
                padding: 16px;
            }
        }

        /* Loading States */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .loading-spinner {
            width: 48px;
            height: 48px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Utility Classes */
        .hidden {
            display: none !important;
        }

        .text-center {
            text-align: center;
        }

        .mb-4 {
            margin-bottom: 16px;
        }

        .mt-4 {
            margin-top: 16px;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header Section -->
        <div class="portfolio-header">
            <div class="header-content">
                <div>
                    <h1 class="header-title">Merchant Portfolio Management</h1>
                    <p class="header-subtitle">Comprehensive merchant verification and risk management platform</p>
                </div>
                <div class="header-stats">
                    <div class="stat-item">
                        <span class="stat-value" id="totalMerchants">-</span>
                        <span class="stat-label">Total Merchants</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-value" id="activeSessions">-</span>
                        <span class="stat-label">Active Sessions</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-value" id="pendingReviews">-</span>
                        <span class="stat-label">Pending Reviews</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="portfolio-content">
            <!-- Sidebar -->
            <div class="portfolio-sidebar">
                <!-- Session Manager -->
                <div class="sidebar-section">
                    <h3 class="section-title">
                        <i class="fas fa-user-clock"></i>
                        Session Management
                    </h3>
                    <div id="sessionManagerContainer"></div>
                </div>

                <!-- Portfolio Type Filter -->
                <div class="sidebar-section">
                    <h3 class="section-title">
                        <i class="fas fa-filter"></i>
                        Portfolio Types
                    </h3>
                    <div id="portfolioFilterContainer"></div>
                </div>

                <!-- Risk Level Indicator -->
                <div class="sidebar-section">
                    <h3 class="section-title">
                        <i class="fas fa-shield-alt"></i>
                        Risk Overview
                    </h3>
                    <div id="riskIndicatorContainer"></div>
                </div>

                <!-- Mock Data Warning -->
                <div class="sidebar-section">
                    <div id="mockDataWarningContainer"></div>
                </div>
            </div>

            <!-- Main Area -->
            <div class="portfolio-main">
                <!-- Quick Actions -->
                <div class="quick-actions">
                    <h3 class="section-title">
                        <i class="fas fa-bolt"></i>
                        Quick Actions
                    </h3>
                    <div class="actions-grid">
                        <a href="#" class="action-card" id="addMerchantAction">
                            <div class="action-icon">
                                <i class="fas fa-plus"></i>
                            </div>
                            <h4 class="action-title">Add Merchant</h4>
                            <p class="action-description">Register a new merchant for verification</p>
                        </a>
                        <a href="#" class="action-card" id="bulkOperationsAction">
                            <div class="action-icon">
                                <i class="fas fa-tasks"></i>
                            </div>
                            <h4 class="action-title">Bulk Operations</h4>
                            <p class="action-description">Perform operations on multiple merchants</p>
                        </a>
                        <a href="#" class="action-card" id="compareMerchantsAction">
                            <div class="action-icon">
                                <i class="fas fa-balance-scale"></i>
                            </div>
                            <h4 class="action-title">Compare Merchants</h4>
                            <p class="action-description">Side-by-side merchant comparison</p>
                        </a>
                        <a href="#" class="action-card" id="generateReportAction">
                            <div class="action-icon">
                                <i class="fas fa-chart-bar"></i>
                            </div>
                            <h4 class="action-title">Generate Report</h4>
                            <p class="action-description">Create comprehensive merchant reports</p>
                        </a>
                    </div>
                </div>

                <!-- Merchant Search -->
                <div class="component-container">
                    <h3 class="section-title">
                        <i class="fas fa-search"></i>
                        Merchant Search & Management
                    </h3>
                    <div id="merchantSearchContainer"></div>
                </div>

                <!-- Coming Soon Features -->
                <div class="component-container">
                    <div id="comingSoonBannerContainer"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div class="loading-overlay hidden" id="loadingOverlay">
        <div class="loading-spinner"></div>
    </div>

    <!-- Scripts -->
    <script src="js/components/session-manager.js"></script>
    <script src="js/components/portfolio-type-filter.js"></script>
    <script src="js/components/risk-level-indicator.js"></script>
    <script src="js/components/mock-data-warning.js"></script>
    <script src="js/components/merchant-search.js"></script>
    <script src="js/components/coming-soon-banner.js"></script>
    
    <script>
        // Application Configuration
        const APP_CONFIG = {
            apiBaseUrl: 'https://api-gateway-service-production-21fd.up.railway.app',
            autoRefresh: true,
            refreshInterval: 30000
        };

        // Global application state
        let appState = {
            currentSession: null,
            selectedFilters: {},
            merchants: [],
            isLoading: false
        };

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });

        async function initializeApp() {
            try {
                showLoading(true);
                
                // Initialize components
                await initializeComponents();
                
                // Load initial data
                await loadInitialData();
                
                // Set up event handlers
                setupEventHandlers();
                
                console.log('KYB Platform initialized successfully');
                
            } catch (error) {
                console.error('Failed to initialize application:', error);
                showError('Failed to initialize application. Please refresh the page.');
            } finally {
                showLoading(false);
            }
        }

        async function initializeComponents() {
            // Initialize Session Manager
            window.sessionManager = new SessionManager({
                container: document.getElementById('sessionManagerContainer'),
                apiBaseUrl: APP_CONFIG.apiBaseUrl,
                showTimer: true,
                showHistory: true,
                onSessionStart: handleSessionStart,
                onSessionEnd: handleSessionEnd,
                onSessionSwitch: handleSessionSwitch,
                onError: handleComponentError
            });

            // Initialize Portfolio Type Filter
            window.portfolioFilter = new PortfolioTypeFilter({
                container: document.getElementById('portfolioFilterContainer'),
                apiBaseUrl: APP_CONFIG.apiBaseUrl,
                mode: 'multiple',
                showCounts: true,
                showDescriptions: true,
                onSelectionChange: handlePortfolioFilterChange,
                onError: handleComponentError
            });

            // Initialize Risk Level Indicator
            window.riskIndicator = new RiskLevelIndicator({
                container: document.getElementById('riskIndicatorContainer'),
                apiBaseUrl: APP_CONFIG.apiBaseUrl,
                compactMode: false,
                showDescriptions: true,
                showCounts: true,
                allowSelection: true,
                onRiskLevelChange: handleRiskLevelChange,
                onError: handleComponentError
            });

            // Initialize Mock Data Warning
            window.mockDataWarning = new MockDataWarning({
                container: document.getElementById('mockDataWarningContainer'),
                apiBaseUrl: APP_CONFIG.apiBaseUrl,
                dataSource: 'mock',
                warningLevel: 'info',
                showDataCount: true,
                showLastUpdated: true,
                showActions: true,
                onDataSourceChange: handleDataSourceChange,
                onError: handleComponentError
            });

            // Initialize Merchant Search
            window.merchantSearch = new MerchantSearch({
                container: document.getElementById('merchantSearchContainer'),
                apiBaseUrl: APP_CONFIG.apiBaseUrl,
                showFilters: true,
                showExport: true,
                autoLoad: true,
                onMerchantSelect: handleMerchantSelect,
                onSearchResults: handleSearchResults,
                onError: handleComponentError
            });

            // Initialize Coming Soon Banner
            window.comingSoonBanner = new ComingSoonBanner({
                container: document.getElementById('comingSoonBannerContainer'),
                apiBaseUrl: APP_CONFIG.apiBaseUrl,
                category: 'merchant-management',
                autoRefresh: APP_CONFIG.autoRefresh,
                showMockDataWarning: true,
                onFeatureUpdate: handleFeatureUpdate,
                onError: handleComponentError
            });
        }

        async function loadInitialData() {
            // Load header statistics
            await loadHeaderStats();
            
            // Refresh all components
            await Promise.all([
                window.sessionManager?.refresh(),
                window.portfolioFilter?.refresh(),
                window.riskIndicator?.refresh(),
                window.mockDataWarning?.refresh(),
                window.merchantSearch?.refresh(),
                window.comingSoonBanner?.refresh()
            ]);
        }

        async function loadHeaderStats() {
            try {
                const response = await fetch(`${APP_CONFIG.apiBaseUrl}/api/v1/merchants/stats`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    }
                });

                if (response.ok) {
                    const stats = await response.json();
                    updateHeaderStats(stats);
                } else {
                    // Fallback to mock stats
                    updateHeaderStats({
                        total_merchants: 1247,
                        active_sessions: 3,
                        pending_reviews: 23
                    });
                }
            } catch (error) {
                console.error('Error loading header stats:', error);
                // Use fallback stats
                updateHeaderStats({
                    total_merchants: 1247,
                    active_sessions: 3,
                    pending_reviews: 23
                });
            }
        }

        function updateHeaderStats(stats) {
            const totalMerchants = document.getElementById('totalMerchants');
            const activeSessions = document.getElementById('activeSessions');
            const pendingReviews = document.getElementById('pendingReviews');

            if (totalMerchants) totalMerchants.textContent = stats.total_merchants?.toLocaleString() || '0';
            if (activeSessions) activeSessions.textContent = stats.active_sessions || '0';
            if (pendingReviews) pendingReviews.textContent = stats.pending_reviews || '0';
        }

        function setupEventHandlers() {
            // Quick action handlers
            document.getElementById('addMerchantAction')?.addEventListener('click', handleAddMerchant);
            document.getElementById('bulkOperationsAction')?.addEventListener('click', handleBulkOperations);
            document.getElementById('compareMerchantsAction')?.addEventListener('click', handleCompareMerchants);
            document.getElementById('generateReportAction')?.addEventListener('click', handleGenerateReport);

            // Global error handler
            window.addEventListener('error', handleGlobalError);
            window.addEventListener('unhandledrejection', handleGlobalError);
        }

        // Event Handlers
        function handleSessionStart(session) {
            console.log('Session started:', session);
            appState.currentSession = session;
            updateHeaderStats({ active_sessions: 1 });
        }

        function handleSessionEnd(session) {
            console.log('Session ended:', session);
            appState.currentSession = null;
            updateHeaderStats({ active_sessions: 0 });
        }

        function handleSessionSwitch(session) {
            console.log('Session switched:', session);
            appState.currentSession = session;
        }

        function handlePortfolioFilterChange(data) {
            console.log('Portfolio filter changed:', data);
            appState.selectedFilters.portfolioTypes = data.selected;
            
            // Update merchant search with new filters
            if (window.merchantSearch) {
                window.merchantSearch.setFilters({
                    portfolio_type: data.selected.join(',')
                });
            }
        }

        function handleRiskLevelChange(data) {
            console.log('Risk level changed:', data);
            appState.selectedFilters.riskLevel = data.riskLevel;
            
            // Update merchant search with new filters
            if (window.merchantSearch) {
                window.merchantSearch.setFilters({
                    risk_level: data.riskLevel
                });
            }
        }

        function handleDataSourceChange(source, dataInfo) {
            console.log('Data source changed:', source, dataInfo);
            appState.dataSource = source;
        }

        function handleMerchantSelect(merchant) {
            console.log('Merchant selected:', merchant);
            // In a real app, this would navigate to merchant detail page
            alert(`Selected merchant: ${merchant.name}\nID: ${merchant.id}\nPortfolio: ${merchant.portfolio_type}\nRisk: ${merchant.risk_level}`);
        }

        function handleSearchResults(merchants, data) {
            console.log('Search results updated:', merchants.length, 'merchants');
            appState.merchants = merchants;
        }

        function handleFeatureUpdate(feature) {
            console.log('Feature updated:', feature);
        }

        function handleComponentError(error) {
            console.error('Component error:', error);
            showError(`Component error: ${error.message}`);
        }

        function handleGlobalError(event) {
            console.error('Global error:', event);
            showError('An unexpected error occurred. Please refresh the page.');
        }

        // Quick Action Handlers
        function handleAddMerchant(event) {
            event.preventDefault();
            console.log('Add merchant action clicked');
            // In a real app, this would open an add merchant modal or navigate to add merchant page
            alert('Add Merchant functionality would open here');
        }

        function handleBulkOperations(event) {
            event.preventDefault();
            console.log('Bulk operations action clicked');
            // In a real app, this would open bulk operations interface
            alert('Bulk Operations functionality would open here');
        }

        function handleCompareMerchants(event) {
            event.preventDefault();
            console.log('Compare merchants action clicked');
            // In a real app, this would open merchant comparison interface
            alert('Merchant Comparison functionality would open here');
        }

        function handleGenerateReport(event) {
            event.preventDefault();
            console.log('Generate report action clicked');
            // In a real app, this would open report generation interface
            alert('Report Generation functionality would open here');
        }

        // Utility Functions
        function showLoading(show) {
            const overlay = document.getElementById('loadingOverlay');
            if (overlay) {
                overlay.classList.toggle('hidden', !show);
            }
            appState.isLoading = show;
        }

        function showError(message) {
            // In a real app, this would show a proper error notification
            console.error('Error:', message);
            alert(`Error: ${message}`);
        }

        // Auto-refresh functionality
        if (APP_CONFIG.autoRefresh) {
            setInterval(() => {
                if (!appState.isLoading) {
                    loadInitialData();
                }
            }, APP_CONFIG.refreshInterval);
        }

        // Export for debugging
        window.KYBApp = {
            state: appState,
            config: APP_CONFIG,
            components: {
                sessionManager: () => window.sessionManager,
                portfolioFilter: () => window.portfolioFilter,
                riskIndicator: () => window.riskIndicator,
                mockDataWarning: () => window.mockDataWarning,
                merchantSearch: () => window.merchantSearch,
                comingSoonBanner: () => window.comingSoonBanner
            },
            refresh: loadInitialData
        };
    </script>
</body>
</html>
