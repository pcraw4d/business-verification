<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Merchant Details - KYB Platform</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="css/risk-indicators.css">
    <script src="components/navigation.js"></script>
    <script src="components/merchant-context.js"></script>
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .card-hover {
            transition: all 0.3s ease-in-out;
        }
        .card-hover:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }
        .confidence-bar {
            background: linear-gradient(90deg, #ef4444 0%, #f97316 25%, #eab308 50%, #22c55e 75%, #3b82f6 100%);
        }
        .risk-gauge {
            background: conic-gradient(from 0deg, #ef4444 0deg, #f97316 72deg, #eab308 144deg, #22c55e 216deg, #3b82f6 288deg, #ef4444 360deg);
        }
        .expandable-section {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-in-out;
            opacity: 0;
        }
        .expandable-section.expanded {
            max-height: 5000px;
            opacity: 1;
        }
        .skeleton-loading {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
        }
        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
        .progressive-disclosure {
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.4s ease-in-out;
        }
        .progressive-disclosure.visible {
            opacity: 1;
            transform: translateY(0);
        }
        /* Enhanced Risk Level Styles */
        .risk-indicator {
            position: relative;
            transition: all 0.3s ease-in-out;
        }
        .risk-indicator:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }
        .risk-badge {
            position: relative;
            overflow: hidden;
            border: 2px solid;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        .risk-badge::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: left 0.5s;
        }
        .risk-badge:hover::before {
            left: 100%;
        }
        .risk-low {
            background: linear-gradient(135deg, #10b981, #059669);
            border-color: #047857;
            color: white;
        }
        .risk-medium {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            border-color: #b45309;
            color: white;
        }
        .risk-high {
            background: linear-gradient(135deg, #f97316, #ea580c);
            border-color: #c2410c;
            color: white;
        }
        .risk-critical {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            border-color: #b91c1c;
            color: white;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }
        .risk-trend {
            position: relative;
            display: inline-flex;
            align-items: center;
            padding: 2px 6px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
        }
        .trend-up {
            background: #fef2f2;
            color: #dc2626;
        }
        .trend-down {
            background: #f0fdf4;
            color: #16a34a;
        }
        .trend-stable {
            background: #f8fafc;
            color: #6b7280;
        }
        /* Tab Styles */
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .tab-button {
            background: none;
            border: none;
            padding: 12px 24px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
        }
        .tab-button.active {
            border-bottom-color: #3498db;
            color: #3498db;
            font-weight: 600;
        }
        .tab-button:hover {
            background: rgba(52, 152, 219, 0.1);
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Navigation -->
    <nav class="bg-white shadow-lg sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <h1 class="text-xl font-bold text-gray-900" id="merchantNameText">Loading...</h1>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <span class="bg-green-100 text-green-800 text-xs font-medium px-2.5 py-0.5 rounded">ENHANCED</span>
                    <span class="bg-blue-100 text-blue-800 text-xs font-medium px-2.5 py-0.5 rounded">LIVE</span>
                    <button id="helpBtn" class="text-gray-600 hover:text-gray-900">
                        <i class="fas fa-question-circle"></i>
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Tab Navigation -->
        <div class="bg-white rounded-lg shadow-lg mb-8">
            <div class="border-b border-gray-200">
                <nav class="-mb-px flex space-x-8" aria-label="Tabs">
                    <button class="tab-button active" data-tab="merchant-details" class="whitespace-nowrap py-2 px-1 border-b-2 border-blue-500 font-medium text-sm text-blue-600">
                        <i class="fas fa-info-circle mr-2"></i>
                        Merchant Details
                    </button>
                    <button class="tab-button" data-tab="business-analytics" class="whitespace-nowrap py-2 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300">
                        <i class="fas fa-chart-line mr-2"></i>
                        Business Analytics
                    </button>
                    <button class="tab-button" data-tab="risk-assessment" class="whitespace-nowrap py-2 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300">
                        <i class="fas fa-exclamation-triangle mr-2"></i>
                        Risk Assessment
                    </button>
                    <button class="tab-button" data-tab="risk-indicators" class="whitespace-nowrap py-2 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300">
                        <i class="fas fa-gauge-high mr-2"></i>
                        Risk Indicators
                    </button>
                </nav>
            </div>
        </div>

        <!-- Tab Content -->
        <!-- Merchant Details Tab -->
        <div class="tab-content active" id="merchant-details">
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h2 class="text-2xl font-bold text-gray-900 mb-6">Merchant Information</h2>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Business Information -->
                    <div class="space-y-4">
                        <h3 class="text-lg font-semibold text-gray-800 flex items-center">
                            <i class="fas fa-building mr-2 text-blue-600"></i>
                            Business Information
                        </h3>
                        <div class="space-y-3">
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Business Name</label>
                                <p class="mt-1 text-sm text-gray-900" id="businessName">-</p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Website</label>
                                <p class="mt-1 text-sm text-gray-900" id="websiteUrl">-</p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Description</label>
                                <p class="mt-1 text-sm text-gray-900" id="businessDescription">-</p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Registration Number</label>
                                <p class="mt-1 text-sm text-gray-900" id="registrationNumber">-</p>
                            </div>
                        </div>
                    </div>

                    <!-- Address Information -->
                    <div class="space-y-4">
                        <h3 class="text-lg font-semibold text-gray-800 flex items-center">
                            <i class="fas fa-map-marker-alt mr-2 text-green-600"></i>
                            Address Information
                        </h3>
                        <div class="space-y-3">
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Street Address</label>
                                <p class="mt-1 text-sm text-gray-900" id="streetAddress">-</p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">City</label>
                                <p class="mt-1 text-sm text-gray-900" id="city">-</p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">State/Province</label>
                                <p class="mt-1 text-sm text-gray-900" id="state">-</p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Postal Code</label>
                                <p class="mt-1 text-sm text-gray-900" id="postalCode">-</p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Country</label>
                                <p class="mt-1 text-sm text-gray-900" id="country">-</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Contact Information -->
                <div class="mt-6 pt-6 border-t border-gray-200">
                    <h3 class="text-lg font-semibold text-gray-800 flex items-center mb-4">
                        <i class="fas fa-phone mr-2 text-purple-600"></i>
                        Contact Information
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Phone Number</label>
                            <p class="mt-1 text-sm text-gray-900" id="phoneNumber">-</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Email Address</label>
                            <p class="mt-1 text-sm text-gray-900" id="email">-</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Business Analytics Tab -->
        <div class="tab-content" id="business-analytics">
            <div id="dashboardResults" class="space-y-8">
                <!-- Core Classification Results -->
                <div id="coreResults" class="progressive-disclosure">
                    <div class="bg-white rounded-lg shadow-lg p-6">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-xl font-bold text-gray-900">Core Classification Results</h3>
                            <button class="text-blue-600 hover:text-blue-800 text-sm font-medium" onclick="toggleSection('coreDetails')">
                                <i class="fas fa-chevron-down mr-1"></i>
                                Show Details
                            </button>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <!-- Primary Industry -->
                            <div class="text-center">
                                <div class="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-3">
                                    <i class="fas fa-industry text-blue-600 text-xl"></i>
                                </div>
                                <h4 class="font-medium text-gray-900" id="primaryIndustry">Technology</h4>
                                <p class="text-sm text-gray-500" id="industryCode">541511</p>
                            </div>
                            
                            <!-- Confidence Score -->
                            <div class="text-center">
                                <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-3">
                                    <i class="fas fa-chart-line text-green-600 text-xl"></i>
                                </div>
                                <h4 class="font-medium text-gray-900">Confidence</h4>
                                <p class="text-sm text-gray-500" id="confidenceScore">85%</p>
                            </div>
                            
                            <!-- Risk Level -->
                            <div class="text-center">
                                <div class="w-16 h-16 bg-yellow-100 rounded-full flex items-center justify-center mx-auto mb-3">
                                    <i class="fas fa-shield-alt text-yellow-600 text-xl"></i>
                                </div>
                                <h4 class="font-medium text-gray-900">Risk Level</h4>
                                <p class="text-sm text-gray-500" id="riskLevel">Low</p>
                            </div>
                        </div>
                        
                        <!-- Expandable Details -->
                        <div id="coreDetails" class="expandable-section mt-6">
                            <div class="border-t pt-6">
                                <!-- Enhanced Classification Results -->
                                <div id="enhancedClassificationResults" class="mb-6">
                                    <!-- Top 3 Results for Each Code Type -->
                                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
                                        <!-- MCC Codes -->
                                        <div id="mccCodesCard" class="bg-gray-50 rounded-lg p-4">
                                            <div class="flex items-center mb-3">
                                                <div class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center mr-3">
                                                    <span class="text-blue-600 font-bold text-sm">M</span>
                                                </div>
                                                <h6 class="font-medium text-gray-900">MCC Codes</h6>
                                            </div>
                                            <div id="mccCodesList" class="space-y-3">
                                                <!-- Populated by JavaScript -->
                                            </div>
                                        </div>
                                        
                                        <!-- SIC Codes -->
                                        <div id="sicCodesCard" class="bg-gray-50 rounded-lg p-4">
                                            <div class="flex items-center mb-3">
                                                <div class="w-8 h-8 bg-red-100 rounded-full flex items-center justify-center mr-3">
                                                    <span class="text-red-600 font-bold text-sm">S</span>
                                                </div>
                                                <h6 class="font-medium text-gray-900">SIC Codes</h6>
                                            </div>
                                            <div id="sicCodesList" class="space-y-3">
                                                <!-- Populated by JavaScript -->
                                            </div>
                                        </div>
                                        
                                        <!-- NAICS Codes -->
                                        <div id="naicsCodesCard" class="bg-gray-50 rounded-lg p-4">
                                            <div class="flex items-center mb-3">
                                                <div class="w-8 h-8 bg-green-100 rounded-full flex items-center justify-center mr-3">
                                                    <span class="text-green-600 font-bold text-sm">N</span>
                                                </div>
                                                <h6 class="font-medium text-gray-900">NAICS Codes</h6>
                                            </div>
                                            <div id="naicsCodesList" class="space-y-3">
                                                <!-- Populated by JavaScript -->
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Method Breakdown -->
                                    <div id="methodBreakdownSection" class="mb-6">
                                        <h5 class="font-medium text-gray-900 mb-3">Classification Methods Used</h5>
                                        <div id="methodBreakdown" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                            <!-- Populated by JavaScript -->
                                        </div>
                                    </div>
                                    
                                    <!-- Website Keywords -->
                                    <div id="websiteKeywordsSection" class="mb-6">
                                        <div class="flex items-center justify-between mb-3">
                                            <h5 class="font-medium text-gray-900">Website Keywords Used</h5>
                                            <button id="toggleKeywordsBtn" class="text-blue-600 hover:text-blue-800 text-sm font-medium flex items-center">
                                                <span id="toggleKeywordsText">Show Keywords</span>
                                                <svg id="toggleKeywordsIcon" class="w-4 h-4 ml-1 transform transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                                </svg>
                                            </button>
                                        </div>
                                        <div id="websiteKeywords" class="flex flex-wrap gap-2" style="display: none;">
                                            <!-- Populated by JavaScript -->
                                        </div>
                                    </div>
                                    
                                    <!-- Classification Reasoning -->
                                    <div id="classificationReasoningSection" class="mb-6">
                                        <h5 class="font-medium text-gray-900 mb-3">Classification Reasoning</h5>
                                        <div id="classificationReasoning" class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                                            <!-- Populated by JavaScript -->
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Security Indicators Section -->
                <div id="securityIndicators" class="progressive-disclosure">
                    <div class="bg-white rounded-lg shadow-lg p-6">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-xl font-bold text-gray-900">Security & Trust Indicators</h3>
                            <button class="text-blue-600 hover:text-blue-800 text-sm font-medium" onclick="toggleSection('securityDetails')">
                                <i class="fas fa-chevron-down mr-1"></i>
                                Show Details
                            </button>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                            <!-- Data Source Trust -->
                            <div class="text-center">
                                <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-3">
                                    <i class="fas fa-shield-check text-green-600 text-xl"></i>
                                </div>
                                <h4 class="font-medium text-gray-900">Data Source</h4>
                                <p class="text-sm text-gray-500" id="dataSourceTrust">Trusted</p>
                            </div>
                            
                            <!-- Website Verification -->
                            <div class="text-center">
                                <div class="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-3">
                                    <i class="fas fa-globe text-blue-600 text-xl"></i>
                                </div>
                                <h4 class="font-medium text-gray-900">Website</h4>
                                <p class="text-sm text-gray-500" id="websiteVerification">Verified</p>
                            </div>
                            
                            <!-- Security Validation -->
                            <div class="text-center">
                                <div class="w-16 h-16 bg-purple-100 rounded-full flex items-center justify-center mx-auto mb-3">
                                    <i class="fas fa-lock text-purple-600 text-xl"></i>
                                </div>
                                <h4 class="font-medium text-gray-900">Security</h4>
                                <p class="text-sm text-gray-500" id="securityValidation">Validated</p>
                            </div>
                            
                            <!-- Trust Score -->
                            <div class="text-center">
                                <div class="w-16 h-16 bg-yellow-100 rounded-full flex items-center justify-center mx-auto mb-3">
                                    <i class="fas fa-star text-yellow-600 text-xl"></i>
                                </div>
                                <h4 class="font-medium text-gray-900">Trust Score</h4>
                                <p class="text-sm text-gray-500" id="trustScore">95%</p>
                            </div>
                        </div>
                        
                        <!-- Expandable Security Details -->
                        <div id="securityDetails" class="expandable-section mt-6">
                            <div class="border-t pt-6">
                                <div id="securityDetailsContent">
                                    <!-- Populated by JavaScript -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Quality Metrics Section -->
                <div id="qualityMetrics" class="progressive-disclosure">
                    <div class="bg-white rounded-lg shadow-lg p-6">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-xl font-bold text-gray-900">Data Quality Metrics</h3>
                            <button class="text-blue-600 hover:text-blue-800 text-sm font-medium" onclick="toggleSection('qualityDetails')">
                                <i class="fas fa-chevron-down mr-1"></i>
                                Show Details
                            </button>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-5 gap-6">
                            <!-- Overall Quality -->
                            <div class="text-center">
                                <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-3">
                                    <i class="fas fa-award text-green-600 text-xl"></i>
                                </div>
                                <h4 class="font-medium text-gray-900">Overall Quality</h4>
                                <p class="text-sm text-gray-500" id="overallQuality">A</p>
                            </div>
                            
                            <!-- Evidence Strength -->
                            <div class="text-center">
                                <div class="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-3">
                                    <i class="fas fa-chart-bar text-blue-600 text-xl"></i>
                                </div>
                                <h4 class="font-medium text-gray-900">Evidence</h4>
                                <p class="text-sm text-gray-500" id="evidenceStrength">Strong</p>
                            </div>
                            
                            <!-- Data Completeness -->
                            <div class="text-center">
                                <div class="w-16 h-16 bg-purple-100 rounded-full flex items-center justify-center mx-auto mb-3">
                                    <i class="fas fa-database text-purple-600 text-xl"></i>
                                </div>
                                <h4 class="font-medium text-gray-900">Completeness</h4>
                                <p class="text-sm text-gray-500" id="dataCompleteness">85%</p>
                            </div>
                            
                            <!-- Agreement Score -->
                            <div class="text-center">
                                <div class="w-16 h-16 bg-yellow-100 rounded-full flex items-center justify-center mx-auto mb-3">
                                    <i class="fas fa-handshake text-yellow-600 text-xl"></i>
                                </div>
                                <h4 class="font-medium text-gray-900">Agreement</h4>
                                <p class="text-sm text-gray-500" id="agreementScore">75%</p>
                            </div>
                            
                            <!-- Consistency -->
                            <div class="text-center">
                                <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-3">
                                    <i class="fas fa-balance-scale text-red-600 text-xl"></i>
                                </div>
                                <h4 class="font-medium text-gray-900">Consistency</h4>
                                <p class="text-sm text-gray-500" id="consistencyScore">Low</p>
                            </div>
                        </div>
                        
                        <!-- Expandable Quality Details -->
                        <div id="qualityDetails" class="expandable-section mt-6">
                            <div class="border-t pt-6">
                                <div id="qualityDetailsContent">
                                    <!-- Populated by JavaScript -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Risk Assessment Section -->
                <div id="riskAssessment" class="progressive-disclosure">
                    <div class="bg-white rounded-lg shadow-lg p-6">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-xl font-bold text-gray-900">Risk Assessment</h3>
                            <button class="text-blue-600 hover:text-blue-800 text-sm font-medium" onclick="toggleSection('riskDetails')">
                                <i class="fas fa-chevron-down mr-1"></i>
                                Show Details
                            </button>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                            <!-- Overall Risk Score -->
                            <div class="text-center">
                                <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-3">
                                    <i class="fas fa-exclamation-triangle text-red-600 text-xl"></i>
                                </div>
                                <h4 class="font-medium text-gray-900">Risk Score</h4>
                                <p class="text-sm text-gray-500" id="overallRiskScore">25</p>
                            </div>
                            
                            <!-- Compliance Risk -->
                            <div class="text-center">
                                <div class="w-16 h-16 bg-yellow-100 rounded-full flex items-center justify-center mx-auto mb-3">
                                    <i class="fas fa-gavel text-yellow-600 text-xl"></i>
                                </div>
                                <h4 class="font-medium text-gray-900">Compliance Risk</h4>
                                <p class="text-sm text-gray-500" id="complianceRisk">Low</p>
                            </div>
                            
                            <!-- Financial Risk -->
                            <div class="text-center">
                                <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-3">
                                    <i class="fas fa-dollar-sign text-green-600 text-xl"></i>
                                </div>
                                <h4 class="font-medium text-gray-900">Financial Risk</h4>
                                <p class="text-sm text-gray-500" id="financialRisk">Low</p>
                            </div>
                            
                            <!-- Operational Risk -->
                            <div class="text-center">
                                <div class="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-3">
                                    <i class="fas fa-cogs text-blue-600 text-xl"></i>
                                </div>
                                <h4 class="font-medium text-gray-900">Operational Risk</h4>
                                <p class="text-sm text-gray-500" id="operationalRisk">Medium</p>
                            </div>
                        </div>
                        
                        <!-- Expandable Risk Details -->
                        <div id="riskDetails" class="expandable-section mt-6">
                            <div class="border-t pt-6">
                                <div id="riskDetailsContent">
                                    <!-- Populated by JavaScript -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Business Intelligence Section -->
                <div id="businessIntelligence" class="progressive-disclosure">
                    <div class="bg-white rounded-lg shadow-lg p-6">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-xl font-bold text-gray-900">Business Intelligence</h3>
                            <button class="text-blue-600 hover:text-blue-800 text-sm font-medium" onclick="toggleSection('intelligenceDetails')">
                                <i class="fas fa-chevron-down mr-1"></i>
                                Show Details
                            </button>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                            <!-- Employee Count -->
                            <div class="text-center">
                                <div class="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-3">
                                    <i class="fas fa-users text-blue-600 text-xl"></i>
                                </div>
                                <h4 class="font-medium text-gray-900">Employees</h4>
                                <p class="text-sm text-gray-500" id="employeeCount">50-100</p>
                            </div>
                            
                            <!-- Revenue Range -->
                            <div class="text-center">
                                <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-3">
                                    <i class="fas fa-chart-line text-green-600 text-xl"></i>
                                </div>
                                <h4 class="font-medium text-gray-900">Revenue</h4>
                                <p class="text-sm text-gray-500" id="revenueRange">$1M-$10M</p>
                            </div>
                            
                            <!-- Founded Year -->
                            <div class="text-center">
                                <div class="w-16 h-16 bg-purple-100 rounded-full flex items-center justify-center mx-auto mb-3">
                                    <i class="fas fa-calendar text-purple-600 text-xl"></i>
                                </div>
                                <h4 class="font-medium text-gray-900">Founded</h4>
                                <p class="text-sm text-gray-500" id="foundedYear">2015</p>
                            </div>
                            
                            <!-- Location -->
                            <div class="text-center">
                                <div class="w-16 h-16 bg-yellow-100 rounded-full flex items-center justify-center mx-auto mb-3">
                                    <i class="fas fa-map-marker-alt text-yellow-600 text-xl"></i>
                                </div>
                                <h4 class="font-medium text-gray-900">Location</h4>
                                <p class="text-sm text-gray-500" id="businessLocation">San Francisco</p>
                            </div>
                        </div>
                        
                        <!-- Expandable Intelligence Details -->
                        <div id="intelligenceDetails" class="expandable-section mt-6">
                            <div class="border-t pt-6">
                                <div id="intelligenceDetailsContent">
                                    <!-- Populated by JavaScript -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Verification Status Section -->
                <div id="verificationStatus" class="progressive-disclosure">
                    <div class="bg-white rounded-lg shadow-lg p-6">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-xl font-bold text-gray-900">Verification Status</h3>
                            <button class="text-blue-600 hover:text-blue-800 text-sm font-medium" onclick="toggleSection('verificationDetails')">
                                <i class="fas fa-chevron-down mr-1"></i>
                                Show Details
                            </button>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                            <!-- Verification Status -->
                            <div class="text-center">
                                <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-3">
                                    <i class="fas fa-check-circle text-green-600 text-xl"></i>
                                </div>
                                <h4 class="font-medium text-gray-900">Status</h4>
                                <p class="text-sm text-gray-500" id="verificationStatus">Complete</p>
                            </div>
                            
                            <!-- Processing Time -->
                            <div class="text-center">
                                <div class="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-3">
                                    <i class="fas fa-clock text-blue-600 text-xl"></i>
                                </div>
                                <h4 class="font-medium text-gray-900">Processing Time</h4>
                                <p class="text-sm text-gray-500" id="processingTime">0.5s</p>
                            </div>
                            
                            <!-- Data Sources -->
                            <div class="text-center">
                                <div class="w-16 h-16 bg-purple-100 rounded-full flex items-center justify-center mx-auto mb-3">
                                    <i class="fas fa-database text-purple-600 text-xl"></i>
                                </div>
                                <h4 class="font-medium text-gray-900">Data Sources</h4>
                                <p class="text-sm text-gray-500" id="dataSources">5 sources</p>
                            </div>
                            
                            <!-- Last Updated -->
                            <div class="text-center">
                                <div class="w-16 h-16 bg-yellow-100 rounded-full flex items-center justify-center mx-auto mb-3">
                                    <i class="fas fa-sync text-yellow-600 text-xl"></i>
                                </div>
                                <h4 class="font-medium text-gray-900">Last Updated</h4>
                                <p class="text-sm text-gray-500" id="lastUpdated">Just now</p>
                            </div>
                        </div>
                        
                        <!-- Expandable Verification Details -->
                        <div id="verificationDetails" class="expandable-section mt-6">
                            <div class="border-t pt-6">
                                <div id="verificationDetailsContent">
                                    <!-- Populated by JavaScript -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Risk Assessment Tab -->
        <div class="tab-content" id="risk-assessment">
            <div id="riskAssessmentContainer"></div>
        </div>

        <!-- Risk Indicators Tab -->
        <div class="tab-content" id="risk-indicators">
            <div id="riskIndicatorsContainer"></div>
        </div>
    </div>

    <script>
        // Merchant Details JavaScript
        class MerchantDetails {
            constructor() {
                this.merchantData = null;
                this.apiResults = null;
                this.init();
            }

            init() {
                this.loadMerchantData();
                this.bindEvents();
                this.initializeComponents();
            }

            async loadMerchantData() {
                try {
                    // Get merchant ID first
                    const merchantId = getMerchantId();
                    console.log('üîç Loading merchant data for ID:', merchantId);
                    
                    // Try to load from session storage first
                    const merchantDataStr = sessionStorage.getItem('merchantData');
                    const apiResultsStr = sessionStorage.getItem('merchantApiResults');
                    
                    if (merchantDataStr) {
                        this.merchantData = JSON.parse(merchantDataStr);
                        this.populateMerchantDetails();
                        console.log('‚úÖ Loaded merchant data from session storage');
                    } else if (merchantId) {
                        // If no session storage, try to load from API
                        console.log('üì° No session storage data, loading from API...');
                        try {
                            const apiConfig = typeof APIConfig !== 'undefined' ? APIConfig : null;
                            if (apiConfig) {
                                const endpoints = apiConfig.getEndpoints();
                                const response = await fetch(endpoints.merchantById(merchantId), {
                                    headers: apiConfig.getHeaders()
                                });
                                if (response.ok) {
                                    this.merchantData = await response.json();
                                    this.populateMerchantDetails();
                                    // Store in session for next time
                                    sessionStorage.setItem('merchantData', JSON.stringify(this.merchantData));
                                    console.log('‚úÖ Loaded merchant data from API');
                                } else {
                                    console.warn('‚ö†Ô∏è API returned error:', response.status);
                                }
                            }
                        } catch (apiError) {
                            console.error('‚ùå Failed to load from API:', apiError);
                        }
                    }
                    
                    if (apiResultsStr) {
                        this.apiResults = JSON.parse(apiResultsStr);
                        this.populateApiResults();
                        console.log('‚úÖ Loaded API results from session storage');
                    } else if (merchantId) {
                        // If no API results in session storage, try to load from API
                        console.log('üì° No API results in session storage, attempting to load from API...');
                        await this.loadBusinessIntelligenceData(merchantId);
                    }
                    
                    // Update page title
                    if (this.merchantData && this.merchantData.businessName) {
                        const nameElement = document.getElementById('merchantNameText');
                        if (nameElement) {
                            nameElement.textContent = this.merchantData.businessName;
                        }
                        document.title = `${this.merchantData.businessName} - Merchant Details - KYB Platform`;
                    }
                    
                } catch (error) {
                    console.error('‚ùå Error loading merchant data:', error);
                    this.showError('Failed to load merchant data');
                }
            }

            populateMerchantDetails() {
                if (!this.merchantData) {
                    console.warn('‚ö†Ô∏è No merchant data to populate');
                    return;
                }

                console.log('üìù Populating merchant details:', this.merchantData);
                console.log('üìù Merchant data structure:', JSON.stringify(this.merchantData, null, 2));

                // Helper function to safely set text content with field name variations
                const setText = (id, ...fieldNames) => {
                    const element = document.getElementById(id);
                    if (!element) {
                        console.warn(`‚ö†Ô∏è Element with ID '${id}' not found`);
                        return;
                    }
                    
                    // Try each field name variation
                    let value = null;
                    for (const fieldName of fieldNames) {
                        if (this.merchantData[fieldName] !== undefined && this.merchantData[fieldName] !== null) {
                            value = this.merchantData[fieldName];
                            break;
                        }
                    }
                    
                    element.textContent = value || '-';
                    if (value) {
                        console.log(`‚úÖ Set ${id} to: ${value}`);
                    }
                };

                // Populate merchant details tab with field name variations
                setText('businessName', 'businessName', 'name', 'business_name', 'companyName', 'company_name');
                setText('websiteUrl', 'websiteUrl', 'website', 'website_url', 'url', 'domain');
                setText('businessDescription', 'businessDescription', 'description', 'business_description', 'about', 'summary');
                setText('registrationNumber', 'registrationNumber', 'registration_number', 'regNumber', 'reg_number', 'ein', 'taxId', 'tax_id');
                setText('streetAddress', 'streetAddress', 'address', 'street_address', 'street', 'addressLine1', 'address_line1');
                setText('city', 'city');
                setText('state', 'state', 'province', 'region');
                setText('postalCode', 'postalCode', 'postal_code', 'zipCode', 'zip_code', 'zip');
                setText('country', 'country', 'countryCode', 'country_code');
                setText('phoneNumber', 'phoneNumber', 'phone', 'phone_number', 'telephone', 'contactPhone', 'contact_phone');
                setText('email', 'email', 'contactEmail', 'contact_email', 'businessEmail', 'business_email');
                
                console.log('‚úÖ Merchant details populated');
            }

            populateApiResults() {
                if (!this.apiResults) {
                    console.warn('‚ö†Ô∏è No API results available');
                    return;
                }

                console.log('üì¶ API Results structure:', Object.keys(this.apiResults));
                console.log('üì¶ API Results:', JSON.stringify(this.apiResults, null, 2));

                // Populate Business Intelligence results
                if (this.apiResults.businessIntelligence) {
                    console.log('‚úÖ Found businessIntelligence in apiResults');
                    this.populateBusinessIntelligenceResults(this.apiResults.businessIntelligence);
                } else {
                    console.warn('‚ö†Ô∏è No businessIntelligence in apiResults');
                    // Try to load from API
                    const merchantId = getMerchantId();
                    if (merchantId) {
                        this.loadBusinessIntelligenceData(merchantId);
                    }
                }

                // Populate Risk Assessment results
                if (this.apiResults.riskAssessment) {
                    this.populateRiskAssessmentResults(this.apiResults.riskAssessment);
                }

                // Populate Risk Indicators results
                if (this.apiResults.riskIndicators) {
                    this.populateRiskIndicatorsResults(this.apiResults.riskIndicators);
                }
            }

            populateBusinessIntelligenceResults(data) {
                console.log('üìä Populating Business Intelligence results:', data);
                console.log('üìä Data type:', typeof data);
                console.log('üìä Is data null?', data === null);
                console.log('üìä Is data undefined?', data === undefined);
                console.log('üìä Data keys:', data ? Object.keys(data) : 'N/A');
                console.log('üìä Actual BI data structure:', JSON.stringify(data, null, 2));
                
                // Check if data is empty or invalid
                if (!data || (typeof data === 'object' && Object.keys(data).length === 0)) {
                    console.warn('‚ö†Ô∏è Business Intelligence data is empty or invalid');
                    console.log('üîç Attempting to load BI data from API...');
                    const merchantId = getMerchantId();
                    if (merchantId) {
                        await this.loadBusinessIntelligenceData(merchantId);
                    }
                    return;
                }
                
                // Extract data from various possible structures
                let result = data;
                if (data.business_intelligence) {
                    result = data.business_intelligence;
                } else if (data.response) {
                    result = data.response;
                }
                
                // Extract classification codes
                let mccCodes = [];
                let sicCodes = [];
                let naicsCodes = [];
                let primaryIndustry = 'Unknown';
                let confidenceScore = 0;
                let methodsUsed = [];
                let websiteKeywords = [];
                let classificationReasoning = '';
                
                // First, check for top-level primary_industry (new format)
                if (result.primary_industry) {
                    primaryIndustry = result.primary_industry;
                }
                if (result.confidence_score !== undefined) {
                    confidenceScore = result.confidence_score;
                }
                
                // Try different data structures
                if (result.response && result.response.classification_codes) {
                    const codes = result.response.classification_codes;
                    mccCodes = codes.mcc || [];
                    sicCodes = codes.sic || [];
                    naicsCodes = codes.naics || [];
                    primaryIndustry = result.response.primary_classification?.industry_name || result.response.detected_industry || 'Unknown';
                    confidenceScore = result.response.primary_classification?.confidence_score || result.response.overall_confidence || 0;
                    methodsUsed = result.response.methods_used || result.response.classification_methods || [];
                    websiteKeywords = result.response.website_keywords || result.response.keywords || [];
                    classificationReasoning = result.response.reasoning || result.response.classification_reasoning || result.response.explanation || '';
                } else if (result.classification_codes) {
                    mccCodes = result.classification_codes.mcc || [];
                    sicCodes = result.classification_codes.sic || [];
                    naicsCodes = result.classification_codes.naics || [];
                    primaryIndustry = result.primary_classification?.industry_name || result.detected_industry || 'Unknown';
                    confidenceScore = result.primary_classification?.confidence_score || result.overall_confidence || 0;
                    methodsUsed = result.methods_used || result.classification_methods || [];
                    websiteKeywords = result.website_keywords || result.keywords || [];
                    classificationReasoning = result.reasoning || result.classification_reasoning || result.explanation || '';
                } else if (result.classification) {
                    // Check for direct mcc_codes, naics_codes, sic_codes structure (new format)
                    if (result.classification.mcc_codes || result.classification.naics_codes || result.classification.sic_codes) {
                        mccCodes = result.classification.mcc_codes || [];
                        sicCodes = result.classification.sic_codes || [];
                        naicsCodes = result.classification.naics_codes || [];
                        // Use classification.industry first, then fallback to top-level primary_industry, then other options
                        primaryIndustry = result.classification.industry || primaryIndustry || result.classification.primary_industry || result.classification.industry_name || 'Unknown';
                        confidenceScore = result.classification.confidence_score || result.classification.confidence || 0;
                        methodsUsed = result.classification.methods_used || result.classification.methods || [];
                        websiteKeywords = result.classification.website_keywords || result.classification.keywords || [];
                        classificationReasoning = result.classification.reasoning || result.classification.explanation || '';
                    } else if (result.classification.classification_codes) {
                        // Check for nested classification_codes structure (legacy format)
                        const codes = result.classification.classification_codes;
                        mccCodes = codes.mcc || [];
                        sicCodes = codes.sic || [];
                        naicsCodes = codes.naics || [];
                        primaryIndustry = result.classification.primary_industry || result.classification.industry_name || 'Unknown';
                        confidenceScore = result.classification.confidence_score || result.classification.confidence || 0;
                        methodsUsed = result.classification.methods_used || result.classification.methods || [];
                        websiteKeywords = result.classification.website_keywords || result.classification.keywords || [];
                        classificationReasoning = result.classification.reasoning || result.classification.explanation || '';
                    }
                } else if (result.data) {
                    // Try nested data structure
                    const dataObj = result.data;
                    if (dataObj.classification_codes) {
                        mccCodes = dataObj.classification_codes.mcc || [];
                        sicCodes = dataObj.classification_codes.sic || [];
                        naicsCodes = dataObj.classification_codes.naics || [];
                    }
                    primaryIndustry = dataObj.primary_industry || dataObj.industry_name || 'Unknown';
                    confidenceScore = dataObj.confidence_score || dataObj.confidence || 0;
                    methodsUsed = dataObj.methods_used || dataObj.classification_methods || [];
                    websiteKeywords = dataObj.website_keywords || dataObj.keywords || [];
                    classificationReasoning = dataObj.reasoning || dataObj.explanation || '';
                }
                
                // Log extracted data
                console.log('üìä Extracted data:', {
                    mccCodes: mccCodes.length,
                    sicCodes: sicCodes.length,
                    naicsCodes: naicsCodes.length,
                    primaryIndustry,
                    confidenceScore,
                    methodsUsed: methodsUsed.length,
                    websiteKeywords: websiteKeywords.length,
                    hasReasoning: !!classificationReasoning
                });
                
                // Populate primary industry and confidence
                const primaryIndustryEl = document.getElementById('primaryIndustry');
                const industryCodeEl = document.getElementById('industryCode');
                const confidenceScoreEl = document.getElementById('confidenceScore');
                
                console.log('üîç Element check:', {
                    primaryIndustryEl: !!primaryIndustryEl,
                    industryCodeEl: !!industryCodeEl,
                    confidenceScoreEl: !!confidenceScoreEl
                });
                
                if (primaryIndustryEl) {
                    primaryIndustryEl.textContent = primaryIndustry;
                    console.log(`‚úÖ Set primaryIndustry to: ${primaryIndustry}`);
                } else {
                    console.warn('‚ö†Ô∏è primaryIndustry element not found');
                }
                
                if (industryCodeEl) {
                    if (naicsCodes.length > 0) {
                        const code = typeof naicsCodes[0] === 'string' ? naicsCodes[0] : (naicsCodes[0].code || naicsCodes[0].naics_code || '-');
                        industryCodeEl.textContent = code;
                        console.log(`‚úÖ Set industryCode to: ${code}`);
                    } else {
                        industryCodeEl.textContent = '-';
                        console.warn('‚ö†Ô∏è No NAICS codes available');
                    }
                } else {
                    console.warn('‚ö†Ô∏è industryCode element not found');
                }
                
                if (confidenceScoreEl) {
                    confidenceScoreEl.textContent = `${Math.round(confidenceScore * 100)}%`;
                    console.log(`‚úÖ Set confidenceScore to: ${Math.round(confidenceScore * 100)}%`);
                } else {
                    console.warn('‚ö†Ô∏è confidenceScore element not found');
                }
                
                // Populate MCC codes
                const mccList = document.getElementById('mccCodesList');
                console.log('üîç MCC list element:', !!mccList, 'MCC codes count:', mccCodes.length);
                if (mccList) {
                    if (mccCodes.length > 0) {
                        const mccHTML = mccCodes.slice(0, 3).map((code, index) => {
                            const codeObj = typeof code === 'string' ? { code, description: code } : code;
                            const codeValue = codeObj.code || codeObj.mcc_code || codeObj.mcc || (typeof code === 'string' ? code : 'Unknown');
                            const description = codeObj.description || codeObj.name || codeValue;
                            return `
                                <div class="bg-white rounded-lg p-3 border border-gray-200">
                                    <div class="flex justify-between items-start mb-2">
                                        <span class="bg-blue-100 text-blue-600 text-xs font-bold px-2 py-1 rounded-full">#${index + 1}</span>
                                        <span class="text-xs text-gray-500">${Math.round((codeObj.confidence || 0.8) * 100)}%</span>
                                    </div>
                                    <h6 class="font-medium text-gray-900 mb-1 text-sm">${description}</h6>
                                    <p class="text-xs text-gray-600 font-mono">${codeValue}</p>
                                </div>
                            `;
                        }).join('');
                        mccList.innerHTML = mccHTML;
                        console.log(`‚úÖ Populated ${mccCodes.slice(0, 3).length} MCC codes`);
                    } else {
                        mccList.innerHTML = '<p class="text-sm text-gray-500">No MCC codes found</p>';
                        console.warn('‚ö†Ô∏è No MCC codes to display');
                    }
                } else {
                    console.error('‚ùå mccCodesList element not found in DOM');
                }
                
                // Populate SIC codes
                const sicList = document.getElementById('sicCodesList');
                console.log('üîç SIC list element:', !!sicList, 'SIC codes count:', sicCodes.length);
                if (sicList) {
                    if (sicCodes.length > 0) {
                        const sicHTML = sicCodes.slice(0, 3).map((code, index) => {
                            const codeObj = typeof code === 'string' ? { code, description: code } : code;
                            const codeValue = codeObj.code || codeObj.sic_code || codeObj.sic || (typeof code === 'string' ? code : 'Unknown');
                            const description = codeObj.description || codeObj.name || codeValue;
                            return `
                                <div class="bg-white rounded-lg p-3 border border-gray-200">
                                    <div class="flex justify-between items-start mb-2">
                                        <span class="bg-red-100 text-red-600 text-xs font-bold px-2 py-1 rounded-full">#${index + 1}</span>
                                        <span class="text-xs text-gray-500">${Math.round((codeObj.confidence || 0.8) * 100)}%</span>
                                    </div>
                                    <h6 class="font-medium text-gray-900 mb-1 text-sm">${description}</h6>
                                    <p class="text-xs text-gray-600 font-mono">${codeValue}</p>
                                </div>
                            `;
                        }).join('');
                        sicList.innerHTML = sicHTML;
                        console.log(`‚úÖ Populated ${sicCodes.slice(0, 3).length} SIC codes`);
                    } else {
                        sicList.innerHTML = '<p class="text-sm text-gray-500">No SIC codes found</p>';
                        console.warn('‚ö†Ô∏è No SIC codes to display');
                    }
                } else {
                    console.error('‚ùå sicCodesList element not found in DOM');
                }
                
                // Populate NAICS codes
                const naicsList = document.getElementById('naicsCodesList');
                console.log('üîç NAICS list element:', !!naicsList, 'NAICS codes count:', naicsCodes.length);
                if (naicsList) {
                    if (naicsCodes.length > 0) {
                        const naicsHTML = naicsCodes.slice(0, 3).map((code, index) => {
                            const codeObj = typeof code === 'string' ? { code, description: code } : code;
                            const codeValue = codeObj.code || codeObj.naics_code || codeObj.naics || (typeof code === 'string' ? code : 'Unknown');
                            const description = codeObj.description || codeObj.name || codeValue;
                            return `
                                <div class="bg-white rounded-lg p-3 border border-gray-200">
                                    <div class="flex justify-between items-start mb-2">
                                        <span class="bg-green-100 text-green-600 text-xs font-bold px-2 py-1 rounded-full">#${index + 1}</span>
                                        <span class="text-xs text-gray-500">${Math.round((codeObj.confidence || 0.8) * 100)}%</span>
                                    </div>
                                    <h6 class="font-medium text-gray-900 mb-1 text-sm">${description}</h6>
                                    <p class="text-xs text-gray-600 font-mono">${codeValue}</p>
                                </div>
                            `;
                        }).join('');
                        naicsList.innerHTML = naicsHTML;
                        console.log(`‚úÖ Populated ${naicsCodes.slice(0, 3).length} NAICS codes`);
                    } else {
                        naicsList.innerHTML = '<p class="text-sm text-gray-500">No NAICS codes found</p>';
                        console.warn('‚ö†Ô∏è No NAICS codes to display');
                    }
                } else {
                    console.error('‚ùå naicsCodesList element not found in DOM');
                }
                
                // Populate method breakdown
                const methodBreakdownEl = document.getElementById('methodBreakdown');
                if (methodBreakdownEl) {
                    if (methodsUsed.length > 0) {
                        methodBreakdownEl.innerHTML = methodsUsed.map(method => {
                            const methodName = typeof method === 'string' ? method : (method.name || method.method || 'Unknown');
                            const methodConfidence = typeof method === 'object' && method.confidence ? Math.round(method.confidence * 100) : 'N/A';
                            return `
                                <div class="bg-white rounded-lg p-3 border border-gray-200">
                                    <div class="flex justify-between items-center">
                                        <span class="font-medium text-gray-900 text-sm">${methodName}</span>
                                        <span class="text-xs text-gray-500">${methodConfidence}%</span>
                                    </div>
                                </div>
                            `;
                        }).join('');
                    } else {
                        methodBreakdownEl.innerHTML = '<p class="text-sm text-gray-500">No classification methods information available</p>';
                    }
                }
                
                // Populate website keywords
                const websiteKeywordsEl = document.getElementById('websiteKeywords');
                if (websiteKeywordsEl && websiteKeywords.length > 0) {
                    websiteKeywordsEl.innerHTML = websiteKeywords.map(keyword => {
                        const keywordText = typeof keyword === 'string' ? keyword : (keyword.text || keyword.keyword || keyword);
                        return `<span class="bg-blue-100 text-blue-800 text-xs font-medium px-2 py-1 rounded-full">${keywordText}</span>`;
                    }).join('');
                    
                    // Set up toggle button
                    const toggleKeywordsBtn = document.getElementById('toggleKeywordsBtn');
                    if (toggleKeywordsBtn) {
                        toggleKeywordsBtn.addEventListener('click', () => {
                            const isVisible = websiteKeywordsEl.style.display !== 'none';
                            websiteKeywordsEl.style.display = isVisible ? 'none' : 'flex';
                            const toggleText = document.getElementById('toggleKeywordsText');
                            const toggleIcon = document.getElementById('toggleKeywordsIcon');
                            if (toggleText) toggleText.textContent = isVisible ? 'Show Keywords' : 'Hide Keywords';
                            if (toggleIcon) toggleIcon.style.transform = isVisible ? 'rotate(0deg)' : 'rotate(180deg)';
                        });
                    }
                } else if (websiteKeywordsEl) {
                    websiteKeywordsEl.innerHTML = '<p class="text-sm text-gray-500">No website keywords available</p>';
                }
                
                // Populate classification reasoning
                const classificationReasoningEl = document.getElementById('classificationReasoning');
                if (classificationReasoningEl) {
                    if (classificationReasoning) {
                        classificationReasoningEl.innerHTML = `<p class="text-sm text-gray-700">${classificationReasoning}</p>`;
                    } else {
                        classificationReasoningEl.innerHTML = '<p class="text-sm text-gray-500">No classification reasoning available</p>';
                    }
                }
                
                // Show progressive disclosure sections
                setTimeout(() => {
                    const element = document.getElementById('coreResults');
                    if (element) element.classList.add('visible');
                }, 100);
                
                setTimeout(() => {
                    const element = document.getElementById('securityIndicators');
                    if (element) element.classList.add('visible');
                }, 200);
                
                setTimeout(() => {
                    const element = document.getElementById('qualityMetrics');
                    if (element) element.classList.add('visible');
                }, 300);
            }

            populateRiskAssessmentResults(data) {
                console.log('Populating Risk Assessment results:', data);
            }

            populateRiskIndicatorsResults(data) {
                console.log('Populating Risk Indicators results:', data);
            }

            async loadBusinessIntelligenceData(merchantId) {
                try {
                    console.log('üì° Loading Business Intelligence data from API for merchant:', merchantId);
                    
                    // Try to get BI data from merchant data first
                    if (this.merchantData && this.merchantData.businessIntelligence) {
                        console.log('‚úÖ Found BI data in merchant data');
                        if (!this.apiResults) {
                            this.apiResults = {};
                        }
                        this.apiResults.businessIntelligence = this.merchantData.businessIntelligence;
                        this.populateBusinessIntelligenceResults(this.apiResults.businessIntelligence);
                        return;
                    }
                    
                    // Try to fetch from merchant API (might have BI embedded)
                    const apiConfig = typeof APIConfig !== 'undefined' ? APIConfig : null;
                    if (apiConfig && merchantId) {
                        const endpoints = apiConfig.getEndpoints();
                        console.log('üì° Fetching merchant data from:', endpoints.merchantById(merchantId));
                        
                        try {
                            const response = await fetch(endpoints.merchantById(merchantId), {
                                headers: apiConfig.getHeaders()
                            });
                            
                            console.log('üì° Merchant API response status:', response.status);
                            console.log('üì° Merchant API response headers:', Object.fromEntries(response.headers.entries()));
                            
                            if (!response.ok) {
                                const errorText = await response.text().catch(() => 'Unknown error');
                                console.error('‚ùå Merchant API error:', response.status, errorText.substring(0, 200));
                                throw new Error(`HTTP ${response.status}: ${errorText.substring(0, 100)}`);
                            }
                            
                            const contentType = response.headers.get('content-type') || '';
                            if (!contentType.includes('application/json')) {
                                const text = await response.text();
                                console.error('‚ùå Merchant API returned non-JSON:', text.substring(0, 200));
                                throw new Error(`API returned non-JSON. Status: ${response.status}`);
                            }
                            
                            const merchantData = await response.json();
                            console.log('üì¶ Merchant data from API (full):', JSON.stringify(merchantData, null, 2));
                            console.log('üì¶ Merchant data keys:', Object.keys(merchantData));
                            
                            // Update merchant data
                            this.merchantData = merchantData;
                            this.populateMerchantDetails();
                            
                            // Check if BI data is embedded in merchant response
                            if (merchantData.businessIntelligence || merchantData.business_intelligence || merchantData.business_intelligence_results) {
                                if (!this.apiResults) {
                                    this.apiResults = {};
                                }
                                this.apiResults.businessIntelligence = merchantData.businessIntelligence || merchantData.business_intelligence || merchantData.business_intelligence_results;
                                this.populateBusinessIntelligenceResults(this.apiResults.businessIntelligence);
                                
                                // Store in sessionStorage
                                sessionStorage.setItem('merchantApiResults', JSON.stringify(this.apiResults));
                                sessionStorage.setItem('merchantData', JSON.stringify(merchantData));
                                console.log('‚úÖ Loaded and stored BI data from merchant API');
                                return;
                            } else {
                                console.log('‚ö†Ô∏è No BI data found in merchant response, will try BI service');
                            }
                        } catch (fetchError) {
                            console.error('‚ùå Failed to fetch merchant data:', fetchError);
                            throw fetchError;
                        }
                    }
                    
                    // If still no data, try BI service directly
                    if (apiConfig) {
                        const endpoints = apiConfig.getEndpoints();
                        // Check if we have merchant data to use for BI analysis
                        if (this.merchantData) {
                            console.log('üì° Attempting to fetch BI data from BI service...');
                            try {
                                const biResponse = await fetch(`${apiConfig.getBaseURL()}/api/v1/bi/analyze`, {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json',
                                        ...apiConfig.getHeaders()
                                    },
                                    body: JSON.stringify({
                                        business_name: this.merchantData.businessName || this.merchantData.name,
                                        website_url: this.merchantData.websiteUrl || this.merchantData.website,
                                        description: this.merchantData.businessDescription || this.merchantData.description || ''
                                    })
                                });
                                
                                if (biResponse.ok) {
                                    const biData = await biResponse.json();
                                    console.log('‚úÖ BI data from BI service:', biData);
                                    
                                    if (!this.apiResults) {
                                        this.apiResults = {};
                                    }
                                    this.apiResults.businessIntelligence = biData;
                                    this.populateBusinessIntelligenceResults(biData);
                                    
                                    // Store in sessionStorage
                                    sessionStorage.setItem('merchantApiResults', JSON.stringify(this.apiResults));
                                    console.log('‚úÖ Loaded and stored BI data from BI service');
                                    return;
                                } else {
                                    console.warn('‚ö†Ô∏è BI service returned error:', biResponse.status);
                                }
                            } catch (biError) {
                                console.error('‚ùå Failed to fetch from BI service:', biError);
                            }
                        }
                    }
                    
                    console.warn('‚ö†Ô∏è Could not load BI data from any source');
                } catch (error) {
                    console.error('‚ùå Error loading Business Intelligence data:', error);
                }
            }

            bindEvents() {
                // Tab switching
                document.querySelectorAll('.tab-button').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const tabId = e.target.closest('.tab-button').dataset.tab;
                        this.switchTab(tabId);
                    });
                });
            }

            switchTab(tabId) {
                // Skip Risk Indicators tab - let our new implementation handle it
                if (tabId === 'risk-indicators') {
                    console.log('üîÑ Skipping Risk Indicators tab - handled by new implementation');
                    return;
                }
                
                // Handle Risk Assessment tab - set merchant ID for MerchantRiskTab
                if (tabId === 'risk-assessment') {
                    const merchantId = getMerchantId();
                    if (merchantId) {
                        window.currentMerchantId = merchantId;
                        console.log('üéØ Risk Assessment tab clicked, setting merchant ID:', merchantId);
                        
                        // Initialize MerchantRiskTab if available
                        if (typeof MerchantRiskTab !== 'undefined' && !window.merchantRiskTab) {
                            const container = document.getElementById('riskAssessmentContainer');
                            if (container) {
                                window.merchantRiskTab = new MerchantRiskTab();
                                window.merchantRiskTab.loadRiskAssessmentContent(container);
                            }
                        } else if (window.merchantRiskTab) {
                            const container = document.getElementById('riskAssessmentContainer');
                            if (container) {
                                window.merchantRiskTab.loadRiskAssessmentContent(container);
                            }
                        }
                    }
                }
                
                // Remove active class from all tabs and buttons
                document.querySelectorAll('.tab-content').forEach(tab => {
                    tab.classList.remove('active');
                });
                document.querySelectorAll('.tab-button').forEach(button => {
                    button.classList.remove('active');
                });

                // Add active class to selected tab and button
                const tabElement = document.getElementById(tabId);
                const buttonElement = document.querySelector(`[data-tab="${tabId}"]`);
                
                if (tabElement) tabElement.classList.add('active');
                if (buttonElement) buttonElement.classList.add('active');
            }

            initializeComponents() {
                // Initialize navigation if available
                if (typeof KYBNavigation !== 'undefined') {
                    new KYBNavigation();
                }
            }

            showError(message) {
                console.error(message);
                // You can implement a proper error display here
            }
        }

        // Global functions for expandable sections
        function toggleSection(sectionId) {
            const section = document.getElementById(sectionId);
            if (section) {
                const isExpanded = section.classList.contains('expanded');
                section.classList.toggle('expanded');
                console.log(`üìÇ Section ${sectionId} ${isExpanded ? 'collapsed' : 'expanded'}`);
                
                // Ensure content is visible when expanded
                if (section.classList.contains('expanded')) {
                    // Force display if needed
                    section.style.display = '';
                    section.style.visibility = 'visible';
                }
            } else {
                console.warn(`‚ö†Ô∏è Section with ID '${sectionId}' not found`);
            }
        }

        // Initialize when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            window.merchantDetails = new MerchantDetails();
        });
    </script>

    <!-- Risk Indicators Components -->
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="js/api-config.js"></script>
    <script src="js/components/real-data-integration.js"></script>
    <script src="js/components/risk-visualization.js"></script>
    <script src="js/components/risk-explainability.js"></script>
    <script src="js/components/risk-level-indicator.js"></script>
    <script src="js/utils/risk-indicators-helpers.js"></script>
    <script src="js/components/risk-indicators-ui-template.js"></script>
    <script src="js/components/risk-indicators-data-service.js"></script>
    <script src="js/components/website-risk-display.js"></script>
    
    <!-- Shared Component Library (load as modules) -->
    <script type="module">
        // Import and expose shared components globally
        try {
            const { getEventBus } = await import('./shared/events/event-bus.js');
            const { getRiskDataService } = await import('./shared/data-services/risk-data-service.js');
            const { getMerchantDataService } = await import('./shared/data-services/merchant-data-service.js');
            const { getRiskVisualizations } = await import('./shared/visualizations/risk-visualizations.js');
            const { getCrossTabNavigation } = await import('./shared/navigation/cross-tab-navigation.js');
            const { getExportService } = await import('./shared/components/export-service.js');
            const { getAlertService } = await import('./shared/components/alert-service.js');
            
            // Make available globally for non-module scripts
            window.getEventBus = getEventBus;
            window.getRiskDataService = getRiskDataService;
            window.getMerchantDataService = getMerchantDataService;
            window.getRiskVisualizations = getRiskVisualizations;
            window.getCrossTabNavigation = getCrossTabNavigation;
            window.getExportService = getExportService;
            window.getAlertService = getAlertService;
            
            console.log('‚úÖ Shared component library loaded');
            
            // Dispatch event when components are ready
            window.dispatchEvent(new CustomEvent('sharedComponentsReady'));
        } catch (error) {
            console.error('‚ùå Failed to load shared components:', error);
            // Components will use fallback behavior
        }
    </script>
    
    <!-- Predictive Risk Forecast Component -->
    <script src="js/components/predictive-risk-forecast.js"></script>
    
    <!-- Main Risk Indicators Tab Component -->
    <script src="js/components/merchant-risk-indicators-tab.js"></script>

    <!-- Initialize Risk Indicators Tab -->
    <script>
        // Helper function to get merchant ID
        function getMerchantId() {
            // Try to get from URL parameters first
            const urlParams = new URLSearchParams(window.location.search);
            const merchantIdFromUrl = urlParams.get('merchantId') || urlParams.get('id');
            if (merchantIdFromUrl) {
                return merchantIdFromUrl;
            }
            
            // Try to get from session storage
            const merchantDataStr = sessionStorage.getItem('merchantData');
            if (merchantDataStr) {
                try {
                    const merchantData = JSON.parse(merchantDataStr);
                    return merchantData.id || merchantData.merchantId || merchantData.businessId;
                } catch (e) {
                    console.warn('Failed to parse merchant data from session storage:', e);
                }
            }
            
            // Try to get from global merchant details instance
            if (window.merchantDetails && window.merchantDetails.merchantData) {
                return window.merchantDetails.merchantData.id || 
                       window.merchantDetails.merchantData.merchantId || 
                       window.merchantDetails.merchantData.businessId;
            }
            
            // Fallback: generate a test merchant ID for demo purposes
            console.warn('No merchant ID found, using demo merchant ID');
            return 'demo-merchant-123';
        }

        // Initialize NEW Risk Indicators Tab (run after existing DOMContentLoaded)
        setTimeout(function() {
            console.log('üöÄ DOM loaded, initializing NEW Risk Indicators Tab...');
            console.log('üîç Checking if D3.js is loaded:', typeof d3);
            console.log('üîç Checking if MerchantRiskIndicatorsTab class exists:', typeof MerchantRiskIndicatorsTab);
            console.log('üîç Checking if RiskIndicatorsUITemplate exists:', typeof RiskIndicatorsUITemplate);
            console.log('üîç Checking if RiskIndicatorsDataService exists:', typeof RiskIndicatorsDataService);
            console.log('üîç Checking if APIConfig exists:', typeof APIConfig);
            console.log('üîç Checking if RealDataIntegration exists:', typeof RealDataIntegration);
            
            // Initialize Risk Indicators Tab
            try {
                if (typeof MerchantRiskIndicatorsTab === 'undefined') {
                    console.error('‚ùå MerchantRiskIndicatorsTab class not found!');
                    return;
                }
                window.riskIndicatorsTab = new MerchantRiskIndicatorsTab('riskIndicatorsContainer');
                console.log('‚úÖ NEW Risk Indicators Tab initialized successfully');
                
                // Try to initialize visualization component if D3.js is available
                if (typeof d3 !== 'undefined') {
                    window.riskIndicatorsTab.initializeVisualization();
                } else {
                    console.warn('‚ö†Ô∏è D3.js not available, visualization will be initialized later');
                }
                
                // Auto-load if merchant ID is available and Risk Indicators tab is active
                const merchantId = getMerchantId();
                const riskIndicatorsTab = document.getElementById('risk-indicators');
                if (merchantId && riskIndicatorsTab && riskIndicatorsTab.classList.contains('active')) {
                    console.log('üîÑ Auto-loading Risk Indicators tab for merchant:', merchantId);
                    window.riskIndicatorsTab.init(merchantId).catch(error => {
                        console.error('‚ùå Auto-load failed:', error);
                    });
                }
            } catch (error) {
                console.error('‚ùå Failed to initialize NEW Risk Indicators Tab:', error);
            }
            
            // Listen for tab activation
            console.log('üîç Looking for Risk Indicators tab button...');
            const riskIndicatorsTabButton = document.querySelector('[data-tab="risk-indicators"]');
            console.log('üîç Found button:', riskIndicatorsTabButton);
            console.log('üîç All tab buttons:', document.querySelectorAll('.tab-button'));
            console.log('üîç All data-tab attributes:', document.querySelectorAll('[data-tab]'));
            
            if (riskIndicatorsTabButton) {
                console.log('‚úÖ Risk Indicators tab button found');
                
                // Remove any existing event listeners by cloning the button
                const newButton = riskIndicatorsTabButton.cloneNode(true);
                riskIndicatorsTabButton.parentNode.replaceChild(newButton, riskIndicatorsTabButton);
                
                // Add our new event listener to the clean button
                newButton.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('üéØ NEW Risk Indicators Tab button clicked!');
                    
                    // Handle tab switching (add/remove active classes)
                    document.querySelectorAll('.tab-content').forEach(tab => {
                        tab.classList.remove('active');
                    });
                    document.querySelectorAll('.tab-button').forEach(button => {
                        button.classList.remove('active');
                    });
                    
                    // Add active class to Risk Indicators tab and button
                    const tabElement = document.getElementById('risk-indicators');
                    if (tabElement) tabElement.classList.add('active');
                    newButton.classList.add('active');
                    
                    const merchantId = getMerchantId();
                    console.log('üéØ Risk Indicators Tab clicked, merchant ID:', merchantId);
                    if (merchantId && window.riskIndicatorsTab) {
                        console.log('üéØ Calling NEW Risk Indicators Tab init...');
                        window.riskIndicatorsTab.init(merchantId).catch(error => {
                            console.error('‚ùå Failed to initialize Risk Indicators Tab:', error);
                            const container = document.getElementById('riskIndicatorsContainer');
                            if (container) {
                                container.innerHTML = `
                                    <div class="bg-red-50 border border-red-200 rounded-lg p-6">
                                        <h3 class="font-bold text-red-800 mb-2">Error Loading Risk Indicators</h3>
                                        <p class="text-red-600 mb-2">Merchant ID: ${merchantId}</p>
                                        <p class="text-red-600 mb-4">Error: ${error.message || 'Unknown error'}</p>
                                        <button onclick="window.riskIndicatorsTab.init('${merchantId}')" class="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700">
                                            Retry
                                        </button>
                                    </div>
                                `;
                            }
                        });
                    } else {
                        console.error('‚ùå No merchant ID found or risk indicators tab not initialized');
                        const container = document.getElementById('riskIndicatorsContainer');
                        if (container) {
                            container.innerHTML = `
                                <div class="bg-yellow-100 border border-yellow-400 text-yellow-700 px-4 py-3 rounded">
                                    <h3 class="font-bold">Risk Indicators Tab</h3>
                                    <p>Merchant ID: ${merchantId || 'Not found'}</p>
                                    <p>Tab Status: ${window.riskIndicatorsTab ? 'Initialized' : 'Not initialized'}</p>
                                    <p class="mt-2">Please check the browser console for more details.</p>
                                </div>
                            `;
                        }
                    }
                });
            } else {
                console.error('‚ùå Risk Indicators tab button not found');
            }
        }, 2000); // Wait 2 seconds for DOM to be fully ready
    </script>
</body>
</html>
