groups:
  - name: kyb-platform-recording-rules
    rules:
      # HTTP request rate
      - record: job:kyb_http_requests_total:rate5m
        expr: rate(kyb_http_requests_total[5m])
      
      - record: job:kyb_http_requests_total:rate1m
        expr: rate(kyb_http_requests_total[1m])
      
      # HTTP request duration percentiles
      - record: job:kyb_http_request_duration_seconds:p50
        expr: histogram_quantile(0.5, rate(kyb_http_request_duration_seconds_bucket[5m]))
      
      - record: job:kyb_http_request_duration_seconds:p95
        expr: histogram_quantile(0.95, rate(kyb_http_request_duration_seconds_bucket[5m]))
      
      - record: job:kyb_http_request_duration_seconds:p99
        expr: histogram_quantile(0.99, rate(kyb_http_request_duration_seconds_bucket[5m]))
      
      # Business metrics rates
      - record: job:kyb_classification_requests_total:rate5m
        expr: rate(kyb_classification_requests_total[5m])
      
      - record: job:kyb_risk_assessment_requests_total:rate5m
        expr: rate(kyb_risk_assessment_requests_total[5m])
      
      - record: job:kyb_compliance_check_requests_total:rate5m
        expr: rate(kyb_compliance_check_requests_total[5m])
      
      # Error rates
      - record: job:kyb_database_errors_total:rate5m
        expr: rate(kyb_database_errors_total[5m])
      
      - record: job:kyb_external_api_errors_total:rate5m
        expr: rate(kyb_external_api_errors_total[5m])
      
      - record: job:kyb_authentication_events_total:rate5m
        expr: rate(kyb_authentication_events_total[5m])
      
      - record: job:kyb_rate_limit_hits_total:rate5m
        expr: rate(kyb_rate_limit_hits_total[5m])
      
      # HTTP error rate
      - record: job:kyb_http_requests_total:error_rate5m
        expr: rate(kyb_http_requests_total{status_code=~"5.."}[5m]) / rate(kyb_http_requests_total[5m])
      
      # System metrics
      - record: job:kyb_system_memory_usage_bytes:total
        expr: sum(kyb_system_memory_usage_bytes) by (instance)
      
      - record: job:kyb_system_goroutines:total
        expr: sum(kyb_system_goroutines) by (instance)
      
      # Database connection utilization
      - record: job:kyb_database_connections:utilization
        expr: kyb_database_connections / 100 * 100
      
      # External API success rate
      - record: job:kyb_external_api_calls_total:success_rate5m
        expr: rate(kyb_external_api_calls_total{status="success"}[5m]) / rate(kyb_external_api_calls_total[5m])
      
      # Authentication success rate
      - record: job:kyb_authentication_events_total:success_rate5m
        expr: rate(kyb_authentication_events_total{status="success"}[5m]) / rate(kyb_authentication_events_total[5m])
      
      # Classification accuracy average
      - record: job:kyb_classification_accuracy:average
        expr: avg(kyb_classification_accuracy) by (method)
      
      # Health check status
      - record: job:kyb_health_check_status:overall
        expr: avg(kyb_health_check_status) by (component)
      
      # Request throughput by endpoint
      - record: job:kyb_http_requests_total:by_endpoint_rate5m
        expr: rate(kyb_http_requests_total[5m]) by (endpoint)
      
      # Response time by endpoint
      - record: job:kyb_http_request_duration_seconds:by_endpoint_p95
        expr: histogram_quantile(0.95, rate(kyb_http_request_duration_seconds_bucket[5m])) by (endpoint)
      
      # API key usage by endpoint
      - record: job:kyb_api_key_usage_total:by_endpoint_rate5m
        expr: rate(kyb_api_key_usage_total[5m]) by (endpoint)
      
      # Rate limit hits by endpoint
      - record: job:kyb_rate_limit_hits_total:by_endpoint_rate5m
        expr: rate(kyb_rate_limit_hits_total[5m]) by (endpoint)
